<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" language="java" %>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>굿즈샵 품목 관리 - DDTOWN 관리자 시스템</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/admin_portal.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/admin_items.css">
</head> 

<body>
<div class="emp-container">
        <header class="emp-header">
            <div class="emp-logo">
                <a href="${pageContext.request.contextPath}/main">DDTOWN 관리자</a>
            </div>
            <div class="emp-user-info">
                <span id="adminUserName"><i class="fas fa-user-circle"></i> ${not empty adminUser.username ? adminUser.username : '관리자 (admin_user)'}</span>
                <a href="#" class="emp-logout-btn" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>
            </div>
        </header>
		
        <div class="emp-body-wrapper">
            <aside class="emp-sidebar">
                <nav class="emp-nav">
                    <ul>
                        <li>
                            <a href="#" class="emp-nav-item has-submenu" data-menu="corp">
                                <i class="fas fa-building"></i> 기업관리 <span class="submenu-arrow">&gt;</span>
                            </a>
                            <ul class="emp-submenu" id="submenu-corp">
                                <li><a href="${pageContext.request.contextPath}/notice/admin_corp_notice_list.html" class="emp-nav-item">공지사항 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/info/admin_info_dashboard.html" class="emp-nav-item">기업정보 관리</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#" class="emp-nav-item has-submenu" data-menu="cs">
                                <i class="fas fa-headset"></i> 고객센터 <span class="submenu-arrow">&gt;</span>
                            </a>
                            <ul class="emp-submenu" id="submenu-cs">
                                <li><a href="${pageContext.request.contextPath}/cs/admin_cs_faq_list.html" class="emp-nav-item">FAQ 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/cs/admin_cs_inquiry_list.html" class="emp-nav-item">1:1문의 관리</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#" class="emp-nav-item has-submenu" data-menu="community">
                                <i class="fas fa-users"></i> 아티스트 커뮤니티 관리 <span class="submenu-arrow">&gt;</span>
                            </a>
                            <ul class="emp-submenu" id="submenu-community">
                                <li><a href="${pageContext.request.contextPath}/artist/admin_member_list.html" class="emp-nav-item">회원관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/artist/admin_artist_list.html" class="emp-nav-item">아티스트 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/report/admin_report_list.html" class="emp-nav-item">신고 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/blacklist/admin_blacklist_list.html" class="emp-nav-item">블랙리스트 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/apt/admin_apt_list.html" class="emp-nav-item">APT 관리</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#" class="emp-nav-item has-submenu" data-menu="goods">
                                <i class="fas fa-store"></i> 굿즈샵 관리 <span class="submenu-arrow">&gt;</span>
                            </a>
                            <ul class="emp-submenu" id="submenu-goods">
                                <li><a href="${pageContext.request.contextPath}/admin/goods/1.notice/admin_goods_notice_list.html" class="emp-nav-item">공지사항 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/admin/goods/itemList" class="emp-nav-item">품목 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/admin/goods/3.categories/admin_goods_categories_list.html" class="emp-nav-item">품목 카테고리 관리</a></li>
                                <li><a href="${pageContext.request.contextPath}/admin/goods/4.orders/admin_goods_orders_list.html" class="emp-nav-item">주문내역 관리</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="${pageContext.request.contextPath}/stats/admin_stats.html" class="emp-nav-item" data-menu="stats">
                                <i class="fas fa-chart-line"></i> 통계관리
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>
            <main class="emp-content">
                <section id="goodsItemsSection" class="ea-section active-section">
                    <div class="ea-section-header">
                        <h2>굿즈샵 품목 관리</h2>
                        <form method="GET" action="${pageContext.request.contextPath}/admin/goods/2.items/items_list.jsp" class="ea-header-actions">
                            <input type="text" id="goodsItemSearchInput" name="searchKeyword" class="ea-search-input" placeholder="상품명, 상품코드로 검색..." value="${param.searchKeyword}">
                            <select id="goodsItemCategoryFilter" name="categoryFilter" class="ea-filter-select">
                                <option value="">정렬</option>
                                <option value="photocard" ${param.categoryFilter == 'photocard' ? 'selected' : ''}>최신 등록순</option>
                                <option value="album" ${param.categoryFilter == 'album' ? 'selected' : ''}>최신 수정순</option>
                                <option value="lightstick" ${param.categoryFilter == 'lightstick' ? 'selected' : ''}>낮은 가격순</option>
                                <option value="clothing" ${param.categoryFilter == 'clothing' ? 'selected' : ''}>높은 가격순</option>
                            </select>
                            <button id="goodsItemSearchBtn" type="submit" class="ea-btn"><i class="fas fa-search"></i> 검색</button>
                            <a href="${pageContext.request.contextPath}/admin/goods/items/form" class="ea-btn primary"><i class="fas fa-plus"></i> 새 상품 등록</a>
                        </form>
                    </div>

                    <table class="ea-table">
                        <thead>
                            <tr>
                                <th style="width: 8%;">상품코드</th>
                                <th style="width: 8%;">이미지</th>
                                <th>상품명</th>
                                <th style="width: 10%;">판매가격</th>
                                <th style="width: 8%;">재고</th>
                                <th style="width: 10%;">판매상태</th>
                                <th style="width: 10%;">등록일</th>
                                <th style="width: 15%;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="goodsItemsTableBody">
                            <c:choose>
                                <c:when test="${not empty goodsList}">
                                    <c:forEach items="${goodsList}" var="goods">
                                        <tr>
                                            <td>${goods.goodsNo}</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty goods.representativeImageUrl}">
                                                        <img src="${pageContext.request.contextPath}${goods.representativeImageUrl}" alt="${goods.goodsNm} 썸네일" class="item-thumbnail">
                                                    </c:when>
                                                    <c:otherwise>
                                                        <img src="https://via.placeholder.com/50?text=No+Image" alt="이미지 없음" class="item-thumbnail">
                                                    </c:otherwise>
                                                </c:choose>
                                            </td>
                                            <td><a href="${pageContext.request.contextPath}/admin/goods/items/itemsDetail?id=${goods.goodsNo}" class="doc-link">${goods.goodsNm}</a></td>
								            <td><fmt:formatNumber value="${goods.goodsPrice}" type="number" pattern="#,##0" /> 원</td>
								            <td>
								                <%-- 재고 수량 표시 --%>
								                <c:choose>
								                    <c:when test="${goods.stockRemainQty == null || goods.stockRemainQty <= 0}">
								                        <span style="color: red;">품절</span> (0개)
								                    </c:when>
								                    <c:otherwise>
								                        ${goods.stockRemainQty} 개
								                    </c:otherwise>
								                </c:choose>
								            </td>
								            <td>
								                <c:choose>
								                    <c:when test="${goods.statusEngKey == 'IN_STOCK'}">
								                        <span class="status-badge status-selling">${goods.statusKorName}</span>
								                    </c:when>
								                    <c:when test="${goods.statusEngKey == 'SOLD_OUT'}">
								                        <span class="status-badge status-soldout">${goods.statusKorName}</span>
								                    </c:when>
								                    <c:otherwise>
								                        <span class="status-badge">${goods.statusKorName} (Code: ${goods.statusEngKey})</span>
								                    </c:otherwise>
								                </c:choose>
								            </td>
								            <td><fmt:formatDate value="${goods.goodsRegDate}" pattern="yyyy-MM-dd"/></td>
								            <td>
								                <a href="${pageContext.request.contextPath}/admin/goods/items/detail?id=${goods.goodsNo}" class="ea-btn sm"><i class="fas fa-eye"></i> 상세보기</a>
								            </td>
                                        </tr>
                                    </c:forEach>
                                </c:when>
                                <c:otherwise>
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: 20px;">등록된 상품이 없습니다.</td>
                                    </tr>
                                </c:otherwise>
                            </c:choose>
                        </tbody>
                    </table>
                    <div class="ea-pagination" id="goodsItemsPagination">
                        <c:if test="${totalPages > 0}">
                            이전 페이지 그룹 또는 첫 페이지로 가기
                            <c:if test="${currentPage > 1}">
                                <a href="?page=1&searchKeyword=${param.searchKeyword}&categoryFilter=${param.categoryFilter}">&laquo;&laquo;</a>
                                <a href="?page=${currentPage - 1}&searchKeyword=${param.searchKeyword}&categoryFilter=${param.categoryFilter}">&laquo;</a>
                            </c:if>

                            <c:forEach var="pageNum" begin="${startPage}" end="${endPage}">
                                <a href="?page=${pageNum}&searchKeyword=${param.searchKeyword}&categoryFilter=${param.categoryFilter}" class="${pageNum == currentPage ? 'active' : ''}">${pageNum}</a>
                            </c:forEach>

                            다음 페이지 그룹 또는 마지막 페이지로 가기
                            <c:if test="${currentPage < totalPages}">
                                <a href="?page=${currentPage + 1}&searchKeyword=${param.searchKeyword}&categoryFilter=${param.categoryFilter}">&raquo;</a>
                                <a href="?page=${totalPages}&searchKeyword=${param.searchKeyword}&categoryFilter=${param.categoryFilter}">&raquo;&raquo;</a>
                            </c:if>
                        </c:if>
                    </div>
                </section>
            </main>
        </div>

        <footer class="emp-footer">
            <p>&copy; <jsp:useBean id="now" class="java.util.Date" /><fmt:formatDate value="${now}" pattern="yyyy" /> DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>
    <script>
        // 로그아웃 기능 (실제 로그아웃 처리는 서버에서)
        const logoutButton = document.getElementById('adminLogoutBtn');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('로그아웃 하시겠습니까?')) {
                    // 실제 로그아웃 URL로 이동
                    window.location.href = '${pageContext.request.contextPath}/admin/logout';
                }
            });
        }

        // 사이드바 메뉴 기능 (기존 HTML의 스크립트 로직 유지, URL은 JSP에 맞게 수정됨)
        document.addEventListener('DOMContentLoaded', function() {
            const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
            navItemsWithSubmenu.forEach(item => {
                const arrow = item.querySelector('.submenu-arrow');
                item.addEventListener('click', function(event) {
                    // 링크 이동을 막지 않으려면 아래 주석 처리 (href="#" 인 경우에만 막는 것이 좋음)
                    if (this.getAttribute('href') === '#') {
                        event.preventDefault();
                    }

                    const parentLi = this.parentElement;
                    const submenu = this.nextElementSibling;

                    // 다른 열린 서브메뉴 닫기
                    if (submenu && submenu.classList.contains('emp-submenu')) {
                        const parentUl = parentLi.parentElement;
                        if (parentUl) {
                            Array.from(parentUl.children).forEach(siblingLi => {
                                if (siblingLi !== parentLi) {
                                    const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
                                    if (siblingSubmenuControl) {
                                        const siblingSubmenu = siblingSubmenuControl.nextElementSibling;
                                        siblingSubmenuControl.classList.remove('open');
                                        if (siblingSubmenu && siblingSubmenu.classList.contains('emp-submenu')) {
                                            siblingSubmenu.style.display = 'none';
                                        }
                                        const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
                                        if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
                                    }
                                }
                            });
                        }
                    }
                    
                    // 현재 클릭한 메뉴 토글
                    this.classList.toggle('open');
                    if (submenu && submenu.classList.contains('emp-submenu')) {
                        submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
                        if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                });
            });

            // 현재 URL을 기반으로 활성 메뉴 표시
            const currentFullHref = window.location.href;
            const contextPath = "${pageContext.request.contextPath}";

            document.querySelectorAll('.emp-sidebar .emp-nav-item[href]').forEach(link => {
                const linkHrefAttribute = link.getAttribute('href');
                // 링크가 #이 아니고, 현재 URL이 해당 링크로 끝나는 경우 (컨텍스트 경로 고려)
                if (linkHrefAttribute && linkHrefAttribute !== "#") {
                    const fullLinkPath = (linkHrefAttribute.startsWith(contextPath) ? linkHrefAttribute : contextPath + linkHrefAttribute);
                    // URL이 정확히 일치하거나, 현재 URL이 링크로 시작하고 추가 파라미터가 있는 경우도 고려할 수 있음
                    // 여기서는 단순 endsWith 대신, URL 객체를 사용하여 경로만 비교하는 것이 더 정확할 수 있습니다.
                    // 간단하게는 아래와 같이 처리:
                    if (currentFullHref.includes(fullLinkPath)) { // includes로 변경하여 파라미터가 있어도 매칭되도록
                        link.classList.add('active');
                        let currentActiveElement = link;
                        // 부모 서브메뉴 펼치기
                        while (true) {
                            const parentLi = currentActiveElement.parentElement;
                            if (!parentLi) break;
                            const parentSubmenuUl = parentLi.closest('.emp-submenu');
                            if (parentSubmenuUl) {
                                parentSubmenuUl.style.display = 'block';
                                const controllingAnchor = parentSubmenuUl.previousElementSibling;
                                if (controllingAnchor && controllingAnchor.tagName === 'A' && controllingAnchor.classList.contains('has-submenu')) {
                                    controllingAnchor.classList.add('active', 'open');
                                    const arrow = controllingAnchor.querySelector('.submenu-arrow');
                                    if (arrow) {
                                        arrow.style.transform = 'rotate(90deg)';
                                    }
                                    currentActiveElement = controllingAnchor;
                                } else {
                                    break;
                                }
                            } else {
                                break;
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
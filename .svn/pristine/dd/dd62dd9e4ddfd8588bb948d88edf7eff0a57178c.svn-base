<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>전체 회원 관리</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="${pageContext.request.contextPath}/resources/ckeditorInquiry/ckeditor.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
<%@ include file="../../modules/headerPart.jsp" %>
<style type="text/css">
#memberSearchButton {
    width: auto; 
    min-width: max-content; 
    white-space: nowrap; 
    writing-mode: horizontal-tb !important; 
    padding-left: 12px; 
    padding-right: 12px; 
}
</style>
</head>
<body>
<div class="emp-container">
        <%@ include file="../modules/header.jsp" %>

        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
            
			<main class="emp-content">
				<section class="ea-section">
					<div class="ea-section-header">
						<h2>전체 회원 관리</h2>
						<div class="ea-header-actions">
							<form class="input-group input-group-sm" method="get" id="searchForm" style="flex-wrap: nowrap; ">
	                            <select id="memberStatusFilter" name="searchType" class="ea-filter-select" style="margin-right: 10px;">
	                                <option value="all" <c:if test="${pagingVO.searchType eq 'all'}">selected</c:if>>전체 상태</option>
	                                <option value="MSC001" <c:if test="${pagingVO.searchType eq 'MSC001'}">selected</c:if>>정상</option>
	                                <option value="MSC002" <c:if test="${pagingVO.searchType eq 'MSC002'}">selected</c:if>>탈퇴</option>
	                                <option value="MSC003" <c:if test="${pagingVO.searchType eq 'MSC003'}">selected</c:if>>블랙리스트</option>
	                            </select>
	                            <input type="text" id="memberSearchInput" name="searchWord" class="ea-search-input" placeholder="아이디, 이름, 닉네임, 이메일 검색" value="${pagingVO.searchWord}">
								<input type="hidden" name="currentPage" value="1" id="page">
	                            
	                            <div class="input-group-append">
									<button type="submit" id="memberSearchButton" class="ea-btn primary">검색</button>
								</div>
                        	</form>
						</div>
					</div>
						
						<table class="ea-table" id="memberListTable">
			                <thead>
			                    <tr>
			                        <th>번호</th>
			                        <th>아이디</th>
			                        <th>이름</th>
			                        <th>닉네임</th>
			                        <th>이메일</th>
			                        <th>상태</th>
			                        <th>가입일</th>
			                        <th>관리</th>
			                    </tr>
			                </thead>
			                <tbody id="memberTableBody">
			                	<c:if test="${empty pagingVO.dataList}">
	                                <tr>
	                                    <td colspan="8" class="text-center">등록된 회원 정보가 없습니다.</td>
	                                </tr>
                                </c:if>
			                	<c:forEach items="${pagingVO.dataList }" var="vo">
			                		<tr>
			                			<td>${vo.rowNum }</td>
			                			<td>
			                				<a href="/admin/community/member/detail/${vo.memUsername }" class="member-id-link">
				                			${vo.memUsername }
			                				</a>
			                			</td>
			                			<td>${vo.peopleVO.fullName }</td>
			                			<td >
			                				<div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
					                			${vo.memNicknm }
				                				<c:if test="${vo.peopleVO.userTypeCode == 'UTC002' }">
				                					<img alt="아티스트 인증 마크" src="${pageContext.request.contextPath }/resources/img/verified.png" style="width: 15px; height: 15px;">
				                				</c:if>
											</div>
			                			</td>
			                			<td>${vo.peopleVO.peoEmail }</td>
			                			<c:choose>
			                				<c:when test="${vo.memStatDetCode eq '정상'}">
			                					<td><span class="status-badge answered">${vo.memStatDetCode }</span></td>
			                				</c:when>
			                				<c:when test="${vo.memStatDetCode eq '정지' }">
			                					<td><span class="status-badge pending">${vo.memStatDetCode }</span></td>
			                				</c:when>
			                				<c:otherwise>
			                					<td><span class="status-badge danger">${vo.memStatDetCode }</span></td>
			                				</c:otherwise>
			                			</c:choose>
			                			<td><fmt:formatDate value="${vo.memRegDate}" pattern="yyyy-MM-dd"/></td>
			                			<td><button class="ea-btn sm outline" data-member-id="${vo.memUsername }" onclick="javascript:location.href='/admin/community/member/detail/${vo.memUsername}'">보기</button></td>
			                		</tr>
			                	</c:forEach>
			                </tbody>
			            </table>
			            <div class="pagination-container" id="pagingArea">
			            	${pagingVO.pagingHTML}
			            </div>
				</section>
			</main>
		</div>

        <footer class="emp-footer">
            <p>&copy; <fmt:formatDate value="<%=new java.util.Date()%>" pattern="yyyy"/> DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>
<script type="text/javascript">
//사이드바 메뉴 기능
document.addEventListener('DOMContentLoaded', function() {
    const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
    navItemsWithSubmenu.forEach(item => {
        const arrow = item.querySelector('.submenu-arrow');
        item.addEventListener('click', function(event) {
            if (this.getAttribute('href') === '#') {
                event.preventDefault();
            }
            const parentLi = this.parentElement;
            const submenu = this.nextElementSibling;

            if (submenu && submenu.classList.contains('emp-submenu')) {
                const parentUl = parentLi.parentElement;
                if (parentUl) {
                    Array.from(parentUl.children).forEach(siblingLi => {
                        if (siblingLi !== parentLi) {
                            const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
                            if (siblingSubmenuControl) {
                                const siblingSubmenuElement = siblingSubmenuControl.nextElementSibling;
                                siblingSubmenuControl.classList.remove('open');
                                if (siblingSubmenuElement && siblingSubmenuElement.classList.contains('emp-submenu')) {
                                    siblingSubmenuElement.style.display = 'none';
                                }
                                const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
                                if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                }
            }
            
            this.classList.toggle('open');
            if (submenu && submenu.classList.contains('emp-submenu')) {
                submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
                if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        });
    });

    // 현재 페이지 URL 기반으로 사이드바 메뉴 활성화
    const currentFullHref = window.location.href;
    document.querySelectorAll('.emp-sidebar .emp-nav-item[href]').forEach(link => {
        if (link.href === currentFullHref) {
            link.classList.add('active');
            let currentActiveElement = link;
            while (true) {
                const parentLi = currentActiveElement.parentElement;
                if (!parentLi) break;
                const parentSubmenuUl = parentLi.closest('ul.emp-submenu');
                if (parentSubmenuUl) {
                    parentSubmenuUl.style.display = 'block';
                    const controllingAnchor = parentSubmenuUl.previousElementSibling;
                    if (controllingAnchor && controllingAnchor.classList.contains('has-submenu')) {
                        controllingAnchor.classList.add('active', 'open');
                        const arrow = controllingAnchor.querySelector('.submenu-arrow');
                        if (arrow) arrow.style.transform = 'rotate(90deg)';
                        currentActiveElement = controllingAnchor;
                    } else break;
                } else break;
            }
        }
    });

	//페이지네이션 처리 시작
	const searchForm = document.getElementById("searchForm");
    const pageInput = searchForm.querySelector("input[name='currentPage']"); // hidden input의 name 사용
    const paginationControls = document.getElementById("pagingArea");

    if (paginationControls) { // paginationControls 요소가 존재할 때만 이벤트 리스너 추가
        paginationControls.addEventListener("click", function(e) {
            e.preventDefault(); // 기본 링크 이동 방지

            // 클릭된 요소가 'page-link' 클래스를 가지고 있고 'A' 또는 'SPAN' 태그인지 확인
            if (e.target.classList.contains("page-link") && (e.target.nodeName === "A" || e.target.nodeName === "SPAN")) {
                pageInput.value = e.target.dataset.page; // data-page 속성 값으로 hidden input 업데이트
                searchForm.submit(); // 폼 제출
            }
        });
    }
    // 페이지네이션 처리 끝
})
	
$(function(){
	// 검색결과 유지한채 이동
	let memberListTable = $("#memberListTable");
	memberListTable.on("click","button",function(){
		const memberId = $(this).data("member-id");
		let searchWord = "${pagingVO.searchWord}";
		let currentPage = "${pagingVO.currentPage}";
		
		sessionStorage.setItem("currentPage",currentPage);
		sessionStorage.setItem("searchWord",searchWord);
		
		
		location.href="/admin/community/member/detail/" + memberId;
	})
});	


</script>
</body>
</html>
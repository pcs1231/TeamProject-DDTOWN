<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>1:1 문의 상세 및 답변 - DDTOWN 관리자</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="${pageContext.request.contextPath}/resources/ckeditorInquiry/ckeditor.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<%@ include file="../../modules/headerPart.jsp" %>
</head>
<script type="text/javascript">
//사이드바 메뉴 기능
document.addEventListener('DOMContentLoaded', function() {
    const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
    navItemsWithSubmenu.forEach(item => {
        const arrow = item.querySelector('.submenu-arrow');
        item.addEventListener('click', function(event) {
            if (this.getAttribute('href') === '#') {
                event.preventDefault();
            }
            const parentLi = this.parentElement;
            const submenu = this.nextElementSibling;

            if (submenu && submenu.classList.contains('emp-submenu')) {
                const parentUl = parentLi.parentElement;
                if (parentUl) {
                    Array.from(parentUl.children).forEach(siblingLi => {
                        if (siblingLi !== parentLi) {
                            const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
                            if (siblingSubmenuControl) {
                                const siblingSubmenuElement = siblingSubmenuControl.nextElementSibling;
                                siblingSubmenuControl.classList.remove('open');
                                if (siblingSubmenuElement && siblingSubmenuElement.classList.contains('emp-submenu')) {
                                    siblingSubmenuElement.style.display = 'none';
                                }
                                const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
                                if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                }
            }
            
            this.classList.toggle('open');
            if (submenu && submenu.classList.contains('emp-submenu')) {
                submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
                if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        });
    });

    // 현재 페이지 URL 기반으로 사이드바 메뉴 활성화
    const currentFullHref = window.location.href;
    document.querySelectorAll('.emp-sidebar .emp-nav-item[href]').forEach(link => {
        if (link.href === currentFullHref) {
            link.classList.add('active');
            let currentActiveElement = link;
            while (true) {
                const parentLi = currentActiveElement.parentElement;
                if (!parentLi) break;
                const parentSubmenuUl = parentLi.closest('ul.emp-submenu');
                if (parentSubmenuUl) {
                    parentSubmenuUl.style.display = 'block';
                    const controllingAnchor = parentSubmenuUl.previousElementSibling;
                    if (controllingAnchor && controllingAnchor.classList.contains('has-submenu')) {
                        controllingAnchor.classList.add('active', 'open');
                        const arrow = controllingAnchor.querySelector('.submenu-arrow');
                        if (arrow) arrow.style.transform = 'rotate(90deg)';
                        currentActiveElement = controllingAnchor;
                    } else break;
                } else break;
            }
        }
    });
});

function dateFormat(jsonDate){
	if (!jsonDate) return "";
	let date = new Date(jsonDate);
	let month = date.getMonth() + 1;
    let day = date.getDate();
    let hour = date.getHours();
    let minute = date.getMinutes();
    let second = date.getSeconds();

    month = month >= 10 ? month : '0' + month;
    day = day >= 10 ? day : '0' + day;
    hour = hour >= 10 ? hour : '0' + hour;
    minute = minute >= 10 ? minute : '0' + minute;
    second = second >= 10 ? second : '0' + second;

    return date.getFullYear() + '-' + month + '-' + day;
}

$(function(){
	const currentUrl = location.href;
    const sliceUrl = currentUrl.split("/");
    const inqNo = sliceUrl[sliceUrl.length -1];
    
    CKEDITOR.replace("answerContent");
    
    let inqStatCode = null;
    
    $.ajax({
    	url : "/admin/inquiry/detailData/"+inqNo,
    	type : "get",
    	success : function(res){
    		console.log(res);
    		let className = "";
    		inqStatCode = res.inqStatCode;
    		$("#inqNo").html(res.inqNo);
    		if(res.inqStatCodeDes == '접수됨'){
    			className = "status-badge pending";
    			$("#inqStatCodeDes").attr('class',className)
    		}else{
    			className = "status-badge answered";
    			$("#inqStatCodeDes").attr('class',className)
    		}
    		$("#inqStatCodeDes").html(res.inqStatCodeDes);
    		$("#inqUsername").html(res.memUsername);
    		$("#inqTypeCodeDes").html(res.inqTypeCodeDes);
    		$("#inqRegDate").html(dateFormat(res.inqRegDate));
    		$("#userEmail").html(res.userEmail);
    		$("#inqTitle").html(res.inqTitle);
    		$("#inqContent").html(res.inqContent);
    		
    		if(res.inqAnsContent != null && res.inqAnsContent != ""){
    			$("#answerHistorySection").attr("style","display:block;");
    			$("#previousAnswer").attr("style","display:block;");
    			$("#prevAnswerer").html(res.empUsername);
    			$("#prevAnswerDate").html(dateFormat(res.inqAnsRegDate));
    			$("#previousAnswerContent").html(res.inqAnsContent);
    			$("#answerForm").attr("style","display:none;");
    			$("#submitAnswerBtn").attr("style","display:none");
    		}
    	},
    	error : function(error, status, thrown){
    		console.log(error.status);
    	}
    });
    
    $("#cancelBtn").on("click",function(){
    	if($("#cancelBtn").html() != "수정취소"){
	    	Swal.fire({
	    		title : "목록으로 돌아가시겠습니까?",
	    		text : "작성중이었던 내용은 저장되지 않습니다.",
	    		icon : 'warning',
	    		showCancelButton: true,
	    		confirmButtonColor: '#3085d6',
	   	      	cancelButtonColor: '#d33',
	   	      	confirmButtonText: '예',
	   	     	 cancelButtonText: '취소',
	    	}).then((result) => {
	    		if(result.isConfirmed){
	    			location.href="/admin/inquiry/main";
	    		}
	    	});
    	}else{
    		Swal.fire({
    			title : '수정을 취소하시겠습니까?',
    			text : '작성중이었던 내용은 저장되지 않습니다.',
    			icon : 'warning',
    			showCancelButton : true,
    			confirmButtonColor: '#3085d6',
	   	      	cancelButtonColor: '#d33',
	   	      	confirmButtonText: '예',
	   	     	cancelButtonText: '취소'
    		}).then((result) => {
    			if(result.isConfirmed){
    				$("#answerForm").attr("style","display:none;");
    				$("#submitAnswerBtn").attr("style","display:none");
    				$("#cancelBtn").html("목록으로");
    			}
    		});
    	}
    });
    
    $("#submitAnswerBtn").on("click",function(){
	    	let inqAnsContent = CKEDITOR.instances.inqAnsContent.getData();
	    	let data = new FormData();
	    	data.append("inqAnsContent",inqAnsContent);
	    	data.append("inqStatCode", inqStatCode);
    	
    	if($("#submitAnswerBtn").html() == "수정하기"){
    		Swal.fire({
    			title : "문의 답변을 수정하시겠습니까?",
    			icon : 'question',
    			showCancelButton : true,
    			confirmButtonText : '수정',
    			cancelButtonText : '취소',
    		}).then((result) => {
    			console.log("545");
    			if(result.isConfirmed){
    				$.ajax({
    					url : "/admin/inquiry/update/" + inqNo,
    					type : "post",
    					data : data,
    					contentType : false,
    					processData : false,
    					success : function(res){
    						if(res == "OK"){
    							Swal.fire({
    								title : '수정 완료!',
    								text : '수정이 완료되었습니다!',
    								icon : 'success',
    								showConfrimButton : true
    							}).then((result) => {
    								if(result.isConfirmed){
    									location.href = "/admin/inquiry/detail/" + inqNo;
    								}
    							});
    						}else{
    							Swal.fire({
    								title : '수정 실패!',
    								text : '문의 답변 수정에 실패했습니다. 다시 시도해주세요!',
    								icon : 'error'
    							});
    						}
    					},
    					error : function(error, status, thrown){
    						console.log(error.status);
    						Swal.fire({
								title : '수정 실패!',
								text : '문의 답변 수정에 실패했습니다. 다시 시도해주세요!',
								icon : 'error'
							});
    					},
    					beforeSend : function(xhr) {
	        		        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
	        		    }
    				});
    			}
    		});
    	}else{
	    	console.log(inqAnsContent);
	    	Swal.fire({
	    		title : "문의 답변을 등록하시겠습니까?",
	    		icon : 'question',
	    		showCancelButton : true,
	    		confirmButtonText : '저장',
	    		cancelButtonText : '취소',
	    	}).then((result) => {
	    		console.log(result);
	    		if(result.isConfirmed){
	    			$.ajax({
	    				url : "/admin/inquiry/insert/" + inqNo,
	    				type : "post",
	    				data : data,
	    				contentType : false,
	    				processData : false,
	    				success : function(res){
	    					console.log("res = ",res)
	    					if(res == "OK"){
	    						Swal.fire({
	    							title : '등록 완료!',
	    							text : '문의 답변 등록이 완료되었습니다!',
	    							icon : 'success',
	    							showConfrimButton : true,
	    						}).then((result) => {
	    							location.href = "/admin/inquiry/detail/"+inqNo;
	    						});
	    					}else{
	    						Swal.fire({
    								title : '등록 실패!',
    								text : '문의 답변 등록에 실패했습니다. 다시 시도해주세요!',
    								icon : 'error'
    							});
	    					}
	    				},
	    				error : function(error, status, thrown){
	    					console.log(error.status);
	    					Swal.fire({
								title : '등록 실패!',
								text : '문의 답변 등록에 실패했습니다. 다시 시도해주세요!',
								icon : 'error'
							});
	    				},
	    				beforeSend : function(xhr) {
	        		        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
	        		    }
	    			});
	    		}
	    	});
    		
    	}
    	
    });
    
    $("#updateAnswerBtn").on("click",function(){
    	$("#answerForm").attr("style","display:block;");
    	let submitAnswerBtn = $("#submitAnswerBtn");
    	submitAnswerBtn.html("수정하기");
    	submitAnswerBtn.attr("class", "ea-btn warning");
    	$("#cancelBtn").html("수정취소");
    	CKEDITOR.instances.inqAnsContent.setData($("#previousAnswerContent").html());
    	$("#submitAnswerBtn").attr("style","display:block");
    });
    
    $("#inqAnsContent").on("keyup",function(ev){
    	console.log(ev);
    })
    
    let content = CKEDITOR.instances.inqAnsContent;
    content.on("change",function(ev){
    	let text = content.document.getBody().getText();
    	let size = content.document.getBody().getText().trim().length;
    	
    	if(size > 1000){
    		let subText = text.substring(0,1000);	
    		let editorInstance = CKEDITOR.instances.inqAnsContent;
    		editorInstance.editable().setText(subText);
    		Swal.fire({
    			title : "입력초과!",
    			text : "문의 답변은 1000자를 초과할 수 없습니다!",
    			icon : "error",
    			timer : "1500"
    		}).then((result) => {
    			$(".cmt-sub-size").text(subText.length);
    			return false;
    		});
    	}
    	
    	$(".cmt-sub-size").text(size);
    })
});

function contentLengthCheck(ele){
	let size = ele.value.length;
	let text = ele.value;
	
	console.log(size);
	
	if(size > 1000){
		let subText = text.substring(0,650);	
		ele.value = subText;	
		Swal.fire({
			title : "입력초과!",
			text : "문의 답변은 1000자 이상 작성하실 수 없습니다.",
			icon : "error",
			timer : "1500"
		}).then((result) => {
			$(ele).parents("#inquiryAnswerForm").find(".cmt-sub-size").text(subText.length);
			return false;
		});
	}
	
	$(ele).parent("#inquiryAnswerForm").find(".cmt-sub-size").text(size);
}



</script>
<body>
<div class="emp-container">
	<%@ include file="../modules/header.jsp" %>
       
       <div class="emp-body-wrapper">
           <%@ include file="../modules/aside.jsp" %>

			<main class="emp-content">
				<section id="csInquiryDetailSection" class="ea-section active-section">
					<div class="ea-section-header">
			            <h2 id="inquiryDetailTitle">1:1 문의 상세 및 답변</h2>
			        </div>
			        
			        <div class="inquiry-detail-container">
			        	<section class="inquiry-section user-inquiry">
			        		<h3>사용자 문의 내용</h3>
			        		<dl class="inquiry-meta-grid">
			        			<div><dt>문의 번호:</dt><dd id="inqNo"></dd></div>
			        			<div><dt>문의 상태:</dt><dd><span class="status-badge pending" id="inqStatCodeDes"></span></dd></div>
			        			<div><dt>문의자 ID:</dt><dd id="inqUsername"></dd></div>
			        			<div><dt>문의 유형:</dt><dd id="inqTypeCodeDes">배송</dd></div>
			                    <div><dt>문의일:</dt><dd id="inqRegDate"></dd></div>
			                    <div><dt>연락처(이메일):</dt><dd id="userEmail"></dd></div>
			        		</dl>
			        		<h4>문의 제목: <span id="inqTitle" style="font-weight:normal;"></span></h4>
			                <div class="inquiry-content-view" id="inqContent"></div>
			        	</section>
			        	
			        	<section class="inquiry-section answer-history" id="answerHistorySection" style="display:none">
			        		<h3>답변 내역</h3>
				        		<button type="button" class="ea-btn warning" id="updateAnswerBtn">수정</button>
			        		<div class="answer-item" id="previousAnswer" style="display:none;">
			        			<div class="answer-meta">
			        				<span id="prevAnswerer"></span> | <span id="prevAnswerDate"></span>
			        			</div>
			        			<div class="answer-text" id="previousAnswerContent">
			        			</div>
			        		</div>
			        	</section>
			        	<section class="inquiry-section answer-form" id="answerForm" style="display:block">
			        		<h3 id="answerFormTitle">답변 작성</h3>
			        		<form class="ea-form" id="inquiryAnswerForm">
			        			<input type="hidden" id="inqNo" name="inqNo">
			        			<label for="inqAnsContent">답변 내용</label>
			        			<textarea id="inqAnsContent" name="answerContent" ></textarea>
			        			<div class="text-right pt-2">
									<span class="pt-1"><span class="cmt-sub-size">0</span>/1000</span> 
								</div>
			        		</form>
			        	</section>
			       		<div class="ea-form-actions">
			                <button type="button" class="ea-btn primary" id="submitAnswerBtn" style="display:block">답변 등록</button>
			                <button type="button" class="ea-btn outline" id="cancelBtn">목록으로</button>
			            </div>
			        </div>
				</section>
			</main>
		</div>
	</div>
</body>
</html>
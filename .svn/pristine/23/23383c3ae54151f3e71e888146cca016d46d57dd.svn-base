<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 상세보기 - DDTOWN 직원 포털</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" ></script>
    <style>
    	.emp-content{
    	flex: auto;
	    padding: 25px;
	    background-color: #f5f6fa;
	    DISPLAY: FLEX;
	    justify-content: center;
    	}
    	.post-reply-container {
		    /* max-width: 700px; */
		    margin: 20px 10px 20px 10px;
		    background: #fff;
		    border-radius: 10px;
		    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
		    padding: 36px 36px 28px 36px;
		    /* margin-top: 40px; */
		}
        .post-detail-container { width: 1000px;
							    margin: 20px;
							    background: #fff;
							    border-radius: 10px;
							    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
							    padding: 36px 36px 28px 36px; }
        .post-detail-container h2 { font-size: 1.7em; color: #234aad; margin-bottom: 28px; }
        .post-detail-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
        .post-detail-table th, .post-detail-table td { padding: 10px 8px; text-align: left; font-size: 1em; }
        .post-detail-table th { width: 140px; color: #234aad; background: #f5f5f5; font-weight: 600; }
        .post-detail-table td { background: #fafbfc; }
        .post-detail-content { min-height: 120px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 18px 14px; background: #fcfcfc; margin-bottom: 18px; font-size: 1.08em; line-height: 1.7; }
        .post-detail-btns { text-align: center; margin-top: 30px; }
        .post-detail-btns button { padding: 10px 32px; font-size: 1.1em; border: none; border-radius: 5px; margin: 0 8px; cursor: pointer; }
        .post-detail-btns .list-btn { background: #bdbdbd; color: #fff; }
        .post-detail-btns .edit-btn { background: #1976d2; color: #fff; }
        .post-detail-btns .delete-btn { background: #e74c3c; color: #fff; }
        .file-link { color: #1976d2; text-decoration: underline; margin-left: 8px; }
        .comment-section { margin-top: 40px; }
        .comment-section h3 { font-size: 1.15em; color: #234aad; margin-bottom: 12px; }
        .comment-table { width: 100%; border-collapse: collapse; }
        .comment-table th, .comment-table td { border: 1px solid #e0e0e0; padding: 8px 8px; text-align: center; font-size: 0.98em; }
        .comment-table th { background: #f5f5f5; }
        .comment-table td.content { text-align: left; }
        .comment-table td .comment-delete-btn { padding: 4px 12px; background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.97em; }
        
        .imgContainer{
        	position: relative;
        	margin:5px;
        	max-width:50%;
        	border-radius:8px;
        }
        
        .imgContainer img {
		    max-width: 100%; 
		    height: auto;
		    border-radius: 8px;
		    display: block; /* 이미지 하단 여백 제거 */
		}
		
		.deleteImgBtn {
		    position: absolute; /* 부모인 .image-container를 기준으로 위치 */
		    top: 5px;     /* 상단에서 5px 떨어지게 */
		    right: 5px;   /* 우측에서 5px 떨어지게 */
		    border: none;
		    border-radius: 50%; /* 동그란 모양 */
		    padding: 2px 5px;
		    cursor: pointer;
		    font-size: 1.2em; /* 아이콘 크기 조절 */
		    z-index: 10; /* 이미지가 버튼을 덮지 않도록 */
		}
		
		.deleteImgBtn:hover {
		    color: #fff;
		}
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>
        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
            <main class="emp-content" >
                <div class="post-detail-container">
                    <h2>게시물 상세보기</h2>
                    <table class="post-detail-table">
                        <tr>
                            <th>ID</th>
                            <td><c:out value="${artistVO.comuPostNo }"/></td>
                        </tr>
                        <tr>
                            <th>아티스트</th>
                            <td>${artistVO.writerProfile.artistVO.artNm }</td>
                        </tr>
                        <tr>
                            <th>작성일</th>
                            <td><fmt:formatDate value="${artistVO.comuPostRegDate }" pattern="yyyy-MM-dd HH:mm:ss"/></td>
                        </tr>
                        <tr>
                            <th>좋아요 수</th>
                            <td>${artistVO.comuPostLike }</td>
                        </tr>
                        <tr>
                            <th>멤버십 여부</th>
                            <td>${artistVO.comuPostMbspYn }</td>
                        </tr>
                        <tr>
                            <th>게시글 삭제 여부</th>
                            <td>${artistVO.comuPostDelYn }</td>
                        </tr>
                        <tr>
                            <th>게시글 상태</th>
                            <td>${artistVO.comuPostStatCode }</td>
                        </tr>
                        
                    </table>
                    <div class="post-detail-content">
                        <c:out value="${artistVO.comuPostContent }" />
                        <c:if test="${not empty artistVO.postFiles }">
                        	<c:forEach items="${artistVO.postFiles }" var="file">
                        		<img src="${file.webPath }" alt="첨부 이미지" style="margin-top:12px; max-width:50%; border-radius:8px;">
                        	</c:forEach>
                        </c:if>
                    </div>
                    <div class="post-detail-btns">
                        <button type="button" class="list-btn" onclick="window.location.href='/emp/post/list'">목록</button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" id="editModal" data-bs-target="#postEdit">수정</button>
                    </div>
                </div>
                <div class="post-reply-container">
                	<h5>게시물 댓글 목록 상세보기</h5>
                	<div class="comment-section">
                        <h3>댓글</h3><span>전제 댓글 수:<span id="totalReply"></span></span>
                        <form id="searchForm">
	                        <select class="searchType" id="searchType" name="searchType">
	                        	<option id="typeAll" value="">전체</option>
	                        	<option id="typeWriter" value="writer">작성자</option>
	                        	<option id="typeContent" value="content">내용</option>
	                        </select> 
	                        <input type="search" class="searchWord" id="searchWord" name="searchWord" value="" placeHolder="작성자 또는 내용을 입력해주세요" />
	                        <button type="button" class="btn btn-primary" id="searchBtn">검색</button>
                        </form>
	                        <table class="comment-table">
                            <thead>
                                <tr>
                                    <th>작성자</th>
                                    <th>내용</th>
                                    <th>작성일</th>
                                </tr>
                            </thead>
                            <tbody id="replyArea">
                            </tbody>
                        </table>
                        <div id="pagingArea">
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    

	<%@ include file="../../modules/footerPart.jsp" %>

<%@ include file="../../modules/sidebar.jsp" %>
<div id="modalArea">
<div class="modal fade" id="postEdit" tabindex="-1" aria-labelledby="postEditModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="postEditModalLabel">${artistVO.writerProfile.artistVO.artNm } 게시글</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="editForm">
					<div class="mb-3">
						<label for="comuPostRegDate" class="col-form-label">작성일</label>
						<input type="datetime" class="form-control" id="comuPostRegDate" value="${artistVO.comuPostRegDate }" readonly="readonly">
					</div>
					<div class="mb-3">
						<label for="comuPostModDate" class="col-form-label">수정일</label>
						<input type="datetime-local" min="${artistVO.comuPostModDate }" class="form-control" id="comuPostModDate" value="${artistVO.comuPostModDate }" readonly="readonly">
					</div>
					<div class="mb-3">
						<label for="memberShipYn" class="col-form-label">멤버십 선택</label>
						<input type="checkbox" id="editMemberShipYn"  <c:if test="${artistVO.comuPostMbspYn }">checked</c:if> />
						<input type="hidden" id="memberShipYn" name="memberShipYn" value=""/>
					</div>
					<div class="mb-3">
						<label for="postImg" class="col-form-label">사진</label>
						<div class="editImgArea">
							<c:if test="${not empty artistVO.postFiles }">
	                        	<c:forEach items="${artistVO.postFiles }" var="file">
	                        		<div class="imgContainer">
		                        		<img src="${file.webPath }" alt="첨부 이미지" ">
		                        		<button class="deleteImgBtn" id="deleteImgBtn" data-fileGorupNo="${file.fileGroupNo }" data-fileNo="${file.attachDetailNo }" ><i class="bi bi-x-circle-fill"></i></button>
	                        		</div>
	                        	</c:forEach>
	                        </c:if>
						</div>
					</div>
					<div class="mb-3">
						<label for="comuPostContent" class="col-form-label">내용</label>
						<textarea class="form-control" id="comuPostContent">${artistVO.comuPostContent }</textarea>
					</div>
					<div class="mb-3">
						<input type="file" name="files" id="editFile" multiple accept="image/*">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="updatePostBtn">수정</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
			</div>
		</div>
	</div>
</div>
</div>
</body>
<script>

$(function(){
	replyList();
	
	
	
	let pathName = window.location.pathname;
	let pathList = pathName.split("/");
	let comuPostNo = pathList[4];
	
	let fileMap = new Map();	// 업로드한 파일 담을 객체
	let fileNum = 0;		// 업로드한 파일의 순번
	
	let upFile = new Map();	// 수정 중 업로드한 파일 담을 객체
	let upFileNum = 0;		// 수정 중 업로드한 파일의 순번

	let deleteFileList = [];	// 삭제할 파일의 상세번호
	let deleteFileGroupNo = new Map();	// 삭제할 파일의 그룹번호
	
	$(".editImgArea").on("click","button",function(e){
		e.preventDefault();
		console.log($(this));
		let parentDiv = $(this).parent('div');
		let fileNo = $(this)[0].dataset.fileno;
		let fileGroupNo = $(this)[0].dataset.filegorupno;
		
		deleteFileList.push(fileNo);
		deleteFileGroupNo.set(fileNo, parentDiv);
		
		parentDiv.hide();
	});
	
	$("#editFile").on("change",function(e){
		let files = e.target.files;

		let html = ``;
		for(let i=0; i<files.length; i++){
			let file = files[i];

			fileMap.set(fileNum.toString(),file);

			let reader = new FileReader();
    		reader.onload = function(e){
    			html = `
    				<div class="imgContainer new-preview">
	            		<img src="\${e.target.result}" alt="첨부 이미지" >
	            		<button class="deleteImgBtn" id="deleteImgBtn" ><i class="bi bi-x-circle-fill"></i></button>
	        		</div>
					`;
        		fileNum++;
			$(".editImgArea").append(html);
    		}
    		reader.readAsDataURL(file);
		}
		
		console.log(fileMap)
	});
	
	$("#updatePostBtn").on("click",function(){
		
		console.log("${artistVO.comuPostNo}")
		
		let checked = $("#editMemberShipYn").is(":checked");
		$("#memberShipYn").val(checked);
		
		
		if(deleteFileList != null && deleteFileList.length > 0){
			console.log(deleteFileList);
			$("#deleteFiles").val(deleteFileList);
		}
		
		
		let fileList = document.getElementById("editFile");
		let files = fileList.files;
		
		
		let data = new FormData();
		data.append("comuPostNo","${artistVO.comuPostNo}");
		data.append("boardTypeCode", "${artistVO.boardTypeCode}");
		
		
		data.append("memUsername","${artistVO.writerProfile.artistVO.memUsername}");
		data.append("comuPostContent", $("#comuPostContent").val());
		
		if("${artistVO.fileGroupNo}" != null && "${artistVO.fileGroupNo}" != ''){
			console.log("${artistVO.fileGroupNo}");
			data.append("fileGroupNo","${artistVO.fileGroupNo}");
		}
		
		if(deleteFileList != null && deleteFileList.length > 0){
			data.append("deleteFiles",deleteFileList);
		}else{
			data.append("deleteFiles",deleteFileList);
		}
		
		if(checked){
			data.append("comuPostMbspYn","Y");
		}else{
			data.append("comuPostMbspYn","N");
		}
		
		if(files.length > 0){
			for(let i=0; i<files.length; i++){
				data.append("files",files[i]);
			}
		}
		
		$.ajax({
			url : "/community/update/post",
			type : "POST",
			data : data,
			processData : false,
			contentType : false,
			success : function(res){
				if(res == "OK"){
					alert("글 수정 완료!");
				}else{
					alert("글 수정 실패!");
				}
				location.href = "/emp/post/detail/${artistVO.comuPostNo}" ;
			},
			error : function(error){
				console.log(error.status);
			},
			beforeSend : function(xhr) {
		        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		    }
		})
	});
	
	$("#searchBtn").on("click",function(){
		let searchType = $("#searchType").val();
		let searchWord = $("#searchWord").val();
		
		console.log(searchType);
		
		let data = {
			"searchType" : searchType,
			"searchWord" : searchWord
		}
		
		replyList(data);
	});
	
	$("#searchWord").on("keydown",function(e){
		let data = {
			"searchWord" : $("#searchWord").val(),
			"searchType" : $("#searchType").val()	
		}
		if (e.key === 'Enter') {
			console.log('엔터키를 눌렀습니다.');
			replyList(data);
		}
	})
	
	$("#pagingArea").on("click","a",function(e){
		e.preventDefault();
		console.log($(this)[0].dataset.page);
		let page = $(this)[0].dataset.page;
		
		let searchType = $("#searchType").val();
		let searchWord = $("#searchWord").val();
		
		data = {
			"searchType" : searchType,
			"searchWord" : searchWord,
			"currentPage" : page
		}
		
		replyList(data);
	});
	
	$("#postEdit").on("hide.bs.modal",function(){
		$("#editForm")[0].reset();
		
		deleteFileGroupNo.forEach(($element, fileNo) => {
	        $element.show();
	        // 필요하다면 deleteFileList 등에서도 제거
	    });
		deleteFileGroupNo.clear();
		deleteFileList.length = 0;
	});
	
});

function replyList(data){
	let pathName = window.location.pathname;
	let pathList = pathName.split("/");
	let comuPostNo = pathList[4];
	
	$.ajax({
		url : '/emp/post/replyList/' + comuPostNo,
		type : 'get',
		data : data,
		success : function(res){
			console.log(res);
			if(res.pagingVO.searchWord != null && res.pagingVO.searchWord != ''){
				$("#searchWord").val(res.pagingVO.searchWord);
			}
			let replyList = res.pagingVO.dataList;
			let html = ``;
			if(replyList != null &&replyList.length > 0){
				for(let i=0; i<replyList.length; i++){
					let reply = replyList[i];
					
					let comuReplyRegDate = reply.comuReplyRegDate;
					let comuReplyModDate = reply.comuReplyModDate;
					
					let formatDate;
					
					if(comuReplyRegDate === comuReplyModDate){
						formatDate = dateFormat(comuReplyRegDate);
					}else{
						formatDate = dateFormat(comuReplyModDate) + " (수정됨)";
					}
					
					html += `
						<tr>
	                        <td>\${reply.replyMember.comuNicknm}</td>
	                        <td class="content">\${reply.comuReplyContent}</td>
	                        <td>\${formatDate}</td>
	                    </tr>
					`;
				}
			
			
			}else{
				html = `
					<tr>
	                    <td colspan="3">조회하실 댓글이 없습니다.</td>
	                </tr>
				`;
				
			}
			$("#replyArea").html(html);
			$("#pagingArea").html(res.pagingVO.pagingHTML);
			$("#totalReply").html(res.pagingVO.totalRecord);
		},
		error : function(error){
			console.log(error.status);
		}
	});
}

function dateFormat(jsonDate){
	if (!jsonDate) return "";
	let date = new Date(jsonDate);
	let month = date.getMonth() + 1;
    let day = date.getDate();
    let hour = date.getHours();
    let minute = date.getMinutes();
    let second = date.getSeconds();

    month = month >= 10 ? month : '0' + month;
    day = day >= 10 ? day : '0' + day;
    hour = hour >= 10 ? hour : '0' + hour;
    minute = minute >= 10 ? minute : '0' + minute;
    second = second >= 10 ? second : '0' + second;

    return date.getFullYear() + '-' + month + '-' + day + " " + hour + ":" + minute + ":" + second;
}
</script>


</html> 
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" language="java" %>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APT 대문</title>
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/mainservice_common.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/artist_community.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/artistDetail.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/artist.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style type="text/css">
	    body a {
	    	text-decoration: none;
	    }
	    .tab-content h2, .artist-name-description h1 {
	    	font-weight: 900;
	    }
	    
	
    </style>
</head>
<body>
	<jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />
	
    <div class="artist-detail-container">
        <header class="artist-detail-header">
            <div class="artist-profile-image-large">
                <img src="${group.artGroupProfileImg }" alt="${group.artGroupNm }의 프로필 배너" />
            </div>
            <div class="artist-info-bar">
                <div class="artist-name-description">
                    <h1 class="d-flex gap-2">
                    	${group.artGroupNm } 
                    	<img alt="아티스트 인증 마크" src="${pageContext.request.contextPath }/resources/img/verified.png" style="width: 25px; height: 25px;">
                    </h1>
                </div>
                <div class="artist-actions">
                    <a href="/community/gate/${group.artGroupNo}/apt" class="action-button go-to-apt" id="goToAptBtn">APT 바로가기</a>
                </div>
            </div>
        </header>

        <nav class="artist-content-tabs">
            <ul>
                <li><a href="#" data-tab="profile-content" class="active-tab">프로필 탭</a></li>
                <li><a href="#" data-tab="album-content">앨범 및 음원 정보 조회 탭</a></li>
            </ul>
        </nav>

        <main class="artist-content-area">
            <section id="profile-content" class="tab-content active">
            	
            		<c:choose>
            			<c:when test="${group.artGroupTypeCode == 'AGTC001'}">
            				<h2>그룹 소개</h2>
            			</c:when>
            			<c:otherwise>
            				<h2>아티스트 소개</h2>
            			</c:otherwise>
            		</c:choose>
                
                <div class="artist-profile-info">
                    <p>${group.artGroupContent}</p>
                    <ul class="artist-meta">
                        <li><strong>데뷔일:</strong> ${group.artGroupDebutdate }</li>
                        <c:set var="representativeSong" value="정보 없음"/> <%-- 기본값 설정 --%>
                        <c:if test="${not empty group.albumList}">
					    <c:forEach items="${group.albumList}" var="album">
					        <c:set var="representativeSong" value="${album.titleSong}"/>
					    </c:forEach>
					</c:if>
					<li><strong>대표곡:</strong> ${representativeSong}</li>
					<li><strong>멤버:</strong> 
						<div class="artist-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                            <c:forEach items="${group.artistList }" var="artist">
                                <div class="artist-item" data-name="${artist.artNm}" data-img="${artist.artProfileImg}">
                                    <p class="artist-name">${artist.artNm }</p>
                                </div>
                            </c:forEach>
                        </div>
					</li>
                        
                     
                    </ul>
                </div>
                <div>
	                <h2>최근 활동</h2>
	                <ul>
						<c:choose>
							<c:when test="${not empty noticeList }">
								<li>
									<c:forEach items="${noticeList }" var="notice">
											<a href="/community/notice/post/${notice.comuNotiNo }">
						        				<div class="feed-title">[<c:out value="${notice.codeDescription }" />]<c:out value="${notice.comuNotiTitle }"/></div>
						        				<div class="feed-date"><fmt:formatDate value="${notice.comuNotiRegDate }" pattern="yyyy-MM-dd"/></div>
						        			</a>
									</c:forEach>
								</li>
							</c:when>
						</c:choose>
	                </ul>
                </div>
            </section>

            <section id="album-content" class="tab-content" style="display: none;">
                <h2>앨범 및 음원 정보</h2>

                <div class="album-list">
                <c:if test="${not empty group.albumList}">
			        <div class="album-list">
			            <c:forEach var="album" items="${group.albumList}">
			                <article class="album-item">
			                    <div class="album-cover">
			                        <img src="${album.albumImg}" alt="${album.albumNm} 커버" style="width:350px; height:auto;"/>
			                    </div>
			                    <div class="album-details">
			                        <h3 class="album-title">${album.albumNm}</h3>
			                        <p class="album-release-date">
			                            <strong>발매일:</strong> 
			                            <fmt:formatDate value="${album.albumRegDate}" pattern="yyyy년 MM월 dd일" />
			                        </p>
			                        <p class="album-description">${album.albumDetail}</p>
			                        
			                        <p><strong>타이틀 곡:</strong> 
			                            <c:choose>
			                                <c:when test="${not empty album.titleSong}">
			                                    ${album.titleSong}
			                                </c:when>
			                                <c:otherwise>
			                                    (타이틀 곡 정보 없음)
			                                </c:otherwise>
			                            </c:choose>
			                        </p>
			
			                        <h4>수록곡 전체:</h4>
			                        <ul class="track-list-table">
			                            <c:forEach var="song" items="${album.albumSongs}">
			                                <li>
			                                    ${song.songNm}
			                                    <c:if test="${'Y' eq song.songTitleYn}">
			                                        <span class="track-title-badge">(타이틀)</span>
			                                    </c:if>
			                                </li>
			                            </c:forEach>
			                        </ul>
			                    </div>
			                </article>
			            </c:forEach>
			        </div>
			    </c:if>
                </div>
            </section>
        </main>
    </div>
	
	<div id="artist-modal" class="artist-modal" style="display:none;">
        <div class="artist-modal-content">
            <span class="artist-modal-close">&times;</span>
            <img id="modal-artist-img" src="" alt="아티스트 프로필" class="modal-artist-img">
            <div class="modal-artist-info">
                <h3 id="modal-artist-name"></h3>
            </div>
        </div>
    </div>
    
	<div id="footer">
        <!-- FOOTER -->
        <jsp:include page="/WEB-INF/views/modules/communityFooter.jsp" />
        <script src="${pageContext.request.contextPath}/resources/js/pages/communityFooter.js"></script>
        <!-- FOOTER END -->
    </div>
    
    <script>

        // 수정된 탭 기능
        const tabs = document.querySelectorAll('.artist-content-tabs a');
        const tabContents = document.querySelectorAll('.artist-content-area .tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function(event) {
                event.preventDefault();

                tabs.forEach(t => t.classList.remove('active-tab'));
                this.classList.add('active-tab');

                const targetId = this.dataset.tab;

                tabContents.forEach(content => {
                    if (content.id === targetId) {
                        content.style.display = 'block';
                    } else {
                        content.style.display = 'none';
                    }
                });
            });
        });

        // 페이지 로드 시 첫 번째 탭 활성화 및 해당 콘텐츠 표시
        if (tabs.length > 0 && tabContents.length > 0) {
            tabs[0].classList.add('active-tab');
            const firstTabTargetId = tabs[0].dataset.tab;

            tabContents.forEach(content => {
                if (content.id === firstTabTargetId) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {

            const artistItems = document.querySelectorAll('.artist-item'); 
            const artistModal = document.getElementById('artist-modal'); 
            
            const modalCloseBtn = artistModal ? artistModal.querySelector('.artist-modal-close') : null;

            if (artistItems.length > 0 && artistModal) {
                artistItems.forEach(function(item) {
                    item.addEventListener('click', function() {
                    	
                        const imgSrc = this.dataset.img; 
                        const name = this.dataset.name;

                        if (imgSrc && name) { 
                            document.getElementById('modal-artist-img').src = imgSrc;
                            document.getElementById('modal-artist-img').alt = name + " 프로필";
                            document.getElementById('modal-artist-name').textContent = name;
                            
                            artistModal.style.display = 'flex'; // 모달 표시 (flex로 중앙 정렬 가정)
                        } else {
                            console.error('멤버 카드에 data-name 또는 data-img 속성이 없습니다.', this);
                        }
                    });
                });

                if (modalCloseBtn) {
                    modalCloseBtn.addEventListener('click', function() {
                        artistModal.style.display = 'none';
                    });
                }

                // 모달 바깥 클릭 시 닫기
                artistModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });

                // (선택) Esc 키로 모달 닫기
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && artistModal.style.display === 'flex') {
                        artistModal.style.display = 'none';
                    }
                });

            } else {
                if (artistItems.length === 0) {
                    console.warn("클릭할 .artist-item 요소를 찾지 못했습니다. HTML 구조를 확인해주세요.");
                }
                if (!artistModal) {
                    console.warn("#artist-modal 요소를 찾지 못했습니다. 모달 HTML이 페이지에 포함되어 있는지 확인해주세요.");
                }
            }
        });

    </script>
</body>
</html>
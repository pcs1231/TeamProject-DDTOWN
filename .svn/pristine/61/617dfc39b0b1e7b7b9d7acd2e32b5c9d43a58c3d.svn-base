package kr.or.ddit.ddtown.service.chat.dm;


import java.security.Principal;
import java.util.Date;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.springframework.messaging.simp.SimpMessageSendingOperations;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.ddtown.mapper.chat.dm.ChatMessageMapper;
import kr.or.ddit.ddtown.mapper.community.CommunityProfileMapper;
import kr.or.ddit.ddtown.service.community.ICommunityProfileService;
import kr.or.ddit.vo.chat.dm.ChatMessageVO;
import kr.or.ddit.vo.file.AttachmentFileDetailVO;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequiredArgsConstructor
@Service
public class ChatMessageServiceImpl implements IChatMessageService {
	
	private final ChatMessageMapper chatMessageMapper;
	private final IChatChannelService chatChannelService;
	private final ICommunityProfileService communityService;
	private final SimpMessageSendingOperations messagingTemplate;
	
	private static final Pattern BAD_WORD_PATTERN = Pattern.compile(
			"((ì‹œë°œ|ì”¨ë°œ|ì‰¬ë°œ|ã…†ã…‚|ã……ã…‚|ã…ˆê°™|ì¢†ê°™|ì¡´ë‚˜|ë³‘ì‹ |ê°œìƒˆë¼|ì§€ë„|ë¯¸ì¹œ|ì• ë¯¸|ë‹¥ì³|ìƒˆë¼|ì—¼ë³‘|ì— ì°½|ê±¸ë ˆ|ì°½ë…„|ê³ ì|ì°ë”°|ìœ¡ì‹œëŸ´|ì¦|ã…‚ã……|ã…†ã„²|ã……ã„²|ã…ˆë°¥|ã…ˆã„´|êº¼ì ¸))",
			Pattern.CASE_INSENSITIVE
			);
	
	// ì±„íŒ…ë°© ë©”ì„¸ì§€ ì €ì¥
	@Override
	@Transactional
	public ChatMessageVO saveAndProcessChatMessage(ChatMessageVO message, Principal principal) {
		
		// 1. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
		String currentUser = principal.getName();
		log.info("name : {}", currentUser);
		
		// 2. ë°œì‹ ì í”„ë¡œí•„ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
		int comuProfileNo = chatChannelService.getComuProfileNoForChatChannel(message.getChatChannelNo(), currentUser);
		
		if(comuProfileNo == -1) {
			log.warn("Invalid comuProfileNo for user {}", comuProfileNo);
			return null;
		}
		
		// 3. ì»¤ë®¤ë‹ˆí‹° ë‹‰ë„¤ì„, í”„ë¡œí•„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
		Integer artGroupNo = chatChannelService.getArtGroupNoByChatChannelNo(message.getChatChannelNo());
		String comuNicknm = communityService.getComuNicknmByUsername(currentUser, artGroupNo);
		String userProfileImgPath = communityService.getComuProfileImgPath(currentUser, artGroupNo);
		
		// 4. ë©”ì„¸ì§€ ì „ì†¡ ì‹œê° ë° ë°œì‹ ì ì„¤ì •
		message.setUsername(currentUser);
		message.setComuProfileNo(comuProfileNo);
		message.setComuNicknm(comuNicknm);
		message.setUserProfileImgPath(userProfileImgPath);
		
		if(message.getChatSendDate() == null) {
			message.setChatSendDate(new Date());
		}
		
		// 5. ë©”ì„¸ì§€ íƒ€ì… ì½”ë“œ ì„¤ì •
		String originalContent = message.getChatContent();
		
		if(ChatMessageVO.MessageType.TALK.equals(message.getType())) {
			message.setChatMsgTypeCode("CMTC001");	// ì¼ë°˜ ë©”ì„¸ì§€ íƒ€ì…
		} else if(ChatMessageVO.MessageType.FILE.equals(message.getType())) {
			message.setChatMsgTypeCode("CMTC002");	// ì²¨ë¶€ íŒŒì¼ íƒ€ì…
		} else if(originalContent != null && originalContent.contains("@everyone")) {
			message.setType(ChatMessageVO.MessageType.MENTION_ALL);
			message.setChatMsgTypeCode("CMTC001");
		} else {
			message.setType(ChatMessageVO.MessageType.TALK);
			message.setChatMsgTypeCode("CMTC001");	// ê¸°ë³¸ ê°’
		}
		
		try {
			// 6. ë¹„ì†ì–´ í•„í„°ë§ ë¡œì§
			Matcher matcher = BAD_WORD_PATTERN.matcher(message.getChatContent());
			if(matcher.find()) {
				sendSystemWarningMessageToUser(currentUser, "ğŸš« ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ë©”ì‹œì§€ê°€ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸš«");
				return null;
			}
			
			// 7. DB ì €ì¥ (ë§¤í¼ í˜¸ì¶œ)
			chatMessageMapper.insertMessage(message);
			
			// 8. ì±„íŒ… ì±„ë„ ë§ˆì§€ë§‰ ë©”ì„¸ì§€ ë‚ ì§œ ì—…ë°ì´íŠ¸
			chatChannelService.updateChatLastDate(message.getChatChannelNo());
			
			// 9. ê¶Œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
			Authentication authentication = (Authentication) principal;
			
			// 10. ëª¨ë“  ì°¸ì—¬ìì—ê²Œ ë©”ì„¸ì§€ ì „ì†¡
			List<String> participantUsernames = chatChannelService.getChatParticipants(message.getChatChannelNo());
			
			// 11. ë©”ì„¸ì§€ ì „ì†¡ ë¡œì§
			for(String participantUsername : participantUsernames) {
				
				// ë³¸ì¸ ë©”ì„¸ì§€ ìì‹ ì—ê²Œ ë³´ì—¬ì•¼ í•¨
				if(message.getUsername().equals(participantUsername)) {
					messagingTemplate.convertAndSendToUser(participantUsername, "/queue/messages", message);
					continue;
				}
				
				// ìƒëŒ€ë°© ë©”ì„¸ì§€ ì²˜ë¦¬
				List<String> participantRoleCodes = chatChannelService.getUserRoleCodes(participantUsername, message.getChatChannelNo());
				
				boolean isRecipientArtist = participantRoleCodes.contains("PRC001");
				boolean isRecipientMembership =participantRoleCodes.contains("PRC002");
				
				// ì•„í‹°ìŠ¤íŠ¸ì˜ ê²½ìš° ëª¨ë“  ë©”ì„¸ì§€ ì¡°íšŒ ê°€ëŠ¥
				if(isRecipientArtist) {
					messagingTemplate.convertAndSendToUser(participantUsername, "/queue/messages", message);
					log.debug("ë©”ì‹œì§€ '{}' ì•„í‹°ìŠ¤íŠ¸ ({})ì—ê²Œ ì „ì†¡", message.getChatContent(), participantUsername);
				// ë©¤ë²„ì‹­ íšŒì›ì€ ì•„í‹°ìŠ¤íŠ¸ê°€ ë³´ë‚¸ ë©”ì„¸ì§€ë§Œ ë³¼ ìˆ˜ ìˆìŒ
		        } else if(isRecipientMembership) {
		        	boolean isSenderArtist = authentication.getAuthorities().stream()
		        			.anyMatch(a -> a.getAuthority().equals("ROLE_ARTIST"));
		        			
		        	if(isSenderArtist) {
		        		messagingTemplate.convertAndSendToUser(participantUsername, "/queue/messages", message);
		        		log.debug("ë©”ì‹œì§€ '{}' ë©¤ë²„ì‹­ íšŒì› ({})ì—ê²Œ ì „ì†¡", message.getChatContent(), participantUsername);
		        	}
		        }
			}
			return message;
		}catch (Exception e) {
			log.error("ë©”ì„¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ : {}", e.getMessage(), e);
			sendSystemErrorMessageToUser(currentUser, "ğŸš« ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸš«");
			throw new RuntimeException("ì±„íŒ… ë©”ì„¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨", e);
		}
	}
	
	// í•„í„°ë§ ê²½ê³  ë©”ì„¸ì§€
	private void sendSystemWarningMessageToUser(String currentUser, String message) {
		ChatMessageVO warnMsg = new ChatMessageVO();
        warnMsg.setUsername("SYSTEM");
        warnMsg.setComuNicknm("ì‹œìŠ¤í…œ");
        warnMsg.setChatContent(message);
        warnMsg.setChatSendDate(new Date());
        warnMsg.setChatMsgTypeCode("CMTC001");
        warnMsg.setType(ChatMessageVO.MessageType.TALK);
        messagingTemplate.convertAndSendToUser(currentUser, "/queue/messages", warnMsg);
		
	}

	// ì‹œìŠ¤í…œ ë©”ì„¸ì§€
	private void sendSystemErrorMessageToUser(String currentUser, String message) {
		ChatMessageVO errorMsg = new ChatMessageVO();
		errorMsg.setUsername("SYSTEM");
        errorMsg.setComuNicknm("ì‹œìŠ¤í…œ");
        errorMsg.setChatContent(message);
        errorMsg.setChatSendDate(new Date());
        errorMsg.setChatMsgTypeCode("CMTC001");
        errorMsg.setType(ChatMessageVO.MessageType.TALK);
        messagingTemplate.convertAndSendToUser(currentUser,"/queue/messages",errorMsg);
		
	}

	// íŒŒì¼ ì²¨ë¶€ ìƒì„¸ ì¶”ê°€
	@Override
	@Transactional
	public void insertAttachFileDetail(AttachmentFileDetailVO fileDetailVO) {
		chatMessageMapper.insertAttachFileDetail(fileDetailVO);		
	}

	// ë§ˆì§€ë§‰ ë©”ì„¸ì§€ ë²ˆí˜¸ ì¡°íšŒ
	@Override
	public Integer selectLastMessageNo(int chatChannelNo) {
		return chatMessageMapper.selectLastMessageNo(chatChannelNo);
	}

	// ë”ë³´ê¸° : í˜ì´ì§€ë„¤ì´ì…˜
	@Override
	public List<ChatMessageVO> getChatMessagesByChannelPaged(int chatChannelNo, int offset, int limit) {
		List<ChatMessageVO> messages = chatMessageMapper.selectChatMessagesByChannelPaged(chatChannelNo, offset, limit);
		
		Integer artGroupNo = chatChannelService.getArtGroupNoByChatChannelNo(chatChannelNo);
		
		for(ChatMessageVO msg : messages) {
			String userProfileImgPath = communityService.getComuProfileImgPath(msg.getUsername(), artGroupNo);
			
			// í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ nullë¡œ ì„¤ì •í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬
            if (userProfileImgPath != null && !userProfileImgPath.isEmpty() && !userProfileImgPath.contains("/upload/profile")) {
                userProfileImgPath = null;
            }
			msg.setUserProfileImgPath(userProfileImgPath);
		}
		return messages;
		
	}
	
}

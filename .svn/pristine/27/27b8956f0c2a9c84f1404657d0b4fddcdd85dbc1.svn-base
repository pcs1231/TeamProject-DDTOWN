<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>취소/환불 관리 - DDTOWN 관리자 시스템</title>
 	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/admin_refund.css">
 	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/admin_cancel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <%@ include file="../../../modules/headerPart.jsp" %>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../../modules/header.jsp" %>

        <div class="emp-body-wrapper">
            <%@ include file="../../modules/aside.jsp" %>
            <main class="emp-content">
                <div class="ea-section">
                    <div class="ea-section-header">
                        <h2>주문 취소/환불 관리</h2>
                    </div>
                    
                    <form id="searchForm" action="/admin/goods/cancelRefund/list" method="get" class="search-filter-controls" style="margin-bottom:20px;">
                        <input type="hidden" name="currentPage" id="currentPage" value="${pagingVO.currentPage}" />

                        <input type="text" id="searchKeyword" name="searchKeyword" class="ea-search-input" 
                               placeholder="회원ID, 주문번호, 상품명 검색" value="${param.searchKeyword}">
                        
                        <select id="statusCode" name="statusCode" class="ea-filter-select">
						    <option value="">전체 상태</option>
						    <option value="CSC001" ${param.statusCode eq 'CSC001' ? 'selected' : ''}>취소 요청 접수</option>
						    <option value="CSC002" ${param.statusCode eq 'CSC002' ? 'selected' : ''}>취소 처리중</option>
						    <option value="CSC003" ${param.statusCode eq 'CSC003' ? 'selected' : ''}>취소 완료</option>
						</select>
                        
                        <button type="submit" id="searchButton" class="ea-btn"><i class="fas fa-search"></i> 검색</button>
                        <button type="button" id="resetButton" class="ea-btn" onclick="resetSearchForm()">초기화</button>
                    </form>
                    
                    <table class="ea-table" id="cancelRefundTable">
                        <thead>
                            <tr>
                                <th>취소번호</th>
                                <th>유형</th>
                                <th>상태</th>
                                <th>주문번호</th>
                                <th>회원ID</th>
                                <th>상품명</th>

                                <th>요청일</th>
                                <th>처리일</th>
                            </tr>
                        </thead>
                        <tbody>
                            <c:choose>
                                <c:when test="${not empty pagingVO.dataList}">
                                    <c:forEach var="cancel" items="${pagingVO.dataList}">
                                        <tr>
                                            <td>
                                                <c:url var="detailLink" value="/admin/goods/cancelRefund/detail">
                                                    <c:param name="cancelNo" value="${cancel.cancelNo}"/>
                                                    <c:param name="currentPage" value="${pagingVO.currentPage}"/>
                                                    <c:param name="searchKeyword" value="${param.searchKeyword}"/>
                                                    <c:param name="statusCode" value="${param.statusCode}"/>
                                                </c:url>
                                                <a href="${detailLink}" class="btn btn-sm btn-info">${cancel.cancelNo}</a>
                                            </td>
                                            
                                            <td>
                                                <span class="refund-type-badge type-${cancel.cancelType}">
                                                    ${cancel.cancelTypeName}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="refund-status-badge status-${cancel.cancelStatCode}">
                                                    ${cancel.cancelStatName}
                                                </span>
                                            </td>
                                            
                                            <td>${cancel.orderNo}</td>
                                            <td>${cancel.memUsername}</td>
                                            <td>
											    ${cancel.goodsNm}
											    <c:if test="${cancel.otherGoodsCount != null && cancel.otherGoodsCount > 0}">
											        외 ${cancel.otherGoodsCount}건
											    </c:if>
											</td>
                                            
                                            <td><fmt:formatDate value="${cancel.cancelReqDate}" pattern="yyyy-MM-dd HH:mm"/></td>
                                            <td><fmt:formatDate value="${cancel.cancelResDate}" pattern="yyyy-MM-dd HH:mm"/></td>
                                        </tr>
                                    </c:forEach>
                                </c:when>
                                <c:otherwise>
                                    <tr>
                                        <td colspan="9" class="text-center">조회된 취소/환불 내역이 없습니다.</td>
                                    </tr>
                                </c:otherwise>
                            </c:choose>
                        </tbody>
                    </table>

                    <div class="d-flex justify-content-center ea-pagination" id="paginationArea">
                        ${pagingVO.pagingHTML}
                    </div>

                </div>
            </main>
        </div>
    </div>
<%@ include file="../../../modules/footerPart.jsp" %>
<%@ include file="../../../modules/sidebar.jsp" %>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById("searchForm");
        const currentPageInput = document.getElementById("currentPage");
        const paginationArea = document.getElementById("paginationArea");

        if (paginationArea) {
            // 페이지네이션 링크 클릭 시
            paginationArea.addEventListener("click", function(e) {
                e.preventDefault(); // 기본 링크 동작 방지

                const clickedElement = e.target.closest(".page-link"); // 가장 가까운 .page-link 부모 찾기
                if (clickedElement && clickedElement.dataset.page) { // data-page 속성이 있는지 확인
                    currentPageInput.value = clickedElement.dataset.page; // hidden input 값 업데이트
                    searchForm.submit(); // 폼 제출
                }
            });
        }
    });

    // 검색 초기화 함수 (전역 스코프에 정의하여 onclick에서 호출 가능하게 함)
    function resetSearchForm() {
        document.getElementById('searchKeyword').value = ''; // 검색어 초기화
        document.getElementById('statusCode').value = '';     // 상태 필터 초기화
        document.getElementById('currentPage').value = '1';   // 현재 페이지 1로 초기화 (필수)
        document.getElementById('searchForm').submit();       // 폼 제출
    }
</script>
</body>
</html>
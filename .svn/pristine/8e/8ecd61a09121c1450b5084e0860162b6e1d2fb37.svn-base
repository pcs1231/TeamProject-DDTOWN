<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="kr.or.ddit.ddtown.mapper.concert.schedule.IConcertScheduleMapper">
 
 	<select id="selectConcertCount" parameterType="kr.or.ddit.vo.PaginationInfoVO" resultType="int">
        SELECT COUNT(*)
        FROM CONCERT c
        LEFT JOIN ARTIST_GROUP ag ON c.art_group_no = ag.art_group_no LEFT JOIN CONCERT_HALL ch ON c.concert_hall_no = ch.concert_hall_no <where>
            <if test="searchWord != null and searchWord != ''">
                <choose>
                    <when test="searchType == 'concertNm'">
                        AND c.concert_nm LIKE '%' || #{searchWord} || '%'
                    </when>
                    <when test="searchType == 'artistName'">
                        AND ag.art_group_nm LIKE '%' || #{searchWord} || '%'
                    </when>
                    <when test="searchType == 'hallName'">
                        AND ch.concert_hall_nm LIKE '%' || #{searchWord} || '%'
                    </when>
                    <otherwise>
                        AND (
                            c.concert_nm LIKE '%' || #{searchWord} || '%'
                            OR ag.art_group_nm LIKE '%' || #{searchWord} || '%'
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>
 
 	<select id="selectConcertList" parameterType="kr.or.ddit.vo.PaginationInfoVO" resultType="kr.or.ddit.vo.concert.ConcertVO">
        SELECT b.*
        FROM (
            SELECT a.*, ROWNUM AS rnum
            FROM (
                SELECT
                    c.concert_no, c.art_group_no, c.concert_hall_no, c.concert_cat_code,
                    c.concert_reservation_stat_code, c.concert_stat_code, c.concert_img,
                    c.concert_online_yn, c.concert_nm, c.concert_date, c.concert_address,
                    c.concert_start_date, c.concert_end_date, c.concert_running_time,
                    c.concert_guide, c.file_group_no,
                    ag.art_group_nm AS artGroupName,
                    ch.concert_hall_nm AS concertHallName
                FROM CONCERT c
                LEFT JOIN ARTIST_GROUP ag ON c.art_group_no = ag.art_group_no
                LEFT JOIN CONCERT_HALL ch ON c.concert_hall_no = ch.concert_hall_no
                <where>
                    <if test="searchWord != null and searchWord != ''">
                        <choose>
                            <when test="searchType == 'concertNm'"> AND c.concert_nm LIKE '%' || #{searchWord} || '%'
                            </when>
                            <when test="searchType == 'artistName'">
                                AND ag.art_group_nm LIKE '%' || #{searchWord} || '%'
                            </when>
                            <when test="searchType == 'hallName'">
                                AND ch.concert_hall_nm LIKE '%' || #{searchWord} || '%'
                            </when>
                            <otherwise> AND (
                                    c.concert_nm LIKE '%' || #{searchWord} || '%'
                                    OR ag.art_group_nm LIKE '%' || #{searchWord} || '%'
                                )
                            </otherwise>
                        </choose>
                    </if>
                </where>
                ORDER BY c.concert_no DESC ) a
        ) b
        <![CDATA[
        WHERE rnum >= #{startRow} AND rnum <= #{endRow}
        ]]>
    </select>
    
    <insert id="insertSchedule" parameterType="kr.or.ddit.vo.concert.ConcertVO">
    	<selectKey keyProperty="concertNo" resultType="int" order="BEFORE">
    		SELECT CONCERT_SEQ.NEXTVAL FROM DUAL
    	</selectKey>
    	INSERT INTO CONCERT(
    		concert_no, art_group_no, concert_hall_no, concert_cat_code, concert_reservation_stat_code, concert_stat_code,
    		concert_img, concert_online_yn, concert_nm, concert_date, concert_address, concert_start_date, concert_end_date,
    		concert_running_time, concert_guide, file_group_no
    	) VALUES (
    		#{concertNo},
            #{artGroupNo, jdbcType=NUMERIC},
            #{concertHallNo, jdbcType=NUMERIC},
            #{concertCatCode, jdbcType=VARCHAR},
            #{concertReservationStatCode, jdbcType=VARCHAR},
            #{concertStatCode, jdbcType=VARCHAR},
            #{concertImg, jdbcType=VARCHAR},
            #{concertOnlineYn, jdbcType=CHAR},
            #{concertNm, jdbcType=VARCHAR},
            #{concertDate, jdbcType=DATE},
            #{concertAddress, jdbcType=VARCHAR},
            #{concertStartDate, jdbcType=TIMESTAMP},
            #{concertEndDate, jdbcType=TIMESTAMP},
            #{concertRunningTime, jdbcType=NUMERIC},
            #{concertGuide, jdbcType=CLOB},
            #{fileGroupNo, jdbcType=NUMERIC}
    	)
    </insert>
    
    <select id="selectSchedule" parameterType="int" resultType="kr.or.ddit.vo.concert.ConcertVO">
    	SELECT 
    		c.concert_no, c.art_group_no, c.concert_hall_no, c.concert_cat_code,
            c.concert_reservation_stat_code, c.concert_stat_code, c.concert_img,
            c.concert_online_yn, c.concert_nm, c.concert_date, c.concert_address,
            c.concert_start_date, c.concert_end_date, c.concert_running_time, c.concert_guide,
            c.file_group_no, ag.art_group_nm AS artGroupName,
            ch.concert_hall_nm AS concertHallName
        FROM CONCERT c
        LEFT JOIN ARTIST_GROUP ag ON c.art_group_no = ag.art_group_no
        LEFT JOIN CONCERT_HALL ch ON c.concert_hall_no = ch.concert_hall_no
        WHERE c.concert_no = #{concertNo}
    </select>
 	
 	<update id="updateSchedule" parameterType="kr.or.ddit.vo.concert.ConcertVO">
 		UPDATE CONCERT
 		SET
 			art_group_no = #{artGroupNo, jdbcType=NUMERIC},
            concert_hall_no = #{concertHallNo, jdbcType=NUMERIC},
            concert_cat_code = #{concertCatCode, jdbcType=VARCHAR},
            concert_reservation_stat_code = #{concertReservationStatCode, jdbcType=VARCHAR},
            concert_stat_code = #{concertStatCode, jdbcType=VARCHAR},
            concert_img = #{concertImg, jdbcType=VARCHAR},
            concert_online_yn = #{concertOnlineYn, jdbcType=CHAR},
            concert_nm = #{concertNm, jdbcType=VARCHAR},
            concert_date = #{concertDate, jdbcType=DATE},
            concert_address = #{concertAddress, jdbcType=VARCHAR},
            concert_start_date = #{concertStartDate, jdbcType=TIMESTAMP},
            concert_end_date = #{concertEndDate, jdbcType=TIMESTAMP},
            concert_running_time = #{concertRunningTime, jdbcType=NUMERIC},
            concert_guide = #{concertGuide, jdbcType=CLOB},
            file_group_no = #{fileGroupNo, jdbcType=NUMERIC}
        WHERE concert_no = #{concertNo}
 	</update>
 	
 	<delete id="deleteSchedule" parameterType="int">
        DELETE FROM CONCERT 
        WHERE concert_no = #{concertNo}
    </delete>
 </mapper>
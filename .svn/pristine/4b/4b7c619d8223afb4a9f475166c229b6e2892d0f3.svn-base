<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘서트 좌석 관리 - DDTOWN 직원 포털</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <%@ include file="../../modules/headerPart.jsp" %>
    <style>
        .seat-header-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
        .seat-header-bar .seat-title { font-size: 1.5em; font-weight: 700; color: #234aad; }
        .seat-header-bar .seat-add-btn { background: #1976d2; color: #fff; border: none; border-radius: 5px; padding: 8px 22px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .seat-header-bar .seat-add-btn:hover { background: #1451a3; }
        .concert-select-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; }
        .concert-select-bar select { padding: 7px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; min-width: 200px; }
        .seat-table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 18px; }
        .seat-table th, .seat-table td { border: 1px solid #e0e0e0; padding: 10px; text-align: center; }
        .seat-table th { background: #f5f5f5; font-weight: 600; }
        .seat-table td .btn { padding: 5px 14px; border-radius: 5px; font-size: 0.98em; cursor: pointer; border: none; margin: 0 2px; }
        .seat-table td .btn-edit { background: #1976d2; color: #fff; }
        .seat-table td .btn-delete { background: #e74c3c; color: #fff; }
        .seat-table td .btn-edit:hover { opacity: 0.85; }
        .seat-table td .btn-delete:hover { background: #c0392b; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; overflow: auto; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 30px 30px 20px 30px; border-radius: 10px; min-width: 340px; max-width: 95vw; box-shadow: 0 4px 24px rgba(0,0,0,0.18); position: relative; }
        .modal-content h2 { margin-top: 0; }
        .close { position: absolute; right: 18px; top: 12px; font-size: 2em; color: #888; cursor: pointer; }
        .modal-content label { font-weight: 500; }
        .modal-content input, .modal-content select { width: 100%; margin-top: 4px; margin-bottom: 8px; padding: 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .modal-content .modal-btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
        .modal-content .modal-btn-row button { padding: 8px 22px; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        .modal-content .modal-btn-row .cancel-btn { background: #888; color: #fff; }
        .modal-content .modal-btn-row .save-btn { background: #1976d2; color: #fff; }
        .seat-map-container { margin-top: 30px; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .seat-map-title { font-size: 1.2em; font-weight: 600; color: #234aad; margin-bottom: 15px; }
        .stage-area { text-align: center; margin-bottom: 20px; }
        .stage { display: inline-block; background: #444; color: #fff; padding: 8px 40px; border-radius: 6px; font-weight: 1200; letter-spacing: 2px; }
        .seat-map { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .seat-section { width: 100%; max-width: 800px; margin-bottom: 30px; background: #f8f9fa; border-radius: 8px; padding: 18px 0 10px 0; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
        .seat-section h4 { font-size: 1.1em; color: #234aad; margin-bottom: 12px; text-align: left; padding-left: 18px; }
        .seat-rows { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; padding-left: 150px; }
        .seat-row { display: flex; flex-direction: row; gap: 8px; align-items: center; }
        .seat-label { width: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.95em; color: #888; margin-right: 6px; margin-bottom: 0; }
        .seat { width: 32px; height: 32px; border-radius: 6px; border: 1.5px solid #bbb; background: #fff; color: #333; font-weight: 600; font-size: 0.9em; /* Slightly smaller font for two digits */ display: flex; align-items: center; justify-content: center; cursor: pointer; transition: box-shadow 0.15s; }
        .seat.available { background: #fff; }
        .seat.occupied { background: #e74c3c; color: #fff; cursor: not-allowed; }
        .seat-row + .seat-row { margin-top: 2px; }
        .seat-legend { display: flex; justify-content: flex-end; gap: 20px; margin-top: 20px; margin-right: 18px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .seat-sample { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #bbb; }
        .seat-sample.available { background: #fff; }
        .seat-sample.occupied { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>
        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
            <main class="emp-content" style="position:relative; min-height:600px;">
                <div class="seat-header-bar">
                    <div class="seat-title">콘서트 좌석 관리</div>
                    <button class="seat-add-btn" id="addSeatBtn"><i class="fas fa-plus"></i> 새 등급/가격 추가</button>
                </div>
                <div class="concert-select-bar">
                    <select id="concertSelect">
                    	<c:choose>
                    		<c:when test="${empty concertList}">
		                        <option value="">진행중인 콘서트가 없습니다.</option>
                    		</c:when>
                    		<c:otherwise>
                    			<c:forEach items="${concertList}" var="concert">
                    				<option value="${concert.concertNo}">${concert.concertNm}</option>
                    			</c:forEach>
                    		</c:otherwise>
                    	</c:choose>
                    </select>
                </div>
                <table class="seat-table" id="seatTable">
                    <thead>
                        <tr>
                            <th>좌석 등급</th>
                            <th>가격</th>
                            <th>좌석 수</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="seatTableBody">

                    </tbody>
                </table>
                <div class="seat-map-container" id="seatMapContainer">
                    <div class="seat-map-title">좌석 현황</div>
                    <div class="stage-area">
                        <div class="stage">STAGE</div>
                    </div>
                    <div class="seat-map-container" style="position: relative; height: 400px;">
					    <object data="${pageContext.request.contextPath}/resources/concertHall.svg" type="image/svg+xml" id="hallSvg" style="transform : scale(0.5); position: absolute; top:-168px; left:-70px;"></object>
					</div>
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="seat-sample available"></div>
                            <span>예매 가능</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat-sample occupied"></div>
                            <span>예매 완료</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="seatModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" id="closeSeatModal">&times;</span>
            <h2 id="seatModalTitle">새 좌석 등급/가격 추가</h2>
            <form id="seatForm">
                <label>좌석 등급 <span style="color:red;">*</span><br>
                    <input type="text" id="seatGrade" required>
                </label>
                <label>가격 <span style="color:red;">*</span><br>
                    <input type="number" id="seatPrice" required>
                </label>
                <label>좌석 수 <span style="color:red;">*</span><br>
                    <input type="number" id="seatCount" required>
                </label>
                <div class="modal-btn-row">
                    <button type="button" class="cancel-btn" id="seatCancelBtn">취소</button>
                    <button type="submit" class="save-btn" id="seatSaveBtn">저장</button>
                </div>
            </form>
        </div>
    </div>

	<%@ include file="../../modules/footerPart.jsp" %>
	<%@ include file="../../modules/sidebar.jsp" %>
<script>
	$(function(){
		const hallSvg = document.getElementById("hallSvg");
		let seat;
		hallSvg.onload = function(){
			const svgDocument = this.contentDocument;
			let svg = svgDocument.querySelector("svg");
			seat = $("rect",svg);
		}

		let concertSelect = $("#concertSelect"); // 콘서트 정보 불러오기
		let selectedConcert = concertSelect.val();
		// 첫 로딩 때 선택된 콘서트 불러오기
		if(selectedConcert != ""){
			getSeatInfo(selectedConcert);
		}

		concertSelect.on("change",function(){
			let concertNo = $(this).val();
			getSeatInfo(concertNo);
		})

		function getSeatInfo(concertNo){
			$.ajax({
				url : `/api/emp/concert/getseatinfo?concertNo=\${concertNo}`,
				type : "get",
				success : function(res){
					console.log(res);
					let seatCount = {"SGC001":0, "SGC002":0, "SGC003":0, "SGC004":0};
					let {ticketList, seatGradeList} = res;
					for(let ticket of ticketList){
						console.log(ticket);
						let {memUsername, seatNo,seatGradeCode} = ticket;
						seatCount[seatGradeCode]++;
						if(memUsername != null && memUsername != ""){
							seat.each((i,v)=>{
								if($(v).attr("class") == seatNo){
									$(v).css("fill","red");
									return;
								}
							})
						}
					}
					console.log(seatCount);
					let seatHtml = ``;
					for(let seatGrade of seatGradeList){
						let {commCodeDetNo,description} = seatGrade
						seatHtml += `
							<tr>
								<td>\${description}</td>
	                            <td>가격</td>
	                            <td>\${seatCount[commCodeDetNo]}</td>
	                            <td>
	                            	<button>수정</button>
	                            </td>
                            </tr>
						`;
					}

					$("#seatTableBody").html(seatHtml);
				},
				error : function(err){
					console.log(err);
				}
			})
		}

	});
</script>
</body>
</html>
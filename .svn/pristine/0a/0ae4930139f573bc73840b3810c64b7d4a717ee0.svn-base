package kr.or.ddit.ddtown.service.goods.cancel;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.ddtown.mapper.admin.goods.order.IAdminOrdersMapper;
import kr.or.ddit.ddtown.mapper.goods.IGoodsMapper;
import kr.or.ddit.ddtown.mapper.orders.ICancelMapper;
import kr.or.ddit.ddtown.mapper.orders.IPaymentMapper;
import kr.or.ddit.vo.PaginationInfoVO;
import kr.or.ddit.vo.order.OrderCancelVO;
import kr.or.ddit.vo.order.OrderDetailVO;
import kr.or.ddit.vo.order.OrdersVO;
import kr.or.ddit.vo.order.PaymentVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class CancelServiceImpl implements ICancelService {
	
	@Autowired
	private IAdminOrdersMapper adminOrdersMapper; //ì£¼ë¬¸ ìƒíƒœ ì—…ëƒìš©
	
	@Autowired
	private IGoodsMapper goodsMapper; //ì¬ê³  ë³µêµ¬ìš©
	
	@Autowired
	private ICancelMapper cancelMapper; //Cancel í…Œì´ë¸” ê¸°ë¡ìš©
	
	@Autowired
	private IPaymentMapper paymentMapper; //ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ìš©
	
	@Override
    @Transactional
    public ServiceResult processAdminOrderCancel(OrdersVO order, String empUsername) {
        log.info("### CancelServiceImpl - processAdminOrderCancel í˜¸ì¶œ: orderId={}, empUsername={}", order.getOrderNo(), empUsername);

        try {
            // 1. ORDERS í…Œì´ë¸”ì˜ ì£¼ë¬¸ ìƒíƒœë¥¼ 'ì·¨ì†Œ ì™„ë£Œ'ë¡œ ë³€ê²½ (OSC008)
            OrdersVO updateOrderVO = new OrdersVO();
            updateOrderVO.setOrderNo(order.getOrderNo());
            updateOrderVO.setOrderStatCode("OSC008"); // ê³µí†µ ì½”ë“œ 'ì·¨ì†Œ ì™„ë£Œ'

            int statusUpdateCount = adminOrdersMapper.updateOrder(updateOrderVO);
            if (statusUpdateCount <= 0) {
                log.error("ì£¼ë¬¸(orderId={}) ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨.", order.getOrderNo());
                throw new RuntimeException("ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
            }
            log.info("ì£¼ë¬¸(orderId={}) ìƒíƒœê°€ 'ì·¨ì†Œ ì™„ë£Œ(CSC003)'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", order.getOrderNo());

            // 2. ì£¼ë¬¸ ìƒì„¸ ì •ë³´ì˜ ì¬ê³  ë³µêµ¬ ë° CANCEL í…Œì´ë¸” ê¸°ë¡ 
            if (order.getOrderDetailList() != null && !order.getOrderDetailList().isEmpty()) {
                for (OrderDetailVO detail : order.getOrderDetailList()) {
                    // ê° ì£¼ë¬¸ ìƒì„¸ í•­ëª©ì— ëŒ€í•´ ì¬ê³  ë³µêµ¬
                    log.info("### CancelServiceImpl - ì¬ê³  ë³µêµ¬ ì‹œë„: orderDetNo={}, goodsNo={}, goodsOptNo={}, orderDetQty={}",
                             detail.getOrderDetNo(), detail.getGoodsNo(), detail.getGoodsOptNo(), detail.getOrderDetQty());

                    int updatedRows = goodsMapper.increaseGoodsStock(
                        detail.getGoodsNo(),
                        detail.getGoodsOptNo(),
                        detail.getOrderDetQty()
                    );

                    log.info("### CancelServiceImpl - increaseGoodsStock í˜¸ì¶œ (ì¬ê³  ë³µêµ¬): ìƒí’ˆë²ˆí˜¸={}, ì˜µì…˜ë²ˆí˜¸={}, ìˆ˜ëŸ‰={}, ê²°ê³¼={}",
                             detail.getGoodsNo(), detail.getGoodsOptNo(), detail.getOrderDetQty(), updatedRows);

                    if (updatedRows == 0) {
                        log.error("ìƒí’ˆ(goodsNo={}, goodsOptNo={}) ì¬ê³  ë³µêµ¬ ì‹¤íŒ¨. ì£¼ë¬¸ ìˆ˜ëŸ‰={}",
                                  detail.getGoodsNo(), detail.getGoodsOptNo(), detail.getOrderDetQty());
                        throw new RuntimeException("ì¬ê³  ë³µêµ¬ ì‹¤íŒ¨");
                    }

                    // ê° ì£¼ë¬¸ ìƒì„¸ í•­ëª©ì— ëŒ€í•´ CANCEL í…Œì´ë¸”ì— ì·¨ì†Œ ê¸°ë¡ INSERT
                    OrderCancelVO cancelVO = new OrderCancelVO();
                    cancelVO.setOrderNo(order.getOrderNo());
                    cancelVO.setGoodsNo(detail.getGoodsNo()); 

                    cancelVO.setCancelType("CT003"); // ê´€ë¦¬ì ì£¼ë¬¸ ì·¨ì†Œ
                    cancelVO.setCancelReasonCode("CRC001"); // ì˜ˆì‹œ: ê³ ê° ë³€ì‹¬
                    cancelVO.setCancelStatCode("CSC003"); // ì·¨ì†Œ ì™„ë£Œ

                    cancelVO.setEmpUsername(empUsername);
                    cancelVO.setMemUsername(order.getCustomerId());
                    cancelVO.setCancelReasonDetail("ê´€ë¦¬ì ì§ì ‘ ì „ì²´ ì·¨ì†Œ (ê²°ì œ API ë¯¸ì—°ë™ í…ŒìŠ¤íŠ¸)");

                    // í˜„ì¬ ë£¨í”„ì˜ ìƒí’ˆì— ëŒ€í•œ ì·¨ì†Œ ìˆ˜ëŸ‰
                    cancelVO.setCancelItemQty(detail.getOrderDetQty());

                    double pricePerItem = (double)order.getOrderTotalPrice() / order.getOrderDetailList().stream().mapToInt(OrderDetailVO::getOrderDetQty).sum();
                    int cancelPrice = (int) (detail.getOrderDetQty() * pricePerItem);

                    cancelVO.setCancelReqPrice(cancelPrice); // ê° ìƒí’ˆë³„ ì·¨ì†Œ ìš”ì²­ ê¸ˆì•¡
                    cancelVO.setCancelResPrice(cancelPrice); // ê° ìƒí’ˆë³„ ìµœì¢… ì²˜ë¦¬ ê¸ˆì•¡

                    cancelVO.setCancelAccountNo(null);
                    cancelVO.setCancelAccountHol(null);

                    int cancelInsertCount = cancelMapper.insertCancel(cancelVO);
                    if (cancelInsertCount <= 0) {
                        log.error("CANCEL í…Œì´ë¸”ì— ìƒí’ˆ(goodsNo={}) ì·¨ì†Œ ê¸°ë¡ INSERT ì‹¤íŒ¨. orderId={}", detail.getGoodsNo(), order.getOrderNo());
                        throw new RuntimeException("ìƒí’ˆ ì·¨ì†Œ ê¸°ë¡ ìƒì„± ì‹¤íŒ¨");
                    }
                    log.info("CANCEL í…Œì´ë¸”ì— ì£¼ë¬¸(orderId={}) ìƒí’ˆ(goodsNo={}) ì·¨ì†Œ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", order.getOrderNo(), detail.getGoodsNo());
                }
            } else {
                log.warn("### CancelServiceImpl - ì£¼ë¬¸(orderNo={}) ìƒì„¸ ì •ë³´ê°€ ì—†ì–´ ì¬ê³  ë³µêµ¬ ë° ì·¨ì†Œ ê¸°ë¡ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.", order.getOrderNo());
                // ì£¼ë¬¸ ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ê²½ìš°, ì¶”ê°€ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬ ë˜ëŠ” ë¡œê¹… í•„ìš”
                throw new RuntimeException("ì£¼ë¬¸ ìƒì„¸ ì •ë³´ ì—†ìŒ. ì¬ê³  ë³µêµ¬ ë° ì·¨ì†Œ ê¸°ë¡ ë¶ˆê°€.");
            }

         // TODO: ê²°ì œ ì·¨ì†Œ ì—°ë™ ë¡œì§ êµ¬í˜„ í•„ìš” (PGì‚¬ API í˜¸ì¶œ ë“±) - ì „ì²´ ì£¼ë¬¸ì— ëŒ€í•´ í•œ ë²ˆë§Œ!
            // ğŸš¨ğŸš¨ğŸš¨ ì—¬ê¸°ì— ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€ ğŸš¨ğŸš¨ğŸš¨
            PaymentVO paymentToUpdate = new PaymentVO();
            paymentToUpdate.setOrderNo(order.getOrderNo());
            paymentToUpdate.setPaymentStatCode("PSC003"); // ê²°ì œ ì·¨ì†Œ ì½”ë“œ (ì œê³µí•´ì£¼ì‹  PSC003)

            // adminOrdersMapperë¥¼ ì‚¬ìš©í•˜ì—¬ PAYMENT í…Œì´ë¸” ì—…ë°ì´íŠ¸
            // ì´ ë©”ì„œë“œëŠ” IAdminOrdersMapperì— 'updatePaymentStatusForOrder' ë“±ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            int paymentUpdateResult = paymentMapper.updatePaymentStatus(paymentToUpdate); // ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œ
            // ë˜ëŠ” IPaymentMapperë¥¼ ì‚¬ìš©í•œë‹¤ë©´: paymentMapper.updatePaymentStatus(paymentToUpdate);

            if (paymentUpdateResult <= 0) {
                log.error("ê²°ì œ(orderNo={}) ìƒíƒœë¥¼ 'ì·¨ì†Œ(PSC003)'ë¡œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨.", order.getOrderNo());
                throw new RuntimeException("ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
            }
            log.info("ê²°ì œ(orderNo={}) ìƒíƒœê°€ 'ì·¨ì†Œ(PSC003)'ë¡œ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", order.getOrderNo());

            // PGì‚¬ API í˜¸ì¶œ ë¡œì§ì€ ì—¬ê¸°ì— ì¶”ê°€ (DB ìƒíƒœ ë³€ê²½ í›„ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì¼ë°˜ì )
            // ì˜ˆ: pgService.callCancelApi(order.getOrderNo(), cancelVO.getCancelReqPrice());

            return ServiceResult.OK;

        } catch (Exception e) {
            log.error("CancelServiceImplì—ì„œ ì£¼ë¬¸ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
            throw new RuntimeException("ì£¼ë¬¸ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
        }
    }

    /**
     * ê²€ìƒ‰ ë° í•„í„°ë§ ì¡°ê±´ì— ë”°ë¼ ì·¨ì†Œ/í™˜ë¶ˆ ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
     * ì´ ë©”ì„œë“œëŠ” ì‚¬ìš©ìê°€ ê²€ìƒ‰ ë˜ëŠ” í•„í„°ë§ ì¡°ê±´ì„ ì…ë ¥í–ˆì„ ë•Œ AJAX ìš”ì²­ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
     * @param filterParams ê²€ìƒ‰ í‚¤ì›Œë“œ(searchKeyword)ì™€ ìƒíƒœ ì½”ë“œ(statusCode)ë¥¼ í¬í•¨í•˜ëŠ” Map
     * @return í•„í„°ë§ëœ OrderCancelVO ëª©ë¡
     */
    @Override
    public int getTotalCancelRefundCount(PaginationInfoVO<OrderCancelVO> pagingVO) {
        log.info("getTotalCancelRefundCount() í˜¸ì¶œ: í•„í„°ë§ ì¡°ê±´ - {}", pagingVO.getSearchMap());
        return cancelMapper.selectTotalCancelRefundCount(pagingVO);
    }

	@Override
	public OrderCancelVO selectCancelDetail(int cancelNo) {
		return cancelMapper.selectCancelDetail(cancelNo); // ë§¤í¼ í˜¸ì¶œ
	}

	@Override
	public int updateCancelRefund(OrderCancelVO orderCancelVO) {
        log.info("ì·¨ì†Œ/í™˜ë¶ˆ ë°ì´í„° ì—…ë°ì´íŠ¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ: {}", orderCancelVO);
        return cancelMapper.updateCancelRefund(orderCancelVO);
	}

    @Override
    public List<OrderCancelVO> getFilteredCancelRefunds(PaginationInfoVO<OrderCancelVO> pagingVO) {
        log.info("getFilteredCancelRefunds() í˜¸ì¶œ: í•„í„°ë§ ì¡°ê±´ - {}", pagingVO.getSearchMap());
        // PaginationInfoVO ê°ì²´ì—ëŠ” ì´ë¯¸ startRowì™€ endRowê°€ ê³„ì‚°ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, MapperëŠ” ì´ ê°’ë“¤ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
        return cancelMapper.selectFilteredCancelRefunds(pagingVO);
    }
}

<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN 전자결재 - 결재 문서 리스트</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/approval_draft_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
</head>
<body>
	<div class="emp-container">
		<%@ include file="../modules/header.jsp" %>
		
		<div class="emp-body-wrapper">
			<%@ include file="../modules/aside.jsp" %>
			
			<main class="emp-content">
			
				<section class="ea-section">
					
					<div class="ea-section-header">
						<h2>결재 문서함</h2>
					    		
						<div class="approval-list-search-row ea-header-actions" style="display:flex; gap:8px; justify-content: flex-end; align-items: center; margin-bottom:18px;">
							<form id="searchForm">
								<input type="hidden" name="currentPage" id="currentPage" value="${pagingVO.currentPage}">
								<select id="searchType" name="searchType" class="approval-search-input" style="height:40px; border-radius:5px; border:1px solid #ccc; font-size:1em;">
									<option value="all">전체 상태</option> 
									<option value="ESC001" <c:if test="${pagingVO.searchType eq 'ESC001' }">selected</c:if>>대기</option>
									<option value="ESC002" <c:if test="${pagingVO.searchType eq 'ESC002' }">selected</c:if>>진행</option>
									<option value="ESC003" <c:if test="${pagingVO.searchType eq 'ESC003' }">selected</c:if>>승인</option>
									<option value="ESC004" <c:if test="${pagingVO.searchType eq 'ESC004' }">selected</c:if>>반려</option>
									<option value="ESC005" <c:if test="${pagingVO.searchType eq 'ESC005' }">selected</c:if>>회수</option>
								</select>
								<input type="text" id="searchWord" name="searchWord" value="${pagingVO.searchWord}" class="approval-search-input" placeholder="검색 (제목, 작성자...)" style="width:220px; height:40px; border-radius:5px; border:1px solid #ccc; padding:0 12px; font-size:1em;">
								<button type="submit" id="approval-search-btn" class="ea-btn primary" style="height:36px; min-width:70px;"><i class="fas fa-search"></i> 검색</button>
							</form>
						</div>
					</div>
				
					<div class="approval-list-table-wrap">
						<table class="approval-list-table">
							<thead>
								<tr>
									<th>번호</th>
									<th>제목</th>
									<th>기안자</th>
									<th>기안일</th>
									<th>결재상태</th>
									<th>PDF</th>
								</tr>
							</thead>
							<tbody id="approval-list-tbody">
								<c:choose>
									<c:when test="${pagingVO.dataList ne null }">
										<c:forEach items="${pagingVO.dataList}" var="approval">
											<tr>
												<td>${approval.edmsNo}</td>
												<td style="text-align: left"><a href="" style="color:#007bff; text-decoration: none;" data-edms-stat-code="${approval.edmsStatCode}" data-edms-no="${approval.edmsNo}"> ${approval.edmsTitle}</a></td>
												<td>${approval.empName}</td>
												<td><fmt:formatDate value="${approval.edmsReqDate}" pattern="yyyy/MM/dd" type="date" /> </td>
												<td>
												<c:if test="${approval.edmsStatCode eq 'ESC001'}">
													<span style="background:#818681;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">대기</span>
												</c:if>
												<c:if test="${approval.edmsStatCode eq 'ESC002'}">
													<span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">진행</span>
												</c:if>
												<c:if test="${approval.edmsStatCode eq 'ESC003'}">
													<span style="background:#007bff;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">승인</span>
												</c:if>
												<c:if test="${approval.edmsStatCode eq 'ESC004'}">
													<span style="background:#b71c1c;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">반려</span>
												</c:if>
												<c:if test="${approval.edmsStatCode eq 'ESC005'}">
													<span style="background:#ec841a;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">회수</span>
												</c:if>
												</td>
												<td><button class="approval-btn" onclick="window.open('pdf_viewer.html?edmsNo=${approval.edmsNo}','_blank')"><i class="fas fa-file-pdf"></i> PDF</button></td>
											</tr>
										</c:forEach>
									</c:when>
									<c:otherwise>
										<tr><td colspan="6" style="text-align:center;">검색 결과가 없습니다.</td></tr>
									</c:otherwise>
								</c:choose>
							</tbody>
						</table>
						<div class="approval-pagination" id="pagingArea">
							${pagingVO.pagingHTML }
						</div>
					</div>
				</section>
			</main>
		</div>
	</div>
	<footer class="emp-footer">
		<p>&copy; 2025 DDTOWN Entertainment. All rights reserved. (직원 전용)</p>
	</footer>
</body>
<%@ include file="../../modules/footerPart.jsp" %>

<%@ include file="../../modules/sidebar.jsp" %>
<script>
$(function(){
	const currentPageEl =  $("#currentPage"); // 현재 페이지 번호
	const searchTypeEl = $("#searchType"); // 정렬 실렉트박스
	const searchWordEl = $("#searchWord"); // 검색어
	
	// 검색결과 유지한채 상세정보 이동
	let approvalListTbody = $("#approval-list-tbody");
	approvalListTbody.on("click","a",function(e){
		e.preventDefault();
		const edmsNo = $(this).data("edmsNo");
		const edmsStatCode = $(this).data("edmsStatCode");
		let searchWord = "${pagingVO.searchWord}";
		let searchType = "${pagingVO.searchType}";
		let currentPage = "${pagingVO.currentPage}";
		
		sessionStorage.setItem("currentPage",currentPage);
		sessionStorage.setItem("searchWord",searchWord);
		sessionStorage.setItem("searchType",searchType);
		if(edmsStatCode == 'ESC005'){
			location.href="${pageContext.request.contextPath}/emp/edms/update?edmsNo="+edmsNo;
		}else{
			location.href="${pageContext.request.contextPath}/emp/edms/detail?edmsNo="+edmsNo;
		}
	})
	
	// 페이지 a누르면 이동
	const approvalPagination = $("#approval-pagination");
	const searchForm = $("#searchForm");
	
	approvalPagination.on("click","a",function(){
		const page = $(this).data("page");
		$("#currentPage").val(page);
		searchForm.submit();
	})
	
	// 상태값 정렬
	searchTypeEl.on("change",function(){
		console.log("asdf")
		let currentPage = currentPageEl.val();
		let searchType = $(this).val();
		let searchWord = searchWordEl.val();
		
		displayList(currentPage,searchType, searchWord)
	})
	
	
	function displayList(currentPage='1',searchType='all',searchWord=''){
		let url = '${pageContext.request.contextPath}/api/emp/edms/getApprovalList?currentPage='+ currentPage +'&searchType='+searchType+'&searchWord='+searchWord;
		
		$.ajax({
			url : url,
			type : "get",
			success : function(res){
				console.log(res);
				let {currentPage, dataList:edmsList, searchType, searchWord } = res;
				currentPageEl.val(currentPage);
				let html = ``;
				if(edmsList != null && edmsList.length > 0){
					for(let edms of edmsList){
						let {rnum,edmsNo, empName,edmsTitle,edmsStatCode,edmsReqDate} = edms;
						const formattedReqDate = `\${new Date(edmsReqDate).getFullYear()}/\${String(new Date(edmsReqDate).getMonth() + 1).padStart(2, "0")}/\${String(new Date(edmsReqDate).getDate()).padStart(2, "0")}`;
						let stat = edmsStatCode == 'ESC001' ? '<span style="background:#818681;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">대기</span>' 
								: edmsStatCode == 'ESC002' ? '<span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">진행</span>'
								: edmsStatCode == 'ESC003' ? '<span style="background:#007bff;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">승인</span>' 
								: edmsStatCode == 'ESC004' ? '<span style="background:#b71c1c;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">반려</span>' 
								: '<span style="background:#ec841a;color:#fff;padding:4px 12px;border-radius:16px;font-size:0.97em;">회수</span>';
						html += `
                           	<tr>
                            	<td>\${edmsNo}</td>
                                <td style="text-align: left"><a href="" style="color:#007bff; text-decoration: none;" data-edms-no="\${edmsNo}"> \${edmsTitle}</a></td>
                                <td>\${empName}</td>
                                <td>\${formattedReqDate}</td>
                                <td>\${stat}</td>
                                <td><button class="approval-btn" onclick="window.open('pdf_viewer.html?edmsNo=\${edmsNo}','_blank')"><i class="fas fa-file-pdf"></i> PDF</button></td>
                             </tr>
						`;
					}
				}else {
					html = `<tr><td colspan="6" style="text-align:center;">검색 결과가 없습니다.</td></tr>`;
				}
				approvalListTbody.html(html);
			}
		})
	}
})
    </script>
</html> 
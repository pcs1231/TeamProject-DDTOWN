package kr.or.ddit.ddtown.controller.admin.goods;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.ddtown.service.admin.goods.orders.IAdminOrdersService;
import kr.or.ddit.ddtown.service.goods.cancel.ICancelService;
import kr.or.ddit.vo.PaginationInfoVO;
import kr.or.ddit.vo.order.OrdersVO;
import kr.or.ddit.vo.security.CustomOAuth2User;
import kr.or.ddit.vo.security.CustomUser;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/admin/goods/orders")
public class AdminGoodsOrdersController {
	
	@Autowired
	private IAdminOrdersService adminOrderService;
	
	@Autowired
	private ICancelService cancelService;
	
	 @GetMapping("/list")
	    public String goodsOrdersList(
	            @RequestParam(name = "currentPage", required = false, defaultValue = "1") int currentPage,
	            @RequestParam(name = "orderDateStart", required = false) String orderDateStart,
	            @RequestParam(name = "orderDateEnd", required = false) String orderDateEnd,
	            @RequestParam(name = "orderStatusFilter", required = false) String orderStatusFilter,
	            @RequestParam(name = "orderSearchInput", required = false) String orderSearchInput,
	            Model model) {

	        PaginationInfoVO<OrdersVO> pagingVO = new PaginationInfoVO<>();
	        pagingVO.setCurrentPage(currentPage);

	        // ê²€ìƒ‰ ì¡°ê±´ì„ ë‹´ì„ Map ìƒì„± ë° ì„¤ì •
	        Map<String, Object> searchMap = new HashMap<>();
	        
	        if (orderDateStart != null && !orderDateStart.isEmpty()) {
	            searchMap.put("orderDateStart", orderDateStart);
	        }
	        if (orderDateEnd != null && !orderDateEnd.isEmpty()) {
	            searchMap.put("orderDateEnd", orderDateEnd);
	        }
	        if (orderStatusFilter != null && !orderStatusFilter.isEmpty()) {
	            searchMap.put("orderStatusFilter", orderStatusFilter);
	        }
	        if (orderSearchInput != null && !orderSearchInput.isEmpty()) {
	            searchMap.put("orderSearchInput", orderSearchInput);
	        }
	        pagingVO.setSearchMap(searchMap); // <-- searchMapì„ pagingVOì— ì„¤ì •í•©ë‹ˆë‹¤.

	        log.info("### AdminGoodsOrdersController - goodsOrdersList í˜¸ì¶œ: currentPage={}, searchMap={}",
	                 pagingVO.getCurrentPage(), pagingVO.getSearchMap()); // ë¡œê·¸ë„ searchMapìœ¼ë¡œ ë³€ê²½

	        int totalRecord = adminOrderService.getTotalOrdersCount(pagingVO);
	        pagingVO.setTotalRecord(totalRecord);

	        List<OrdersVO> orderList = adminOrderService.getAllOrders(pagingVO);
	        pagingVO.setDataList(orderList);

	        model.addAttribute("pagingVO", pagingVO);

	        // JSPì—ì„œ ê²€ìƒ‰ í•„ë“œ ê°’ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ Modelì— ì§ì ‘ ì¶”ê°€ (ë˜ëŠ” searchMapì„ ê·¸ëŒ€ë¡œ ì „ë‹¬)
	        model.addAttribute("orderDateStart", orderDateStart);
	        model.addAttribute("orderDateEnd", orderDateEnd);
	        model.addAttribute("orderStatusFilter", orderStatusFilter);
	        model.addAttribute("orderSearchInput", orderSearchInput);


	        return "admin/goods/orders/orders_list";
	    }

	    @GetMapping("/detail")
	    public String goodsOrdersDetail(
	            @RequestParam("orderNo") int orderNo,
	            // ìƒì„¸ í˜ì´ì§€ 'ëª©ë¡' ë²„íŠ¼ì„ ìœ„í•´ ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ë“¤ì„ ê·¸ëŒ€ë¡œ ë°›ì•„ì„œ Modelì— ë„˜ê²¨ì¤ë‹ˆë‹¤.
	            @RequestParam(name = "currentPage", required = false, defaultValue = "1") int currentPage,
	            @RequestParam(name = "orderDateStart", required = false) String orderDateStart,
	            @RequestParam(name = "orderDateEnd", required = false) String orderDateEnd,
	            @RequestParam(name = "orderStatusFilter", required = false) String orderStatusFilter,
	            @RequestParam(name = "orderSearchInput", required = false) String orderSearchInput,
	            Model model) {

	        log.info("### AdminGoodsOrdersController - goodsOrdersDetail í˜¸ì¶œ: orderNo={}", orderNo);
	        OrdersVO order = adminOrderService.getOrderDetail(orderNo);
	        
	        // ğŸš¨ğŸš¨ğŸš¨ ì—¬ê¸° ë¡œê·¸ ì¶”ê°€
	        log.info("ì¡°íšŒëœ ì£¼ë¬¸ ì •ë³´ (order.orderStatCode): {}", order.getOrderStatCode());
	        log.info("ì¡°íšŒëœ ì£¼ë¬¸ ì •ë³´ (order.refundedAmount): {}", order.getRefundedAmount());
	        log.info("ì¡°íšŒëœ ì£¼ë¬¸ ì •ë³´ (order.totalGoodsPrice): {}", order.getTotalGoodsPrice());
	        log.info("ì¡°íšŒëœ ì£¼ë¬¸ ì •ë³´ (order.actualShippingFee): {}", order.getActualShippingFee());
	        // ... í•„ìš”í•˜ë©´ order ê°ì²´ ì „ì²´ë¥¼ ì¶œë ¥ (toString() ìë™ ìƒì„±)
	        // log.info("ì¡°íšŒëœ ì£¼ë¬¸ ì •ë³´ ì „ì²´: {}", order);

	        model.addAttribute("order", order);

	        // JSP 'ëª©ë¡' ë²„íŠ¼ êµ¬ì„±ì„ ìœ„í•œ íŒŒë¼ë¯¸í„° ì „ë‹¬
	        model.addAttribute("currentPage", currentPage);
	        model.addAttribute("orderDateStart", orderDateStart);
	        model.addAttribute("orderDateEnd", orderDateEnd);
	        model.addAttribute("orderStatusFilter", orderStatusFilter);
	        model.addAttribute("orderSearchInput", orderSearchInput);

	        return "admin/goods/orders/orders_detail";
	    }
	    
	    // ğŸš¨ğŸš¨ğŸš¨ ìƒˆë¡œ ì¶”ê°€í•  ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ ë©”ì„œë“œ ğŸš¨ğŸš¨ğŸš¨
	    @PutMapping("/update") // JSPì—ì„œ PUT ë©”ì„œë“œë¡œ ìš”ì²­í•˜ë¯€ë¡œ @PutMapping ì‚¬ìš©
	    @ResponseBody // JSON ì‘ë‹µì„ ìœ„í•´ ì¶”ê°€
	    public ResponseEntity<Map<String, String>> updateOrder(@RequestBody OrdersVO orderVO) {
	        log.info("### AdminGoodsOrdersController - updateOrder í˜¸ì¶œ: orderNo={}, orderStatCode={}, orderMemo={}",
	                 orderVO.getOrderNo(), orderVO.getOrderStatCode(), orderVO.getOrderMemo());

	        Map<String, String> response = new HashMap<>();
	        try {
	            // ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì—…ë°ì´íŠ¸ ë¡œì§ í˜¸ì¶œ
	            // ì˜ˆë¥¼ ë“¤ì–´, adminOrderService.updateOrderStatusAndMemo(orderVO);
	            // ì´ ë©”ì„œë“œë¥¼ IAdminOrdersServiceì— ì¶”ê°€í•˜ê³  êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
	            int updateCount = adminOrderService.updateOrderStatusAndMemo(orderVO); // ì„œë¹„ìŠ¤ì— ì¶”ê°€í•  ë©”ì„œë“œ

	            if (updateCount > 0) {
	                response.put("status", "OK");
	                response.put("message", "ì£¼ë¬¸ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
	                return new ResponseEntity<>(response, HttpStatus.OK);
	            } else {
	                response.put("status", "FAILED");
	                response.put("message", "ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ê±°ë‚˜ ì£¼ë¬¸ ë²ˆí˜¸ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	                return new ResponseEntity<>(response, HttpStatus.BAD_REQUEST); // ì‹¤íŒ¨ ì‹œ BAD_REQUEST
	            }
	        } catch (Exception e) {
	            log.error("ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage(), e);
	            response.put("status", "ERROR");
	            response.put("message", "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
	            return new ResponseEntity<>(response, HttpStatus.INTERNAL_SERVER_ERROR); // ì˜ˆì™¸ ë°œìƒ ì‹œ INTERNAL_SERVER_ERROR
	        }
	    }
	    
	    
	    @PutMapping("/cancel/{orderNo}") // PUT ìš”ì²­ì„ ë°›ë„ë¡ ë§¤í•‘
	    @ResponseBody // JSON ì‘ë‹µì„ ìœ„í•´ ì¶”ê°€ (ServiceResultê°€ JSONìœ¼ë¡œ ë³€í™˜ë¨)
	    public ResponseEntity<String> cancelOrder(
	            @PathVariable("orderNo") int orderNo,
	            @AuthenticationPrincipal Object principal
	            ) {
	        log.info("### AdminGoodsOrdersController - cancelOrder í˜¸ì¶œ: orderId={}", orderNo);

	        String empUsername = null;

	        if (principal instanceof CustomUser) {
	            CustomUser customUser = (CustomUser) principal;
	            if (customUser.getEmployeeVO() != null) {
	                empUsername = customUser.getEmployeeVO().getEmpUsername();
	                log.info("ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ID (Employee): {}", empUsername);
	            } else if (customUser.getMemberVO() != null) {
	                empUsername = customUser.getMemberVO().getMemUsername();
	                log.warn("ì¼ë°˜ íšŒì›(MemberVO)ì´ ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì‹œë„: {}", empUsername);
	            }
	        } else if (principal instanceof CustomOAuth2User) {
	            empUsername = ((CustomOAuth2User) principal).getMemberVO().getMemUsername();
	            log.warn("OAuth2 ì‚¬ìš©ìê°€ ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì‹œë„: {}", empUsername);
	        }

	        if (empUsername == null) {
	            log.error("ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ê±°ë‚˜, ìœ íš¨í•œ ê³„ì •ì´ ì•„ë‹™ë‹ˆë‹¤.");
	            return new ResponseEntity<>("UNAUTHORIZED", HttpStatus.UNAUTHORIZED); // 401 Unauthorized
	        }

	        log.info("Controllerì—ì„œ Serviceë¡œ ì „ë‹¬ë  empUsername: {}", empUsername);

	        ServiceResult result = adminOrderService.cancelOrder(orderNo, empUsername); // AdminOrdersServiceImplë¡œ orderNoì™€ empUsername ì „ë‹¬


	        if (result == ServiceResult.OK) {
	            return new ResponseEntity<>("SUCCESS", HttpStatus.OK);
	        } else {
	            return new ResponseEntity<>("FAILED", HttpStatus.INTERNAL_SERVER_ERROR);
	        }
	    }
}


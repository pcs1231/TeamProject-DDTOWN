<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.ddtown.mapper.orders.IOrderMapper">

	<resultMap type="kr.or.ddit.vo.order.OrderDetailVO" id="orderDetailMap">
	    <id property="orderDetNo" column="ORDER_DET_NO"/>
	    <result property="orderNo" column="ORDER_NO"/>
	    <result property="goodsNo" column="GOODS_NO"/>
	    <result property="goodsOptNo" column="GOODS_OPT_NO"/>
	    <result property="orderDetQty" column="ORDER_DET_QTY"/>
	    <result property="goodsNm" column="GOODS_NM"/>
	    <result property="goodsPrice" column="GOODS_PRICE"/>
	    <result property="goodsFileGroupNo" column="GOODS_FILE_GROUP_NO"/>
	    <result property="goodsStatusCode" column="GOODS_STAT_CODE"/>
	    <result property="goodsOptNm" column="GOODS_OPT_NM"/>
	    <result property="goodsOptPrice" column="GOODS_OPT_PRICE"/>
	</resultMap>

	<insert id="insertOrder" parameterType="kr.or.ddit.vo.order.OrdersVO">
        <selectKey keyProperty="orderNo" resultType="int" order="BEFORE">
            SELECT ORDERS_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO ORDERS (
            ORDER_NO, MEM_USERNAME, ORDER_TOTAL_PRICE, ORDER_STAT_CODE,
            ORDER_TYPE_CODE, ORDER_PAY_METHOD_NM, ORDER_DATE,
            ORDER_RECIPIENT_NM, ORDER_RECIPIENT_PHONE, ORDER_ZIP_CODE,
            ORDER_ADDRESS1, ORDER_ADDRESS2, ORDER_EMAIL, ORDER_MEMO,
            ORDER_FROM_CART
        ) VALUES (
            #{orderNo},
            #{memUsername}, #{orderTotalPrice}, #{orderStatCode},
            #{orderTypeCode}, #{orderPayMethodNm}, SYSDATE,
            #{orderRecipientNm}, #{orderRecipientPhone}, #{orderZipCode},
            #{orderAddress1}, #{orderAddress2}, #{orderEmail}, #{orderMemo},
            #{orderFromCart}
        )
    </insert>

    <insert id="insertOrderDetail" parameterType="kr.or.ddit.vo.order.OrderDetailVO">
        INSERT INTO ORDER_DETAIL (
            ORDER_DET_NO, ORDER_NO, GOODS_NO, GOODS_OPT_NO, ORDER_DET_QTY ) VALUES (
            ORDER_DETAIL_SEQ.NEXTVAL, #{orderNo}, #{goodsNo}, #{goodsOptNo}, #{orderDetQty} )
    </insert>

    <insert id="insertPaymentReadyInfo" parameterType="kr.or.ddit.vo.order.PaymentVO">
        INSERT INTO PAYMENT_API (
            TID, ORDER_NO, CID, TOTAL_AMOUNT, PAYMENT_STAT_CODE, SUB_SID, REQUESTED_AT, AID, COMPLETED_AT
        ) VALUES (
            #{tid}, #{orderNo}, #{cid}, #{totalAmount}, #{paymentStatCode}, #{subSid}, SYSDATE, #{aid}, #{completedAt}
        )
    </insert>

	<update id="updateOrderStatus" parameterType="map">
	    UPDATE ORDERS
	    SET
	        ORDER_STAT_CODE = #{statusCode}
	        WHERE ORDER_NO = #{orderNo}
	</update>

    <update id="updatePaymentStatus" parameterType="map">
        UPDATE PAYMENT_API
        SET
            PAYMENT_STAT_CODE = #{statusCode},
            COMPLETED_AT = SYSDATE
        WHERE ORDER_NO = #{orderNo}
    </update>

    <select id="selectOrderByOrderNo" parameterType="int" resultType="kr.or.ddit.vo.order.OrdersVO">
	    SELECT
	        ORDER_NO,
	        MEM_USERNAME,
	        ORDER_TOTAL_PRICE,
	        ORDER_STAT_CODE,
	        ORDER_TYPE_CODE,
	        ORDER_PAY_METHOD_NM,
	        ORDER_DATE,
	        ORDER_RECIPIENT_NM,
	        ORDER_RECIPIENT_PHONE,
	        ORDER_ZIP_CODE,
	        ORDER_ADDRESS1,
	        ORDER_ADDRESS2,
	        ORDER_EMAIL,
	        ORDER_MEMO,
	        ORDER_FROM_CART FROM ORDERS
	    WHERE ORDER_NO = #{orderNo}
	</select>

    <select id="selectPaymentReadyInfoByOrderNo" parameterType="int" resultType="kr.or.ddit.vo.order.PaymentVO">
        SELECT
            TID, ORDER_NO, CID, TOTAL_AMOUNT, PAYMENT_STAT_CODE, SUB_SID, REQUESTED_AT, AID, COMPLETED_AT
        FROM PAYMENT_API
        WHERE ORDER_NO = #{orderNo}
        ORDER BY REQUESTED_AT DESC FETCH FIRST 1 ROW ONLY
    </select>

	<update id="updateOrder" parameterType="kr.or.ddit.vo.order.OrdersVO">
	    UPDATE ORDERS
	    SET
	        ORDER_STAT_CODE = #{orderStatCode},
	        ORDER_TOTAL_PRICE = #{orderTotalPrice}, ORDER_RECIPIENT_NM = #{orderRecipientNm},
	        ORDER_RECIPIENT_PHONE = #{orderRecipientPhone},
	        ORDER_ZIP_CODE = #{orderZipCode},
	        ORDER_ADDRESS1 = #{orderAddress1},
	        ORDER_ADDRESS2 = #{orderAddress2},
	        ORDER_EMAIL = #{orderEmail},
	        ORDER_MEMO = #{orderMemo}
	        WHERE ORDER_NO = #{orderNo}
	</update>

    <update id="updatePaymentInfo" parameterType="kr.or.ddit.vo.order.PaymentVO">
        UPDATE PAYMENT_API
        SET
            PAYMENT_STAT_CODE = #{paymentStatCode},
            COMPLETED_AT = #{completedAt},
            TOTAL_AMOUNT = #{totalAmount},
            AID = #{aid},
            SUB_SID = #{subSid}
            WHERE ORDER_NO = #{orderNo} AND TID = #{tid}
    </update>
    
    <select id="selectOrderDetailsByOrderNo" resultMap="orderDetailMap" parameterType="int">
        SELECT
            OD.ORDER_DET_NO,
            OD.ORDER_NO,
            OD.GOODS_NO,
            OD.GOODS_OPT_NO,
            OD.ORDER_DET_QTY,
            G.GOODS_NM,
            G.GOODS_PRICE,
            G.FILE_GROUP_NO,
            G.GOODS_STAT_CODE,
            GO.GOODS_OPT_NM,
            GO.GOODS_OPT_PRICE
        FROM ORDER_DETAIL OD
        JOIN GOODS G ON OD.GOODS_NO = G.GOODS_NO
        LEFT JOIN GOODS_OPTION GO ON OD.GOODS_OPT_NO = GO.GOODS_OPT_NO
        WHERE OD.ORDER_NO = #{orderNo}
    </select>
    
</mapper>
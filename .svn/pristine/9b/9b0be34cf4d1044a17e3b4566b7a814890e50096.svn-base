<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" language="java"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DDTOWN ì•„í‹°ìŠ¤íŠ¸ ì¸ê¸° íˆ¬í‘œ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css" />
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/resources/css/pages/artist_community.css" />
</head>

<body class="vote-page">
    <jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />

	<div class="vote-container">
        <div class="vote-header">
            <h1>DDTOWN ì•„í‹°ìŠ¤íŠ¸ ì¸ê¸° íˆ¬í‘œ</h1>
            <p>ë‹¹ì‹ ì˜ ìµœì•  ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
            <button id="test">í…ŒìŠ¤íŠ¸ìš©</button>
            <div class="round-info" id="roundInfo">32ê°•</div> </div>

        <div class="vote-gate" id="voteGate">
            <div class="message" id="gateMessage">ì´ìƒí˜• ì›”ë“œì»µì— ì°¸ì—¬í•˜ì—¬ DDTOWN ìµœê³  ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë½‘ì•„ì£¼ì„¸ìš”!</div>
            <button class="btn-start-vote" id="btnStartVote">ì›”ë“œì»µ ì‹œì‘í•˜ê¸°</button>
            <button class="btn-view-ranking" id="btnViewLastWeekRanking" style="display: none;">ì§€ë‚œ ì£¼ ìˆœìœ„ ë³´ê¸°</button>
        </div>

        <div class="vote-arena" id="voteArena" style="display: none;">
            <div class="artist-card" id="artistCard1" data-artist-id="1">
                <div class="artist-image-placeholder" id="artistImage1">A</div>
                <p class="artist-name" id="artistName1">Artist A</p>
            </div>
            <div class="vs-text">VS</div>
            <div class="artist-card" id="artistCard2" data-artist-id="2">
                <div class="artist-image-placeholder" id="artistImage2">B</div>
                <p class="artist-name" id="artistName2">Artist B</p>
            </div>
        </div>

        <div class="vote-result" id="voteResult" style="display: none;">
            <div class="winner-announcement" id="winnerAnnouncement">ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ìµœì•  ì•„í‹°ìŠ¤íŠ¸ëŠ”...</div>
            <div class="winner-card">
                <div class="artist-image-placeholder" id="winnerImage">X</div>
                <p class="artist-name" id="winnerName">Winner Artist</p>
            </div>
            <div class="weekly-ranking" id="weeklyRankingResult">
                <h3>ì§€ë‚œ ì£¼ ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ TOP 3 (íˆ¬í‘œ ìˆ˜)</h3>
                <ul>
                    <li><span class="rank">1ìœ„</span> <span class="artist-name">Artist C</span> <span class="vote-count">1,234í‘œ</span></li>
                    <li><span class="rank">2ìœ„</span> <span class="artist-name">Artist D</span> <span class="vote-count">1,005í‘œ</span></li>
                    <li><span class="rank">3ìœ„</span> <span class="artist-name">Artist E</span> <span class="vote-count">876í‘œ</span></li>
                </ul>
            </div>
            <button class="btn-start-vote" id="btnRestartVote" style="margin-top: 30px; display:none;">ìƒˆë¡œìš´ ì›”ë“œì»µ ì‹œì‘í•˜ê¸° (ê´€ë¦¬ììš©/í…ŒìŠ¤íŠ¸ìš©)</button>
        </div>

    </div>
    <div id="footer-placeholder"></div>
    <script>
    	$("#test").on("click",function(){
    		console.log(document.qeurySelector("#artistCard2").getBoundingClientRect())
    	});
        // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ (ì‹¤ì œë¡œëŠ” ì„œë²„ì™€ ì—°ë™ë˜ì–´ì•¼ í•¨) ---
        let currentRound = 32; // ì˜ˆ: 32ê°•ë¶€í„° ì‹œì‘
        let à¦®à§‹à¦ŸRounds = 5; // 32ê°•(16ê²½ê¸°), 16ê°•(8), 8ê°•(4), 4ê°•(2), ê²°ìŠ¹(1) -> 5ë‹¨ê³„ì˜ ì„ íƒ
        let currentMatch = 0;
        let artists = []; // ì „ì²´ ì•„í‹°ìŠ¤íŠ¸ ëª©ë¡ (ì„œë²„ì—ì„œ ë¡œë“œ ë˜ëŠ” í•˜ë“œì½”ë”©)
        let currentPair = []; // í˜„ì¬ ëŒ€ê²° ì¤‘ì¸ ì•„í‹°ìŠ¤íŠ¸ ìŒ
        let winners = []; // ê° ë¼ìš´ë“œ ìŠ¹ì ëª©ë¡
        let userVotedToday = false; // ì˜¤ëŠ˜ íˆ¬í‘œí–ˆëŠ”ì§€ ì—¬ë¶€ (ì„œë²„ì—ì„œ í™•ì¸ í•„ìš”)
        let weeklyVoteActive = true; // í˜„ì¬ ì£¼ê°„ íˆ¬í‘œê°€ í™œì„± ìƒíƒœì¸ì§€ (ì„œë²„ì—ì„œ í™•ì¸ í•„ìš”)

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const roundInfoEl = document.getElementById('roundInfo');
        const voteGateEl = document.getElementById('voteGate');
        const gateMessageEl = document.getElementById('gateMessage');
        const btnStartVoteEl = document.getElementById('btnStartVote');
        const btnViewLastWeekRankingEl = document.getElementById('btnViewLastWeekRanking');

        const voteArenaEl = document.getElementById('voteArena');
        const artistCard1El = document.getElementById('artistCard1');
        const artistImage1El = document.getElementById('artistImage1');
        const artistName1El = document.getElementById('artistName1');
        const artistCard2El = document.getElementById('artistCard2');
        const artistImage2El = document.getElementById('artistImage2');
        const artistName2El = document.getElementById('artistName2');

        const voteResultEl = document.getElementById('voteResult');
        const winnerAnnouncementEl = document.getElementById('winnerAnnouncement');
        const winnerImageEl = document.getElementById('winnerImage');
        const winnerNameEl = document.getElementById('winnerName');
        const weeklyRankingResultEl = document.getElementById('weeklyRankingResult');
        const btnRestartVoteEl = document.getElementById('btnRestartVote');


        // --- ì˜ˆì‹œ ì•„í‹°ìŠ¤íŠ¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì˜´) ---
        const sampleArtists = [
            { id: 1, name: "Artist A", imageChar: "A" }, { id: 2, name: "Artist B", imageChar: "B" },
            { id: 3, name: "Artist C", imageChar: "C" }, { id: 4, name: "Artist D", imageChar: "D" },
            { id: 5, name: "Artist E", imageChar: "E" }, { id: 6, name: "Artist F", imageChar: "F" },
            { id: 7, name: "Artist G", imageChar: "G" }, { id: 8, name: "Artist H", imageChar: "H" },
            // ... 32ëª…ê¹Œì§€ ì±„ìš°ê±°ë‚˜, JSë¡œ ëœë¤ ì„ íƒí•˜ë„ë¡ êµ¬ì„±
        ];
        // ê°„ë‹¨í•˜ê²Œ 8ê°•ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì˜ˆì‹œë¥¼ ìœ„í•´ 8ëª…ë§Œ ì‚¬ìš©
        let tournamentParticipants = [...sampleArtists.slice(0, 8)]; // 8ê°• ì‹œì‘ ì˜ˆì‹œ


        // --- í•¨ìˆ˜ ì •ì˜ ---
        function shuffleArray(array) { // ë°°ì—´ ì„ê¸° (ëœë¤ ëŒ€ì§„)
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function setupMatch() {
            if (tournamentParticipants.length < 2) { // ì°¸ê°€ìê°€ 1ëª… ë‚¨ìœ¼ë©´ ìµœì¢… ìš°ìŠ¹
                displayWinner(tournamentParticipants[0]);
                return;
            }
            if (currentMatch * 2 >= tournamentParticipants.length) { // í˜„ì¬ ë¼ìš´ë“œ ëª¨ë“  ê²½ê¸° ì¢…ë£Œ
                currentRound = tournamentParticipants.length / 2; // ë‹¤ìŒ ë¼ìš´ë“œ (ì˜ˆ: 8ëª… -> 4ê°•)
                tournamentParticipants = [...winners]; // ìŠ¹ìë“¤ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ì°¸ê°€ì êµ¬ì„±
                winners = []; // ìŠ¹ì ëª©ë¡ ì´ˆê¸°í™”
                currentMatch = 0; // ê²½ê¸° ë²ˆí˜¸ ì´ˆê¸°í™”
                if (tournamentParticipants.length < 2) { // ìµœì¢… ìš°ìŠ¹ì ê²°ì •
                    displayWinner(tournamentParticipants[0]);
                    return;
                }
                shuffleArray(tournamentParticipants); // ë‹¤ìŒ ë¼ìš´ë“œ ëŒ€ì§„ ì„ê¸°
            }

            roundInfoEl.textContent = `\${currentRound * 2}ê°• \${currentMatch + 1}ë²ˆì§¸ ê²½ê¸°`; // 8ê°• 1ê²½ê¸° (2*N í˜•íƒœ)

            currentPair = [tournamentParticipants[currentMatch * 2], tournamentParticipants[currentMatch * 2 + 1]];
            if (!currentPair[0] || !currentPair[1]) { // ëŒ€ì§„í‘œ ì˜¤ë¥˜ ë˜ëŠ” í™€ìˆ˜ ì°¸ê°€ì ì²˜ë¦¬ (ì—¬ê¸°ì„  ê°„ë‹¨íˆ ì¢…ë£Œ)
                 console.error("ëŒ€ì§„í‘œ ìƒì„± ì˜¤ë¥˜ ë˜ëŠ” ì°¸ê°€ì ë¶€ì¡±");
                 displayWinner(tournamentParticipants[0] || {name: "ì˜¤ë¥˜", imageChar: "?"}); // ì„ì‹œ ì²˜ë¦¬
                 return;
            }

            artistImage1El.textContent = currentPair[0].imageChar;
            artistName1El.textContent = currentPair[0].name;
            artistCard1El.dataset.artistId = currentPair[0].id;

            artistImage2El.textContent = currentPair[1].imageChar;
            artistName2El.textContent = currentPair[1].name;
            artistCard2El.dataset.artistId = currentPair[1].id;

            voteGateEl.style.display = 'none';
            voteResultEl.style.display = 'none';
            voteArenaEl.style.display = 'flex';
        }

        function handleVote(selectedArtistCard) {
            const selectedId = parseInt(selectedArtistCard.dataset.artistId);
            const winner = currentPair.find(artist => artist.id === selectedId);
            winners.push(winner);

            // --- ì‹¤ì œë¡œëŠ” ì„œë²„ì— íˆ¬í‘œ ê¸°ë¡ ì „ì†¡ ---
            console.log(`ì„ íƒ: \${winner.name} (ID: \${winner.id}), í˜„ì¬ ë¼ìš´ë“œ: \${currentRound*2}ê°•`);

            currentMatch++;
            setupMatch();
        }

        function displayWinner(winner) {
            winnerAnnouncementEl.textContent = `ğŸ‰ ìµœì¢… ìš°ìŠ¹! ë‹¹ì‹ ì˜ ìµœì•  ì•„í‹°ìŠ¤íŠ¸ëŠ” ğŸ‰`;
            winnerImageEl.textContent = winner.imageChar;
            winnerNameEl.textContent = winner.name;

            voteArenaEl.style.display = 'none';
            voteGateEl.style.display = 'none'; // ì‹œì‘ ê²Œì´íŠ¸ë„ ìˆ¨ê¹€
            voteResultEl.style.display = 'block';
            weeklyRankingResultEl.style.display = 'block'; // ìµœì¢… ìš°ìŠ¹ ì‹œì—ë„ ì§€ë‚œ ì£¼ ë­í‚¹ ë³´ì—¬ì£¼ê¸° (ì„ íƒ)
            roundInfoEl.textContent = "ì›”ë“œì»µ ì¢…ë£Œ";
            btnRestartVoteEl.style.display = 'inline-block'; // í…ŒìŠ¤íŠ¸ìš© ì¬ì‹œì‘ ë²„íŠ¼
            userVotedToday = true; // íˆ¬í‘œ ì™„ë£Œ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬)
        }

        function showVoteGate() {
            voteArenaEl.style.display = 'none';
            voteResultEl.style.display = 'none';
            voteGateEl.style.display = 'block';
            roundInfoEl.textContent = `\${tournamentParticipants.length}ê°•`; // ì´ˆê¸° ë¼ìš´ë“œ í‘œì‹œ (ì˜ˆ: 8ê°•)

            if (userVotedToday) {
                gateMessageEl.textContent = "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì°¸ì—¬í•´ì£¼ì„¸ìš”.";
                btnStartVoteEl.style.display = 'none';
                btnViewLastWeekRankingEl.style.display = 'inline-block';
            } else if (!weeklyVoteActive) {
                gateMessageEl.textContent = "ì´ë²ˆ ì£¼ ì›”ë“œì»µì€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì£¼ ì›”ë“œì»µì„ ê¸°ëŒ€í•´ì£¼ì„¸ìš”!";
                btnStartVoteEl.style.display = 'none';
                btnViewLastWeekRankingEl.style.display = 'inline-block';
            } else {
                gateMessageEl.textContent = "ì´ìƒí˜• ì›”ë“œì»µì— ì°¸ì—¬í•˜ì—¬ DDTOWN ìµœê³  ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ë¥¼ ë½‘ì•„ì£¼ì„¸ìš”!";
                btnStartVoteEl.style.display = 'inline-block';
                btnViewLastWeekRankingEl.style.display = 'none';
            }
        }

        function initializeVote() {
            // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ userVotedToday, weeklyVoteActive, ì§€ë‚œì£¼ ë­í‚¹ ë“± ìƒíƒœë¥¼ ë°›ì•„ì™€ì•¼ í•¨
            // ì—¬ê¸°ì„œëŠ” í•˜ë“œì½”ë”©ëœ ê°’ìœ¼ë¡œ ì‹œì‘
            userVotedToday = false; // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ falseë¡œ ì‹œì‘
            weeklyVoteActive = true; // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ trueë¡œ ì‹œì‘

            currentRound = tournamentParticipants.length / 2; // ì´ˆê¸° ë¼ìš´ë“œ ì„¤ì • (ì˜ˆ: 8ëª… -> 4ìŒ -> 8ê°•)
            currentMatch = 0;
            winners = [];
            shuffleArray(tournamentParticipants); // ì´ˆê¸° ëŒ€ì§„ ì„ê¸°
            showVoteGate();
        }


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        btnStartVoteEl.addEventListener('click', () => {
            if (userVotedToday) {
                alert("í•˜ë£¨ì— í•œ ë²ˆë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            if (!weeklyVoteActive) {
                alert("í˜„ì¬ëŠ” íˆ¬í‘œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
                return;
            }
            setupMatch();
        });

        btnViewLastWeekRankingEl.addEventListener('click', () => {
            voteGateEl.style.display = 'none';
            voteArenaEl.style.display = 'none';
            winnerAnnouncementEl.textContent = "ì§€ë‚œ ì£¼ ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ TOP 3"; // ì œëª© ë³€ê²½
            winnerImageEl.style.display = 'none'; // ìš°ìŠ¹ì ì´ë¯¸ì§€ ìˆ¨ê¹€
            winnerNameEl.style.display = 'none';  // ìš°ìŠ¹ì ì´ë¦„ ìˆ¨ê¹€
            voteResultEl.style.display = 'block';
            weeklyRankingResultEl.style.display = 'block';
            btnRestartVoteEl.style.display = 'none';
            roundInfoEl.textContent = "ì§€ë‚œ ì£¼ ìˆœìœ„";
        });


        artistCard1El.addEventListener('click', () => handleVote(artistCard1El));
        artistCard2El.addEventListener('click', () => handleVote(artistCard2El));

        btnRestartVoteEl.addEventListener('click', () => { // í…ŒìŠ¤íŠ¸ìš©
             tournamentParticipants = [...sampleArtists.slice(0, 8)]; // ì°¸ê°€ì ì´ˆê¸°í™”
             initializeVote();
             winnerImageEl.style.display = 'flex'; // ìš°ìŠ¹ì ì´ë¯¸ì§€ ë‹¤ì‹œ ë³´ì´ê²Œ
             winnerNameEl.style.display = 'block';  // ìš°ìŠ¹ì ì´ë¦„ ë‹¤ì‹œ ë³´ì´ê²Œ
             btnRestartVoteEl.style.display = 'none';
        });


        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ---
        initializeVote();

        // í‘¸í„° ë¡œë“œ (ì´ì „ê³¼ ë™ì¼)
        const footerPlaceholder = document.getElementById('footer-placeholder');
        if (footerPlaceholder) {
            fetch('footer.html')
                .then(response => response.ok ? response.text() : Promise.reject('Footer not found'))
                .then(data => { footerPlaceholder.innerHTML = data; })
                .catch(error => console.error('Error loading footer:', error));
        }
        // ë¡œê·¸ì¸ ìƒíƒœ (ì´ì „ê³¼ ë™ì¼)
        const authLinkVote = document.getElementById('auth-link');
        if (authLinkVote) {
             let isLoggedInVote = JSON.parse(localStorage.getItem('isLoggedIn')) || false;
             authLinkVote.textContent = isLoggedInVote ? 'ë¡œê·¸ì•„ì›ƒ' : 'ë¡œê·¸ì¸';
             authLinkVote.addEventListener('click', function(event) { /* ...ì´ì „ê³¼ ë™ì¼... */ });
        }

    </script>
</body>
</html>
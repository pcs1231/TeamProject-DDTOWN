<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags"
	prefix="sec"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ì˜ í”„ë¡œí•„</title>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/resources/plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/resources/css/pages/my_profile.css">
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/resources/css/pages/communityModal.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript">
	$(function(){
		<c:if test="${not empty message }">
			Swal.fire({
					title : "${message }",
					icon : "success",
					draggable : true
				});
			<c:remove var="message" scope="request"/>
			<c:remove var="message" scope="session"/>
		</c:if>
		
		// ì•Œë¦¼ì—ì„œ ì˜¨ ê²½ìš° URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
		const urlParams = new URLSearchParams(window.location.search);
		const refreshParam = urlParams.get('refresh');
		const hash = window.location.hash;
		
		if (refreshParam && hash.startsWith('#post-')) {
			console.log("ì•Œë¦¼ì—ì„œ ì˜¨ í”„ë¡œí•„ í˜ì´ì§€ ê°ì§€, ê²Œì‹œë¬¼ ëª¨ë‹¬ ì—´ê¸° ì¤‘...");
			
			// íŠ¹ì • ê²Œì‹œë¬¼ ëª¨ë‹¬ ì—´ê¸°
			const postNo = hash.replace('#post-', '');
			setTimeout(function() {
				displayPostModal(postNo);
				const postModal = new bootstrap.Modal(document.getElementById('postDetailModal'));
				postModal.show();
				console.log("ê²Œì‹œë¬¼ ëª¨ë‹¬ ì—´ê¸° ì™„ë£Œ: " + postNo);
			}, 300);
			
			// íŒŒë¼ë¯¸í„° ì œê±°í•˜ì—¬ ê¹”ë”í•œ URL ìœ ì§€
			const cleanUrl = window.location.pathname + hash;
			history.replaceState(null, null, cleanUrl);
		}
	})
	function sweetAlert(type, msg){
		return Swal.fire({
			title : msg,
			icon : type,
			showConfirmButton: false,
            timer: 2000,
			draggable : true
		});
	}

</script>

<style type="text/css">
.carousel-item-title {
    max-width: 100%;
    border-bottom: 1px solid aliceblue;
    margin-bottom: 10pt;
    padding-bottom: 5pt;
    color: black;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    font-weight: 600;
}
</style>
</head>

<body>
	<sec:authorize access="hasAnyRole('MEMBER','ARTIST')">
		<sec:authentication property="principal" var="user"/>
	</sec:authorize>
	<%@ include file="../../modules/communityHeader.jsp"%>
	<ul class="nav apt-tabs" id="comuTab" role="tabList">
		<li class="nav-item" role="presentation"><a class="tab-item"
			href="${pageContext.request.contextPath}/community/gate/${artGroupNo}/apt#artistPostList">ì•„í‹°ìŠ¤íŠ¸</a>
		</li>
		<li class="nav-item" role="presentation"><a class="tab-item"
			href="${pageContext.request.contextPath}/community/gate/${artGroupNo}/apt#fanPostList">íŒ¬</a>
		</li>
		<li class="nav-item" role="presentation"><a class="tab-item"
			href="${pageContext.request.contextPath}/community/gate/${artGroupNo}/apt#liveArea">ë¼ì´ë¸Œ</a>
		</li>
		<li class="nav-item" role="presentation"><a class="tab-item"
			href="${pageContext.request.contextPath}/community/gate/${artGroupNo}/apt#scheduleList">ìŠ¤ì¼€ì¥´</a>
		</li>
		<li class="nav-item" role="presentation"><a class="tab-item"
			href="${pageContext.request.contextPath}/community/gate/${artGroupNo}/apt#noticeAptList">ê³µì§€ì‚¬í•­</a>
		</li>
	</ul>

	<main class="profile-main container py-4 d-flex gap-3">
		<aside class="apt-sidebar">
			<div class="sidebar-widget goods-widget">
				<div id="carouselExampleFade" class="carousel slide carousel-fade" data-bs-ride="carousel">
					<div class="carousel-inner">
						<c:forEach items="${thumnailImages }" var="img" varStatus="i">
							<a href="${pageContext.request.contextPath}/goods/detail?goodsNo=${img.goodsNo }">
								<div class="carousel-item <c:if test="${i.index == 0 }">active</c:if>" data-bs-interval="5000">
									<div class="carousel-item-title">
										<c:out value="${img.goodsNm }" />
									</div>
									<img src="${img.representativeImageFile.webPath }" class="d-block w-100" >
								</div>
							</a>
						</c:forEach>
					</div>
				</div>
			</div>
		</aside>
		<div class="row g-4 w-100">

			<div class="col-12 col-md">
				<header class="profile-header mb-4">
					<div class="d-flex align-items-center" style="position:relative;">
						<div class="profile-avatar me-3">
							<img src="${profileVO.comuProfileImg}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
								class="rounded-circle">
						</div>
						<div class="profile-nickname display-5 fw-bold"
							id="profileNickname">${profileVO.comuNicknm}</div>
						<sec:authorize access="hasRole('MEMBER')">
							<c:if test="${myComuProfileNo eq profileVO.comuProfileNo}">
								<button class="btn btn-warning btn-sm"
									style="position: absolute; top:0; right:20px;"
									data-comu-profile-no="${profileVO.comuProfileNo}"
									data-comu-nicknm="${profileVO.comuNicknm}"
									data-comu-profile-img="${profileVO.comuProfileImg}"
									data-art-group-no="${profileVO.artGroupNo}"
									data-bs-target="#commProfileModal" data-bs-toggle="modal">í”„ë¡œí•„
									ìˆ˜ì •</button>
							</c:if>
						</sec:authorize>
					</div>
				</header>

				<nav class="profile-tabs mb-4">
					<div class="nav nav-pills nav-fill" id="nav-tab" role="tablist">
						<button class="nav-link active" id="posts-tab"
							data-bs-toggle="tab" data-bs-target="#postsTabContent"
							type="button" role="tab" aria-controls="postsTabContent"
							aria-selected="true" data-tab="posts">í¬ìŠ¤íŠ¸</button>
						<button class="nav-link" id="comments-tab" data-bs-toggle="tab"
							data-bs-target="#commentsTabContent" type="button" role="tab"
							aria-controls="commentsTabContent" aria-selected="false"
							data-tab="comments">ëŒ“ê¸€</button>
					</div>
				</nav>

				<div class="tab-content" id="nav-tabContent">
					<section class="profile-tab-content tab-pane fade show active"
						id="postsTabContent" role="tabpanel" aria-labelledby="posts-tab">
						<c:choose>
							<c:when
								test="${empty profileVO.postList or profileVO.postList[0].comuPostNo eq 0}">
								<div class="alert alert-info text-center py-4" role="alert">ì•„ì§
									ì‘ì„±í•œ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
							</c:when>
							<c:otherwise>
								<div class="posts-list-container">
									<c:forEach items="${profileVO.postList}" var="post">
										<div class="card post-card shadow-sm mb-4"
											id="post-${post.comuPostNo}">
											<div class="card-header bg-white border-0 pb-0 pt-3 px-3">
												<div
													class="d-flex align-items-center justify-content-between">
													<a
														href="${pageContext.request.contextPath}/community/${post.artGroupNo}/profile/${post.writerProfile.comuProfileNo}"
														style="text-decoration: none; color: black;">
														<div class="d-flex align-items-center">
															<img src="${post.writerProfile.comuProfileImg}"
																class="rounded-circle comment-avatar" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
																style="width: 40px; height: 40px; object-fit: cover;">
															<div class="ms-2">
																<div>
																	<strong >${post.writerProfile.comuNicknm}</strong>
																	<c:if test="${post.comuPostMbspYn eq 'Y' }">
																		<span class="ml-2 badge text-bg-purple rounded-pill">ë©¤ë²„ì‰½ì „ìš©</span>
																	</c:if>
																</div>
																<small class="text-muted"> <fmt:formatDate
																		value="${post.comuPostModDate}"
																		pattern="yyyy.MM.dd HH:mm" />
																</small>
															</div>
														</div>
													</a>
													<div class="dropdown">
														<c:if test="${not( post.comuPostMbspYn eq 'Y' and post.writerProfile.comuProfileNo ne myComuProfileNo and (not membershipFlag)) }">
														<button class="btn btn-link text-secondary p-0"
															type="button" data-bs-toggle="dropdown"
															aria-expanded="false">
															<i class="bi bi-three-dots-vertical"></i>
														</button>
														<ul class="dropdown-menu">
															<c:if
																test="${post.writerProfile.comuProfileNo == myComuProfileNo}">
																<li>
																	<button class="dropdown-item postUpdateBtn"
																		data-bs-toggle="modal"
																		data-bs-target="#postUpdateModal"
																		data-comu-post-no="${post.comuPostNo}"
																		data-comu-post-content="${post.comuPostContent}"
																		data-file-group-no="${post.fileGroupNo}">ìˆ˜ì •</button>
																</li>
																<li><button
																		class="dropdown-item text-danger postDeleteBtn"
																		data-comu-post-no="${post.comuPostNo}">ì‚­ì œ</button></li>
															</c:if>
															<c:if test="${post.writerProfile.comuProfileNo != myComuProfileNo}">

																<li>
																	<button class="dropdown-item text-danger postReportBtn"
																			data-comu-post-no="${post.comuPostNo}"
																			data-bs-comuPostNo="${post.comuPostNo}"
																			data-bs-boardType="${post.boardTypeCode}"
																			data-bs-comuProfileNo="${post.writerProfile.comuProfileNo}"
																			data-bs-comuNick="${post.writerProfile.comuNicknm}"
																			data-bs-comuContent="${post.comuPostContent}"
																			data-bs-toggle="modal" data-bs-target="#reportModal"
																			data-bs-selectType="RTTC001"
																	>
																		ì‹ ê³ 
																	</button>
																</li>

															</c:if>
														</ul>
														</c:if>
													</div>
												</div>
											</div>

											<div class="card-body detailBox"
											<c:if test="${not( post.comuPostMbspYn eq 'Y' and post.writerProfile.comuProfileNo ne myComuProfileNo and (not membershipFlag)) }">
												style="cursor: pointer;"
												data-comu-post-no="${post.comuPostNo}"
												data-comu-post-mbsp-yn="${post.comuPostMbspYn}"
												data-comu-profile-no="${post.comuProfileNo}"
												data-bs-toggle="modal" data-bs-target="#postModal"
											</c:if>
											>
												<c:if test="${post.comuPostMbspYn eq 'Y' and post.writerProfile.comuProfileNo ne myComuProfileNo and (not membershipFlag) }">
													<div style="position: absolute; width:100%; height:100%; backdrop-filter:blur(10px); border-radius:10px; z-index:100;"></div>
												</c:if>
												<c:if test="${not empty post.postFiles}">
													<div
														class="post-images-container ${fn:length(post.postFiles) == 1 ? 'single-img' : ''} mb-2">
														<c:forEach items="${post.postFiles}" var="file" begin="0"
															end="1">
															<img src="${file.webPath}"
																class="post-single-img img-fluid rounded" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">
														</c:forEach>
													</div>
												</c:if>
												<p class="card-text post-content post-content-text mb-0">
													<c:if test="${fn:length(post.comuPostContent) > 100}">
                                                    ${fn:substring(post.comuPostContent,0,100)}... <span
															class="text-primary small fw-bold">ë” ë³´ê¸°</span>
													</c:if>
													<c:if test="${fn:length(post.comuPostContent) <= 100}">
                                                    ${post.comuPostContent}
                                                </c:if>
												</p>
											</div>

											<hr class="my-3 mx-3">

											<div
												class="post-meta-bottom d-flex justify-content-start align-items-center px-3 pb-3">
												<span
													class="post-likes text-danger me-4 icon-text <c:if test="${post.likeYn eq 'Y'}">active</c:if>"
													style="cursor: pointer;"
													data-comu-post-no="${post.comuPostNo}"
													data-comu-writer-profile-no="${post.writerProfile.comuProfileNo}"
													data-comu-profile-no="${myComuProfileNo}"
													data-comu-post-mbsp-yn="${post.comuPostMbspYn}"
													<c:if test="${not( post.comuPostMbspYn eq 'Y' and post.writerProfile.comuProfileNo ne myComuProfileNo and (not membershipFlag)) }">
													data-board-type-code="${post.boardTypeCode}"
													data-art-group-no="${post.artGroupNo}"
													data-like-yn="${post.likeYn}"
													</c:if>
													>
													<c:set var="heart" value="bi-heart" />
													<c:if
														test="${post.likeYn eq 'Y' }">
														<c:set var="heart" value="bi-heart-fill" />
													</c:if>
													<i class="bi ${heart}"></i>
													<span class="ms-1 likeCount">${post.comuPostLike}</span>
												</span>
												<span class="post-comments text-info icon-text"
												<c:if test="${not( post.comuPostMbspYn eq 'Y' and post.writerProfile.comuProfileNo ne myComuProfileNo and (not membershipFlag)) }">
													style="cursor: pointer;" data-bs-toggle="modal"
													data-bs-target="#postModal"
													data-comu-post-no="${post.comuPostNo}"
													data-comu-post-mbsp-yn="${post.comuPostMbspYn}"
													data-comu-profile-no="${post.comuProfileNo}"
												</c:if>
												>
													<i class="bi bi-chat"></i> <span class="ms-1">${post.comuPostReplyCount}</span>
												</span>
											</div>
										</div>
									</c:forEach>
								</div>
							</c:otherwise>
						</c:choose>
					</section>

					<section class="profile-tab-content tab-pane fade"
						id="commentsTabContent" role="tabpanel"
						aria-labelledby="comments-tab">
						<c:choose>
							<c:when test="${empty profileVO.replyList}">
								<div class="alert alert-info text-center py-4" role="alert">ì•„ì§
									ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
							</c:when>
							<c:otherwise>
								<c:forEach items="${profileVO.replyList}" var="reply">
									<div class="comment-list-item mb-3">
										<div class="card shadow-sm border-0">
											<div class="card-body detailBox"
												id="reply-${reply.comuReplyNo}" style="cursor: pointer;"
												data-comu-post-no="${reply.comuPostNo}"
												data-comu-reply-no="${reply.comuReplyNo}"
												data-bs-toggle="modal" data-bs-target="#postModal">
												<div
													class="d-flex align-items-start mb-2 bg-light p-2 rounded">
													<span> <i
														class="bi bi-chat-square-text-fill text-primary me-2"></i>
													</span>
													<div class="d-flex flex-column flex-grow-1">
														<span class="text-dark fw-bold mb-1">${reply.comuPostContent}</span>
														<small class="text-muted fw-normal">${reply.postMember.comuNicknm}</small>
													</div>
												</div>
												<hr class="my-2" />
												<div class="p-2">
													<p class="card-text text-secondary mb-0">
														<i class="bi bi-reply-fill text-info me-2"></i>
														${reply.comuReplyContent}
													</p>
												</div>
											</div>
										</div>
									</div>
								</c:forEach>
							</c:otherwise>
						</c:choose>
					</section>
				</div>
			</div>

			<div class="col-lg-4 d-md-block">
				<aside class="apt-sidebar">
		            <div class="sidebar-widget apt-level-widget">
		                <h3>APT í˜„í™©</h3>
		                <div class="apt-floor-display" id="aptFloorDisplay">
		                	<!-- 1. div ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ 10ëª…ë‹¹ 1ì¸µìœ¼ë¡œ ê³„ì‚° (ì •ìˆ˜ ë‚˜ëˆ—ì…ˆ) -->
		                	<c:set var="aptFloor" value="${artistGroupVO.communityVO.totalFan div 10 } "/>

		                	<fmt:formatNumber value="${aptFloor }" pattern="#,###,###"/>ì¸µ
		                </div>


		                <div class="fan-count-tooltip-wrapper"> <p class="fan-count-display">íŒ¬ <span id="sidebarFanCountApprox">
		                	<fmt:formatNumber value="${artistGroupVO.communityVO.totalFan}" pattern="#,###,###"></fmt:formatNumber> </span>ëª…</p>
		                </div>
		            </div>
		            <c:if test="${not empty membershipInfo }">
			            <div class="sidebar-widget membership-widget">
			                <div class="membership-icon">ğŸ›¡ï¸</div>
			                <h3>Membership</h3>
			                <c:choose>
			                	<c:when test="${hasMembership }">
			                		<p><strong>ë©¤ë²„ì‹­ì— ê°€ì…ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</strong></p>
			                		<p>íŠ¹ë³„í•œ ì»¨í…ì¸ ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.</p>
			                		<button class="btn-view-membership" onclick="location.href='${pageContext.request.contextPath}/mypage/memberships'" style="cursor:pointer;">
					                ë‚˜ì˜ ë©¤ë²„ì‹­ ë³´ê¸° <span class="arrow">&gt;</span>
					            </button>
			                	</c:when>
			                	<c:otherwise>
			                		<p>ì§€ê¸ˆ ë©¤ë²„ì‹­ì— ê°€ì…í•˜ê³ , íŠ¹ë³„í•œ í˜œíƒì„ ëˆ„ë ¤ë³´ì„¸ìš”.</p>
					                <button class="btn-join-membership" id="openMembershipModalBtn" data-bs-toggle="modal" data-bs-target="#membershipModalOverlay">
					                    ë©¤ë²„ì‹­ ê°€ì…í•˜ê¸° <span class="arrow">&gt;</span>
					                </button>
			                	</c:otherwise>
			                </c:choose>
			            </div>
					</c:if>
		         </aside>
			</div>
		</div>
	</main>

	<div id="footer-placeholder"></div>
	<div class="modal fade" id="postModal" tabindex="-1"
		aria-labelledby="postModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-fullscreen-custom">
			<button type="button" class="btn-close btn-close-white"
				data-bs-dismiss="modal" aria-label="Close"></button>

			<div class="modal-content">
				<div class="modal-body p-0">
					<div class="d-flex h-100">

						<div class="post-pane" id="postBox"></div>

						<div class="comment-pane">
							<div class="comment-pane-header">
								<strong class="mx-auto" id="replyCount"></strong>
							</div>

							<div class="comment-pane-body" id="replyContent"></div>

							<div class="comment-pane-footer">
								<form id="replyForm">
									<input type="hidden" id="myComuProfileNo"
										name="myComuProfileNo" value="${myComuProfileNo}" /> <input
										type="hidden" id="boardTypeCode" name="boardTypeCode" /> <input
										type="hidden" id="comuPostNo" name="comuPostNo" /> <input
										type="hidden" id="artGroupNo" name="artGroupNo" />
									<div class="input-group">
										<textarea class="form-control" id="comuReplyContent"
											placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." aria-label="ëŒ“ê¸€ ì…ë ¥" rows="1"
											style="resize: none;"></textarea>
										<button class="btn btn-primary" type="button"
											id="commentSubmitBtn">ë“±ë¡</button>
									</div>
								</form>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- ë³¸ë¬¸ ìˆ˜ì • ëª¨ë‹¬ -->
	<div class="modal fade" id="postUpdateModal" tabindex="-1"
		aria-labelledby="postUpdateModal" aria-hidden="true">
		<div class="modal-dialog modal-fullscreen-custom">
			<button type="button" class="btn-close btn-close-white"
				data-bs-dismiss="modal" aria-label="Close"></button>

			<div class="modal-content">
				<div class="modal-body p-0">
					<div class="h-100">
						<div class="post-pane" id="postUpdateModalContentBox">
							<form id="updateForm">
								<div class="p-3">
									<h4>ê²Œì‹œë¬¼ ìˆ˜ì •</h4>
									<input type="hidden" name="comuPostNo" id="updatePostNo">
									<input type="hidden" name="fileGroupNo" id="fileGroupNo">
									<div class="mb-3">
										<label for="updatePostContent" class="form-label">ë‚´ìš©</label>
										<div id="previewContainer"></div>
										<textarea class="form-control" id="updatePostContent"
											name="comuPostContent" rows="10"></textarea>
									</div>
									<div class="form-check form-check-reverse mb-3">
										<label class="form-check-label" for="checkMbspYn"> ë©¤ë²„ì‰½ ì „ìš© ì—¬ë¶€</label>
										<input class="form-check-input" type="checkbox"
											value="" name="comuPostMbspYn" id="checkMbspYn">
									</div>
									<div class="mb-3">
										<label for="updatePostFiles" class="form-label">ì²¨ë¶€íŒŒì¼</label> <input
											type="file" class="form-control" id="updatePostFiles"
											name="files" accept="image/*" multiple />
									</div>

									<div class="d-flex justify-content-end gap-2">
										<button type="button" class="btn btn-success"
											id="savePostUpdateBtn">ì €ì¥</button>
										<button type="button" class="btn btn-secondary"
											data-bs-toggle="modal" id="cancelPostUpdateBtn">ì·¨ì†Œ</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- ì‹ ê³ ëª¨ë‹¬ -->
	<div class="modal fade" id="reportModal" tabindex="-1"
		aria-labelledby="reportModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div class="modal-header bg-light">
					<h5 class="modal-title primary fw-bold" id="reportModalLabel">ì‹ ê³ í•˜ê¸°</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>

				<div class="modal-body pb-0">
					<form id="reportForm" method="post">
						<input type="hidden" name="targetComuPostNo" id="targetComuPostNo">
						<input type="hidden" name="targetBoardTypeCode"
							id="targetBoardTypeCode"> <input type="hidden"
							name="targetComuReplyNo" id="targetComuReplyNo" value="">
						<input type="hidden" name="artGroupNo" id="reportArtGroupNo">
						<input type="hidden" name="targetComuProfileNo"
							id="targetComuProfileNo"> <input type="hidden"
							name="reportTargetTypeCode" id="reportTargetTypeCode">

						<div class="mb-4">
							<label class="form-label fw-bold mb-2">ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:</label>
							<div class="radioArea d-flex gap-2 flex-wrap ">
								<!--
					<div class="form-check">
		                <input class="btn-check" type="radio" name="reportReasonCode" id="\${reasonCode.commCodeDetNm}" value="\${reasonCode.commCodeDetNo}">
		                <label class="btn btn-outline-primary" for="\${reasonCode.commCodeDetNm}">\${reasonCode.description}</label>
		            </div>
				 -->
							</div>
						</div>

						<div class="mb-3">
							<label for="targetNick" class="form-label text-muted">ì‹ ê³ 
								ì²˜ë¦¬ ëŒ€ìƒ:</label> <input type="text" class="form-control" id="targetNick"
								disabled />
						</div>

						<div class="mb-4">
							<label for="targetContent" class="form-label text-muted">ì²˜ë¦¬
								ë‚´ìš©:</label>
							<textarea class="form-control" id="targetContent" rows="3"
								disabled></textarea>
						</div>
					</form>
				</div>

				<div class="modal-footer justify-content-end border-top-0">
					<button type="button" class="btn btn-primary px-4"
						id="reportSendBtn">ì‹ ê³ í•˜ê¸°</button>
					<button type="button" class="btn btn-outline-secondary px-4"
						data-bs-dismiss="modal">ì·¨ì†Œ</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ -->
	<div class="modal fade" id="commProfileModal" tabindex="-1"
		aria-labelledby="nicknameModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="commProfileModalLabel">ì»¤ë®¤ë‹ˆí‹° í”„ë¡œí•„ì„
						ë§Œë“¤ì–´ë³´ì„¸ìš”!</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3 d-flex justify-content-center align-items-center">
						<div class="profile-img-box" id="previewImgBox"
							style="width: 100px; height: 100px; border-radius: 50%; cursor: pointer; overflow: hidden;">
							<img alt="í”„ë¡œí•„ì´ë¯¸ì§€"
								src="${pageContext.request.contextPath}/upload/profile/base/defaultImg.png"
								id="previewImg" style="height: 100px; width:100%;">
						</div>
					</div>
					<div class="mb-3">
						<label for="comuNicknm" class="form-label">ë‹‰ë„¤ì„</label> <input
							type="text" class="form-control" id="comuNicknm"
							name="comuNicknm" maxlength="12" placeholder="12ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”">
					</div>

					<div class="mb-3">
						<label for="imgFile" class="form-label">í”„ë¡œí•„ ì´ë¯¸ì§€</label> <input
							class="form-control" type="file" id="imgFile" name="imgFile"
							accept="image/*">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">ë‹«ê¸°</button>
					<button type="button" class="btn btn-primary" id="profileSubmitBtn">ì™„ë£Œ</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ë©¤ë²„ì‰½ ê°€ì… -->
	<div class="modal fade" id="membershipModalOverlay" tabindex="-1" aria-labelledby="membershipModalLabel" aria-hidden="true"
     	data-artist-group-no="${membershipInfo.artGroupNo }"
     	data-membership-goods-no="${artistGroupVO.membershipGoodsNo}">
        <div class="modal-dialog modal-xl">
	        <div class="modal-content membership-modal">
	            <button class="modal-close-btn" id="closeMembershipModalBtn" aria-label="Close" data-bs-dismiss="modal">&times;</button>
	            <div class="modal-header">
	                <h2>${membershipInfo.mbspNm }</h2>
	                <p class="membership-duration">ì´ìš© ê¸°ê°„: ê²°ì œì¼ë¡œë¶€í„° ${membershipInfo.mbspDuration}ì¼</p>
	            </div>
	            <div class="modal-body">
	                <div class="membership-main-image">
	                </div>
	                <h3>ì£¼ìš” í˜œíƒ ì•ˆë‚´</h3>
	                <ul class="modal-benefits-list">
	                    <li>âœ”ï¸ ë©¤ë²„ì‹­ ì „ìš© ì½˜í…ì¸  ì´ìš© ê°€ëŠ¥ (ì¼ë¶€ ë¸”ëŸ¬ ì²˜ë¦¬ëœ ì½˜í…ì¸  ì¦‰ì‹œ í•´ì œ!)</li>
	                    <li>ğŸ—“ï¸ APT ë©”ì¸ ìƒë‹¨ì—ì„œ ì•„í‹°ìŠ¤íŠ¸ êµ¬ë…ì¼ D-Day í™•ì¸</li>
	                    <li>ğŸ¤ ì½˜ì„œíŠ¸/íŒ¬ë¯¸íŒ… ì„ ì˜ˆë§¤ ë° íŠ¹ë³„ ì´ë²¤íŠ¸ ì°¸ì—¬ ê¸°íšŒ</li>
	                    <li>ğŸ í•œì •íŒ ë©¤ë²„ì‹­ í‚¤íŠ¸ ì œê³µ (ë³„ë„ êµ¬ë§¤ ë˜ëŠ” ë“±ê¸‰ì— ë”°ë¼)</li>
	                </ul>

	                <h3>ì´ìš© ì•ˆë‚´ ë° ìœ ì˜ì‚¬í•­</h3>
	                <ul class="modal-notes-list">
	                    <li>ë³¸ ë©¤ë²„ì‹­ì€ ë¹„ìš©ì„ ì„ ì§€ë¶ˆí•˜ì—¬ ì´ìš©í•˜ëŠ” ìœ ë£Œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</li>
	                    <li>ë©¤ë²„ì‹­ì€ ì•„í‹°ìŠ¤íŠ¸(ì†”ë¡œ, ê·¸ë£¹)ë³„ë¡œ ë³„ë„ ìš´ì˜ë˜ë©°, ë³¸ ë©¤ë²„ì‹­ì€ [${artistGroupVO.artGroupNm }] ì „ìš©ì…ë‹ˆë‹¤.</li>
	                    <li>ê·¸ë£¹ ë‚´ ì†”ë¡œ í™œë™ ë©¤ë²„ ë°œìƒ ì‹œ, í•´ë‹¹ ë©¤ë²„ì˜ ì»¤ë®¤ë‹ˆí‹°ëŠ” ë³„ë„ ìƒì„±/ìš´ì˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
	                    <li>ìì„¸í•œ ë‚´ìš©ì€ êµ¬ë§¤ í˜ì´ì§€ì˜ ì•½ê´€ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.</li>
	                </ul>
	            </div>
	            <div class="modal-footer">
	                <div class="membership-price">â‚© <fmt:formatNumber value="${membershipInfo.mbspPrice}" pattern="###,###"></fmt:formatNumber> <span class="vat-notice">(VAT í¬í•¨)</span></div>
	                <button class="btn-modal-purchase" id="goToPurchasePageBtn">ë©¤ë²„ì‹­ êµ¬ë§¤í•˜ê¸°</button>
	            </div>
	        </div>
        </div>
    </div>
	<div id="footer">
        <!-- FOOTER -->
        <jsp:include page="/WEB-INF/views/modules/communityFooter.jsp" />
        <script src="${pageContext.request.contextPath}/resources/js/pages/communityFooter.js"></script>
        <!-- FOOTER END -->
    </div>
</body>
<script type="text/javascript">

// íƒ­ ì „í™˜
document.querySelectorAll('.profile-tabs .tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.profile-tabs .tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('postsTab').style.display = this.dataset.tab === 'posts' ? 'block' : 'none';
    document.getElementById('commentsTab').style.display = this.dataset.tab === 'comments' ? 'block' : 'none';
  });
});


//ë©¤ë²„ì‹­ ê°€ì…í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
document.addEventListener('DOMContentLoaded', function () {
	// ë©¤ë²„ì‹­ êµ¬ë§¤í•˜ê¸° ë²„íŠ¼
	const mbspBtn = document.getElementById('openMembershipModalBtn');
	const membershipModal = document.getElementById('membershipModalOverlay');
	const closeModalBtn = document.querySelector('#closeMembershipModalBtn');
	const goToPurchasePageBtn = document.getElementById('goToPurchasePageBtn');
	console.log("${artistGroupVO.membershipGoodsNo}")
	let artistGroupNo = membershipModal.dataset.artistGroupNo;
	let membershipGoodsNo = parseInt(membershipModal.dataset.membershipGoodsNo);
	console.log(membershipModal.dataset.membershipGoodsNo);
	// ê²°ì œ êµ¬í˜„
	goToPurchasePageBtn.addEventListener('click', function() {
		requestKakaoPaySubscription(membershipGoodsNo, artistGroupNo);
	});

	function requestKakaoPaySubscription(goodsNo, artistGroupNo) {
		// 1. ê²°ì œí•  ë©¤ë²„ì‹­ ìƒí’ˆ ì •ë³´ ì •ì˜
		const orderData = {
				orderItems: [
					{
						goodsNo: goodsNo,
						goodsOptNo: null,
						qty: 1,
						goodsNm: "DDTOWN ì•„í‹°ìŠ¤íŠ¸ ë©¤ë²„ì‹­",
					}
				],
				singleGoodsName: "DDTOWN ì•„í‹°ìŠ¤íŠ¸ ë©¤ë²„ì‹­",
				totalAmount: "${membershipInfo.mbspPrice}",
				isFromCart: false,
				orderTypeCode: "OTC001", // ë©¤ë²„ì‹­
				orderPayMethodNm: "ì¹´ì¹´ì˜¤í˜ì´",
				orderRecipientNm: "${user.memberVO.peoName}",
	            orderRecipientPhone: "${user.memberVO.peoPhone}", // ìœ íš¨í•˜ì§€ ì•Šì€ ì „í™”ë²ˆí˜¸
	            orderZipCode: "${user.memberVO.memZipCode}", // ë”ë¯¸ ìš°í¸ë²ˆí˜¸
	            orderAddress1: "${user.memberVO.memAddress1}", // ë”ë¯¸ ì£¼ì†Œ
	            orderAddress2: "${user.memberVO.memAddress2}", // ë”ë¯¸ ìƒì„¸ ì£¼ì†Œ
	            orderEmail: "${user.memberVO.peoEmail}", // ë”ë¯¸ ì´ë©”ì¼
	            orderMemo: `ë©¤ë²„ì‹­ ìƒí’ˆ êµ¬ë§¤ - ì•„í‹°ìŠ¤íŠ¸ ê·¸ë£¹ ë²ˆí˜¸ : \${artistGroupNo}`
		};

		console.log("ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„ ìš”ì²­ ë°ì´í„° : ", orderData);

		const headers = {
				'Content-Type':'application/json',
				'${_csrf.headerName}' : '${_csrf.token}'
		};

		// 2. ë°±ì—”ë“œ API í˜¸ì¶œ
		fetch('/goods/order/pay/ready', {
			method: 'POST',
			headers: headers,
			body: JSON.stringify(orderData)
		})
		.then(response => {
			if(!response.ok) {
				return response.text().then(errorMessage => {
					console.error("ë°±ì—”ë“œ ì˜¤ë¥˜ ì‘ë‹µ: ", errorMessage);
				});
			}
			return response.json();
		})
		.then(data => {
			const nextRedirectUrl = data.next_redirect_pc_url;

			if(nextRedirectUrl) {
				console.log("ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸: ", nextRedirectUrl);
				window.location.href = nextRedirectUrl;
				localStorage.setItem("url",window.location.href);
			} else {
				console.log("ì¹´ì¹´ì˜¤í˜ì´ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°: ", data);
			}
		})
		.catch(error => {
			console.log("ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜ˆì™¸ ë°œìƒ: ", error.message);
		})
	};

});


$(function(){
	const postModal = $("#postModal"); // í•´ë‹¹ í¬ìŠ¤íŠ¸ í˜¹ì€ ëŒ“ê¸€ì´ë‹¬ë¦° ì›ë³¸ê¸€ì„ ë³´ì—¬ì¤„ ëª¨ë‹¬

	const hash = window.location.hash;

	if(hash && hash.startsWith("#post-")){
		let comuPostNo = hash.substring(6);
		displayPostModal(comuPostNo)
		postModal.modal("show");
	}

	// ë‹‰ë„¤ì„ ë° í”„ë¡œí•„ ì‚¬ì§„ ìˆ˜ì •
	const profileModal = $("#commProfileModal")
	const previewImgBox = $("#previewImgBox");
	const imgFile = $("#imgFile");
	const previewImg = $("#previewImg")
	let file = null;
	profileModal.on("show.bs.modal",function(e){
		let target = e.relatedTarget
		let comuProfileNo = target.getAttribute("data-comu-profile-no");
		let comuNicknm = target.getAttribute("data-comu-nicknm");
		let comuProfileImg = target.getAttribute("data-comu-profile-img");
		let artGroupNo = target.getAttribute("data-art-group-no");

		previewImg.attr("src",comuProfileImg);
		$("#comuNicknm").val(comuNicknm);
		$("#comuProfileNo").val(comuProfileNo);
		profileModal.data("dataInfo",{
			comuProfileNo,comuProfileImg,artGroupNo
		})
	})

	// í”„ë¡œí•„ ì´ë¯¸ì§€ ë°•ìŠ¤ í´ë¦­ì‹œ ì´ë¯¸ì§€íŒŒì¼ ì„ íƒ
	previewImgBox.on("click",function(){
		imgFile.click();
	})

	// í”„ë¡œí•„ ì´ë¯¸ì§€ ì´ë²¤íŠ¸
	imgFile.on("change",function(){
		let dataInfo = profileModal.data("dataInfo")
		let {comuProfileImg} = dataInfo
// 		const defaultPath = "${pageContext.request.contextPath}/upload/profile/base/defaultImg.png";
		const maxSize = 2 * 1024 * 1024;
		file = this.files[0];

		if(file == null){
			previewImg.attr("src", comuProfileImg);
			return false;
		}

		if(file.size > maxSize){
			sweetAlert("error", "íŒŒì¼ ì‚¬ì´ì¦ˆëŠ” 2MB ë¯¸ë§Œìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”!");
			$(this).val("");
			file = null;
			previewImg.attr("src", comuProfileImg);
			return false;
		}

		if(!file.type.startsWith("image/")){
			sweetAlert("error", "ì´ë¯¸ì§€íŒŒì¼ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”");
			$(this).val("");
			file = null;
			previewImg.attr("src", comuProfileImg);
			return false;
		}

		let fileReader = new FileReader();
		fileReader.onload = function(e){
			previewImg.attr("src", e.target.result);
		};

		fileReader.readAsDataURL(file);
	})

	$("#profileSubmitBtn").on("click",function(){
		let dataInfo = profileModal.data("dataInfo")
		let {comuProfileImg,comuProfileNo,artGroupNo} = dataInfo
		let comuNicknm = $("#comuNicknm").val();
		if(comuNicknm == null || comuNicknm.trim() == ''){
			sweetAlert("error","ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
			return false;
		}
		if(comuNicknm.length > 12){
			sweetAlert("error","ë‹‰ë„¤ì„ì€ 12ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”");
			return false;
		}

		let formData = new FormData();
		formData.append("comuProfileNo",comuProfileNo);
		formData.append("comuNicknm",comuNicknm);
		formData.append("comuProfileImg",comuProfileImg);
		formData.append("artGroupNo",artGroupNo);
		if(file != null){
			formData.append("imgFile", file);
		}

		$.ajax({
			url : "/api/community/updateProfile",
			type : "post",
			processData : false,
			contentType : false,
			data : formData,
			beforeSend : function(xhr){
				xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}')
			},
			success : function(res){
				sweetAlert("success","í”„ë¡œí•„ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤").then(res =>{
					location.reload();
				});

			},
			error : function(err){
				console.log(err);
				sweetAlert("error","í”„ë¡œí•„ ë³€ê²½ ë„ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
			}
		})
	})

	profileModal.on('hide.bs.modal',function(){
		previewImg.attr("src","");
		$("#comuNicknm").val("");
		$("#comuProfileNo").val("");
		profileModal.removeData("dataInfo")
	})


	const postUpdateModal = $("#postUpdateModal"); // í•´ë‹¹ í¬ìŠ¤íŠ¸ í˜¹ì€ ëŒ“ê¸€ì´ë‹¬ë¦° ì›ë³¸ê¸€ì„ ë³´ì—¬ì¤„ ëª¨ë‹¬
	const detailBox = $(".detailBox"); // ìì‹ ì´ ì“´ ê¸€ì´ë‚˜ ëŒ“ê¸€ div
	const commentSubmitBtn = $("#commentSubmitBtn");

	postModal.on("show.bs.modal",function(e){
		let comuPostNo = e.relatedTarget.getAttribute("data-comu-post-no");
		let comuPostMbspYn = e.relatedTarget.getAttribute("data-comu-post-mbsp-yn");// ë©¤ë²„ì‰½ ì „ìš© ì—¬ë¶€
		let comuProfileNo = e.relatedTarget.getAttribute("data-comu-profile-no");//í•´ë‹¹ í¬ìŠ¤íŠ¸ì‘ì„± ì»¤ë®¤ë²ˆí˜¸
		let membershipFlag = "${membershipFlag}"
		let myComuProfileNo = "${myComuProfileNo}"

		console.log(comuPostMbspYn,comuProfileNo,membershipFlag,myComuProfileNo)
		if(comuPostMbspYn == 'Y' && comuProfileNo != myComuProfileNo && !membershipFlag){
			sweetAlert("warning","ë©¤ë²„ì‰½ ì „ìš© ê²Œì‹œê¸€ì…ë‹ˆë‹¤.");
			return;
		}

		displayPostModal(comuPostNo);
	});

	// ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
	function padTwoDigits(num) {
	  return num.toString().padStart(2, "0");
	}

	/**
	* ì‹œê°„.ë¶„.ì´ˆ í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ê¸° (ì˜ˆ: 2024.01.01 10:30)
	*/
	function getFormattedDate(time) {
	  const date = new Date(time);

	  return (
	    [
	      date.getFullYear(),
	      padTwoDigits(date.getMonth() + 1),
	      padTwoDigits(date.getDate()),
	    ].join(".") +
	    " " +
	    [
	      padTwoDigits(date.getHours()),
	      padTwoDigits(date.getMinutes())
	    ].join(":")
	  );
	}


	function reportModalInfo(info){

		let postNo = info.postNo;
		let boardType = info.boardType;
		let comuProfileNo = info.comuProfileNo;
		let reasonCodeList = info.reasonCode;
		let reportTarCode = info.reportTarCode;
		let artGroupNo = "${artGroupNo}"; // JSP ELë¡œ ë°”ë¡œ ê°’ ê°€ì ¸ì˜¤ê¸°
		let comuReplyNo = info.comuReplyNo;

		console.log("artGroupNo from reportModalInfo:", artGroupNo);

		let targetNick = info.comuNick;
		let targetContent = info.comuContent;

		let radioHtml = ``;
		for(let i=0; i<reasonCodeList.length; i++){
			let reasonCode = reasonCodeList[i];
			radioHtml += `
				<div class="form-check">
					<input class="btn-check" type="radio" name="reportReasonCode" id="\${reasonCode.commCodeDetNm}" value="\${reasonCode.commCodeDetNo}" autocomplete="off">
					<label class="btn btn-sm btn-outline-primary" for="\${reasonCode.commCodeDetNm}">\${reasonCode.description}</label>
	            </div>
			`;
		}

		$(".radioArea").html(radioHtml);

		$("#targetNick").val(targetNick);
		$("#targetContent").html(targetContent);

		$("#targetComuPostNo").val(postNo);
		$("#targetBoardTypeCode").val(boardType);
		$("#reportArtGroupNo").val(artGroupNo);
		$("#targetComuProfileNo").val(comuProfileNo);
		$("#reportTargetTypeCode").val(reportTarCode);

		if(comuReplyNo != null){
			$("#targetComuReplyNo").val(comuReplyNo);
		}

		console.log("íƒ€ê²Ÿ ì½”ë“œ (reportModalInfo): ", reportTarCode);
	}

	/**
	* ê²Œì‹œê¸€ ëª¨ë‹¬ì„ ë„ìš°ê³  ë‚´ìš© ë¶ˆëŸ¬ì˜¤ëŠ” ê³µí†µ í•¨ìˆ˜
	*/
	function displayPostModal(comuPostNo){
		$.ajax({
			url : `/api/community/getPost?comuPostNo=\${comuPostNo}&myComuProfileNo=${myComuProfileNo}`,
			type : "get",
			success : function(postVO){
// 				console.log("displayPostModal success", postVO);
				$("#boardTypeCode").val(postVO.boardTypeCode);
				$("#comuPostNo").val(comuPostNo);
				$("#artGroupNo").val(postVO.artGroupNo);
				let {artGroupNo, comuPostContent, writerProfile,
					comuPostLike, comuPostReplyCount, comuPostReplyList,
					postFiles, comuPostRegDate, likeYn, comuProfileNo,
					comuPostModDate, fileGroupNo, boardTypeCode, comuPostMbspYn} = postVO;


				// ë³¸ë¬¸ ì˜ì—­
				let postHtml = ``;
				postHtml = `
					<div class="post-pane-header">
						<a href="${pageContext.request.contextPath}/community/\${artGroupNo}/profile/\${writerProfile.comuProfileNo}" style="text-decoration:none; color:black;">
	                	<div class="d-flex align-items-center">
	                        <img src="\${writerProfile.comuProfileImg}" class="rounded-circle comment-avatar">
	                        <div class="ms-2">
	                        	<div>
		                            <strong>\${writerProfile.comuNicknm}</strong>
		             			`;
	             			if(comuPostMbspYn == 'Y'){
								postHtml += `
		                            <span class="ml-2 badge text-bg-purple rounded-pill">ë©¤ë²„ì‰½ì „ìš©</span>
								`;
	             			}
	                        postHtml +=	`
	                        	</div>
	                            <small class="text-muted">\${getFormattedDate(comuPostModDate)}</small>
	                        </div>
	                	</div>
	                	</a>
	                	<div class="dropdown">
					        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
					            <i class="bi bi-three-dots-vertical"></i>
					        </button>
					        <ul class="dropdown-menu"
					`;
				if(writerProfile.comuProfileNo == "${myComuProfileNo}"){
					postHtml += `
						<li><button class="dropdown-item postUpdateBtn" data-bs-toggle="modal"
							data-bs-target="#postUpdateModal"
							data-comu-post-no="\${comuPostNo}"
							data-comu-post-content="\${comuPostContent}"
							data-file-group-no="\${fileGroupNo}"
							>ìˆ˜ì •</button></li>
			            <li><button class="dropdown-item text-danger postDeleteBtn" data-comu-post-no="\${comuPostNo}" >ì‚­ì œ</button></li>
					`;
				}else{
					postHtml += `
						<li><button class="dropdown-item text-danger postReportBtn" data-comu-post-no="\${comuPostNo}"
							data-bs-toggle="modal"
							data-bs-target="#reportModal"
							data-bs-comuPostNo="\${comuPostNo}"
							data-bs-boardType="\${boardTypeCode}"
							data-bs-comuProfileNo="\${writerProfile.comuProfileNo}"
							data-bs-comuNick="\${writerProfile.comuNicknm}"
							data-bs-comuContent="\${comuPostContent}"
							data-bs-selectType="RTTC001"
							>ì‹ ê³ </button>
						</li>
					`;
				}
				postHtml += `
					        </ul>
					    </div>
	                </div>
	                <div class="post-pane-body" style="padding:10px;">
	                `;
           		// íŒŒì¼ ì»¨í…Œì´ë„ˆëŠ” ì´ì œ ì´ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì§€ì—­ë³€ìˆ˜ë¡œ ì‚¬ìš©. ì „ì—­ ë³€ìˆ˜ Mapì€ ë¶ˆí•„ìš”.
	            if(postFiles != null && postFiles.length > 0){
	            	for(let i in postFiles){
	            		let file = postFiles[i];
// 	            		console.log("post file:", file);
	            		postHtml += `
	            			<img src="\${file.webPath}" alt="\${file.fileOriginalNm}" width="80%" style="border-radius:10px;">
	            		`;
	            	}
	            }
	            postHtml += `
	                	<p>\${comuPostContent}<p>
	                </div>
	                <div class="post-pane-footer">
	                `;
	            if(likeYn == 'Y'){
	            postHtml += `
					    <button type="button" class="btn btn-like active" data-comu-post-no="\${comuPostNo}" data-comu-profile-no="${myComuProfileNo}"
					    data-board-type-code="\${boardTypeCode}" data-art-group-no="\${artGroupNo}" data-like-yn="\${likeYn}" id="likeButton">
					        <i class="bi bi-heart-fill"></i>
					        <span id="likeCount">\${comuPostLike}</span>
					    </button>
	            	`;
	            }else{
	            	postHtml += `
					    <button type="button" class="btn btn-like" data-comu-post-no="\${comuPostNo}" data-comu-profile-no="${myComuProfileNo}"
					    	data-board-type-code="\${boardTypeCode}" data-art-group-no="\${artGroupNo}" data-like-yn="\${likeYn}" id="likeButton">
					        <i class="bi bi-heart"></i>
					        <span id="likeCount">\${comuPostLike}</span>
					    </button>
	            	`;
	            }
	            postHtml +=`
					</div>
				`;

				$("#postBox").html(postHtml);

				$("#replyCount").html("ë‹µê¸€ " + comuPostReplyCount + "ê°œ");

				// ëŒ“ê¸€ ì˜ì—­
				let replyHtml = ``;
				for(let reply of comuPostReplyList){
// 					console.log("reply:", reply)
					let {comuReplyContent, boardTypeCode:replyBoardTypeCode, comuReplyRegDate, comuReplyNo, replyMember, comuReplyModDate, comuReplyDelYn} = reply;
					let {comuProfileImg, comuNicknm, comuProfileNo:replyComuProfileNo} = replyMember;
						replyHtml += `
							<div class="comment-item">
							<a href="${pageContext.request.contextPath}/community/\${artGroupNo}/profile/\${replyComuProfileNo}" style="text-decoration:none; color:black;">
								<img src="\${comuProfileImg}" class="rounded-circle comment-avatar">
							</a>
				            <div class="comment-main-wrapper">
				            	<div class="comment-header">
									<a href="${pageContext.request.contextPath}/community/\${artGroupNo}/profile/\${replyComuProfileNo}" style="text-decoration:none; color:black;">
				            			<strong>\${comuNicknm}</strong>
									</a>
	            		`;
						replyHtml +=`
		            		<div class="dropdown">
						        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
						            <i class="bi bi-three-dots-vertical"></i>
						        </button>
						        <ul class="dropdown-menu">
			          	`;
						if("${myComuProfileNo}" == replyComuProfileNo){
							replyHtml += `
					            		<li><button class="dropdown-item text-danger replyDeleteBtn" data-comu-post-no="\${comuPostNo}" data-comu-reply-no="\${comuReplyNo}">ì‚­ì œ</button></li>
					            	</ul>
					            </div>
							`;
						}else{
							replyHtml += `
										<li><button class="dropdown-item text-danger replyReportBtn" data-comu-post-no="\${comuPostNo}" data-comu-reply-no="\${comuReplyNo}"
											data-bs-toggle="modal"
											data-bs-target="#reportModal"
											data-bs-comuPostNo="\${comuPostNo}"
											data-bs-comuReplyNo="\${comuReplyNo}"
											data-bs-boardType="\${replyBoardTypeCode}"
											data-bs-comuProfileNo="\${replyComuProfileNo}"
											data-bs-comuNick="\${comuNicknm}"
											data-bs-comuContent="\${comuReplyContent}"
											data-bs-selectType="RTTC002" >ì‹ ê³ </button></li>
									</ul>
					            </div>
							`;
						}
						replyHtml += `
						        </div>
						        <div class="comment-body-text">
					        	<p>\${comuReplyContent}</p>
					        	<small class="text-muted">\${getFormattedDate(comuReplyModDate)}</small>
							        </div>
							    </div>
							</div>
						`;
					}
				$("#replyContent").html(replyHtml);
				$("#commentSubmitBtn").data("comu-post-no",comuPostNo);
				postModal.data("replyCountInfo",{
					comuPostNo : comuPostNo,
					replyCount : comuPostReplyCount
				});
			},
			error : function(err){
				console.log(err);
				sweetAlert("error","ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
			}
		});

		// ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œ URL í•´ì‹œë¥¼ ì—…ë°ì´íŠ¸
		window.history.replaceState("", document.title, window.location.pathname + window.location.search + "#post-" + comuPostNo);
	}

	/**
	* ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ì— ë°ì´í„° ì£¼ì… í•¨ìˆ˜
	*/
	function displayPostUpdateModal(comuPostNo){
		$.ajax({
			url : `/api/community/getUpdatePost?comuPostNo=\${comuPostNo}`,
			type : "get",
			success : function(postVO){
				console.log("displayPostUpdateModal success", postVO);
				let {artGroupNo, comuPostContent,postFiles,fileGroupNo, comuPostMbspYn} = postVO;

				// ë³¸ë¬¸ ì˜ì—­
				let postHtml = `
					<form id="updateForm">
	                    <div class="p-3">
	                        <h4>ê²Œì‹œë¬¼ ìˆ˜ì •</h4>
	                        <input type="hidden" name="comuPostNo" value="\${comuPostNo}">
	                        <input type="hidden" name="fileGroupNo" value="\${fileGroupNo}">
	                        <div class="mb-3">
	                            <label for="updatePostContent" class="form-label">ë‚´ìš©</label>
	                            <div id="previewContainer">
                           `;
                           if(postFiles != null && postFiles.length > 0){
								for(let file of postFiles){
								postHtml += `
		                        	   <div style="position:relative; display: inline-block;">
				    						<img src="\${file.webPath}" height="120px"/>
				    						<i class="bi bi-x-lg deletePostImg" data-attach-detail-no='\${file.attachDetailNo}' style="position:absolute; top:0; right:0; cursor: pointer; color:red;"></i>
				    					</div>
									`;
								}
                           }
                           postHtml += `
			                            </div>
			                            <textarea class="form-control" id="updatePostContent" name="comuPostContent" rows="10">\${comuPostContent}</textarea>
			                        </div>
			                        <div class="form-check mb-3 d-flex" style="padding-left:0px;">
				                        <label class="form-check-label" for="checkMbspYn"> ë©¤ë²„ì‰½ ì „ìš© ì—¬ë¶€</label>
				                        <input class="form-check-input" type="checkbox" name="comuPostMbspYn" id="checkMbspYn" \${comuPostMbspYn == 'Y' ? 'checked' : ''} style="margin-left:20px;">
			                        </div>
			                        <div class="mb-3">
			                            <label for="updatePostFiles" class="form-label">ì²¨ë¶€íŒŒì¼</label>
			                            <input type="file" class="form-control" id="updatePostFiles" name="files" accept="image/*" multiple/>
			                        </div>

			                        <div class="d-flex justify-content-end gap-2">
			                            <button type="button" class="btn btn-success" id="savePostUpdateBtn">ì €ì¥</button>
			                            <button type="button" class="btn btn-secondary" id="cancelPostUpdateBtn" data-bs-dismiss="modal">ì·¨ì†Œ</button>
			                        </div>
			                    </div>
			            	</form>
		                   `;
				$("#postUpdateModalContentBox").html(postHtml);
			},
			error : function(err){
				console.log(err);
				sweetAlert("error","ê²Œì‹œê¸€ ìˆ˜ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
			}
		})
	}

	// ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— ì—…ë°ì´íŠ¸ ìš”ì²­
	function likeUpdate(data){
		console.log("likeUpdate data:", data);

		$.ajax({
			url : "/api/community/post/likeUpdate",
			type : "post",
			contentType : "application/json; charset=utf-8",
			data : JSON.stringify(data),
			beforeSend : function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
			},
			success : function(res){
				console.log("Like update success:", res);
				// ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ í›„ ë³„ë„ì˜ í™”ë©´ ê°±ì‹ ì€ ê° í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬ë¨
			},
			error : function(err){
				console.error("Like update error:", err);
				sweetAlert("error","ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			}
		})
	}

	// jQuery DOM Ready ë¸”ë¡
	$(function(){
		const postModal = $("#postModal"); // í•´ë‹¹ í¬ìŠ¤íŠ¸ í˜¹ì€ ëŒ“ê¸€ì´ë‹¬ë¦° ì›ë³¸ê¸€ì„ ë³´ì—¬ì¤„ ëª¨ë‹¬
		const postUpdateModal = $("#postUpdateModal"); // í•´ë‹¹ í¬ìŠ¤íŠ¸ í˜¹ì€ ëŒ“ê¸€ì´ë‹¬ë¦° ì›ë³¸ê¸€ì„ ë³´ì—¬ì¤„ ëª¨ë‹¬
		const detailBox = $(".detailBox"); // ìì‹ ì´ ì“´ ê¸€ì´ë‚˜ ëŒ“ê¸€ div
		const commentSubmitBtn = $("#commentSubmitBtn");

		// í˜ì´ì§€ ë¡œë“œ ì‹œ URL í•´ì‹œ í™•ì¸í•˜ì—¬ ê²Œì‹œê¸€ ëª¨ë‹¬ ìë™ ë„ìš°ê¸° (ìƒˆë¡œìš´ ê¸°ëŠ¥)
		if (window.location.hash) {
            const hash = window.location.hash;
            console.log("Detected hash on load:", hash);

            if (hash.startsWith("#post-")) {
                const comuPostNo = hash.substring(6);
                if (!isNaN(comuPostNo) && comuPostNo.length > 0) {
                    console.log("Opening post modal for postNo from hash:", comuPostNo);
                    displayPostModal(comuPostNo);
                }
            }
        }

		// ê¸°ì¡´ ê²Œì‹œë¬¼ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ë„ìš°ê¸°)
		// displayPostModal í•¨ìˆ˜ê°€ `show.bs.modal` í•¸ë“¤ëŸ¬ ë‚´ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ,
		// detailBox í´ë¦­ ì´ë²¤íŠ¸ëŠ” ì§ì ‘ displayPostModalì„ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½í•˜ì—¬ ì¤‘ë³µ ë¡œì§ ì œê±° ë° ëª…í™•í™”.
// 		detailBox.on("click", function() {
//             let comuPostNo = $(this).data("comu-post-no");
//             displayPostModal(comuPostNo);
//         });

		// ê²Œì‹œê¸€ ëª¨ë‹¬ì´ ë„ì›Œì§ˆ ë•Œ (Bootstrap show.bs.modal ì´ë²¤íŠ¸)
		// ì´ ë¶€ë¶„ì€ displayPostModal í•¨ìˆ˜ê°€ ì´ë¯¸ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ê´€ë ¨ ë¡œì§ ì œê±°
		postModal.on("show.bs.modal",function(e){
			// ê¸°ì¡´ì— ì´ ì•ˆì— ìˆë˜ displayPostModal í˜¸ì¶œ ë¡œì§ì€ detailBox í´ë¦­ ì‹œ ì§ì ‘ í˜¸ì¶œí•˜ê±°ë‚˜,
			// URL í•´ì‹œ ì²˜ë¦¬ ë¡œì§ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ ì œê±°í•©ë‹ˆë‹¤.
			// ë§Œì•½ data-bs-targetì„ í†µí•´ ëª¨ë‹¬ì´ ì—´ë¦¬ê³  ê·¸ targetì—ì„œ comuPostNoë¥¼ ê°€ì ¸ì™€ì•¼ í•œë‹¤ë©´,
			// ì•„ë˜ ì£¼ì„ ì²˜ë¦¬ëœ ì½”ë“œë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
			// let comuPostNo = e.relatedTarget.getAttribute("data-comu-post-no");
			// if (comuPostNo) displayPostModal(comuPostNo);
		});


		// ì¢‹ì•„ìš” ëŒ“ê¸€ìˆ˜ ë™ê¸°í™” ë° URL í•´ì‹œ ì •ë¦¬ (postModal ë‹«í ë•Œ)
		postModal.on("hidden.bs.modal",function(){
			const savedLikeStatus = postModal.data('currentLikeStatus');
			const replyCountInfo = postModal.data("replyCountInfo");

			if(savedLikeStatus){
				let {isLiked,comuPostNo,likeCount} = savedLikeStatus
				const mainLikeButton = $(`.post-likes[data-comu-post-no="\${comuPostNo}"]`);
				if(mainLikeButton.length > 0){ // í•´ë‹¹ ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ ì²˜ë¦¬
					const likeIcon = mainLikeButton.find('i');
			        const likeCountSpan = mainLikeButton.find('.likeCount');

					if(isLiked){
						mainLikeButton.addClass("active");
						likeIcon.removeClass("bi-heart").addClass("bi-heart-fill");
					}else{
						mainLikeButton.removeClass("active");
						likeIcon.removeClass("bi-heart-fill").addClass("bi-heart");
					}
					likeCountSpan.text(likeCount);
					mainLikeButton.data("likeYn",isLiked ? 'Y' : 'N');
				}
			}
			if(replyCountInfo){ // replyCountInfoê°€ ìˆì„ ë•Œë§Œ ì²˜ë¦¬
				const mainReply = $(`.post-comments[data-comu-post-no="\${replyCountInfo.comuPostNo}"]`)
				if(mainReply.length > 0) { // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
					mainReply.find('span').text(replyCountInfo.replyCount);
				}
			}

			postModal.removeData("currentLikeStatus"); // ì €ì¥ëœ ë°ì´í„° ì‚­ì œ
			postModal.removeData("replyCountInfo"); // ì €ì¥ëœ ë°ì´í„° ì‚­ì œ

			// ëª¨ë‹¬ ë‹«í ë•Œ URL í•´ì‹œ ì •ë¦¬ (ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„)
            if (window.location.hash.startsWith("#post-")) {
                window.history.replaceState("", document.title, window.location.pathname + window.location.search);
            }
		})

		// ê¸€ ì‚­ì œ
		$("body").on("click",".postDeleteBtn",function(){
			let comuPostNo = $(this).data("comuPostNo");
			Swal.fire({
				   title: 'ì •ë§ë¡œ ì‚­ì œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
				   text: 'ë‹¤ì‹œ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ì„¸ìš”.',
				   icon: 'warning',

				   showCancelButton: true,
				   confirmButtonColor: '#3085d6',
				   cancelButtonColor: '#d33',
				   confirmButtonText: 'ì‚­ì œ',
				   cancelButtonText: 'ì·¨ì†Œ',

				}).then(result => {
				    if(result.isConfirmed) {
				    	$.ajax({
							url : "/api/community/post/delete?comuPostNo="+comuPostNo,
							type : "post",
							beforeSend : function(xhr){
								xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
							},
							success : function(res){
								if(res == 'OK'){
									sweetAlert("success","ê²Œì‹œê¸€ ì‚­ì œ ì„±ê³µí–ˆìŠµë‹ˆë‹¤");
									location.reload();
								}
							},
							error : function(err){
								sweetAlert("error","ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
							}

						})
				    }
				});
		})

		// ìˆ˜ì • ëª¨ë‹¬ ë…¸ì¶œì‹œ ë°ì´í„° ì£¼ì…
		// let fileContainer = new Map(); // displayPostUpdateModal í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì „ì—­ ë³€ìˆ˜ ë¶ˆí•„ìš”
		postUpdateModal.on("show.bs.modal",function(e){
			console.log(e.relatedTarget)
			let comuPostNo = e.relatedTarget.getAttribute("data-comu-post-no");
			displayPostUpdateModal(comuPostNo);
		})

		// í¬ìŠ¤íŠ¸ ìˆ˜ì •ë²„íŠ¼ í´ë¦­
		postUpdateModal.on("click","#savePostUpdateBtn",function(){
			let formData = new FormData($("#updateForm")[0]);

			$.ajax({
				url : "/api/community/post/update",
				type : "post",
				beforeSend : function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
				},
				processData : false,
				contentType : false,
				data : formData,
				success : function(res){
					if(res == "OK"){
						sweetAlert("success","ê¸€ ìˆ˜ì •ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.").then((res)=>{
							location.reload();
						})
					}
				},
				error : function(err){
					console.log(err)
					sweetAlert("error", "ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
			})

		})

		// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
		postUpdateModal.on("change","#updatePostFiles",function(){
			let files = this.files;
			$(".deletePostImg","#previewContainer").each((i,v)=> v.click()) // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì œê±°

			for(let file of files){
				let reader = new FileReader();
				reader.onload = function(e){
					html = `
						<div style="position:relative; display: inline-block;">
							<img src="\${e.target.result}" height="120px"/>
							<i class="bi bi-x-lg deletePostImg" style="position:absolute; top:0; right:0; cursor: pointer;"></i>
						</div>
					`
					$("#previewContainer").append(html)
				}
				reader.readAsDataURL(file);
			}
		});

		// ì´ë¯¸ì§€ ì‚­ì œ
		postUpdateModal.on("click",".deletePostImg",function(){
			console.log(this)
			let attachDetailNo = $(this).data("attachDetailNo");
			if(attachDetailNo){ // ê¸°ì¡´ ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ì´ë¼ë©´ hidden input ì¶”ê°€
				let html = `<input type="hidden" name="deleteFiles" value="\${attachDetailNo}" />`
				$("#updateForm").append(html);
			}
			$(this).parent('div').remove(); // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì œê±°
		})

		// ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼
		postModal.on("click",".replyDeleteBtn",function(){
			// let deleteEl = $(this).parents(".detailBox") // ì´ ë³€ìˆ˜ëŠ” í˜„ì¬ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
			let comuPostNo = $(this).data("comuPostNo");
			let comuReplyNo = $(this).data("comuReplyNo");
			console.log("Deleting Reply No:", comuReplyNo, "from Post No:", comuPostNo);

			Swal.fire({
				   title: 'ì •ë§ë¡œ ì‚­ì œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
				   text: 'ë‹¤ì‹œ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ì„¸ìš”.',
				   icon: 'warning',

				   showCancelButton: true,
				   confirmButtonColor: '#3085d6',
				   cancelButtonColor: '#d33',
				   confirmButtonText: 'ì‚­ì œ',
				   cancelButtonText: 'ì·¨ì†Œ',

				}).then(result => {
				    if(result.isConfirmed) {
				    	$.ajax({
							url : "/api/community/reply/delete?comuReplyNo="+comuReplyNo,
							type : "post",
							beforeSend : function(xhr){
								xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
							},
							success : function(res){
								if(res == 'OK'){
									sweetAlert("success","ëŒ“ê¸€ ì‚­ì œ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
									displayPostModal(comuPostNo); // ëŒ“ê¸€ ì‚­ì œ í›„ ê²Œì‹œê¸€ ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
									// $(`.detailBox[data-comu-reply-no='\${comuReplyNo}']`,"#replyContainer").hide(); // displayPostModal í˜¸ì¶œë¡œ ëŒ€ì²´
								}
							},
							error : function(err){
								sweetAlert("error","ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
							}

						})
				    }
				});
		})

		// ëŒ“ê¸€ ì‘ì„± ê¸°ëŠ¥
		commentSubmitBtn.on("click",function(){
			let comuProfileNo = $("#myComuProfileNo").val();
			let boardTypeCode = $("#boardTypeCode").val();
			let comuPostNo = $("#comuPostNo").val();
			let artGroupNo = $("#artGroupNo").val();
			let comuReplyContent = $("#comuReplyContent").val();

			if (!comuReplyContent.trim()) {
                sweetAlert("warning", "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

			let data = {
					boardTypeCode
					,comuPostNo
					,artGroupNo
					,comuProfileNo
					,comuReplyContent
			}
			$.ajax({
				url : "/api/community/reply/insert",
				type : "post",
				contentType : "application/json; charset=utf-8",
				beforeSend : function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
				},
				data : JSON.stringify(data),
				success : function(res){
					console.log(res)
					let {result, replyVO} = res;
					if(result == 'OK'){
						let comuPostNo = replyVO.comuPostNo
						displayPostModal(comuPostNo); // ëŒ“ê¸€ ì‘ì„± í›„ ê²Œì‹œê¸€ ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
						$("#comuReplyContent").val(""); // ëŒ“ê¸€ ì…ë ¥ì°½ ë¹„ìš°ê¸°
					}
				},
				error : function(err){
					console.log(err)
					sweetAlert("error","ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
			})
		})

		// ì‹ ê³  ê¸°ëŠ¥
		$("#reportSendBtn").on("click",function(){
			console.log("ì‹ ê³  ë²„íŠ¼ í´ë¦­");
			let reportForm = $("#reportForm")[0];
			let reportReasonCode = $(`input[name='reportReasonCode']:checked`);
			console.log("ì„ íƒëœ ì‹ ê³  ì‚¬ìœ :", reportReasonCode);

			if(reportReasonCode.length <= 0){
				sweetAlert("error","ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
				return false;
			}
			let formData = new FormData(reportForm);
			$.ajax({
				url : "/api/community/send/report",
				type : "post",
				processData : false,
				contentType : false,
				data : formData,
				beforeSend : function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}")
				},
				success : function(res){
					if(res == "OK"){
						sweetAlert("success","ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
						$("#reportModal").modal('hide');
					}else if(res == "EXIST"){ // '=' í•˜ë‚˜ëŠ” í• ë‹¹ ì—°ì‚°ì, '==' ë˜ëŠ” '===' ë¹„êµ ì—°ì‚°ì ì‚¬ìš© ê¶Œì¥
						sweetAlert("warning","ì´ë¯¸ ì‹ ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.");
						$("#reportModal").modal('hide');
					}
				},
				error : function(err){
					sweetAlert("error","ì‹ ê³  ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”");
				}
			});
		})

		// ì¢‹ì•„ìš” ê¸°ëŠ¥ (ë©”ì¸ í˜ì´ì§€ ê²Œì‹œë¬¼ ì¹´ë“œ)
		$(".post-likes").on("click",function(){

			let comuPostNo = $(this).data("comuPostNo");
	        let comuProfileNo = $(this).data("comuProfileNo");
	        let boardTypeCode = $(this).data("boardTypeCode");
	        let artGroupNo = $(this).data("artGroupNo");
	     	let likeYn = $(this).data("likeYn")
	     	let comuPostMbspYn = $(this).data("comuPostMbspYn");
	     	let comuWriterProfileNo = $(this).data("comuWriterProfileNo");
	     	let flag = ${membershipFlag};
	     	let insertDelete = likeYn == 'N' ? 1 : -1;
// 	     	console.log(comuPostMbspYn)
// 	     	console.log("${myComuProfileNo}")
// 	     	console.log(comuWriterProfileNo)
	     	if(comuPostMbspYn == 'Y' && comuWriterProfileNo != "${myComuProfileNo}" && !flag){
	     		sweetAlert("error","ë©¤ë²„ì‰½ ê°€ì… í›„ ì´ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤.");
				return ;
	     	}

	        let data = {
	        		comuPostNo,comuProfileNo,boardTypeCode,artGroupNo,insertDelete
	        }
	        likeUpdate(data); // ì¢‹ì•„ìš” API í˜¸ì¶œ
	        $(this).toggleClass('active'); // ë²„íŠ¼ í™œì„±/ë¹„í™œì„± í´ë˜ìŠ¤ í† ê¸€

	        const likeIcon = $(this).find('i'); // ë²„íŠ¼ ì•ˆì˜ i íƒœê·¸(ì•„ì´ì½˜)ë¥¼ ì°¾ìŒ
	        const likeCountSpan = $(this).find('.likeCount');
	        let currentCount = parseInt(likeCountSpan.text().trim()); // í˜„ì¬ ìˆ«ì ê°€ì ¸ì˜¤ê¸°

	        // í˜„ì¬ 'active' í´ë˜ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì•„ì´ì½˜ ëª¨ì–‘ê³¼ ìˆ«ì ë³€ê²½
	        if ($(this).hasClass('active')) {
	            // "ì¢‹ì•„ìš”"ë¥¼ ëˆ„ë¥¸ ìƒíƒœ (í™œì„± ìƒíƒœ)
	            likeIcon.removeClass('bi-heart').addClass('bi-heart-fill');
	            likeCountSpan.text(currentCount + 1);
	            $(this).data("likeYn","Y") // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
	        } else {
	            // "ì¢‹ì•„ìš”"ë¥¼ ì·¨ì†Œí•œ ìƒíƒœ (ë¹„í™œì„± ìƒíƒœ)
	            likeIcon.removeClass('bi-heart-fill').addClass('bi-heart');
	            likeCountSpan.text(currentCount - 1);
	            $(this).data("likeYn","N") // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
	        }
		});

		// ì¢‹ì•„ìš” ê¸°ëŠ¥ (ëª¨ë‹¬ ë‚´ ì¢‹ì•„ìš” ë²„íŠ¼)
	    postModal.on('click',"#likeButton", function() {
	        let comuPostNo = $(this).data("comuPostNo");
	        let comuProfileNo = $(this).data("comuProfileNo");
	        let boardTypeCode = $(this).data("boardTypeCode");
	        let artGroupNo = $(this).data("artGroupNo");
	     	let likeYn = $(this).data("likeYn")
	     	console.log("Modal LikeYn:", likeYn)
			let insertDelete = likeYn == 'N' ? 1 : -1;
	        let data = {
	        		comuPostNo,comuProfileNo,boardTypeCode,artGroupNo,insertDelete
	        }
	        likeUpdate(data); // ì¢‹ì•„ìš” API í˜¸ì¶œ

	        $(this).toggleClass('active'); // ë²„íŠ¼ í™œì„±/ë¹„í™œì„± í´ë˜ìŠ¤ í† ê¸€

	        const likeIcon = $(this).find('i'); // ë²„íŠ¼ ì•ˆì˜ i íƒœê·¸(ì•„ì´ì½˜)ë¥¼ ì°¾ìŒ
	        const likeCountSpan = $(this).find('#likeCount');
	        let currentCount = parseInt(likeCountSpan.text().trim()); // í˜„ì¬ ìˆ«ì ê°€ì ¸ì˜¤ê¸°

	        // í˜„ì¬ 'active' í´ë˜ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì•„ì´ì½˜ ëª¨ì–‘ê³¼ ìˆ«ì ë³€ê²½
	        if ($(this).hasClass('active')) {
	            // "ì¢‹ì•„ìš”"ë¥¼ ëˆ„ë¥¸ ìƒíƒœ (í™œì„± ìƒíƒœ)
	            likeIcon.removeClass('bi-heart').addClass('bi-heart-fill');
	            likeCountSpan.text(currentCount + 1);
	            $(this).data("likeYn","Y") // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
	        } else {
	            // "ì¢‹ì•„ìš”"ë¥¼ ì·¨ì†Œí•œ ìƒíƒœ (ë¹„í™œì„± ìƒíƒœ)
	            likeIcon.removeClass('bi-heart-fill').addClass('bi-heart');
	            likeCountSpan.text(currentCount - 1);
	            $(this).data("likeYn","N") // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
	        }

	        // ëª¨ë‹¬ ë‹«í˜ ì‹œ ë©”ì¸ í™”ë©´ ë™ê¸°í™”ë¥¼ ìœ„í•´ í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœ ì €ì¥
	        postModal.data('currentLikeStatus', {
	            comuPostNo: comuPostNo,
	            isLiked: $(this).hasClass('active'), // true/false
	            likeCount: parseInt(likeCountSpan.text().trim()) // ìµœì¢… ì¢‹ì•„ìš” ìˆ˜
	        });
	    });

		// textareaì—ì„œ í‚¤ë³´ë“œë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì‹¤í–‰ ìë™ ë†’ì´ì¡°ì ˆ
	    $('.comment-pane-footer textarea').on('keyup', function() {
	        // ì¼ë‹¨ ë†’ì´ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ ì¤„ì–´ë“œëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ê²Œ í•¨
	        $(this).css('height', 'auto');
	        // ìŠ¤í¬ë¡¤ ë†’ì´(ë‚´ìš© ì „ì²´ ë†’ì´)ë¥¼ ì‹¤ì œ ë†’ì´ë¡œ ì§€ì •
	        $(this).css('height', $(this).prop('scrollHeight') + 'px');
	    });

		// ì—”í„°í‚¤ ëŒ“ê¸€ ì „ì†¡
	    $('.comment-pane-footer textarea').on('keydown', function(e) {
	        // Shift í‚¤ë¥¼ ëˆ„ë¥´ì§€ ì•Šê³  Enter í‚¤ë§Œ ëˆŒë €ì„ ë•Œ
	        if (e.key === 'Enter' && !e.shiftKey) {
	            e.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(ì¤„ë°”ê¿ˆ)ì„ ë§‰ìŒ
	            $('#commentSubmitBtn').click(); // ë“±ë¡ ë²„íŠ¼ì„ ê°•ì œë¡œ í´ë¦­
	        }
	    });

		// ì‹ ê³ ëª¨ë‹¬ ì—´ë¦¼ (data-bs- ê´€ë ¨ ì†ì„± ì‚¬ìš©)
	    $("#reportModal").on("show.bs.modal",function(e){
			console.log("ì‹ ê³  ëª¨ë‹¬ ì—´ë¦¼");

			let postNo = e.relatedTarget.getAttribute('data-bs-comuPostNo'); // ëŒ€ìƒ ê²Œì‹œê¸€ ë²ˆí˜¸
			let boardType = e.relatedTarget.getAttribute('data-bs-boardType'); // ì•„í‹°ìŠ¤íŠ¸ íŒ¬ ê²Œì‹œê¸€ì¸ì§€
			let comuProfileNo = e.relatedTarget.getAttribute('data-bs-comuProfileNo');// íƒ€ì¼“ì˜ ì»¤ë®¤í”„ë¡œí•„ë„˜ë²„
			let comuNick = e.relatedTarget.getAttribute('data-bs-comuNick'); // íƒ€ê²Ÿì˜ ì»¤ë®¤ë‹‰
			let comuContent = e.relatedTarget.getAttribute('data-bs-comuContent'); // íƒ€ì¼“ ë‚´ìš©
			let selectType = e.relatedTarget.getAttribute('data-bs-selectType'); // RTTC001(ê²Œì‹œê¸€) ë˜ëŠ” RTTC002(ëŒ“ê¸€)
			let comuReplyNo = e.relatedTarget.getAttribute('data-bs-comuReplyNo'); // ëŒ“ê¸€ì¼ë•Œë§Œ í•„ìš”


			// JSP ELì—ì„œ ë°›ì•„ì˜¨ ì½”ë“œ ë§µ ì‚¬ìš©
			let code = ${codeMap};
			let reasonCode = code.reasonCode; // ì‹ ê³  ì‚¬ìœ  ì½”ë“œ ëª©ë¡
			// let reportStatCode = code.reportStatCode; // ì´ ë³€ìˆ˜ëŠ” í˜„ì¬ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
			// let reportTarCode = code.reportTarCode; // ì´ ë³€ìˆ˜ëŠ” ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³  selectTypeìœ¼ë¡œ ì „ë‹¬ë¨

			let info = {
				"postNo" : postNo,
				"boardType" : boardType,
				"comuProfileNo" : comuProfileNo,
				"reasonCode" : reasonCode, // ì´ë¯¸ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì´ìœ  ëª©ë¡ ì‚¬ìš©
				"reportTarCode" : selectType, // ì§ì ‘ selectTypeì„ ë„˜ê²¨ì¤Œ (RTTC001 ë˜ëŠ” RTTC002)
				"comuNick" : comuNick,
				"comuContent" : comuContent,
				"comuReplyNo" : comuReplyNo
			};
			reportModalInfo(info);
		});

		// ì‹ ê³  ëª¨ë‹¬ ë‹«ê¸°
	    $("#reportModal").on("hide.bs.modal",function(e){
			$("#targetComuReplyNo").val(""); // ëŒ“ê¸€ ì‹ ê³ ì‹œ ì‚¬ìš©ëœ ê°’ ì´ˆê¸°í™”
			$("#reportForm")[0].reset(); // í¼ í•„ë“œ ì´ˆê¸°í™”
		});

		// `postUpdateModal`ì˜ "ì·¨ì†Œ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (data-bs-dismiss="modal" ì†ì„± ì‚¬ìš© ì‹œ í•„ìš” ì—†ìŒ)
		$("#cancelPostUpdateBtn").on("click", function() {
            postUpdateModal.modal('hide');
        });
	});
});
</script>
</html>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신고 관리 - DDTOWN 관리자</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
     <style>
        .report-detail-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .report-main-content, .report-processing-panel { background-color: #fff; border: 1px solid #e7eaf3; border-radius: 8px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .report-main-content h3, .report-processing-panel h3 { font-size: 1.3em; color: #2c3e50; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .report-info-section dt { font-weight: 500; color: #555; width: 100px; float: left; clear: left; margin-bottom: 10px; }
        .report-info-section dd { margin-left: 110px; margin-bottom: 10px; color: #333; }
        .report-content-preview { border: 1px solid #eee; padding: 15px; border-radius: 4px; background-color: #f9f9f9; margin-top: 10px; min-height: 80px; line-height: 1.6; }
        .report-content-preview img { max-width: 100%; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>
        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
            <main class="emp-content">
                <section id="reportDetailSection" class="ea-section active-section">
                    <div class="ea-section-header">
                        <h2 id="reportDetailTitle">신고 내용 상세</h2>
                        <a href="/admin/community/report/list" class="ea-btn outline sm"><i class="fas fa-list"></i> 목록으로</a>
                    </div>
                    <div class="report-detail-grid">
                        <div class="report-main-content">
                            <h3>신고 정보</h3>
                            <dl class="report-info-section">
                            <input type="hidden" id="targetComuPostNo" name="targetComuPostNo" value="${report.targetComuPostNo}" />
                            <input type="hidden" id="targetComuReplyNo" name="targetComuReplyNo" value="${report.targetComuReplyNo}" />
                            <input type="hidden" id="targetChatNo" name="targetChatNo" value="${report.targetChatNo}" />
                            <input type="hidden" id="targetMemUsername" name="targetMemUsername" value="${report.targetMemUsername}" />
                                <dt>신고 번호:</dt><dd id="reportNo">${report.reportNo }</dd>
                                <dt>신고 유형:</dt>
                                <dd id="reportTargetTypeCodeName">
                                	<c:choose>
                                		<c:when test="${report.reportTargetTypeCode eq 'RTTC001'}">게시글</c:when>
                                		<c:when test="${report.reportTargetTypeCode eq 'RTTC002'}">댓글</c:when>
                                		<c:when test="${report.reportTargetTypeCode eq 'RTTC003'}">채팅</c:when>
                                	</c:choose>
	                            </dd>
	                            <input type="hidden" id="reportTargetTypeCode" value="${report.reportTargetTypeCode}" />
                                <dt>신고 대상:</dt><dd id="detailReportedTarget">${report.targetMemUsername }</dd>
                                <dt>신고자:</dt><dd id="reported-writer">${report.memUsername }</dd>
                                <dt>신고일:</dt><dd id="detailReportDate">${report.reportRegDate }</dd>
                                <dt>처리 상태:</dt><dd>
                                	<span class="report-status-badge new" id="detailReportStatus">
	                                	<c:choose>
	                                			<c:when test="${report.reportStatCode eq 'RSC001'}">접수됨</c:when>
				                       			<c:when test="${report.reportStatCode eq 'RSC002'}">처리 완료</c:when>
	                                	</c:choose>
                                </span></dd>
                                <input type="hidden" id="reportStatusCodeName" value="${report.reportStatCode}" />
                                <dt>게시물 내용:</dt><dd id="detailReportDate"> ${report.reportedContent}</dd>
                            </dl>
                            <h3>신고 사유</h3>
                            <div class="report-content-preview" id="detailReportReason">
                                <p><strong>사유:</strong>
                                	<c:choose>
                                			<c:when test="${report.reportReasonCode eq 'RRC001'}">스팸</c:when>
			                       			<c:when test="${report.reportReasonCode eq 'RRC002'}">욕설</c:when>
			                       			<c:when test="${report.reportReasonCode eq 'RRC003'}">음란물</c:when>
			                       			<c:when test="${report.reportReasonCode eq 'RRC004'}">기타</c:when>
                                	</c:choose>
                                </p>
                               <!--  <p><strong>상세 내용:</strong> 게시물 본문에 심한 욕설과 비방이 포함되어 있어 신고합니다. 확인 후 조치 부탁드립니다.</p> -->
                            </div>
                        </div>
                        <div class="report-processing-panel">
                            <h3>신고 처리</h3>
                            <form id="reportProcessForm" class="ea-form">
                                <div class="form-group">
                                    <label for="processAction">처리 조치 선택</label>
                                    <select id="reportResultCode" name="reportResultCode">
                                        <option value="">조치 선택</option>
                                        <option value="RRTC002">콘텐츠 삭제</option>
                                        <option value="RRTC001">조치 없음</option>
                                    </select>
                                </div>
<!--                                 <div class="form-group">
                                    <label for="processMemo">처리 메모 (관리자용)</label>
                                    <textarea id="processMemo" name="memo" placeholder="처리 내용 및 사유를 간략히 기록합니다."></textarea>
                                </div> -->
                                <div class="ea-form-actions" style="text-align:left;">
                                    <button type="submit" id="TreatBtn" class="ea-btn primary">처리 완료</button>
                                </div>
                            </form>
                            <hr style="margin:25px 0;">
                            <h4>신고 누적 회원 조치</h4>
                            <p id="reportedUserAccumulatedInfo" style="font-size:0.9em; margin-bottom:10px;">
                                신고 대상 회원 (<strong id="reportedUserIdDisplay">${report.targetMemUsername }</strong>) 누적 신고 횟수: <strong id="reportedUserTotalReports">5</strong>회
                            </p>
                            <button class="ea-btn danger sm" id="forceAddToBlacklistBtn">즉시 블랙리스트 추가</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>

    </div>
    <script>
        
        //신고 처리 버튼 클릭
        let TreatBtn = $("#TreatBtn");	//처리완료 버튼
 //       let reportResultCodeSelect = $("#reportResultCode");	//처리조치 드롭다운
        
  //      let currentReportStatCode = $("#currentReportStatCode").val();
        
//         if (currentReportStatCode === 'RSC002') {
//             TreatBtn.prop('disabled', true); // '처리 완료' 버튼 비활성화
//             TreatBtn.text('처리 완료됨');     // 버튼 텍스트 변경
//             reportResultCodeSelect.prop('disabled', true); // '처리 조치 선택' 드롭다운 비활성화
//         }

        
        TreatBtn.on("click", function(event){
        	event.preventDefault();	//폼제출 기본동작 방지
        	
        	let reportNo = $("#reportNo").text();
        	let reportTargetTypeCode = $("#reportTargetTypeCode").val();
        	let reportResultCode = $("#reportResultCode").val();
        	let targetMemUsername = $("#targetMemUsername").val();
        	
        	let targetComuPostNo = $("#targetComuPostNo").val();
        	let targetComuReplyNo = $("#targetComuReplyNo").val();
        	let targetChatNo = $("#targetChatNo").val();
        	
        	 if (reportResultCode == null || reportResultCode === "") {
    	        sweetAlert("error", "처리 조치를 선택해주세요!");
    	        $("#reportResultCode").focus();
    	        return false;
    	    } 
        	 
        	let data = {
        			reportNo: reportNo,								//신고번호
        			reportTargetTypeCode : reportTargetTypeCode,	//글 유형
        			reportResultCode : reportResultCode,			//처리코드
        			targetMemUsername : targetMemUsername,
        			targetComuPostNo : targetComuPostNo,			//게시글 번호
        			targetComuReplyNo : targetComuReplyNo,			//댓글번호
        			targetChatNo : targetChatNo						//채팅메세지 번호
        			
        	}
        	console.log(data);
        	
        	$.ajax({
        		url:"/admin/community/report/update",
        		type:"post",
        		data: JSON.stringify(data),
        		contentType: "application/json; charset=utf-8",
        		beforeSend : function(xhr) {
        	    	xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
        	    },
        		success: function(res){
        			console.log(res);
        			if(res == "EXIST"){
        				 Swal.fire({
        			            icon: 'success',
        			            title: '성공적으로 처리되었습니다!',
        			            showConfirmButton: false, // 선택 사항: 확인 버튼 숨기기
        			            timer: 1500 // 선택 사항: 1.5초 후 자동으로 닫기
        			        });
        				 
//          				 TreatBtn.prop('disabled', true); // '처리 완료' 버튼 비활성화
//                          TreatBtn.text('처리 완료됨'); // 버튼 텍스트 변경
//                          reportResultCodeSelect.prop('disabled', true); // '처리 조치 선택' 드롭다운 비활성화 
        				
        			}else{
        				Swal.fire({
        		            icon: 'error',
        		            title: '처리 실패',
        		            text: res.message || "알 수 없는 오류"
        		        });
        			}
        		}
        	})
        })
/*         // 신고 처리 폼 제출
        const reportProcessForm = document.getElementById('reportProcessForm');
        if(reportProcessForm){
            reportProcessForm.addEventListener('submit', function(event){
                event.preventDefault();
                const action = document.getElementById('processAction').value;
                const memo = document.getElementById('processMemo').value;
                if(!action){
                    alert('처리 조치를 선택해주세요.');
                    return;
                }
                alert(`신고 [${reportId}]에 대해 [${action}] 조치를 요청했습니다. 메모: ${memo} (서버 연동 필요)`);
                document.getElementById('detailReportStatus').className = 'report-status-badge completed';
                document.getElementById('detailReportStatus').textContent = '처리완료';
            });
        }
        // 즉시 블랙리스트 추가 버튼
        if(forceAddToBlacklistBtnEl) {
            forceAddToBlacklistBtnEl.addEventListener('click', function(){
                const reportedUserId = document.getElementById('reportedUserIdDisplay').textContent;
                if(confirm(`${reportedUserId} 회원을 즉시 블랙리스트에 추가하고 활동을 제한하시겠습니까?`)){
                    alert(`${reportedUserId} 회원을 블랙리스트에 추가했습니다. (서버 연동 필요)`);
                }
            });
        } */
    </script>
</body>
<%@ include file="../../modules/footerPart.jsp" %>

<%@ include file="../../modules/sidebar.jsp" %>
</html> 
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="jakarta.tags.functions" prefix="fn" %>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${artistComuNicknm} - ê³µì‹ íŒ¬í´ëŸ½ ë°©</title>
    <meta name="_csrf" content="${_csrf.token }">
    <meta name="_csrf_header" content="${_csrf.headerName }">
    <style>
        body { font-family: sans-serif; margin: 20px; display: flex; flex-direction: column; height: 90vh; }
        #chatDisplay {
            border: 1px solid #ccc;
            height: 70%;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        #messageInput {
            width: calc(100% - 160px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
        }
        #attachFileBtn {
        	width: 70px;
            padding: 8px;
            border: none;
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        #attachFileBtn:hover {
            background-color: #5a6268;
        }
        #sendMessageBtn {
            width: 70px;
            padding: 8px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        #sendMessageBtn:hover {
            background-color: #0056b3;
        }
        .chat-message {
        margin-bottom: 5px;
        border-radius: 3px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
	    }
	    .my-message {
	        text-align: right;
	        align-items: flex-end;
	    }
	    .other-message {
	        text-align: left;
	        align-items: flex-start;
	    }
	    .chat-sender {
	        font-weight: bold;
	        margin-bottom: 2px;
	        display: block;
	        font-size: 0.9em;
	        color: #333;
	    }
	    .chat-content-wrapper {
	        display: flex;
	        align-items: flex-end;
	        gap: 8px;
	    }
	    .my-message .chat-content-wrapper {
	        flex-direction: row-reverse;
	    }
	    .other-message .chat-content-wrapper {
	        flex-direction: row;
	    }
	    .chat-content {
	        white-space: pre-wrap;
	        word-break: break-all;
	        padding: 8px 12px;
	        border-radius: 15px;
	       	min-width: 50px;
	        max-width: 90%;
	        box-shadow: 0 1px 1px rgba(0,0,0,0.1);
	        line-height: 1.4;
	    }
	    .my-message .chat-content {
	        background-color: #dcf8c6;
	        color: #333;
	    }
	    .other-message .chat-content {
	        background-color: #ffffff;
	        color: #333;
	    }
	    .chat-time {
	        font-size: 0.75em;
	        color: #888;
	        white-space: nowrap;
	        align-self: flex-end;
	    }
	    .chat-date-header {
	        text-align: center;
	        margin: 15px 0;
	        color: #666;
	        font-size: 0.85em;
	        font-weight: bold;
	        padding: 5px 10px;
	        background-color: #e0e0e0;
	        border-radius: 10px;
	        align-self: center;
	        max-width: fit-content;
	        margin-left: auto;
	        margin-right: auto;
	    }
	    .chat-sender-info {
	    	display: flex;
	    	align-items: center;
	    	margin-bottom: 5px;
	    	gap: 8px;
	    }
	    .chat-profile-img {
	    	width: 30px;
	    	height: 30px;
	    	border-radius: 50%;
	    	object-fit: cover;
	    	border: 1px solid #eee;
	    	flex-shrink: 0;
	    }
	    .chat-profile-initial {
	    	width: 30px;
	    	height: 30px;
	    	border-radius: 50%;
	    	background-color: #007bff;
	    	color: white;
	    	display: flex;
	    	justify-content: center;
	    	align-items: center;
	    	font-weight: bold;
	    	font-size: 0.9em;
	    	border: 1px solid #0056b3;
	    	flex-shrink: 0;
	    }
	    .my-message .chat-sender-info {
	    	flex-direction: row-reverse;
	    	justify-content: flex-end;
	    }
	    .other-message .chat-sender-info {
	    	flex-direction: row;
	    	justify-content: flex-start;
	    }
	    .chat-image {
	    	max-width: 500px;
	    	max-height: 500px;
	    	object-fit: cover;
            border-radius: 8px;
            margin-top: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .chat-content.image-only {
        	padding: 0;
        	background-color: transparent;
        	box-shadow: none;
        }
        .chat-message.system-message {
	        text-align: center;
	        margin: 10px 0;
        	font-size: 0.9em;
        	align-items: center;
        	font-style: italic;
        }
        .chat-message.system-message .chat-content {
        	background-color: #f0f0f0;
        	padding: 5px 10px;
        	border-radius: 10px;
        	display: inline-block;
        }
        .mention-highlight {
        	background-color: #ffeb3b;
        	padding: 2px 4px;
        	border-radius: 4px;
        	font-weight: bold;
        }
        #loadMoreBtn {
        	display: block;
        	margin: 10px auto;
        	padding: 10px 20px;
        	background-color: #17a2b8;
        	color: white;
        	border: none;
        	border-radius: 5px;
        	cursor: pointer;
        	font-size: 0.9em;
        }
        #loadMoreBtn:hover {
        	background-color: #138496;
        }
        #loadMoreBtn:disabled {
        	background-color: #cccccc;
        	cursor: not-allowed;
        }
        .loading-indicator, .no-more-messages-indicator { 
        	text-align: center;
        	padding: 10px;
        	color: #888;
        	font-style: italic;
        	display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }
        .no-more-messages-indicator { 
        	font-size: 0.85em;
        	border-top: 1px dashed #eee;
        	margin-top: 10px;
        	padding-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <%-- jQuery CDN ì¶”ê°€ --%>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script> <%-- ë‚ ì§œ í¬ë§·íŒ…ì„ ìœ„í•œ Moment.js ì¶”ê°€ --%>
</head>
<body>
    <h1>${artistComuNicknm} - ê³µì‹ íŒ¬í´ëŸ½ ë°©</h1>
    <div>í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì : ${myComuNicknm }</div>
    <div>ì•„í‹°ìŠ¤íŠ¸ : ${artistComuNicknm }</div>
    
    <div id="chatDisplay">
        <button id="loadMoreBtn">ì´ì „ ë©”ì‹œì§€ ë” ë³´ê¸°</button>
        <div class="loading-indicator" id="loadingIndicator">ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="no-more-messages-indicator" id="noMoreMessagesIndicator">ë” ì´ìƒ ì´ì „ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
    <div>
	    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
	    <c:if test="${!isHasMembership}">
	    	<input type="file" id="fileInput" style="display: none;" accept="image/*, application/pdf">
		    <button id="attachFileBtn">ğŸ“‚</button>
	    </c:if>
	    <button id="sendMessageBtn">ì „ì†¡</button>
    </div>
    <script>
    	let stompClient = null;
    	let isConnected = false;
    	
        document.addEventListener('DOMContentLoaded', function() {
        	// Moment.js í•œêµ­ì–´ ë¡œì¼€ì¼ ì„¤ì •
        	moment.locale('ko');	
        	
        	// CSRF í† í° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        	const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        	
        	// ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const chatChannelNo = ${chatChannelNo};
            const username = "<sec:authentication property='name'/>";
            const artistUsername = "${artistUsername}";
            const artistComuNicknm = "${artistComuNicknm}";
			const myComuNicknm = "${myComuNicknm}";
			const isCurrentUserArtist = ${isArtist};
			const isCurrentUserMembership = ${isHasMembership};
            
			// ìš”ì†Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const chatDisplay = document.getElementById('chatDisplay');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessageBtn');
            
            // íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const fileInput = document.getElementById('fileInput');
            const attachFileBtn = document.getElementById('attachFileBtn');
            
            // ë” ë³´ê¸° ë²„íŠ¼ ìš”ì†Œ
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noMoreMessagesIndicator = document.getElementById('noMoreMessagesIndicator');
           	let currentOffset = ${messageOffset};	// ì´ˆê¸° offset
           	const messageLimit = 50;
           	let isLoading = false;					// ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ í”Œë˜ê·¸
           	let allMessagesLoaded = false;			// ëª¨ë“  ë©”ì„¸ì§€ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem('wschat.username', username);
            localStorage.setItem('wschat.chatChannelNo', chatChannelNo);
            localStorage.setItem('wschat.nickname', myComuNicknm);

         	// ìµœê·¼ ë©”ì„¸ì§€ ë‚ ì§œ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
            let lastDisplayedDate = null;
         	let oldestDisplayedDate = null;
            
          	// ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
           function displayMessage(message, prepend = false) {
         		// ë©”ì„¸ì§€ ì¤‘ë³µ ë°©ì§€
         		if(message.chatNo && document.getElementById(`message-\${message.chatNo}`)) {
         			return;
         		}
         		
         		// 1. ë©”ì„¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± ë° í´ë˜ìŠ¤ ì¶”ê°€
               const messageElement = document.createElement('div');
               messageElement.classList.add('chat-message');
               
               if(message.chatNo) {
            	   messageElement.id = `message-\${message.chatNo}`;
               }
               
               // ì‹œìŠ¤í…œ ë©”ì„¸ì§€ ì²˜ë¦¬
               if(message.username === "SYSTEM") {
            	   messageElement.classList.add('system-message');
            	   const systemContent = document.createElement('span');
            	   systemContent.classList.add('chat-content');
            	   systemContent.textContent = `ì‹œìŠ¤í…œ: \${message.chatContent}`;
            	   messageElement.appendChild(systemContent);
            	   
            	   if(prepend) {
            		   chatDisplay.insertBefore(messageElement, loadingIndicator.nextSibling);
            	   } else {
	            	   chatDisplay.appendChild(messageElement);
            	   }
            	   return;
            	
            	// ì‹œìŠ¤í…œ ë©”ì„¸ì§€ê°€ ì•„ë‹Œ ê²½ìš°
               } else { 
            	   // 2. ì‚¬ìš©ì ë©”ì‹œì§€ (ë‚´ ë©”ì‹œì§€ / ìƒëŒ€ë°© ë©”ì‹œì§€)
                   const isMyMessage = (message.username === username);
               	   const isMessageFromArtist = (message.username === artistUsername);
               	   
                   messageElement.classList.add(isMyMessage ? 'my-message' : 'other-message');

                   // ë‚ ì§œ í—¤ë” í‘œì‹œ ë¡œì§
                   // ì„œë²„ì—ì„œ ë„˜ì–´ì˜¤ëŠ” chatSendDate Moment.jsë¡œ ë³€í™˜
                   const messageMoment = moment(message.chatSendDate);
                   const messageDateFormatted = messageMoment.format('YYYYë…„ Mì›” Dì¼');
                   const messageDateKey = messageMoment.format('YYYY-MM-DD');	// ë‚ ì§œ ë¹„êµ ìœ„í•´

                   let dateHeaderElement = null;
                   let existingDateHeader = chatDisplay.querySelector(`.chat-date-header[data-date="\${messageDateKey}"]`);
                   
                   // ë‚ ì§œ í—¤ë” ìƒì„± ì¡°ê±´
                   if (prepend) { // ì´ì „ ë©”ì‹œì§€ ë¡œë“œ (ìƒë‹¨ì— ì¶”ê°€ë  ë©”ì‹œì§€)
                   		// ì´ì „ì— í‘œì‹œëœ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œë³´ë‹¤ ë” ì˜¤ë˜ëœ ë‚ ì§œì¼ ê²½ìš°ì—ë§Œ ë‚ ì§œ í—¤ë” ì¶”ê°€
                       if (!existingDateHeader) {
                           dateHeaderElement = document.createElement('div');
                           dateHeaderElement.classList.add('chat-date-header');
                           dateHeaderElement.textContent = messageDateFormatted;
                           dateHeaderElement.setAttribute('data-date', messageDateKey);
                           
                           // ë‚ ì§œ í—¤ë”ë¥¼ noMoreMessagesIndicator ë°”ë¡œ ë‹¤ìŒì— ì‚½ì…
                           let dateHeaderInsertTarget = noMoreMessagesIndicator.nextSibling || loadingIndicator.nextSibling || loadMoreBtn.nextSibling;
                           chatDisplay.insertBefore(dateHeaderElement, dateHeaderInsertTarget);
                           existingDateHeader = dateHeaderElement;
                       }
                   
                   	   // ë©”ì„¸ì§€ ì‚½ì… ìœ„ì¹˜ : í•´ë‹¹ ë‚ ì§œ í—¤ë” ë°”ë¡œ ë‹¤ìŒ
                       let messageInsertTarget = existingDateHeader ? existingDateHeader.nextSibling : (noMoreMessagesIndicator.nextSibling || loadingIndicator.nextSibling || loadMoreBtn.nextSibling);
                       chatDisplay.insertBefore(messageElement, messageInsertTarget);
                   
                       // oldestDisplayedDate ì—…ë°ì´íŠ¸: í˜„ì¬ ë©”ì‹œì§€ ë‚ ì§œê°€ ê¸°ì¡´ ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œë³´ë‹¤ ë” ì˜¤ë˜ë˜ë©´ ê°±ì‹ 
                       if (oldestDisplayedDate === null || messageMoment.isBefore(moment(oldestDisplayedDate), 'day')) {
                           oldestDisplayedDate = messageDateKey;
                       }
                   } else { // ìƒˆ ë©”ì‹œì§€ ë˜ëŠ” ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ (í•˜ë‹¨ì— ì¶”ê°€ë  ë©”ì‹œì§€)
                	   if (!existingDateHeader) { // í•´ë‹¹ ë‚ ì§œì˜ í—¤ë”ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ìƒˆë¡œ ì¶”ê°€
                           dateHeaderElement = document.createElement('div');
                           dateHeaderElement.classList.add('chat-date-header');
                           dateHeaderElement.textContent = messageDateFormatted;
                           dateHeaderElement.setAttribute('data-date', messageDateKey);
                           chatDisplay.appendChild(dateHeaderElement);
                       }
                       chatDisplay.appendChild(messageElement);

                       // lastDisplayedDate ì—…ë°ì´íŠ¸: í˜„ì¬ ë©”ì‹œì§€ ë‚ ì§œê°€ ê¸°ì¡´ ê°€ì¥ ìµœì‹  ë‚ ì§œë³´ë‹¤ ë” ìƒˆë¡œìš°ë©´ ê°±ì‹ 
                       if (lastDisplayedDate === null || messageMoment.isAfter(moment(lastDisplayedDate), 'day')) {
                           lastDisplayedDate = messageDateKey;
                       }
                   }

                   // 3. í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ë‹‰ë„¤ì„
                   const senderInfoContainer = document.createElement('div');
                   senderInfoContainer.classList.add('chat-sender-info');
                   
                   let profileDisplayElement;
                   if(message.userProfileImgPath && message.userProfileImgPath !== 'null' && message.userProfileImgPath.trim() !== '') {
                       profileDisplayElement = document.createElement('img');
                       profileDisplayElement.classList.add('chat-profile-img');
                       profileDisplayElement.src = message.userProfileImgPath;
                       profileDisplayElement.alt = (message.comuNicknm || message.username) + " í”„ë¡œí•„";
                   } else {
                       profileDisplayElement = document.createElement('div');
                       profileDisplayElement.classList.add('chat-profile-initial');
                       const initial = (message.comuNicknm && message.comuNicknm.length > 0) ? 
                               message.comuNicknm.charAt(0).toUpperCase() : '?';
                       profileDisplayElement.textContent = initial;
                   }
                   
                   const senderElement = document.createElement('span');
                   senderElement.classList.add('chat-sender');
                   senderElement.textContent = message.comuNicknm || message.username;
                   
                   if(isMyMessage) {	// ë‚´ ë©”ì„¸ì§€ì¸ ê²½ìš°
                       senderInfoContainer.appendChild(senderElement);
                       senderInfoContainer.appendChild(profileDisplayElement);
                   } else {				// ìƒëŒ€ë°© ë©”ì„¸ì§€
                       senderInfoContainer.appendChild(profileDisplayElement);
                       senderInfoContainer.appendChild(senderElement);
                   }

                   // 4. ë©”ì‹œì§€ ë‚´ìš© ë° ì‹œê°„
                   const contentWrapper = document.createElement('div');
                   contentWrapper.classList.add('chat-content-wrapper');
                   
                   const contentElement = document.createElement('span');
                   contentElement.classList.add('chat-content');
                   
                   if(message.type === 'FILE' && message.fileUrl) {
                       const fileUrl = message.fileUrl;
                       if(fileUrl) {
                           if(fileUrl.match(/\.(jpeg|jpg|gif|png)$/i)) { // ì´ë¯¸ì§€ í™•ì¥ì í™•ì¸
                               const imgElement = document.createElement('img');
                               imgElement.classList.add('chat-image');
                               imgElement.src = fileUrl;
                               imgElement.alt = message.chatContent || 'ì´ë¯¸ì§€';
                               imgElement.onclick = () => window.open(fileUrl, '_blank');
                               contentElement.appendChild(imgElement);
                               contentElement.classList.add('image-only');
                           } else {
                               const fileLink = document.createElement('a');
                               fileLink.href = fileUrl;
                               fileLink.target = '_blank';
                               fileLink.textContent = `[íŒŒì¼] ${message.chatContent}`;
                               contentElement.appendChild(fileLink);
                           }
                       } else {
                           contentElement.textContent = "íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                       }
                   } else { // ì¼ë°˜ í…ìŠ¤íŠ¸ ë©”ì‹œì§€
                       let processedContent = message.chatContent;	// ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ê°’
                       
                       // @everyone ë©˜ì…˜ ì²˜ë¦¬ ë¡œì§
                       if(processedContent.includes('@everyone')) {
                    	   if(isMessageFromArtist) {
                    		   if(isCurrentUserArtist) {
		                           const highlightedMention = `<span class="mention-highlight">@everyone</span>`;
		                           processedContent = processedContent.replaceAll('@everyone', highlightedMention);
		                           contentElement.innerHTML = processedContent;
	                    	   } else if(isCurrentUserMembership) {
	                    		   const replacedMention = `@\${myComuNicknm}`;
	                    		   const highlightedMention = `<span class="mention-highlight">\${replacedMention}</span>`;
	                    		   processedContent = processedContent.replaceAll('@everyone', highlightedMention);
	                    		   contentElement.innerHTML = processedContent;
                    		   }
                    	   }
                       } else {
                    	   // @everyoneì´ ì—†ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ ë©”ì„¸ì§€
                    	   contentElement.innerHTML = processedContent;
                       }
                   }
                   
                   const timeElement = document.createElement('span');
                   timeElement.classList.add('chat-time');
                   timeElement.textContent = messageMoment.format('A h:mm');
                   
                   contentWrapper.appendChild(contentElement);
                   contentWrapper.appendChild(timeElement);

                   messageElement.appendChild(senderInfoContainer);
                   messageElement.appendChild(contentWrapper);
               }
           }

           // ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ (JSPì—ì„œ JSON í˜•íƒœë¡œ ê°€ì ¸ì˜¨ ê²ƒì„ JavaScriptë¡œ íŒŒì‹±)
           const initialMessageJson = '<c:out value="${initialMessageJson}" escapeXml="false" />';
           let initialMessages = [];
           
           try {
        	   // JSON ë¬¸ìì—´ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
        	   if(initialMessageJson.trim() === '') {
        		   initialMessages = [];
        	   } else {
        		   initialMessages = JSON.parse(initialMessageJson);
        	   }
           } catch(e) {
        	   console.error("ì´ˆê¸° ë©”ì„¸ì§€ JSON íŒŒì‹± ì˜¤ë¥˜ : ", e);
        	   console.error("ë¬¸ì œì˜ JSON ë¬¸ìì—´ : ", initialMessageJson);
        	   initialMessages = [];	// íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸° ë©”ì‹œì§€ë¥¼ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•˜ì—¬ ì•± í¬ë˜ì‹œ ë°©ì§€
        	   displayMessage({ username: "SYSTEM", chatContent: "ì´ˆê¸° ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (JSON íŒŒì‹± ì‹¤íŒ¨)" }, false);
           }
           
           console.log("ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ ê²°ê³¼:", initialMessages);
           
           if(initialMessages.length === 0) {
        	   displayMessage({ username: "SYSTEM", chatContent: "ì•„ì§ ë©”ì„¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!" }, false);
        	   allMessagesLoaded = true;
        	   loadMoreBtn.style.display = 'none';
        	   noMoreMessagesIndicator.style.display = 'block';
           } else {
        	   // ì´ˆê¸° ë¡œë”© ë©”ì„¸ì§€ : ìµœì‹  ìˆœìœ¼ë¡œ ì˜¤ê¸° ë•Œë¬¸ì— ë’¤ì§‘ì–´ì•¼ í•¨.(ë‚ ì§œ, ì±„íŒ… ë²ˆí˜¸ ë‘˜ë‹¤).
        	   initialMessages.reverse();
        	   
        	   // ì´ˆê¸° ë©”ì„¸ì§€ ë Œë”ë§
	           for(let i = 0; i < initialMessages.length; i++) {
	        	   displayMessage(initialMessages[i], false);	// ì˜¤ë˜ëœ ê²ƒë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì¶”ê°€
	           }
        	   currentOffset = initialMessages.length;
        	   
        	   if(initialMessages.length > 0) {
	        	   oldestDisplayedDate = moment(initialMessages[0].chatSendDate).format('YYYY-MM-DD');
	        	   lastDisplayedDate = moment(initialMessages[initialMessages.length -1].chatSendDate).format('YYYY-MM-DD');
        	   }
           }
           // ì´ˆê¸° ë¡œë“œ í›„ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
           chatDisplay.scrollTop = chatDisplay.scrollHeight;
           
           // "ë” ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
           loadMoreBtn.addEventListener('click', function() {
               if (isLoading || allMessagesLoaded) {
                   return;
               }
               
               loadingIndicator.style.display = 'block';
               loadMoreBtn.disabled = true;
               isLoading = true;

               const oldScrollHeight = chatDisplay.scrollHeight; // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ë†’ì´ ì €ì¥

               fetch(`/chat/dm/channel/\${chatChannelNo}/more-messages?offset=\${currentOffset}&limit=\${messageLimit}`, {
                   headers: { [csrfHeader]: csrfToken }
               })
               .then(response => {
                   if (!response.ok) {
                       throw new Error('HTTP ì˜¤ë¥˜! ìƒíƒœ: ' + response.status);
                   }
                   return response.json();
               })
               .then(messages => {
                   loadingIndicator.style.display = 'none';
                   loadMoreBtn.disabled = false;
                   isLoading = false;
                   console.log("ë”ë³´ê¸° ë©”ì„¸ì§€ : ",  messages);

                   if (messages.length > 0) {
                       // ë” ë³´ê¸° ë©”ì„¸ì§€ ë Œë”ë§ì€ displayMessage í•¨ìˆ˜ ì‚¬ìš©
                       for(let i = 0; i < messages.length; i++) {
                    	   displayMessage(messages[i], true);		// prepend = true
                       }
                       currentOffset += messages.length;	// offset ì—…ë°ì´íŠ¸

                       // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€
                       const newScrollHeight = chatDisplay.scrollHeight;
                       chatDisplay.scrollTop = newScrollHeight - oldScrollHeight;
                   } else {
                       allMessagesLoaded = true;
                       loadMoreBtn.style.display = 'none';
                       noMoreMessagesIndicator.style.display = 'block';
                   }
               })
               .catch(error => {
                   console.error("ì´ì „ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
                   loadingIndicator.style.display = 'none';
                   loadMoreBtn.disabled = false;
                   isLoading = false;
                   displayMessage({ username: "SYSTEM", chatContent: "ì´ì „ ë©”ì‹œì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." }, false);
               });
           });

           // ì›¹ì†Œì¼“ ì—°ê²° í•¨ìˆ˜
           function connect() {
           	if(isConnected && stompClient !== null && stompClient.connected) {
           		console.warn("STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¤‘ë³µ ì—°ê²° ì‹œë„ ì°¨ë‹¨.");
           		return;
           	}
           	
               const socket = new SockJS('/ws-stomp');
               stompClient = Stomp.over(socket);
               
               stompClient.connect({
               	[csrfHeader]: csrfToken
               }, function(frame) {
               	console.log('Connected: ' + frame);
               	isConnected = true;
           
                   stompClient.subscribe(`/user/queue/messages`, function(messageOutput) {
                   	console.log("private message received : ", messageOutput.body);
                       displayMessage(JSON.parse(messageOutput.body), false); // ìƒˆ ë©”ì‹œì§€ëŠ” í•˜ë‹¨ì— ì¶”ê°€
                       chatDisplay.scrollTop = chatDisplay.scrollHeight; // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
                   }, {id: 'chatSubscription'});
               }, function(error) {
                   console.error('STOMP ì—°ê²° ì˜¤ë¥˜:', error);
               	isConnected = false;
               	stompClient = null;
               	displayMessage({ username: "SYSTEM", chatContent: "ì±„íŒ…ë°© ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”." }, false);
               });
           }
           
        	// í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
           function sendMessage() {
               const messageContent = messageInput.value.trim();
               if (messageContent && stompClient && stompClient.connected) {
                   const chatMessage = {
                       username: username,
                       chatChannelNo: chatChannelNo,
                       chatContent: messageContent,
                       comuNicknm: myComuNicknm,
                       type: 'TALK'
                   };
                   stompClient.send(`/pub/chat/dm/message`, {
               		[csrfHeader]: csrfToken
               	}, JSON.stringify(chatMessage));
               	messageInput.value = '';
               } else if(!stompClient || !stompClient.connected) {
            	   displayMessage({ username: "SYSTEM", chatContent: "ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." }, false);
               }
           }
                   
           // íŒŒì¼ ì „ì†¡ í•¨ìˆ˜
           async function sendFileMessage(file) {
           	if(!file || !stompClient || !stompClient.connected) return;
           	
           	const MAX_FILE_SIZE = 10 * 1024 * 1024;	// 10MB
           	const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf']; // PDF í—ˆìš©
           	
           	if(file.size > MAX_FILE_SIZE) {
           		alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
           		fileInput.value = '';
           		return;
           	}
           	
           	if(!ALLOWED_TYPES.includes(file.type)) {
           		alert("í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ì´ë¯¸ì§€(JPG, PNG, GIF) ë˜ëŠ” PDFë§Œ ì—…ë¡œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
           		fileInput.value = '';
           		return;
           	}
           	
           	const formData = new FormData();
           	formData.append('file', file);
           	formData.append('chatChannelNo', chatChannelNo);
           	
           	try {
           		const response = await fetch('/chat/dm/uploadImage', {
           			method: 'POST',
           			headers: {
           				[csrfHeader]: csrfToken
           			},
           			body: formData
           		});
           		
           		if(response.ok) {
           			console.log("íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ. ë©”ì„¸ì§€ ì²˜ë¦¬ëŠ” ì„œë²„ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.");
           			fileInput.value = '';
           		} else {
           			const errorText = await response.text();
           			console.error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ : ", response.status, errorText);
           			alert("íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
           		}
           	} catch(e) {
           		console.error("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ : " , e);
           		alert("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
           	}
           }

           // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
           sendButton.addEventListener('click', sendMessage);
           messageInput.addEventListener('keyup', function(event) {
               if (event.key === 'Enter') {
                   sendMessage();
               }
           });
           
        	// íŒŒì¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
           attachFileBtn.addEventListener('click', function() {
           	fileInput.click();
           });
        	
           fileInput.addEventListener('change', function() {
           	if(this.files && this.files.length > 0) {
           		const fileToUpload = this.files.item(0);
           		if(fileToUpload) {
           			sendFileMessage(fileToUpload);
           		}
           	}
           });

           // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²°
      		console.log("DOMContentLoaded ë: connect() í˜¸ì¶œ ì‹œë„");
          	connect();
       });
       
       function disconnect() {
       	if(stompClient !== null && stompClient.connected) {
       		console.log("STOMP ì—°ê²° í•´ì œ ìš”ì²­...");
       		stompClient.disconnect(function() {
       			console.log("STOMP Disconnected callback");
       			isConnected = false;
       			stompClient = null;
       		});
       	} else {
       		console.log("STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•Šì•„ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
       	}
       }
           
      	$(window).on('beforeunload', function() {
      		console.log("Window beforeunload: disconnect() í˜¸ì¶œ");
      		if(typeof disconnect === 'function') {
           	disconnect();
      		}
       });
   </script>
</body>
</html>
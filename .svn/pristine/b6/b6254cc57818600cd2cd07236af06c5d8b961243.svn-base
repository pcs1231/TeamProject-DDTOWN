<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN êµ¿ì¦ˆìƒµ - ì°œëª©ë¡</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_home.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <meta name="_csrf" content="${_csrf.token}"/>
	<meta name="_csrf_header" content="${_csrf.headerName}"/>
</head>
<body class="wishlist-page-body">
    <header class="site-header">
        <div class="logo">
            <a href="${pageContext.request.contextPath}/goods/main">DDTOWN SQUARE</a>
        </div>
        <nav class="utility-nav">
            <c:choose>
                <c:when test="${isLoggedIn == true}"> <%-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ isLoggedIn ëª¨ë¸ ì†ì„±ì„ ì „ë‹¬í•œë‹¤ê³  ê°€ì • --%>
                    <ul id="loggedInNav">
                        <li><a href="#" class="icon-btn" title="ì•Œë¦¼">ğŸ””</a></li>
                        <li><a href="${pageContext.request.contextPath}/mypage.html" class="icon-btn" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a></li>
                        <li><a href="#" class="icon-btn" title="ê³ ê°ì„¼í„°">ğŸ‘©â€ğŸ’»</a></li>
                        <li><a href="${pageContext.request.contextPath}/logout" id="logoutBtn" class="auth-link">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </c:when>
                <c:otherwise>
                    <ul id="loggedOutNav">
                        <li><a href="${pageContext.request.contextPath}/login.html" class="auth-link">ë¡œê·¸ì¸</a></li>
                        <li><a href="${pageContext.request.contextPath}/signup.html" class="signup-link">íšŒì›ê°€ì…</a></li>
                    </ul>
                </c:otherwise>
            </c:choose>
        </nav>
    </header>

    <nav class="main-navigation">
        <ul>
            <li><a href="${pageContext.request.contextPath}/goods/main">êµ¿ì¦ˆìƒµ</a></li>
            <li>
                <a href="#">ì„ í˜¸ë„ ì¡°ì‚¬</a>
                <ul class="submenu">
                    <li><a href="#">ì¸ê¸° íˆ¬í‘œ</a></li>
                </ul>
            </li>
            <li><a href="#">ì½˜ì„œíŠ¸</a></li>
        </ul>
    </nav>

    <div class="wishlist-container">
        <div class="wishlist-header">
            <h1>ì°œëª©ë¡</h1>
        </div>

        <div class="wishlist-items" id="wishlistItems">
            <c:choose>
                <c:when test="${not empty wishedGoodsList}"> <%-- wishedGoodsListëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ëŠ” ì°œ ëª©ë¡ ìƒí’ˆ ë°ì´í„° --%>
                    <c:forEach var="goods" items="${wishedGoodsList}">
                        <div class="wishlist-item" data-goods-no="${goods.goodsNo}"> <%-- ìƒí’ˆ ê³ ìœ  ë²ˆí˜¸ ì‚¬ìš© --%>
                            <div class="item-image">
                                <a href="${pageContext.request.contextPath}/goods/detail?goodsNo=${goods.goodsNo}">
                                    <img src="${not empty goods.representativeImageUrl ? goods.representativeImageUrl : 'https://via.placeholder.com/80x80/E6E6FA/000000?text=No+Image'}" 
                                         alt="${goods.goodsNm}">
                                </a>
                            </div>
                            <div class="item-info">
                                <a href="${pageContext.request.contextPath}/goods/detail?goodsNo=${goods.goodsNo}" class="item-name">${goods.goodsNm}</a>
                                <div class="item-price"><fmt:formatNumber value="${goods.goodsPrice}" type="number"/>ì›</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-action btn-cart" data-goods-no="${goods.goodsNo}">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                                <button class="btn-action btn-heart" data-goods-no="${goods.goodsNo}">
                                    <i class="fas fa-heart"></i> <%-- ì°œëª©ë¡ì´ë¯€ë¡œ í•­ìƒ ì±„ì›Œì§„ í•˜íŠ¸ --%>
                                </button>
                            </div>
                        </div>
                    </c:forEach>
                </c:when>
                <c:otherwise>
                    <div class="empty-wishlist-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px;">
                        <p>ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="${pageContext.request.contextPath}/goods/main" class="btn-shop">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
                    </div>
                </c:otherwise>
            </c:choose>
        </div>
        
        <div class="empty-wishlist" style="display: none;"></div> 
    </div>

    <div id="footer-placeholder"></div>

<script>
        let csrfToken;
        let csrfHeader;

        document.addEventListener('DOMContentLoaded', function() {
            // CSRF í† í° ì´ˆê¸°í™”
            const csrfMeta = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
            if (csrfMeta && csrfHeaderMeta) {
                csrfToken = csrfMeta.content;
                csrfHeader = csrfHeaderMeta.content;
            } else {
                console.error("CSRF meta tags not found.");
            }

            // ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬ (ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ isLoggedIn ëª¨ë¸ ì†ì„±ì„ ë°›ì•„ì™€ ì‚¬ìš©)
            const isLoggedIn = ${isLoggedIn}; 

            const loggedOutNav = document.getElementById('loggedOutNav');
            const loggedInNav = document.getElementById('loggedInNav');
            if (isLoggedIn) {
                if(loggedOutNav) loggedOutNav.style.display = 'none';
                if(loggedInNav) loggedInNav.style.display = 'flex';
            } else {
                if(loggedOutNav) loggedOutNav.style.display = 'flex';
                if(loggedInNav) loggedInNav.style.display = 'none';
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(event) {
                    alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    // ì‹¤ì œ ë¡œê·¸ì•„ì›ƒì€ ì„œë²„ ì¸¡ URLë¡œ ì´ë™í•˜ì—¬ ì²˜ë¦¬
                });
            }

            // ì™¸ë¶€ í‘¸í„° íŒŒì¼ ë¡œë“œ (ê²½ë¡œ ìˆ˜ì •)
            fetch('${pageContext.request.contextPath}/resources/html/footer.html')
                .then(response => response.ok ? response.text() : Promise.reject('Footer not found'))
                .then(data => {
                    const footerPlaceholder = document.getElementById('footer-placeholder');
                    if (footerPlaceholder) {
                        footerPlaceholder.innerHTML = data;
                    }
                })
                .catch(error => console.error('Error loading footer:', error));

            // ì°œëª©ë¡ ì•„ì´í…œ í‘œì‹œ/ìˆ¨ê¹€ ê´€ë¦¬ (JSP Cíƒœê·¸ë¡œ ì´ˆê¸° ë Œë”ë§ë˜ë¯€ë¡œ JSì—ì„œëŠ” ë™ì  ë³€ê²½ë§Œ ê´€ë¦¬)
            const wishlistItemsContainer = document.getElementById('wishlistItems');
            const emptyWishlistMessage = document.querySelector('.empty-wishlist-message'); 

            function updateWishlistDisplay() {
                const items = wishlistItemsContainer.querySelectorAll('.wishlist-item');
                if (items.length === 0) {
                    wishlistItemsContainer.style.display = 'none';
                    if(emptyWishlistMessage) emptyWishlistMessage.style.display = 'flex';
                } else {
                    wishlistItemsContainer.style.display = 'flex';
                    if(emptyWishlistMessage) emptyWishlistMessage.style.display = 'none';
                }
            }

            // ì°œ í•´ì œ ë° ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ê¸°ëŠ¥ (ì´ë²¤íŠ¸ ìœ„ì„)
            wishlistItemsContainer.addEventListener('click', function(event) {
                const target = event.target;
                const item = target.closest('.wishlist-item');
                if (!item) return;

                const goodsNo = item.dataset.goodsNo; // ìƒí’ˆ ë²ˆí˜¸ëŠ” ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ ê°€ì ¸ì˜´

                // 1. ì°œ í•´ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
                if (target.classList.contains('btn-heart') || target.closest('.btn-heart')) { 
                    if (!isLoggedIn) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                        window.location.href = '${pageContext.request.contextPath}/login';
                        return;
                    }

                    if (confirm('ì„ íƒí•œ ìƒí’ˆì„ ì°œëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        fetch('${pageContext.request.contextPath}/goods/wishlist', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrfHeader]: csrfToken
                            },
                            body: JSON.stringify({ goodsNo: parseInt(goodsNo) })
                        })
                        .then(response => {
                            if (!response.ok) {
                                if (response.status === 401) {
                                    alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                                    window.location.href = '${pageContext.request.contextPath}/login';
                                }
                                return response.json().then(errorData => {
                                    throw new Error(errorData.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            alert(data.message);
                            if (data.status === 'success' && data.action === 'removed') {
                                item.remove();
                                updateWishlistDisplay();
                            }
                        })
                        .catch(error => {
                            console.error('ì°œ í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
                            alert('ì°œ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        });
                    }
                } 
                // 2. ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ (ë…ë¦½ì ì¸ else if ë¸”ë¡)
                else if (target.classList.contains('btn-cart')) { 
                    const defaultQty = 1;

                    if (!isLoggedIn) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                        window.location.href = '${pageContext.request.contextPath}/login';
                        return;
                    }

                    const cartItemToAdd = {
                        goodsNo: parseInt(goodsNo),
                        cartQty: defaultQty,
                        goodsOptNo: item.dataset.goodsOptNo ? parseInt(item.dataset.goodsOptNo) : null
                    };

                    fetch('${pageContext.request.contextPath}/goods/cart/addMultiple', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify([cartItemToAdd])
                    })
                    .then(response => {
                        return response.text().then(text => {
                            if (!response.ok) {
                                if (response.status === 401) {
                                    alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                                    window.location.href = '${pageContext.request.contextPath}/login';
                                }
                                throw new Error(text || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
                            }
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e, "ì‘ë‹µ í…ìŠ¤íŠ¸:", text);
                                throw new Error("ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨");
                            }
                        });
                    })
                    .then(data => {
                        alert(data.message);
                        if (data.success) {
                            // ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸ (ì˜ˆ: í”Œë¡œíŒ… ì¥ë°”êµ¬ë‹ˆ ë±ƒì§€ ì¹´ìš´íŠ¸)
                        }
                    })
                    .catch(error => {
                        console.error('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
                        let errorMessage = 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        try {
                            const errorObj = JSON.parse(error.message);
                            if (errorObj && errorObj.message) {
                                errorMessage = errorObj.message;
                            }
                        } catch (e) { /* íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ìœ ì§€ */ }
                        alert(errorMessage);
                    });
                }
                // 3. ìƒí’ˆ í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™ (ë…ë¦½ì ì¸ else if ë¸”ë¡)
                else if (target.classList.contains('item-name') || target.closest('.item-image a')) {
                    const item = target.closest('.wishlist-item');
                    if (item) {
                        const goodsNo = item.dataset.goodsNo;
                        window.location.href = `${pageContext.request.contextPath}/goods/detail?goodsNo=${goodsNo}`;
                    }
                }
            });
            // DOMContentLoaded ì¢…ë£Œ
        });
    </script>
</body>
</html>
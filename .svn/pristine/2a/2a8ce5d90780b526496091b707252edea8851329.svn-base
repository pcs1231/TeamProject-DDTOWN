package kr.or.ddit.ddtown.service.goods.cart;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.ddtown.mapper.file.IAttachmentFileMapper;
import kr.or.ddit.ddtown.mapper.goods.IGoodsCartMapper;
import kr.or.ddit.ddtown.mapper.goods.IGoodsMapper;
import kr.or.ddit.ddtown.service.file.IFileService;
import kr.or.ddit.vo.file.AttachmentFileDetailVO;
import kr.or.ddit.vo.goods.GoodsCartVO;
import kr.or.ddit.vo.goods.goodsOptionVO;
import kr.or.ddit.vo.goods.goodsVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class CartServiceImpl implements ICartService {
	
	@Autowired
	private IGoodsMapper goodsMapper;
	
	@Autowired
	private IGoodsCartMapper cartMapper;
	
	@Autowired
	private IFileService fileService;

	@Override
	public List<GoodsCartVO> getCartItemsUsername(String userId) {
		log.info("서비스 계층!!!! getCartItemsUsername 호출 - userId: {}", userId);
		
		List<GoodsCartVO> cartItems = cartMapper.selectCartItemsUsername(userId);
		
		if(cartItems != null && !cartItems.isEmpty()) {
			for (GoodsCartVO items: cartItems) {
				goodsVO goods = goodsMapper.getGoodsDetail(items.getGoodsNo());
				
				if(goods != null) {
					items.setGoodsNm(goods.getGoodsNm());
					items.setGoodsPrice(goods.getGoodsPrice());
					
					// ### 상품 상세 페이지에서 사용하던 이미지 로직을 여기에 통합! ###
	                // 1. 대표 이미지 정보 설정
	                // goodsVO에서 fileGroupNo를 가져오므로, cartItem이 아닌 goods에서 fileGroupNo를 사용
					  if (goods.getFileGroupNo() != null && goods.getFileGroupNo() > 0) { // <-- null 체크 추가
	                    try {
	                        // fileService는 CartServiceImpl에 @Autowired로 주입되어 있어야 합니다.
	                        AttachmentFileDetailVO representativeFile = fileService.getRepresentativeFileByGroupNo(goods.getFileGroupNo());
	                        
	                        // GoodsCartVO에 대표 이미지 객체 자체를 설정하고 싶다면 필드 추가 후 사용
	                        // items.setRepresentativeImageFile(representativeFile); // GoodsCartVO에 AttachmentFileDetailVO 필드 필요

	                        if (representativeFile != null && representativeFile.getWebPath() != null && !representativeFile.getWebPath().isEmpty()) {
	                            // GoodsCartVO의 representativeImageUrl 필드에 웹 경로를 설정
	                            items.setRepresentativeImageUrl(representativeFile.getWebPath());
	                            log.debug("장바구니 - 상품 번호 {} 대표 이미지 경로: {}", items.getGoodsNo(), representativeFile.getWebPath());
	                        } else {
	                            // 대표 이미지를 못 찾았거나 웹 경로가 없는 경우
	                            items.setRepresentativeImageUrl(null); // 또는 기본 이미지 URL 설정
	                            log.warn("장바구니 - 상품 번호 {} (fileGroupNo: {})에 대한 대표 이미지를 찾을 수 없거나 웹 경로가 없습니다.", items.getGoodsNo(), goods.getFileGroupNo());
	                        }
	                    } catch (Exception e) {
	                        log.error("장바구니 - 상품 번호 {}의 대표 이미지 조회 중 오류발생!: {}", items.getGoodsNo(), e.getMessage());
	                        items.setRepresentativeImageUrl(null); // 오류 발생 시에도 null 처리
	                    }
	                } else {
	                    // fileGroupNo가 없거나 유효하지 않은 경우
	                    items.setRepresentativeImageUrl(null); // 또는 기본 이미지 URL 설정
	                    log.info("장바구니 - 상품 번호 {}에는 유효한 파일 그룹 번호가 없습니다.", items.getGoodsNo());
	                }
	                // ### 이미지 로직 통합 끝 ###
					
					// ### 상품 상태 코드 (goodsStatCode) 설정 - 수정된 부분 ###
	                String currentDbGoodsStatCode = null;
	                if (goods.getGoodsStatCode() != null) {
	                    currentDbGoodsStatCode = goods.getGoodsStatCode();
	                }

	                // JSP에서 사용할 값을 GoodsCartVO의 goodsStatCode 필드에 직접 설정
	                if (currentDbGoodsStatCode != null) {
	                    if ("GSC001".equalsIgnoreCase(currentDbGoodsStatCode)) { // DB 'GSC001'은 'IN_STOCK'에 해당
	                        items.setGoodsStatCode("IN_STOCK");
	                    } else if ("GSC002".equalsIgnoreCase(currentDbGoodsStatCode)) { // DB 'GSC002'는 'SOLD_OUT'에 해당
	                        items.setGoodsStatCode("SOLD_OUT");
	                    } else {
	                        // 정의되지 않은 상태 코드에 대한 처리
	                        items.setGoodsStatCode("UNKNOWN"); // 또는 기본값 설정
	                    }
	                } else {
	                    // goods.getGoodsStatCode() 자체가 null인 경우
	                    items.setGoodsStatCode("UNKNOWN"); // 또는 "IN_STOCK" 등 기본값
	                }
	                log.info("장바구니 항목 - 상품 번호 {}: DB 상태 코드 '{}' -> GoodsCartVO.goodsStatCode '{}'",
	                         items.getGoodsNo(), currentDbGoodsStatCode, items.getGoodsStatCode());
	                // ### 상품 상태 코드 설정 끝 ###
	            } else {
	                // 상품 정보가 null인 경우 (예: 상품 삭제됨)
	                // 이 경우 JSP에서 disabled 처리될 수 있도록 SOLD_OUT 또는 UNAVAILABLE로 설정
	                items.setGoodsStatCode("UNAVAILABLE"); // JSP에서 이 값도 SOLD_OUT처럼 처리하도록 수정 필요
	                log.warn("장바구니 상품 번호 {}에 해당하는 상품 정보를 찾을 수 없습니다. 상태를 'UNAVAILABLE'로 설정합니다.", items.getGoodsNo());
	            }

				
				//상품 옵션 정보 조회
				if(items.getGoodsOptNo() > 0) {
					//옵션이 선택된 경우에만
					goodsOptionVO option = goodsMapper.getOptionDetail(items.getGoodsOptNo());
					
					if (option != null) {
						items.setGoodsOptNm(option.getGoodsOptNm());
						items.setGoodsOptPrice(option.getGoodsOptPrice());
					}
				}
				
				//총 상품 금액 계산 (개별 상품 기준)
				//상품 가격과 옵션 가격 동일하기 때문에.. 총 금액을 저렇게 계산..!!!!
				int unitPrice = (goods != null ? goods.getGoodsPrice(): 0);
				items.setCartTotalAmount(unitPrice * items.getCartQty()); //총 금액
			}
		} else {
			log.warn("사용자 {}의 장바구니에 상품이 없습니다!!", userId);
			return new ArrayList<>();
		}
		return cartItems;
	}

	@Override
	public void addOrUpdateCartItem(GoodsCartVO cart) {
		log.info("서비스 계층 addOrUpdateCartItem 호출!!! - cart: {}", cart);
		
		//1.장바구니에 동일한 상품(옵션 포함)이 이미 있는지 확인!
		GoodsCartVO existingCartItem = cartMapper.selectCartItem(cart);
		
		//상품의 단가 미리 계산!
		goodsVO goods = goodsMapper.getGoodsDetail(cart.getGoodsNo());
		int goodsPrice = (goods != null) ? goods.getGoodsPrice(): 0;
		
		//총 금액!~
		int unitPrice = goodsPrice;
		
		if(existingCartItem != null) {
			//2.이미 존재하는 경우: 수량 및 총 금액 업데이트!!
			int newQty = existingCartItem.getCartQty() + cart.getCartQty(); //기존 수량 + 새로 추가하는 수량 업뎃!
			existingCartItem.setCartQty(newQty);
			existingCartItem.setCartTotalAmount(unitPrice * newQty); //업뎃된 총 금액!!
			
			cartMapper.updateCartItemQuantity(existingCartItem);
			log.info("장바구니 상품 수량 업뎃 완료!!: {}", existingCartItem);
		} else {
			//3.존재하지 않는 경우: 새로운 항목으로 추가!
			cart.setCartTotalAmount(unitPrice * cart.getCartQty()); //새로 추가하는 상품 총 금액
			cartMapper.insertCartItem(cart);
			log.info("장바구니에 새로운 상품 추가 완료!!: {}", cart);
		}
		
	}
	
	@Transactional
	@Override
	public int deleteCartItem(int cartNo) {
		log.info("서비스 계층 - 장바구니 항목 삭제 시도: cartNo={}", cartNo);
		
		try {
			int deletedRows = cartMapper.deleteCartItem(cartNo);
			
			if (deletedRows > 0) {
				log.info("장바구니 항목 (cartNo:{}) 삭제 성공!!! 삭제된 행 수: {}", cartNo, deletedRows);
			} else {
				log.warn("장바구니 항목 (cartNo:{}) 삭제 실패!!! 해당 항목을 찾을 수 없거나 이미 삭제 됐습니다!!", cartNo);
			}
			
			return deletedRows;
		} catch (Exception e) {
			log.error("장바구니 항목 (cartNo: {}) 삭제 중 예외 발생!!: {}", cartNo, e.getMessage(), e);
			
			throw new RuntimeException("장바구니 항목 삭제 중 오류 발생!!" + e.getMessage(), e);
		}
	}

	@Override
	@Transactional
	public int deleteSelectedCartItems(List<Integer> cartNoList) {
		log.info("서비스 계층 - 선택된 장바구니 항목 삭제 시도!! cartNoList={}", cartNoList);
		
		if (cartNoList == null || cartNoList.isEmpty()) {
			return 0;
		}
		
		int totalDeletedRows = 0;
		
		try {
			totalDeletedRows = cartMapper.deleteSelectedCartItems(cartNoList);
			log.info("선택된 장바구니 항목 삭제 성공! 삭제된 행 수: {}", totalDeletedRows);
			
			return totalDeletedRows;
			
		} catch (Exception e) {
			log.error("선택된 장바구니 항목 삭제 중 예외 발생!!: {}", e.getMessage(), e);
			
			//RuntimeException으로 래핑하여 상위 계층으로 예외를 전파하고 트랜잭션 롤백
			throw new RuntimeException("선택된 장바구니 항목 삭제 중 오류 발생: " + e.getMessage(), e);
		}
	}

	@Override
	public int updateCartQuantity(GoodsCartVO cart) {
		log.info("서비스 계층 - 장바구니 항목 수량 업뎃 시도!!! cartNo={}, cartQty={}", cart.getCartNo(), cart.getCartQty());
		try {
			int updatedRows = cartMapper.updateCartQuantity(cart);
			
			if (updatedRows > 0) {
				log.info("장바구니 항목 (cartNo:{}) 수량 업뎃 성공!!! 업뎃된 행의 수: {}", cart.getCartNo(), updatedRows);
			} else {
				log.info("장바구니 항목 (cartNo:{}) 수량 업뎃 실패!!! 해당 항목을 찾을 수 없거나 변경 사항이 없습니다!!", cart.getCartNo());
			}
			return updatedRows;
		} catch (Exception e) {
			log.error("장바구니 항목 (cartNo: {}) 수량 업뎃 중 예외 발생!!!! {}", cart.getCartNo(), e.getMessage(), e);
			throw new RuntimeException("장바구니 항목 수량 업뎃 중 오류 발생!!!" + e.getMessage(), e);
		}
	}
}

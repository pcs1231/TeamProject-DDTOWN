package kr.or.ddit.ddtown.controller.community;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.ddtown.service.community.ICommunityMainPageService;
import kr.or.ddit.vo.community.CommunityProfileVO;
import kr.or.ddit.vo.community.CommunityReplyVO;
import kr.or.ddit.vo.security.CustomOAuth2User;
import kr.or.ddit.vo.security.CustomUser;
import kr.or.ddit.vo.user.MemberVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/community")
public class CommunityReplyController {

	@Autowired
	private ICommunityMainPageService artistMainPageService;
	
	@PostMapping("/reply/insert")
	public ResponseEntity<Map<Object, Object>> replyInsert(CommunityReplyVO replyVO){
		
		log.info("reply 등록 요청 : " + replyVO);
		
		Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
	    MemberVO memberVO = null;
	    if(principal instanceof CustomUser) {
	        memberVO = ((CustomUser) principal).getMemberVO();
	    }else if(principal instanceof CustomOAuth2User) {
	        memberVO = ((CustomOAuth2User) principal).getMemberVO();
	    }
	    
	    // 접속중인 사용자가 해당 아티스트 커뮤니티에 팔로우 하고 있는 지 여부
	    int artGroupNo = replyVO.getArtGroupNo();
	    String memUsername = memberVO.getMemUsername();
	    Map<String, Object> currentUser = new HashMap<String, Object>();
	    currentUser.put("artGroupNo", artGroupNo);
	    currentUser.put("memUsername", memUsername);
	    
	    CommunityProfileVO currentUserComu = artistMainPageService.currentUserComufollowing(currentUser);
		
	    replyVO.setComuProfileNo(currentUserComu.getComuProfileNo());
	    
		ServiceResult result = artistMainPageService.replyInsert(replyVO);
		
		Map<Object, Object> map = new HashMap<>();
		map.put("result", result);
		map.put("replyVO", replyVO);
		
		return new ResponseEntity<Map<Object, Object>>(map, HttpStatus.OK);
	}
	
}

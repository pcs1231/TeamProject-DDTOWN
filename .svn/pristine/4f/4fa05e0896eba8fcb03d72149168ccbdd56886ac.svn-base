<%@page import="java.util.Date"%>
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" language="java"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_home.css" />
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css" />
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/concert_detail.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/themes/base/jquery-ui.min.css">
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js" defer integrity="sha256-9zljDKpE/mQxmaR4V2cGVaQ7arF3CcXxarvgr7Sj8Uc=" crossorigin="anonymous"></script>
<title>DDTOWN SQUARE</title>

<style type="text/css">

section {
    display: flex; /* 자식 요소들을 가로로 나란히 배치 */
    justify-content: center; /* 가운데 정렬 (필요에 따라 start, space-between 등 조절) */
    align-items: flex-start; /* 상단 정렬 (컨텐츠 높이가 다를 경우 유용) */
    flex-wrap: wrap; /* 화면이 좁아지면 자동으로 다음 줄로 넘어가도록 설정 */
    gap: 10px; /* 자식 요소들 사이의 간격 */
    margin: 10px auto; /* 중앙 정렬 및 위아래 여백 */
    max-width: 1200px; /* 전체 섹션의 최대 너비 설정 (조절 가능) */
    align-items: center;
}

/* 예약 정보 (달력 + 버튼)를 위한 새로운 컨테이너 */
.concert-selectedseat-section {
    width: 280px;
    flex-shrink: 0; /* 공간이 부족해도 축소하지 않음 (이 값을 1로 주면 축소될 수 있음) */
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 8px;
    background-color: #eee;
    display: flex;
    flex-direction: column; /* 세로 방향으로 요소 배치 */
    align-items: center; /* 중앙 정렬 */
}

.concert-selectedseat-section h3 {
    margin-top: 25px;
    color: #333;
	padding: 10px;
}

/* 예매하기 버튼 스타일 */
.btn-reserve {
    width: 100%; /* 부모 너비에 맞춤 */
    max-width: 300px; /* 최대 너비 설정 */
    padding: 15px 20px;
    background-color: #8a2be2;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

.btn-cancel {
    width: 100%; /* 부모 너비에 맞춤 */
    max-width: 300px; /* 최대 너비 설정 */
    padding: 15px 20px;
    background-color: #eee;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

.seat-map-container {
	position: relative;
	height: 400px;
	width: 500px;
	overflow: hidden;
}

.seat-map-container object {
	position: absolute;
	top: 50%;
	left: 68%;
	transform: translate(-50%, -50%) scale(0.4);
	width: 330%;
	height: 235%;
	object-fit: contain;
}

.concert-detail-container {
	max-width: 600px;
	flex-shrink: 0;
}

.concert-detail-grid {
	height: 470px;
}


</style>
</head>
<body>
	<jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />

	<h3>좌석 선택</h3>
	<section>
	<div class="concert-detail-container">
	<c:choose>
        <c:when test="${not empty concertVO }">
		    <div class="concert-detail-grid">
		        <div class="seat-map-container" style="position: relative; height: 400px;">
	            	<object data="${pageContext.request.contextPath}/resources/concertHall.svg" type="image/svg+xml" id="concertHallSvg"></object>
	            	<object data="${pageContext.request.contextPath}/resources/seatSection.svg" type="image/svg+xml" id="seatSectionSvg"></object>
	            </div>
		    </div>
    	</c:when>
    	<c:otherwise>
    		<div>콘서트 상세 내용을 불러올 수 없습니다.</div>
    	</c:otherwise>
    </c:choose>
    </div>
    
	<div class="concert-selectedseat-section">
    	<h3>좌석 등급 / 가격</h3>
    	<div class="concert-seat-display">
    		<hr>
            <c:choose>
	            <c:when test="${not empty seatList }">
		            <div class="concert-price">
		                <c:forEach var="seat" items="${seatList }">
			                <div>
			                	<c:if test="${seat.seatGradeCode == 'SGC001' }">
			                		STANDING석: ${ seat.seatPrice}원
			                	</c:if>
			                	<c:if test="${seat.seatGradeCode == 'SGC002' }">
			                		VIP석: ${ seat.seatPrice}원
			                	</c:if>
			                	<c:if test="${seat.seatGradeCode == 'SGC003' }">
			                		R석: ${ seat.seatPrice}원
			                	</c:if>
			                	<c:if test="${seat.seatGradeCode == 'SGC004' }">
			                		S석: ${ seat.seatPrice}원
			                	</c:if>
			                </div>
		                </c:forEach>
		            </div>
	            </c:when>
	            <c:otherwise>
	            	<div>가격 정보가 없습니다.</div>
	            </c:otherwise>
            </c:choose>
    	</div>
    	<hr>
    	<h3>선택 좌석 정보</h3>
    	<div id="selectedSeatInfo">
    		선택된 자석이 없습니다.
    	</div>
    	
    	<hr>
    	<h3>총 결제 금액</h3><span id="totalPrice">0원</span>
    	<hr>
    	<a type="button" href="/concert/detail/${concertVO.concertNo}"class="btn-cancel" id="btnCancel">취소</a>
    	<button class="btn-reserve" id="btnReserve">결제하기</button>
    </div>
    </section>
	<div id="footer-placeholder"></div>
</body>
<script>

	$(function() {
		
		const concertHallSvg = document.getElementById("concertHallSvg");
		const seatSectionSvgObj = document.getElementById("seatSectionSvg");
		
		let seats = [];	// 모든 좌석 요소를 저장할 배열
		const selectedSeatMap = new Map();
		const totalPrice = $('#totalPrice');
		
		// JSP에서 전달받은 JSON 데이터 파싱
		const allTicketList = JSON.parse('${allTicketList}');
		const bookedSeatNo = JSON.parse('${bookedSeatNo}');
		
		console.log("모든 티켓 정보: ", allTicketList);
		console.log("예매된 티켓 정보: ", bookedSeatNo);
		
		// 두 파일이 모두 로드되었는지 확인하는 카운터	
		let loadedSvgCount = 0;
		const totalSvgToLoad = 2;
		
		// 모든 svg 로드가 완료되었을 때 실행될 함수
		function onAllSvgsLoaded() {
			console.log("모든 SVG 파일이 성공적으로 로드되었습니다.");
			
			const seatSectionSvg = seatSectionSvgObj.contentDocument;
			if(seatSectionSvg) {
				const svgRoot = seatSectionSvg.querySelector("svg");
				if(svgRoot) {
					seats = svgRoot.querySelectorAll("rect, circle");
					
					// 좌석 요소에 대한 로직 추가
					seats.forEach(function(seatElement) {
						$(seatElement).on('click', function() {
							const seatId = $(this).attr('id');
							console.log("클릭된 좌석 : ", seatId);
						});
					});
				}
			}
		}
		
		// concertHallSvg 로드 완료 핸들러
		concertHallSvg.onload = function() {
			console.log("concertHallSvg 파일이 성공적으로 로드되었습니다.");
			loadedSvgCount++;
			if(loadedSvgCount === totalSvgToLoad) {
				onAllSvgsLoaded();
			}
		};
		
		seatSectionSvg.onload = function() {
			console.log("seatSectionSvg 파일이 성공적으로 로드되었습니다.");
			loadedSvgCount++;
			if(loadedSvgCount === totalSvgToLoad) {
				onAllSvgsLoaded();
			}
		};
		
		// 결제하기 버튼 이벤트
		$('#btnReserve').on('click', function() {
	    	console.log("결제하기 클릭됨");
		});
		
	});


</script>
</html>
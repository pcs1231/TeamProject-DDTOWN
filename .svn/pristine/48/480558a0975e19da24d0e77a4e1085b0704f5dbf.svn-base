<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>

<sec:authentication property="principal.username" var="currentUsername"/>
<c:set var="isUserLoggedIn" value="${not empty currentUsername && currentUsername ne 'anonymousUser'}"/>

<style>
	/* alertDisplay.jspì˜ <style> íƒœê·¸ ë‚´ìš© ë˜ëŠ” ê³µí†µ CSS íŒŒì¼ì— ì¶”ê°€ */

	/* ìš°ì¸¡ ìƒë‹¨ ìœ í‹¸ë¦¬í‹° ë©”ë‰´ ì •ë ¬ */
	.utility-nav {
	    display: flex; /* ìì‹ ìš”ì†Œë“¤ì„ ê°€ë¡œë¡œ ì •ë ¬ */
	    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
	}
	.utility-nav > ul {
	    display: flex; /* li ìš”ì†Œë“¤ì„ ê°€ë¡œë¡œ ì •ë ¬ */
	    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
	    list-style: none; /* ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
	    margin: 0;
	    padding: 0;
	}
	.utility-nav > ul > li {
	    margin-left: 15px; /* ê° ë©”ë‰´ í•­ëª© ì‚¬ì´ì˜ ê°„ê²© */
	}
	.utility-nav a.icon-btn {
	    font-size: 1.5rem; /* ì•„ì´ì½˜ í¬ê¸°ë¥¼ í‚¤ì›€ (ê¸°ì¡´ 1.5emê³¼ ìœ ì‚¬) */
	    color: #4f5962; /* ì•„ì´ì½˜ ìƒ‰ìƒ (AdminLTE í…Œë§ˆì™€ ìœ ì‚¬í•˜ê²Œ) */
	    text-decoration: none;
	}
	.utility-nav a.auth-link {
	    font-size: 1rem;
	    color: #4f5962;
	    text-decoration: none;
	}
	.utility-nav a:hover {
	    color: #007bff; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìƒ‰ìƒ ë³€ê²½ */
	}


	/* ì•Œë¦¼ ì•„ì´ì½˜ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
	.alert-icon-container { 
	    position: relative;
	    display: flex; /* ë‚´ë¶€ ìš”ì†Œ ì •ë ¬ì„ ìœ„í•´ flexë¡œ ì„¤ì • */
	    align-items: center;
	    justify-content: center;
	}

	/* ì•Œë¦¼ ì¢… ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
	.alert-bell { 
	    font-size: 1.5rem; /* ì•„ì´ì½˜ í¬ê¸° (em -> rem ë³€ê²½, ì¼ê´€ì„±) */
	    color: #333;
	    cursor: pointer;
	    line-height: 1; /* ì•„ì´ì½˜ì˜ ìˆ˜ì§ ì •ë ¬ì„ ìœ„í•´ ì¶”ê°€ */
	}

	/* ì•Œë¦¼ ë°°ì§€(ìˆ«ì) ìŠ¤íƒ€ì¼ - ì•„ì´ì½˜ì„ ê°€ë¦¬ì§€ ì•Šë„ë¡ ìœ„ì¹˜ ì¡°ì • */
	.alert-badge { 
	    position: right;
	    top: -8px;       /* ìœ„ìª½ìœ¼ë¡œ ë” ì˜¬ë¦¼ */
	    right: -10px;    /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë” ì´ë™ */
	    background-color: #dc3545; /* Bootstrap danger color */
	    color: white;
	    border-radius: 50%;
	    padding: 1px 5px; /* íŒ¨ë”© ì¡°ì • */
	    font-size: 0.7rem; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
	    font-weight: bold;
	    border: 2px solid white; /* ì•„ì´ì½˜ê³¼ êµ¬ë¶„ë˜ë„ë¡ í…Œë‘ë¦¬ ì¶”ê°€ */
	    display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
	    line-height: 1; /* ìˆ«ì ìˆ˜ì§ ì •ë ¬ */
	    min-width: 18px; /* í•œ ìë¦¬ ìˆ«ìë„ ì›í˜• ìœ ì§€ */
	    text-align: center;
	}

	/* ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
	.alert-dropdown { 
	    display: none;
	    position: absolute;
	    top: calc(100% + 10px); /* ì•„ì´ì½˜ ì•„ë˜ì— ì•½ê°„ì˜ ê°„ê²©ì„ ë‘ê³  í‘œì‹œ */
	    right: 0;
	    background-color: white;
	    border: 1px solid #ddd;
	    border-radius: 0.25rem; /* ì•½ê°„ì˜ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
	    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	    width: 320px; /* ë„ˆë¹„ ì¡°ì • */
	    max-height: 400px;
	    overflow-y: auto;
	    z-index: 1000;
	}

	/* ... (ë‚˜ë¨¸ì§€ .alert-item, .timestamp ë“± ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ê²ƒì„ ì‚¬ìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤) ... */
    .alert-dropdown-header { 
        padding: 10px;
        font-weight: bold;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .alert-dropdown-header a {
        font-size: 0.9em;
        color: #007bff;
        text-decoration: none;
    }
    .alert-item { 
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
        cursor: pointer;
    }
    .alert-item:last-child {
        border-bottom: none;
    }
    .alert-item.unread {
        background-color: #f8f9fa;
    }
    .alert-item:hover {
        background-color: #e9ecef;
    }
    .alert-item .message { 
        display: block;
        margin-bottom: 5px;
        color: #333;
    }
    .alert-item .timestamp { 
        font-size: 0.8em;
        color: #777;
    }
    .no-alerts { 
        padding: 20px;
        text-align: center;
        color: #888;
    }
</style>

<!--ë¡œê·¸ì¸ í–ˆì„ë•Œë§Œ ì•Œë¦¼ ì•„ì´ì½˜ ì˜ì—­ í‘œì‹œ-->
<c:if test="${isUserLoggedIn}">
    <div class="alert-icon-container">
        <span class="alert-bell" id="alertBellIcon">ğŸ””</span>
        <span class="alert-badge" id="alertBadge">0</span>	<!--ì•ˆì½ì€ ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ-->
        <div class="alert-dropdown" id="alertDropdownList">
            <div class="alert-dropdown-header">
                <span>ì•Œë¦¼</span>
                <a href="<c:url value='/mypage/alerts'/>" id="viewAllAlertsLink">ëª¨ë‘ ë³´ê¸°</a>
            </div>
            <div id="alertItemsContainer">
                <div class="no-alerts">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>		<!--ì´ˆê¸°ê°’-->
            </div>
        </div>
    </div>
</c:if>


<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {		// í˜ì´ì§€ HTML ì½”ë“œ ëª¨ë‘ ì‹¤í–‰ í›„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    const csrfToken = $("meta[name='_csrf']").attr("content");
    const csrfHeader = $("meta[name='_csrf_header']").attr("content");

    const alertBellIcon = $('#alertBellIcon');
    const alertBadge = $('#alertBadge');
    const alertDropdownList = $('#alertDropdownList');
    const alertItemsContainer = $('#alertItemsContainer');
    
    const currentUsername = "<c:out value='${currentUsername}'/>"; 
    const isUserLoggedIn = ${isUserLoggedIn};

    if (!isUserLoggedIn || !currentUsername) {
        console.log("ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    let stompClient = null;		// STOMP í´ë¼ë¦¬ì–¸íŠ¸ ê°ì²´ ì €ì¥ìš© ë³€ìˆ˜
    let unreadAlertCount = 0;		// ì•ˆì½ì€ ì•Œë¦¼ ê°œìˆ˜ ë³€ìˆ˜

    function loadInitialAlerts() { 		// í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœê·¼ ì•Œë¦¼ëª©ë¡, ì•ˆì½ì€ ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        $.ajax({
            url: '<c:url value="/mypage/alerts/latestAndUnreadCnt"/>', 
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    unreadAlertCount = response.unreadCnt || 0;
                    updateAlertBadge(unreadAlertCount); 
                    if (response.alerts && response.alerts.length > 0) { 
                        alertItemsContainer.empty();		// no-alerts ì•Œë¦¼ ë©”ì‹œì§€ ì œê±°
                        response.alerts.forEach(function(alertData) { 
                            prependAlertToList(alertData); 		// ê° ì•Œë¦¼ ëª©ë¡ì— ì¶”ê°€
                        });
                    } else {
                        alertItemsContainer.html('<div class="no-alerts">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
                    }
                } else {
                    console.error("ì´ˆê¸° ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:", response.message);
                }
            },
            error: function(xhr) {
                console.error("ì´ˆê¸° ì•Œë¦¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", xhr.responseText);
            }
        });
    }
	
    function updateAlertBadge(count) {		// ì•ˆì½ì€ ì•Œë¦¼ ê°œìˆ˜ ë°›ì•„ì„œ UI ì—…ë°ì´íŠ¸ 
        unreadAlertCount = count;
        if (unreadAlertCount > 0) {
            alertBadge.text(unreadAlertCount > 99 ? "99+" : unreadAlertCount).show();
        } else {
            alertBadge.hide();
        }
    }

    function prependAlertToList(alertData) { // ë‹¨ì¼ ì•Œë¦¼ ë°ì´í„° -> HTML ìš”ì†Œ ì¶”ê°€ í›„ ëª©ë¡ ìƒë‹¨ì— ì¶”ê°€, alertData - ì„œë²„ë¡œë¶€í„° ë°˜í™˜ë°›ì€ ì•Œë¦¼ ê°ì²´ (AlertVO)
        if (alertItemsContainer.find('.no-alerts').length > 0) {
            alertItemsContainer.empty();
        }

        // WebSocketìœ¼ë¡œ ì˜¤ëŠ” ìƒˆ ì•Œë¦¼ì€ ê¸°ë³¸ê°’ ì•ˆì½ìŒ 'N' , alertData(AlerVO)ì—ì„œ readYnê°’ êº¼ëƒ„
        const isUnread = alertData.alertReadYn === 'N' || alertData.alertReadYn === false || typeof alertData.alertReadYn === 'undefined';
        
        const itemHtml = `
            <div class="alert-item \${isUnread ? 'unread' : 'read'}" data-alert-no="\${alertData.alertNo}"> 
                <div class="alert-content"> 
                    <span class="message">\${alertData.alertContent || 'ìƒˆë¡œìš´ ì•Œë¦¼'}</span>
                    <span class="timestamp">\${formatAlertTimestamp(alertData.alertCreateDate)}</span> 
                </div>
            </div>
        `;
        const newItem = $(itemHtml);

        if (alertData.alertUrl) {		// ì•Œë¦¼ í´ë¦­ ì‹œ ë™ì‘ ì •ì˜ìš©
            newItem.on('click', function() {
                markAlertAsRead($(this).data('alertNo'), $(this)); 	// ì½ìŒ ì²˜ë¦¬ í›„
                window.location.href = "<c:url value='/'/>" + alertData.alertUrl.replace(/^\//, '');		// í•´ë‹¹ URLë¡œ ì´ë™
            });
        } else {
             newItem.on('click', function() { // URL ì—†ì–´ë„ ë™ì‘
                markAlertAsRead($(this).data('alertNo'), $(this)); 
            });
        }
        alertItemsContainer.prepend(newItem);
    }
    
    function formatAlertTimestamp(timestamp) { 		// TIMESTAMP ì´ìš©í•´ì„œ ë°©ê¸ˆì „, Në¶„ì „ ë™ì‘, timestamp - Date ê°ì²´ë¡œ ë³€í™˜ ê°€ëŠ¥
        if (!timestamp) return "";
        const date = new Date(timestamp); 
        const now = new Date();
        const diffMs = now - date;
        const diffSeconds = Math.round(diffMs / 1000);
        const diffMinutes = Math.round(diffSeconds / 60);
        const diffHours = Math.round(diffMinutes / 60);
        const diffDays = Math.round(diffHours / 24);

        if (diffSeconds < 60) return "ë°©ê¸ˆ ì „";
        if (diffMinutes < 60) return `\${diffMinutes}ë¶„ ì „`;
        if (diffHours < 24) return `\${diffHours}ì‹œê°„ ì „`;
        if (diffDays < 7) return `\${diffDays}ì¼ ì „`;
        return `\${date.getFullYear()}-\${String(date.getMonth() + 1).padStart(2, '0')}-\${String(date.getDate()).padStart(2, '0')}`;
    }

    function markAlertAsRead(alertNo, itemElement) { 		// íŠ¹ì • ì•Œë¦¼ ì½ìŒì²˜ë¦¬ (ê°œë³„) , alertNo - ì½ìŒì²˜ë¦¬í•  ì•Œë¦¼ë²ˆí˜¸, itemElement - í™”ë©´ì—ì„œ ìƒíƒœ ë³€ê²½í•  ì•Œë¦¼ ìš”ì†Œ
        if (!itemElement || !itemElement.hasClass('unread')) return;		// ì´ë¯¸ ì½ì€ê±´ ìš”ì²­ ì•ˆë³´ëƒ„

        $.ajax({
            url: '<c:url value="/mypage/alerts/read"/>', 
            type: 'POST',
            data: { alertNo: alertNo }, 
            headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {},
            success: function(response) {
                if (response.success) {
                    itemElement.removeClass('unread').addClass('read');
                    unreadAlertCount = Math.max(0, unreadAlertCount - 1);
                    updateAlertBadge(unreadAlertCount); // ê°œë³„ ì•Œë¦¼ ì½ìŒì²˜ë¦¬ ì´í›„ì— ì•ˆì½ì€ ê°œìˆ˜ 1 ê°ì†Œ
                } else {
                    console.warn("ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨(ì„œë²„):", response.message);
                }
            },
            error: function(xhr) {
                console.error("ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", xhr.responseText);
            }
        });
    }

    function connectWebSocket() {		// WebSocket ì„œë²„ ì—°ê²°, ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ì„œ ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹ 
        const socket = new SockJS('<c:url value="/ws-stomp"/>');		// WebSocketConfig ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function (frame) { 
            console.log('STOMP Connected: ' + frame);
            stompClient.subscribe('/user/' + currentUsername + '/queue/alert', function (alertMessage) { 		// /user/{username}/queue/alerts ê²½ë¡œë¡œ ìì‹ ì—ê²Œ ì˜¤ëŠ” ì•Œë¦¼ë§Œ ë°›ìŒ
                try {
                    const newAlert = JSON.parse(alertMessage.body); 
                    console.log("ìƒˆ ì•Œë¦¼ ìˆ˜ì‹ :", newAlert);
                    prependAlertToList(newAlert); 
                    updateAlertBadge(++unreadAlertCount); 
                    if (Notification && Notification.permission === "granted") { // ë¸Œë¼ìš°ì € ì•Œë¦¼ API ì‚¬ìš© ì‹œ ì•Œë¦¼ ê°ì²´ í™•ì¸
                        new Notification("ìƒˆ ì•Œë¦¼ from DDTOWN", { body: newAlert.alertContent });
                    }
                } catch (e) {
                    console.error("ì•Œë¦¼ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", e, alertMessage.body);
                }
            });
        }, function(error) {
            console.error('STOMP ì—°ê²° ì˜¤ë¥˜: ' + error);
            setTimeout(connectWebSocket, 5000);		// ì—ëŸ¬ ì‹œ 5ì´ˆí›„ ì¬ì—°ê²° ì‹œë„
        });
    }

    alertBellIcon.on('click', function(event) {		// ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­í•˜ë©´ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë…¸ì¶œìš© í•¸ë“¤ëŸ¬
        event.stopPropagation();		// ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (event.preventDefault())
        alertDropdownList.toggle();
    });

    $(document).on('click', function(event) {		// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ ì˜ì—­ í´ë¦­í•˜ë©´ ë©”ë‰´ã…— ìˆ¨ê¸°ê¸°
        if (!alertBellIcon.is(event.target) && alertDropdownList.has(event.target).length === 0) {
            alertDropdownList.hide();
        }
    });
    
    function requestBrowserNotificationPermission() { 	// ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if (typeof Notification !== 'undefined' && Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission().then(function (permission) {
                if (permission === "granted") {
                    console.log("ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨");
                } else {
                    console.log("ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨");
                }
            });
        }
    }

    if (isUserLoggedIn) {		// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœë©´ ì•Œë¦¼ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹¤í–‰
        requestBrowserNotificationPermission(); 
        loadInitialAlerts();    
        connectWebSocket();
    }
});
</script>
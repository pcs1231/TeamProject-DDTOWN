<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통계 관리 - DDTOWN 관리자 시스템</title>
    <%@ include file="../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* statistics.html 에만 적용될 추가/수정 스타일 */
        .stats-section { 
            margin-bottom: 30px; 
            background-color: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04); 
        }
        .stats-section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .stats-section-header h3 { 
            font-size: 1.4em; 
            color: #2c3e50; 
            margin: 0; 
        }
        .stats-filter-group { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .stats-filter-group label { 
            font-weight: 500; 
        }
        .stats-filter-group select { 
            padding: 8px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-size: 0.9em; 
        }
        .stats-cards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 15px 0;
            background: #f4f7fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stats-table-container {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="./modules/header.jsp" %>
        <div class="emp-body-wrapper">
            <%@ include file="./modules/aside.jsp" %>

            <main class="emp-content">
                <!-- 방문자/신규가입자 통계 -->
                <section class="stats-section">
                    <div class="stats-section-header">
                        <h3><i class="fas fa-users"></i> 사용자 활동 통계</h3>
                        <div class="stats-filter-group">
                            <label for="userStatsPeriod">기간:</label>
                            <select id="userStatsPeriod">
                                <option value="daily">일간</option>
                                <option value="weekly">주간</option>
                                <option value="monthly">월간</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="visitorTrendChart"></canvas></div>
                    <div class="chart-container"><canvas id="signupTrendChart"></canvas></div>
                </section>
                <!-- 굿즈샵 통계 -->
                <section class="stats-section">
                    <div class="stats-section-header">
                        <h3><i class="fas fa-shopping-cart"></i> 굿즈샵 통계</h3>
                        <div class="stats-filter-group">
                            <select id="goodsShopPeriodFilter">
                                <option value="daily">일별</option>
                                <option value="weekly">주별</option>
                                <option value="monthly">월별</option>
                            </select>
                        </div>
                    </div>
                    <div class="stats-cards-grid">
                        <div class="dashboard-card summary-card">
                            <div class="card-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="card-content">
                                <h3>이 달 매출액</h3>
                                <p class="count">5,250,000 <span class="unit">원</span></p>
                            </div>
                        </div>
                        <div class="dashboard-card summary-card">
                            <div class="card-icon"><i class="fas fa-receipt"></i></div>
                            <div class="card-content">
                                <h3>이 달 주문 건수</h3>
                                <p class="count">210 <span class="unit">건</span></p>
                            </div>
                        </div>
                        <div class="dashboard-card summary-card">
                            <div class="card-icon"><i class="fas fa-undo-alt"></i></div>
                            <div class="card-content">
                                <h3>이 달 환불/취소 건수</h3>
                                <p class="count">15 <span class="unit">건</span></p>
                            </div>
                        </div>
                    </div>

                    <h4>판매 통계</h4>
                    <div class="chart-container">
                        <canvas id="salesRevenueChart"></canvas>
                    </div>

                    <div class="stats-table-container">
                        <h5>인기 판매 품목 (Top 5)</h5>
                        <table class="ea-table">
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>상품명</th>
                                    <th>판매수량</th>
                                    <th>총 판매금액</th>
                                </tr>
                            </thead>
                            <tbody id="topSellingItemsTable">
                                <tr>
                                    <td>1</td>
                                    <td>샘플 상품 A</td>
                                    <td>120</td>
                                    <td>1,200,000 원</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-center">데이터가 없습니다.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 style="margin-top:25px;">환불/취소/교환 통계</h4>
                    <div class="chart-container">
                        <canvas id="returnsCancellationsChart"></canvas>
                    </div>

                    <div class="stats-table-container">
                        <h5>최근 환불/취소/교환 내역 (최근 5건)</h5>
                        <table class="ea-table">
                            <thead>
                                <tr>
                                    <th>주문번호</th>
                                    <th>상품명</th>
                                    <th>유형</th>
                                    <th>사유</th>
                                    <th>처리상태</th>
                                </tr>
                            </thead>
                            <tbody id="recentReturnsTable">
                                <tr>
                                    <td>ORD001</td>
                                    <td>샘플 상품 B</td>
                                    <td>환불</td>
                                    <td>단순 변심</td>
                                    <td>환불완료</td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="text-center">데이터가 없습니다.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <!-- 분야별 수익 통계 -->
                <section class="stats-section">
                    <div class="stats-section-header">
                        <h3><i class="fas fa-wallet"></i> 분야 별 수익 통계</h3>
                        <div class="stats-filter-group">
                            <select id="revenueSectorFilter">
                                <option value="all">전체 수익</option>
                                <option value="goodsshop">굿즈샵</option>
                                <option value="membership">멤버십</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="revenueBySectorChart"></canvas></div>
                </section>
                <!-- 커뮤니티 활동 통계 -->
                <section class="stats-section">
                    <div class="stats-section-header">
                        <h3><i class="fas fa-comments"></i> 커뮤니티 활동 통계</h3>
                        <div class="stats-filter-group">
                            <select id="communityActivityPeriod">
                                <option value="daily">일간</option>
                                <option value="weekly">주간</option>
                                <option value="monthly">월간</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="postCountChart"></canvas></div>
                    <div class="chart-container"><canvas id="likeCountChart"></canvas></div>
                </section>
                <!-- 월드컵 TOP 아티스트 통계 -->
                <section class="stats-section">
                    <div class="stats-section-header">
                        <h3><i class="fas fa-trophy"></i> 이상형 월드컵 TOP 아티스트 통계</h3>
                        <div class="stats-filter-group">
                            <label for="worldcupRoundFilter">회차/기간:</label>
                            <select id="worldcupRoundFilter">
                                <option value="latest">최근</option>
                                <option value="2025_q1">2025년 1분기</option>
                            </select>
                        </div>
                    </div>
                    <div class="stats-table-container">
                        <h5>TOP 아티스트 (Top 10)</h5>
                        <table class="ea-table">
                            <thead><tr><th>순위</th><th>아티스트명</th><th>득표수</th><th>비율</th></tr></thead>
                            <tbody id="topArtistsTable">
                                <tr><td>1</td><td>아티스트 X</td><td>5,230</td><td>35.2%</td></tr>
                                <tr><td colspan="4" class="text-center">데이터가 없습니다.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="chart-container"><canvas id="topArtistsChart"></canvas></div>
                </section>
            </main>
        </div>

        <footer class="emp-footer">
            <p>&copy; 2025 DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 사이드바 메뉴 로직
            const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
            navItemsWithSubmenu.forEach(item => {
                const arrow = item.querySelector('.submenu-arrow');
                item.addEventListener('click', function(event) {
                    event.preventDefault();
                    const parentLi = this.parentElement;
                    const submenu = this.nextElementSibling;
                    if (submenu && submenu.classList.contains('emp-submenu')) {
                        const parentUl = parentLi.parentElement;
                        if (parentUl) {
                            Array.from(parentUl.children).forEach(siblingLi => {
                                if (siblingLi !== parentLi) {
                                    const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
                                    if (siblingSubmenuControl) {
                                        const siblingSubmenu = siblingSubmenuControl.nextElementSibling;
                                        siblingSubmenuControl.classList.remove('open');
                                        if (siblingSubmenu && siblingSubmenu.classList.contains('emp-submenu')) {
                                            siblingSubmenu.style.display = 'none';
                                        }
                                        const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
                                        if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
                                    }
                                }
                            });
                        }
                    }
                    this.classList.toggle('open');
                    if (submenu && submenu.classList.contains('emp-submenu')) {
                        submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
                        if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                });
            });

            // 로그아웃 버튼
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (confirm("로그아웃 하시겠습니까?")) {
                        alert("로그아웃 되었습니다.");
                    }
                });
            }

            // Chart.js 초기화
            // 매출 추이 차트
            const salesRevenueCtx = document.getElementById('salesRevenueChart').getContext('2d');
            new Chart(salesRevenueCtx, {
                type: 'line',
                data: {
                    labels: ['1월', '2월', '3월', '4월', '5월', '6월'],
                    datasets: [{
                        label: '매출액',
                        data: [1200000, 1900000, 1500000, 2500000, 2200000, 3000000],
                        borderColor: '#3498db',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // 환불/취소 사유 차트
            const returnsCancellationsCtx = document.getElementById('returnsCancellationsChart').getContext('2d');
            new Chart(returnsCancellationsCtx, {
                type: 'pie',
                data: {
                    labels: ['단순 변심', '상품 불량', '배송 지연', '기타'],
                    datasets: [{
                        data: [40, 25, 20, 15],
                        backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // 기간 필터 변경 이벤트
            const periodFilter = document.getElementById('goodsShopPeriodFilter');
            if (periodFilter) {
                periodFilter.addEventListener('change', function() {
                    // 여기에 기간별 데이터 로딩 및 차트 업데이트 로직 추가
                    console.log('기간 필터 변경:', this.value);
                });
            }

            // Chart.js 샘플 차트들
            new Chart(document.getElementById('visitorTrendChart').getContext('2d'), {
                type: 'line',
                data: { labels: ['월', '화', '수', '목', '금', '토', '일'], datasets: [{ label: '방문자 수', data: [120, 150, 180, 200, 170, 220, 210], borderColor: '#3498db', tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            new Chart(document.getElementById('signupTrendChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['월', '화', '수', '목', '금', '토', '일'], datasets: [{ label: '신규 가입자', data: [10, 15, 12, 18, 14, 20, 16], backgroundColor: '#2ecc71' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            new Chart(document.getElementById('revenueBySectorChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['굿즈샵', '멤버십'], datasets: [{ label: '수익', data: [5000000, 2000000], backgroundColor: ['#1abc9c', '#f39c12'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            new Chart(document.getElementById('postCountChart').getContext('2d'), {
                type: 'line',
                data: { labels: ['월', '화', '수', '목', '금', '토', '일'], datasets: [{ label: '게시물 수', data: [30, 40, 35, 50, 45, 60, 55], borderColor: '#34495e', tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            new Chart(document.getElementById('likeCountChart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['월', '화', '수', '목', '금', '토', '일'], datasets: [{ label: '좋아요 수', data: [100, 120, 110, 130, 125, 140, 135], backgroundColor: '#e67e22' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            new Chart(document.getElementById('topArtistsChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['아티스트 X', '아티스트 Y', '아티스트 Z'], datasets: [{ data: [5230, 3200, 2100], backgroundColor: ['#2980b9', '#8e44ad', '#16a085'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
    </script>
</body>
</html> 

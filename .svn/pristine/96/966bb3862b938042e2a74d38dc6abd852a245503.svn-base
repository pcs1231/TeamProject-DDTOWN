<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="${_csrf.token}"/>
    <meta name="_csrf_header" content="${_csrf.headerName}"/>
    <title>DDTOWN 굿즈샵 - 공지사항 상세</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods_notice.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css" />
</head>
<body class="notice-detail-page-body">
    <%-- communityHeader.jsp 포함 --%>
    <jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />

    <div class="notice-detail-container">
        <header class="notice-detail-header">
            <h1>공지사항 상세</h1>
        </header>

        <div class="notice-detail-content-wrap">
            <c:choose>
                <c:when test="${not empty notice}">
                    <div class="notice-detail-title">
                        <h2>${notice.goodsNotiTitle}</h2>
                    </div>
                    <div class="notice-detail-info">
                        <span class="date">
                            작성일: <fmt:formatDate value="${notice.goodsRegDate}" pattern="yyyy-MM-dd HH:mm" />
                        </span>
                        <%-- 조회수는 표시하지 않습니다 (goodsNotiHit 필드 제거됨) --%>
                    </div>
                    <div class="notice-detail-body">
                        <%-- 공지사항 내용을 HTML 형식으로 저장했다면 escape="false"를 사용하여 HTML 태그가 그대로 렌더링되도록 합니다. --%>
                        <p>${notice.goodsNotiContent}</p>
                        
                        <%-- 첨부파일이 있다면 표시 (fileDetailList 필드 사용) --%>
                        <c:if test="${not empty notice.fileDetailList}">
                            <div class="notice-detail-attachments">
                                <h3>첨부파일</h3>
                                <ul>
                                    <c:forEach var="file" items="${notice.fileDetailList}">
                                        <li>
                                            <%-- 첨부파일 다운로드 경로는 실제 컨트롤러 매핑에 맞게 조정해야 합니다. --%>
                                            <a href="${pageContext.request.contextPath}/file/download/${file.fileDetailNo}">
                                                <i class="fas fa-file-alt"></i> ${file.fileOrgNm}
                                            </a>
                                        </li>
                                    </c:forEach>
                                </ul>
                            </div>
                        </c:if>
                    </div>
                </c:when>
                <c:otherwise>
                    <div class="no-notice-found">
                        <p>해당 공지사항을 찾을 수 없습니다.</p>
                    </div>
                </c:otherwise>
            </c:choose>
        </div>

        <div class="notice-detail-actions">
            <%-- 목록으로 돌아가기 버튼 --%>
            <button type="button" class="btn-list" onclick="location.href='${pageContext.request.contextPath}/goods/notice/list'">목록으로</button>

            <%-- 관리자 권한이 있는 경우에만 수정/삭제 버튼 표시 --%>
            <sec:authorize access="hasRole('ROLE_ADMIN')"> <%-- 'ROLE_ADMIN'은 실제 관리자 권한에 맞게 변경해주세요 --%>
                <%-- 수정 페이지로 이동하는 버튼 --%>
                <button type="button" class="btn-edit" onclick="location.href='${pageContext.request.contextPath}/goodsnotice/modify/${notice.goodsNotiNo}'">수정</button>
                <%-- 삭제 기능 버튼 --%>
                <button type="button" class="btn-delete" onclick="deleteNotice(${notice.goodsNotiNo})">삭제</button>
            </sec:authorize>
        </div>
    </div>

    <script>
    // CSRF 토큰 및 헤더는 <meta> 태그에서 가져옵니다.
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    
    // 삭제 버튼 클릭 시 동작할 JavaScript 함수
    function deleteNotice(noticeNo) {
        if (confirm('이 공지사항을 정말 삭제하시겠습니까?')) {
            fetch('${pageContext.request.contextPath}/goodsnotice/delete/' + noticeNo, {
                method: 'POST', // RESTful API 설계에 따라 DELETE 메소드를 사용할 수도 있습니다.
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken // CSRF 헤더 추가
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('공지사항이 성공적으로 삭제되었습니다.');
                    location.href = '${pageContext.request.contextPath}/goodsnotice/list'; // 목록 페이지로 이동
                } else {
                    // 서버에서 에러 메시지를 반환하는 경우를 처리
                    return response.text().then(text => { 
                        throw new Error(text || '알 수 없는 오류가 발생했습니다.'); 
                    });
                }
            })
            .catch(error => {
                console.error('공지사항 삭제 중 오류 발생:', error);
                alert('공지사항 삭제에 실패했습니다: ' + error.message);
            });
        }
    }
    </script>
</body>
</html>
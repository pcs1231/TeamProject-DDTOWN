<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<%@ taglib uri="jakarta.tags.functions" prefix="fn" %>
<%@ taglib uri="jakarta.tags.core"  prefix="c"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>나의 프로필</title>
<%-- <%@ include file="../../modules/headerPart.jsp" %> --%>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/my_profile.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript">
	<c:if test="${not empty message }">
		Swal.fire({
				title : "${message }",
				icon : "success",
				draggable : true
			});
		<c:remove var="message" scope="request"/>
		<c:remove var="message" scope="session"/>
	</c:if>
	function sweetAlert(type, msg){
		Swal.fire({
			title : msg,
			icon : type,
			draggable : true
		});
	}
</script>
<style type="text/css">

/* 전체 화면과 유사하지만, 약간의 여백을 둔 커스텀 크기 */
.modal-dialog.modal-fullscreen-custom {
	top:5vh;
    width: 80vw;
    max-width: none;
    height: 80vh;
    margin: auto;
    position: relative; /* 닫기 버튼 기준점 */
}

/* 외부 닫기 버튼 */
.modal-dialog.modal-fullscreen-custom > .btn-close {
    position: absolute;
    top: -10px;
    right: -25px;
    z-index: 1070;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    padding: 0.5rem;
    filter: invert(1) grayscale(100%) brightness(200%);
}

.modal-dialog.modal-fullscreen-custom .modal-content {
    height: 100%;
    border: none;
    border-radius: 15px;
    overflow: hidden; /* 내부 컨텐츠가 둥근 모서리를 넘지 않도록 */
}

/* 왼쪽 본문 패널 */
.post-pane {
    flex: 7; /* 6:4 비율로 공간 분배 */
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
    height: 100%;
}
.post-pane-header, .post-pane-footer {
    flex-shrink: 0;
    padding: 1rem;
    display: flex;
    align-items: center;
}
.post-pane-header {
    /* Flexbox 컨테이너로 설정 */
    display: flex;

    /* 자식 요소들을 양쪽 끝으로 밀어냄 (핵심!) */
    justify-content: space-between;

    /* 자식 요소들의 세로 정렬을 중앙으로 맞춤 */
    align-items: center;

    /* 기존의 패딩 값 등은 유지 */
    padding: 1rem;
    border-bottom: 1px solid #efefef;
}
.post-pane-footer {
    border-top: 1px solid #efefef;
}
.post-pane-body {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #000;
}

/* 오른쪽 댓글 패널 */
.comment-pane {
    flex: 3; /* 6:4 비율로 공간 분배 */
    background-color: #f7f7f7;
    border-left: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    height: 100%;
}
.comment-pane-header, .comment-pane-footer {
    flex-shrink: 0;
    padding: 1rem;
    background-color: #fff;
    display: flex;
    align-items: center;
}
.comment-pane-header {
    border-bottom: 1px solid #efefef;
}
.comment-pane-footer {
    border-top: 1px solid #efefef;
}
.comment-pane-body {
    flex-grow: 1;
    overflow-y: auto; /* 이 부분만 스크롤됨 */
    padding: 1rem;
}

/* 개별 댓글 아이템 스타일 */
.comment-item {
    display: flex;
    align-items: flex-start; /* 아이콘이 길어질 경우를 대비해 상단 정렬 */
    margin-bottom: 1.5rem;
}
.comment-item .comment-avatar {
    width: 32px;
    height: 32px;
    margin-right: 12px;
}
.comment-item img {
    width: 32px;
    height: 32px;
    margin-right: 12px;
}
/* [핵심] 댓글 내용과 더보기 아이콘을 정렬할 새로운 flex 컨테이너 */
.comment-item .comment-content {
    flex-grow: 1; /* 남는 공간을 모두 차지하도록 설정 */
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.comment-item .comment-content p {
    margin-bottom: 0.25rem;
    color: #333;
}
/* 좋아요 버튼의 기본 스타일 */
.btn-like {
    /* 부트스트랩 버튼의 기본 테두리, 배경 등을 없애고 텍스트처럼 보이게 함 */
    background-color: transparent;
    border: none;
    color: #555; /* 기본 아이콘 및 텍스트 색상 */
    font-size: 1rem;
    padding: 0.25rem 0.5rem;
    transition: color 0.2s ease-in-out; /* 색상 변경 시 부드러운 효과 */
}

.btn-like:hover {
    color: #000;
}

/* [핵심] 버튼이 클릭되어 'active' 클래스를 가졌을 때의 스타일 */
.btn-like.active {
    /* 활성화 상태일 때 아이콘과 텍스트 색상 */
    color: #fd6083;
    font-weight: bold;
}

/* [핵심] 'bi-heart-fill' 아이콘 자체의 색상도 지정 */
.btn-like .bi-heart-fill {
    color: #fd6083;
}
.dropdown-menu{
	z-index:1100;
}
</style>
</head>

<body>

	<header class="site-header">
    <div class="logo">
      <a href="artist_community_main.html">DDTOWN SQUARE</a>
    </div>
    <nav class="utility-nav">
      <ul id="loggedOutNav">
        <li><a href="#" id="loginBtn" class="auth-link">로그인</a></li>
        <li><a href="signup.html" class="signup-link">회원가입</a></li>
      </ul>
      <ul id="loggedInNav" style="display: none">
        <li><a href="#" id="notificationBtn" class="icon-btn" title="알림">🔔</a></li>
        <li><a href="#" id="myPageBtn" class="icon-btn" title="마이페이지">👤</a></li>
        <li><a href="#" class="icon-btn" title="컬렉션">🌟</a></li>
        <li><a href="#" class="icon-btn special-icon" title="스페셜">J</a></li>
        <li><a href="#" class="icon-btn" title="더보기">🛍️</a></li>
        <li><a href="#" id="logoutBtn" class="auth-link">로그아웃</a></li>
      </ul>
    </nav>
  </header>
  <nav class="main-navigation">
    <ul>
      <li><a href="#">굿즈샵</a></li>
      <li>
        <a href="preference_vote.html">선호도 조사</a>
        <ul class="submenu">
          <li><a href="preference_vote.html" style="color: #8a2be2; font-weight:bold;">인기 투표</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <main class="profile-main">
    <header class="profile-header">
      <div class="profile-header-inner">
        <div class="profile-avatar">
          <img src="${profileVO.comuProfileImg}" alt="프로필 이미지">
        </div>
        <div class="profile-nickname" id="profileNickname">${profileVO.comuNicknm}</div>
      </div>
    </header>
    <nav class="profile-tabs">
      <button class="tab active" data-tab="posts">포스트</button>
      <button class="tab" data-tab="comments">댓글</button>
    </nav>
    <section class="profile-tab-content" id="postsTab" style="display:block;">
    	<c:choose>
    		<c:when test="${empty profileVO.postList}">
		      <div class="no-content">아직 작성한 포스트가 없습니다.</div>
    		</c:when>
    		<c:otherwise>
    			<c:forEach items="${profileVO.postList}" var="post">
    				<div class="post-card">
			            <div class="post-header">
			                <span class="category">[자유게시판]</span>
			                <span class="post-date">2023.01.01</span>
			            </div>
			            <div class="post-media">
			                <img src="[내 글의 대표 이미지 URL]" alt="내가 쓴 글 이미지" class="post-thumbnail">
			            </div>
			            <div class="post-content-area">
			                <h4 class="post-title">내가 쓴 글의 멋진 제목입니다.</h4>
			                <p class="post-preview">글 내용의 일부를 미리 보여줍니다. 너무 길지 않게 잘라주세요...</p>
			            </div>
			            <div class="post-meta-bottom">
			                <span class="post-likes">❤️ 123</span>
			                <span class="post-comments">💬 45</span>
			                <span class="post-views">👀 678</span>
			            </div>
			        </div>
    			</c:forEach>
    		</c:otherwise>
    	</c:choose>
    </section>
    <section class="profile-tab-content" id="commentsTab" style="display:none;">
    	<c:choose>
    		<c:when test="${empty profileVO.replyList}">
		      <div class="no-content">아직 작성한 댓글이 없습니다.</div>
    		</c:when>
    		<c:otherwise>
    			<c:forEach items="${profileVO.replyList}" var="reply">
    				<div class="comment-list-item">
			            <div class="comment-content mb-3 detailBox" style="cursor:pointer;" data-comu-post-no="${reply.comuPostNo}">
			            	<div class="d-flex align-items-center">
			                	<span>
				                   <img alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAgCAYAAAB3j6rJAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAFwSURBVHgB7ZfLbYNAEIYHjMQBIbkEUkFIBcEduIS4AofHhRs3LjziCpIS3EFwBaGDUIKvSDwyI2HJWmMbAka2tN+BXcTM7L8DK/0AcO4U4dwDz/PmqqquBUEw8NaAYaR1XW9s2/6CPkJ839dkWf7GqQbjkuV5vnBdN4MuQqIo+m1EZNiRFY6paZp7+CdxHC+xI/FRzRe2nsgmhWH4xiQkQ0QQmL+lWlSTaldV9c7GnAjBhDWNGGwOFcCI2ZdluWrWeL0qBNHp4jjOFkZGkqS0mRrQQcjNuNThSYVc4m6ESH2Cj451FzLLsp46xj5oR/rssC/8Y2Xhp4aFnxoW/rGynBWCrmoOE9ImJKFLURQ6jEwQBMtmmsI1IegtdzTOZrPPMbtCfwWiKMbNGhv2+Yl5psUx8Aca30qWcYhbIwGKoui0sUPNttPX6uJRjIZibvI7gX51gU4tgy5CDpCjx0Ry3M8wjB1uLMFX8zGmIedMwh+5vYcq7uc6lQAAAABJRU5ErkJggg==" width="15px" height="15px">
			                	</span>
			                	${reply.comuPostContent}
			            	</div>
			                <hr/>
			                <p class="">
			                    ${reply.comuReplyContent}
			                </p>
			            </div>
			        </div>
    			</c:forEach>
    		</c:otherwise>
    	</c:choose>
    </section>
  </main>

  <div id="footer-placeholder"></div>
<div class="modal fade" id="postModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-custom">
         <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>

        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="d-flex h-100">

                    <div class="post-pane">
                        <div class="post-pane-header">
                        	<div class="d-flex align-items-center">
	                            <img id="postUserImg" src="" class="rounded-circle">
	                            <div class="ms-2">
	                                <strong class="d-block" id="postUserNm">얼큰한아이스아메리카노</strong>
	                                <small class="text-muted" id="postRegDate">06. 10. 16:32</small>
	                            </div>
                        	</div>
                        	<div class="dropdown">
						        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
						            <i class="bi bi-three-dots-vertical"></i>
						        </button>
						        <ul class="dropdown-menu">
						            <li><a class="dropdown-item" href="#">수정</a></li>
						            <li><a class="dropdown-item" href="#">삭제</a></li>
						            <li><hr class="dropdown-divider"></li>
						            <li><a class="dropdown-item text-danger" href="#">신고</a></li>
						        </ul>
						    </div>
                        </div>
                        <div class="post-pane-body" id="postContent">
                            <img src="https://i.imgur.com/qLuzqSW.png" class="img-fluid">
                        </div>
                        <div class="post-pane-footer">
						    <button type="button" class="btn btn-like" id="likeButton">
						        <i class="bi bi-heart"></i>
						        <span id="likeCount">33</span>
						    </button>
						</div>
                    </div>

                    <div class="comment-pane">
					    <div class="comment-pane-header">
					        <strong class="mx-auto">답글 3개</strong>
					    </div>

					    <div class="comment-pane-body">

					        <div class="comment-item">
					            <img src="https://via.placeholder.com/32" class="rounded-circle comment-avatar">

					            <div class="comment-content">
					                <div>
					                    <strong>whatsinmyplaylist</strong>
					                    <p>앱은 7월 7일에 기적 올린다는데 웹 스토어는 몇일에 열리려나요? 자동결제 되기 전에 오픈했으면 좋겠는데....</p>
					                    <small class="text-muted">06. 10. 17:33</small>
					                </div>
					                <div class="dropdown">
								        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
								            <i class="bi bi-three-dots-vertical"></i>
								        </button>
								        <ul class="dropdown-menu">
								            <li><a class="dropdown-item" href="#">수정</a></li>
								            <li><a class="dropdown-item" href="#">삭제</a></li>
								            <li><hr class="dropdown-divider"></li>
								            <li><a class="dropdown-item text-danger" href="#">신고</a></li>
								        </ul>
								    </div>
					            </div>
					        </div>

					        <div class="comment-item">
					            <img src="https://via.placeholder.com/32" class="rounded-circle comment-avatar">
					            <div class="comment-content">
					                <div>
					                    <strong>플5중하나만어떻게선...</strong>
					                    <p>저도 결제일이 7월 7일 이전이라..</p>
					                    <small class="text-muted">06. 10. 19:21</small>
					                </div>
					                <div class="dropdown">
								        <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
								            <i class="bi bi-three-dots-vertical"></i>
								        </button>
								        <ul class="dropdown-menu">
								            <li><a class="dropdown-item" href="#">수정</a></li>
								            <li><a class="dropdown-item" href="#">삭제</a></li>
								            <li><hr class="dropdown-divider"></li>
								            <li><a class="dropdown-item text-danger" href="#">신고</a></li>
								        </ul>
								    </div>
					            </div>
					        </div>

					    </div>

					    <div class="comment-pane-footer">
						    <div class="input-group">
						        <textarea class="form-control" placeholder="댓글을 입력하세요." aria-label="댓글 입력" rows="1" style="resize: none;"></textarea>
						        <button class="btn btn-primary" type="button" id="commentSubmitBtn">등록</button>
						    </div>
						</div>
					</div>

                </div>
            </div>
        </div>
    </div>
</div>
  <%@ include file="../../modules/footerPart.jsp" %>
</body>
<script type="text/javascript">
// 탭 전환
document.querySelectorAll('.profile-tabs .tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.profile-tabs .tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('postsTab').style.display = this.dataset.tab === 'posts' ? 'block' : 'none';
    document.getElementById('commentsTab').style.display = this.dataset.tab === 'comments' ? 'block' : 'none';
  });
});


$(function(){
	const postModal = $("#postModal"); // 해당 포스트 혹은 댓글이달린 원본글을 보여줄 모달
	const detailBox = $(".detailBox"); // 자신이 쓴 글이나 댓글 div
	detailBox.on("click",function(){
		let comuPostNo = $(this).data("comuPostNo");


		$.ajax({
			url : "/api/community/getPost?comuPostNo="+comuPostNo,
			type : "get",
			success : function(res){
				console.log(res);
				let {writerProfile} = res;
				$("#postUserImg").attr("src",writerProfile.comuProfileImg);
				$("#postUserNm").html(writerProfile.comuNicknm);
				$("#postRegDate").html(getFormattedDate(res.comuPostRegDate));
				$("#postContent").html(res.comuPostContent);
				//$("#replyContentDiv") // 댓글 영역
			},
			error : function(err){
				console.log(err);
			}
		})

		postModal.modal("show");
	})

	// id가 'likeButton'인 요소를 클릭했을 때
    $('#likeButton').on('click', function() {

        // 1. 현재 버튼에 'active' 클래스를 토글(있으면 없애고, 없으면 추가)
        $(this).toggleClass('active');

        const likeIcon = $(this).find('i'); // 버튼 안의 i 태그(아이콘)를 찾음

        // 2. 현재 'active' 클래스가 있는지 확인하여 아이콘 모양을 변경
        if ($(this).hasClass('active')) {
            // "좋아요"를 누른 상태 (활성 상태)
            likeIcon.removeClass('bi-heart').addClass('bi-heart-fill');
            // TODO: 실제로는 여기에 좋아요 숫자 1 증가시키는 로직 추가
        } else {
            // "좋아요"를 취소한 상태 (비활성 상태)
            likeIcon.removeClass('bi-heart-fill').addClass('bi-heart');
            // TODO: 실제로는 여기에 좋아요 숫자 1 감소시키는 로직 추가
        }

        // (응용) 좋아요 숫자 변경 예시
        const likeCountSpan = $('#likeCount');
        let currentCount = parseInt(likeCountSpan.text()); // 현재 숫자 가져오기

        if ($(this).hasClass('active')) {
            likeCountSpan.text(currentCount + 1);
        } else {
            likeCountSpan.text(currentCount - 1);
        }

        // TODO: 실제 애플리케이션에서는 이 시점에 서버와 통신(AJAX)하여
        // "좋아요" 상태를 데이터베이스에 저장해야 합니다.
    });

	// textarea에서 키보드를 누를 때마다 실행 자동 높이조절
    $('.comment-pane-footer textarea').on('keyup', function() {
        // 일단 높이를 초기화하여 줄어드는 것도 가능하게 함
        $(this).css('height', 'auto');
        // 스크롤 높이(내용 전체 높이)를 실제 높이로 지정
        $(this).css('height', $(this).prop('scrollHeight') + 'px');
    });

	// 엔터키 댓글 전송
    $('.comment-pane-footer textarea').on('keydown', function(e) {
        // Shift 키를 누르지 않고 Enter 키만 눌렀을 때
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // 기본 Enter 동작(줄바꿈)을 막음
            $('#commentSubmitBtn').click(); // 등록 버튼을 강제로 클릭
        }
    });


	// 날짜 포맷팅 함수
	function padTwoDigits(num) {
	  return num.toString().padStart(2, "0");
	}

	function getFormattedDate(time) {
	  const date = new Date(time);

	  return (
	    [
	      date.getFullYear(),
	      padTwoDigits(date.getMonth() + 1),
	      padTwoDigits(date.getDate()),
	    ].join(".") +
	    " " +
	    [
	      padTwoDigits(date.getHours()),
	      padTwoDigits(date.getMinutes())
	    ].join(":")
	  );
	}
})
</script>
</html>
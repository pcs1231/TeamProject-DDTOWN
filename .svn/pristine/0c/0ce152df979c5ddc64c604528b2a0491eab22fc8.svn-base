<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.ddtown.mapper.goods.IGoodsCartMapper">
	<!-- 사용자 아이디 개별로 장바구니에 상품 가져오기 -->
	<select id="selectCartItemsUsername" resultType="kr.or.ddit.vo.goods.GoodsCartVO">
	    SELECT
	        gc.cart_no,
	        gc.mem_username,
	        gc.goods_no,
	        gc.goods_opt_no,
	        gc.cart_qty,
	        (g.goods_price + COALESCE(go.goods_opt_price, 0)) * gc.cart_qty AS cart_total_amount,
	        g.goods_nm,
	        g.goods_price,
	        g.file_group_no AS fileGroupNo,
	        go.goods_opt_nm,
	        go.goods_opt_price
	    FROM
	        CART gc
	    JOIN
	        GOODS g ON gc.goods_no = g.goods_no
	    LEFT JOIN
	        GOODS_OPTION go ON gc.goods_opt_no = go.goods_opt_no AND gc.goods_no = go.goods_no
	    WHERE
	        gc.mem_username = #{userId}
	    ORDER BY gc.cart_no DESC
	</select>
	
	<!-- 장바구니에 중복으로 들어있는지 확인! -->
	<select id="selectCartItem" resultType="kr.or.ddit.vo.goods.GoodsCartVO" parameterType="kr.or.ddit.vo.goods.GoodsCartVO">
		select
			cart_no,
			mem_username,
			goods_no,
			goods_opt_no,
			cart_qty,
			cart_total_amount
		from cart
		where mem_username = #{memUsername}
		  and goods_no = #{goodsNo}
		  and goods_opt_no = #{goodsOptNo}
	</select>
	
	<!-- 새상품 장바구니에 추가!!!-->
	<insert id="insertCartItem">
		<selectKey keyProperty="cartNo" resultType="java.lang.Integer" order="BEFORE">
        	SELECT cart_seq.nextval FROM dual
        </selectKey>
		insert into cart (
			cart_no,
			mem_username,
			goods_no,
			goods_opt_no,
			cart_qty,
			cart_total_amount
		) values (
			#{cartNo},
			#{memUsername},
			#{goodsNo},
			#{goodsOptNo},
			#{cartQty},
			#{cartTotalAmount}
		)
	</insert>
	
	<!-- 장바구니 상품 수량 업뎃하기..! -->
	<update id="updateCartItemQuantity">
		update cart
		   set
		   	   cart_qty = #{cartQty},
		   	   cart_total_amount = #{cartTotalAmount}
		   where mem_username = #{memUsername}
		     and goods_no = #{goodsNo}
		     and goods_opt_no = #{goodsOptNo}
	</update>
	
	<!-- 장바구니에 담긴 상품 개별 삭제 -->
	<delete id="deleteCartItem" parameterType="int">
		delete from cart
		where cart_no = #{cartNo}
	</delete>
	
	<!-- 장바구니에 담긴 상품 선택해서 일괄 삭제 -->
	<delete id="deleteSelectedCartItems" parameterType="java.util.List">
		delete from cart
		where cart_no in
		<foreach collection="list" item="cartNo" open="(" separator="," close=")">
			#{cartNo}
		</foreach>
	</delete>
	
	<!-- 장바구니에 담긴 상품 수량 변경하기 -->
	<update id="updateCartQuantity" parameterType="kr.or.ddit.vo.goods.GoodsCartVO">
		update cart
		set
			cart_qty = #{cartQty}
		where
			cart_no = #{cartNo}
	</update>
</mapper>
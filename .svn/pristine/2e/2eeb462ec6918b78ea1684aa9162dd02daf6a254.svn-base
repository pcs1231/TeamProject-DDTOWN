<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="${_csrf.token}"/>
	<meta name="_csrf_header" content="${_csrf.headerName}"/>
    <title>DDTOWN êµ¿ì¦ˆìƒµ</title>
 	
	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods_main.css">
 	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style type="text/css">
		.floating-nav {
		    position: fixed;
		    bottom: 100px;
		    right: 24px;
		    z-index: 1000;
		    display: flex;
		    flex-direction: column;
		    gap: 15px;
		}
	</style>

</head>
<body>

    <%-- ì—¬ê¸°ì— communityHeader.jspë¥¼ í¬í•¨ì‹œí‚µë‹ˆë‹¤. --%>
    <jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />

    <c:if test="${not empty notice}">
        <div class="shop-notice-bar">
            âœ¨ ${notice.goodsNotiTitle}
            <hr> 
            <a href="${pageContext.request.contextPath}/goods/notice/detail/${notice.goodsNotiNo}">ìì„¸íˆ ë³´ê¸°</a>
            <%-- âœ¨ ì—¬ê¸°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤. âœ¨ --%>
            <span class="separator"> | </span> 
            <a href="${pageContext.request.contextPath}/goods/notice/list" class="more-notices-link">ì „ì²´ ê³µì§€ ë³´ê¸°</a>
        </div>
    </c:if>

    <nav class="artist-filter-bar">
        <button class="filter-btn ${empty artGroupNo || artGroupNo == 0 ? 'active' : ''}" 
                data-artist-id="all">ì „ì²´</button>
        <c:forEach var="artist" items="${artistList}">
            <button class="filter-btn ${artGroupNo eq artist.artGroupNo ? 'active' : ''}"
                    data-artist-id="${artist.artGroupNo}">${artist.artGroupNm}</button>
        </c:forEach>
    </nav>

    <section class="product-list-section">
        <div class="product-grid-header">
            <h2>ì „ì²´ ìƒí’ˆ</h2>
            <div class="sort-options">
                <select id="sortProducts">
                    <option value="newest" ${searchType eq 'newest' ? 'selected' : ''}>ì‹ ìƒí’ˆìˆœ</option>
                    <option value="popularity" ${searchType eq 'popularity' ? 'selected' : ''}>ì¸ê¸°ìˆœ</option>
                    <option value="priceLowHigh" ${searchType eq 'priceLowHigh' ? 'selected' : ''}>ë‚®ì€ê°€ê²©ìˆœ</option>
                    <option value="priceHighLow" ${searchType eq 'priceHighLow' ? 'selected' : ''}>ë†’ì€ê°€ê²©ìˆœ</option>
                </select>
            </div>
        </div>

        <div class="product-grid" id="productGrid">
            <c:choose>
                <c:when test="${not empty pagingVO.dataList and pagingVO.totalRecord > 0}">
                    <c:forEach items="${pagingVO.dataList}" var="goods">
                        <div class="product-item">
                            <button class="wish-button ${goods.isWished() ? 'wished' : ''}"
                                    data-wished="${goods.isWished()}"
                                    data-goods-no="${goods.goodsNo}">
                                <i class="fa-heart ${goods.isWished() ? 'fas' : 'far'}"></i>
                            </button>
                            <a href="${pageContext.request.contextPath}/goods/detail?goodsNo=${goods.goodsNo}" class="product-link">
                                <c:choose>
                                    <c:when test="${not empty goods.representativeImageUrl}">
                                        <img src="${pageContext.request.contextPath}${goods.representativeImageUrl}" alt="${goods.goodsNm}" class="product-image">
                                    </c:when>
                                    <c:otherwise>
                                        <img src="https://via.placeholder.com/200?text=No+Image" alt="ì´ë¯¸ì§€ ì—†ìŒ" class="product-image">
                                    </c:otherwise>
                                </c:choose>
                                <div class="product-info">
                                    <div>
                                        <span class="product-artist-tag">${goods.artGroupName}</span>
                                        <h3 class="product-name">${goods.goodsNm}</h3>
                                    </div>
                                    <div class="product-price">
                                        <fmt:formatNumber value="${goods.goodsPrice}" type="number" />
                                        <span class="currency">ì›</span>
                                    </div>
                                    <div class="product-status-stock">
                                        <c:if test="${goods.stockRemainQty <= 0}">
                                            <span style="color: red; font-weight: bold;">[í’ˆì ˆ]</span>
                                        </c:if>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </c:forEach>
                </c:when>
                <c:otherwise>
                    <p style="text-align: center; width: 100%; padding: 50px;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </c:otherwise>
            </c:choose>
        </div>
    </section>

    <div class="pagination">
        <%-- â˜…â˜…â˜… pagingVO.getGoodsPagingHTML() ë©”ì„œë“œ í˜¸ì¶œ â˜…â˜…â˜… --%>
        ${pagingVO.getGoodsPagingHTML(pageContext.request.contextPath)}
    </div>

    <c:set var="cartCount" value="${not empty cartItemCount ? cartItemCount : 0}" />
    <c:set var="wishCount" value="${not empty wishlistItemCount ? wishlistItemCount : 0}" />

    <nav class="floating-nav">
        <a href="${pageContext.request.contextPath}/goods/cart/list" class="floating-btn" id="floatingCartBtn" title="ì¥ë°”êµ¬ë‹ˆ">
            ğŸ›’
            <span class="item-count-badge" id="cartItemCount" style="display: ${cartCount > 0 ? 'flex' : 'none'};">${cartCount}</span>
        </a>
        <a href="${pageContext.request.contextPath}/goods/wishlist" class="floating-btn" id="floatingWishlistBtn" title="ì°œëª©ë¡">
            â¤ï¸
            <span class="item-count-badge" id="wishlistItemCount" style="display: ${wishCount > 0 ? 'flex' : 'none'};">${wishCount}</span>
        </a>

    </nav>

    <script>
    let csrfToken;
    let csrfHeader;
    
    const contextPath = "${pageContext.request.contextPath}";

    document.addEventListener('DOMContentLoaded', function() {
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        if (csrfMeta && csrfHeaderMeta) {
            csrfToken = csrfMeta.content;
            csrfHeader = csrfHeaderMeta.content;
        } else {
            console.error("CSRF meta tags not found. CSRF protection might be disabled or misconfigured.");
        }

        const isUserLoggedIn = ${isLoggedIn};

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(event) {
                alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        }

        // --- ì°œ(Wishlist) ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ (ë³€ë™ ì—†ìŒ) ---
        const wishButtons = document.querySelectorAll('.wish-button');

        wishButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();

                const goodsNo = this.dataset.goodsNo;
                const isWished = this.dataset.wished === 'true';
                const icon = this.querySelector('i');

                if (!isUserLoggedIn) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                    window.location.href = `${contextPath}/login`;
                    return;
                }

                const requestBody = { goodsNo: parseInt(goodsNo) };

                fetch(`${contextPath}/goods/wishlist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                         if (response.status === 401) {
                             alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                             window.location.href = `${contextPath}/login`;
                         }
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);

                    if (data.status === 'success') {
                        if (data.action === 'added') {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            button.classList.add('wished');
                            this.dataset.wished = 'true';
                            
                            Swal.fire({
                                title: 'ìƒí’ˆ ì°œ ì™„ë£Œ!',
                                text: 'ì„ íƒí•˜ì‹  ìƒí’ˆì´ ì°œ ëª©ë¡ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
                                icon: 'success',
                                confirmButtonText: 'í™•ì¸'
                            });
                        } else if (data.action === 'removed') {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            button.classList.remove('wished');
                            this.dataset.wished = 'false';
                            
                         
                            Swal.fire({
                                title: 'ì°œ í•´ì œ ì™„ë£Œ!',
                                text: 'ì„ íƒí•˜ì‹  ìƒí’ˆì´ ì°œ ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.',
                                icon: 'success',
                                confirmButtonText: 'í™•ì¸'
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('ì°œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                    
                    Swal.fire({
                        title: 'ì˜¤ë¥˜ ë°œìƒ',
                        text: 'ì°œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message,
                        icon: 'error',
                        confirmButtonText: 'í™•ì¸'
                    });
                });
            });
        });

     // --- ì•„í‹°ìŠ¤íŠ¸ í•„í„° ë²„íŠ¼ í´ë¦­ ìŠ¤í¬ë¦½íŠ¸ ---
        const filterButtons = document.querySelectorAll('.artist-filter-bar .filter-btn');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const artistId = this.dataset.artistId; // 'all' ë˜ëŠ” ì‹¤ì œ ì•„í‹°ìŠ¤íŠ¸ ID (ìˆ«ì)
                const currentPage = 1; // í•„í„° ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™

                const urlParams = new URLSearchParams(window.location.search);

                let currentSortType = urlParams.get('searchType') || 'newest';

                urlParams.set('currentPage', currentPage);
                urlParams.set('searchType', currentSortType);

                if (artistId !== 'all') {
                    urlParams.set('artGroupNo', artistId);
                } else {
                    urlParams.delete('artGroupNo');
                }

                urlParams.delete('searchWord');

                if(urlParams.get('searchType') === 'goodsNm' || currentSortType === 'goodsNm') {
                    urlParams.set('searchType', 'newest');
                }

                // ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤!
                window.location.href = `\${contextPath}/goods/main?\${urlParams.toString()}`;
            });
        });

     // --- ìƒí’ˆ ì •ë ¬ ë³€ê²½ ìŠ¤í¬ë¦½íŠ¸ ---
        const sortProductsSelect = document.getElementById('sortProducts');
        if (sortProductsSelect) {
            sortProductsSelect.addEventListener('change', function() {
                const selectedSortType = this.value;
                const currentPage = 1; // ì •ë ¬ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™

                const urlParams = new URLSearchParams(window.location.search);

                let currentArtGroupNo = urlParams.get('artGroupNo') || '';
                let currentSearchWord = urlParams.get('searchWord') || '';

                urlParams.set('currentPage', currentPage);
                urlParams.set('searchType', selectedSortType);

                if (currentArtGroupNo) {
                    urlParams.set('artGroupNo', currentArtGroupNo);
                }

                if (currentSearchWord) {
                    urlParams.set('searchWord', currentSearchWord);
                } else {
                    urlParams.delete('searchWord');
                }

                // ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤!
                window.location.href = `\${contextPath}/goods/main?\${urlParams.toString()}`;
            });
        }
        
    });
    </script>
</body>
</html>
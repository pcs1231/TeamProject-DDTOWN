<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN êµ¿ì¦ˆìƒµ - ì£¼ë¬¸í•˜ê¸°</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_home.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods.css">
    <meta name="_csrf" content="${_csrf.token}"/>
	<meta name="_csrf_header" content="${_csrf.headerName}"/>
</head>
<body class="order-page-body">
    <header class="site-header">
        <div class="logo">
            <a href="${pageContext.request.contextPath}/goods/main">DDTOWN SQUARE</a>
        </div>
        <nav class="utility-nav">
            <c:choose>
                <c:when test="${isLoggedIn == true}"> <%-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ isLoggedIn ëª¨ë¸ ì†ì„±ì„ ì „ë‹¬í•œë‹¤ê³  ê°€ì • --%>
                    <ul id="loggedInNav">
                        <li><a href="#" class="icon-btn" title="ì•Œë¦¼">ğŸ””</a></li>
                        <li><a href="${pageContext.request.contextPath}/mypage.html" class="icon-btn" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a></li>
                        <li><a href="#" class="icon-btn" title="ê³ ê°ì„¼í„°">ğŸ‘©â€ğŸ’»</a></li>
                        <li><a href="${pageContext.request.contextPath}/logout" id="logoutBtn" class="auth-link">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </c:when>
                <c:otherwise>
                    <ul id="loggedOutNav">
                        <li><a href="${pageContext.request.contextPath}/login.html" class="auth-link">ë¡œê·¸ì¸</a></li>
                        <li><a href="${pageContext.request.contextPath}/signup.html" class="signup-link">íšŒì›ê°€ì…</a></li>
                    </ul>
                </c:otherwise>
            </c:choose>
        </nav>
    </header>

    <nav class="main-navigation">
        <ul>
            <li><a href="${pageContext.request.contextPath}/goods/main">êµ¿ì¦ˆìƒµ</a></li>
            <li>
                <a href="#">ì„ í˜¸ë„ ì¡°ì‚¬</a>
                <ul class="submenu">
                    <li><a href="#">ì¸ê¸° íˆ¬í‘œ</a></li>
                </ul>
            </li>
            <li><a href="#">ì½˜ì„œíŠ¸</a></li>
        </ul>
    </nav>

    <div class="order-container">
        <div class="order-section">
            <h2>ì£¼ë¬¸ ìƒí’ˆ</h2>
            <div class="order-items">
                <c:choose>
                    <c:when test="${not empty orderItems}"> <%-- orderItemsëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ëŠ” ì£¼ë¬¸ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (GoodsCartVO ë“±) --%>
                        <c:set var="totalProductAmount" value="0"/>
                        <c:forEach var="item" items="${orderItems}">
                            <div class="order-item" 
                                 data-goods-no="${item.goodsNo}" 
                                 data-goods-opt-no="${item.goodsOptNo}" 
                                 data-qty="${item.cartQty}"> <%-- ìƒí’ˆ ì •ë³´ë¥¼ data ì†ì„±ì— ì €ì¥ --%>
                                <div class="item-image">
                                    <img src="${not empty item.representativeImageUrl ? item.representativeImageUrl : 'https://via.placeholder.com/80x80/E6E6FA/000000?text=No+Image'}" alt="${item.goodsNm}">
                                </div>
                                <div class="item-info">
                                    <div class="item-name">${item.goodsNm}</div>
                                    <div class="item-option">ì˜µì…˜: ${not empty item.goodsOptNm ? item.goodsOptNm : 'ì„ íƒ ì—†ìŒ'}</div>
                                </div>
                                <div class="item-quantity">ìˆ˜ëŸ‰: <fmt:formatNumber value="${item.cartQty}" type="number"/></div>
                                <div class="item-price"><fmt:formatNumber value="${item.cartTotalAmount}" type="number"/>ì›</div>
                            </div>
                            <c:set var="totalProductAmount" value="${totalProductAmount + item.cartTotalAmount}"/>
                        </c:forEach>
                    </c:when>
                    <c:otherwise>
                        <p style="text-align: center; padding: 20px;">ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    </c:otherwise>
                </c:choose>
            </div>
        </div>

        <div class="order-section">
            <h2>ë°°ì†¡ì§€ ì •ë³´</h2>
            <form class="delivery-info-form">
                <div class="form-group">
                    <label for="receiverName">ë°›ëŠ” ì‚¬ëŒ</label>
                    <input type="text" id="receiverName" name="receiverName" required 
                           value="${not empty memberInfo ? memberInfo.memNicknm : ''}"> <%-- íšŒì› ë‹‰ë„¤ì„ ê¸°ë³¸ê°’ --%>
                </div>
                <div class="form-group">
                    <label for="receiverPhone">ì—°ë½ì²˜</label>
                    <input type="tel" id="receiverPhone" name="receiverPhone" required
                    	   value = "${not empty memberInfo ? memberInfo.peoPhone: ''}"> <%-- íšŒì› ì „í™”ë²ˆí˜¸ ê¸°ë³¸ê°’ --%>
                </div>

                <div class="form-group">
                    <label for="orderEmailInput">ì´ë©”ì¼ ì£¼ì†Œ</label>
                    <input type="email" id="orderEmailInput" name="orderEmailInput" required
                           value="${not empty memberInfo ? memberInfo.peoEmail : ''}"> <%-- íšŒì› ì´ë©”ì¼ ê¸°ë³¸ê°’ --%>
                </div>
                
                <div class="form-group full-width">
                    <label for="postcode">ìš°í¸ë²ˆí˜¸</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="postcode" name="postcode" readonly style="flex-grow: 1;"
                               value="${not empty memberInfo ? memberInfo.memZipCode : ''}"> <%-- íšŒì› ìš°í¸ë²ˆí˜¸ ê¸°ë³¸ê°’ --%>
                        <button type="button" class="address-search-btn" onclick="searchAddress()">ì£¼ì†Œ ê²€ìƒ‰</button>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="address">ê¸°ë³¸ì£¼ì†Œ</label>
                    <input type="text" id="address" name="address" readonly
                           value="${not empty memberInfo ? memberInfo.memAddress1 : ''}"> <%-- íšŒì› ê¸°ë³¸ì£¼ì†Œ ê¸°ë³¸ê°’ --%>
                </div>
                <div class="form-group full-width">
                    <label for="addressDetail">ìƒì„¸ì£¼ì†Œ</label>
                    <input type="text" id="addressDetail" name="addressDetail"
                           value="${not empty memberInfo ? memberInfo.memAddress2 : ''}"> <%-- íšŒì› ìƒì„¸ì£¼ì†Œ ê¸°ë³¸ê°’ --%>
                </div>
                <div class="form-group">
                    <label for="deliveryRequest">ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                    <select id="deliveryRequest" name="deliveryRequest" onchange="toggleCustomMessage()">
                        <option value="">ë°°ì†¡ ìš”ì²­ì‚¬í•­ ì„ íƒ</option>
                        <option value="door">ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                        <option value="security">ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                        <option value="call">ë°°ì†¡ ì „ ì—°ë½ì£¼ì„¸ìš”</option>
                        <option value="custom">ì§ì ‘ ì…ë ¥</option>
                    </select>
                </div>
                <div class="form-group full-width" id="customMessageArea" style="display: none;">
                    <label for="customMessage">ë°°ì†¡ ë©”ì‹œì§€ ì§ì ‘ ì…ë ¥</label>
                    <textarea id="customMessage" name="customMessage" rows="3" maxlength="50" placeholder="ìµœëŒ€ 50ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤"></textarea>
                </div>
                
                <input type="hidden" id="orderTypeCodeInput" value="OTC002">
            </form>
        </div>

        <div class="order-section">
            <h2>ê²°ì œ ìˆ˜ë‹¨</h2>
            <div class="payment-methods">
                <div class="payment-method selected" data-method="kakao"> <%-- ê¸°ë³¸ ì¹´ì¹´ì˜¤í˜ì´ ì„ íƒ --%>
                    <img src="https://via.placeholder.com/40x40/E6E6FA/000000?text=K" alt="ì¹´ì¹´ì˜¤í˜ì´">
                    <div class="method-name">ì¹´ì¹´ì˜¤í˜ì´</div>
                </div>
                </div>
        </div>

        <div class="order-summary">
            <div class="summary-row">
                <span class="label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                <span class="value" id="totalProductAmountDisplay"><fmt:formatNumber value="${totalProductAmount}" type="number"/>ì›</span>
            </div>
            <div class="summary-row">
                <span class="label">ë°°ì†¡ë¹„</span>
                <span class="value" id="shippingFeeDisplay">
                    <c:set var="shippingFee" value="${totalProductAmount >= 30000 ? 0 : (totalProductAmount > 0 ? 3000 : 0)}"/> <%-- 3ë§Œì› ì´ìƒ ë¬´ë£Œ --%>
                    <fmt:formatNumber value="${shippingFee}" type="number"/>ì›
                </span>
            </div>
            <div class="summary-row total">
                <span class="label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                <span class="value" id="finalPaymentAmountDisplay">
                    <fmt:formatNumber value="${totalProductAmount + shippingFee}" type="number"/>ì›
                </span>
            </div>
            <div class="payment-agreement">
                <label>
                    <input type="checkbox" id="paymentAgreement">
                    ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ë° ê²°ì œ ì§„í–‰ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
                </label>
            </div>
        </div>

        <div class="order-actions">
            <button class="btn-order-cancel" onclick="location.href='${pageContext.request.contextPath}/goods/cart/list'">ì·¨ì†Œ</button> <%-- ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™ --%>
            <button class="btn-order-submit" id="submitOrderBtn">ê²°ì œí•˜ê¸°</button>
        </div>
    </div>

    <div id="footer-placeholder"></div>
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    let csrfToken;
    let csrfHeader;
    
    document.addEventListener('DOMContentLoaded', function() {
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        if (csrfMeta && csrfHeaderMeta) {
            csrfToken = csrfMeta.content; // CSRF í† í° ê°’ (ì˜ˆ: "ABCDEFG12345")
            csrfHeader = csrfHeaderMeta.content; // CSRF í—¤ë” ì´ë¦„ (ì˜ˆ: "X-CSRF-TOKEN")
        } else {
            console.error("CSRF meta tags not found or incorrectly configured.");
            // ì—ëŸ¬ ìƒí™© ì‹œ ì¶”ê°€ì ì¸ ì²˜ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë²„íŠ¼ ë¹„í™œì„±í™” ë“±
        }

        // ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬ (ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ isLoggedIn ëª¨ë¸ ì†ì„±ì„ ë°›ì•„ì™€ ì‚¬ìš©)
        const isLoggedIn = ${isLoggedIn}; 

        const loggedOutNav = document.getElementById('loggedOutNav');
        const loggedInNav = document.getElementById('loggedInNav');
        if (isLoggedIn) {
            if(loggedOutNav) loggedOutNav.style.display = 'none';
            if(loggedInNav) loggedInNav.style.display = 'flex';
        } else {
            if(loggedOutNav) loggedOutNav.style.display = 'flex';
            if(loggedInNav) loggedInNav.style.display = 'none';
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(event) {
                event.preventDefault(); // ê¸°ë³¸ ë§í¬ ì´ë™ ë°©ì§€
                alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤."); 
                // ì‹¤ì œ ë¡œê·¸ì•„ì›ƒì€ ì„œë²„ ì¸¡ URLë¡œ ì´ë™í•˜ì—¬ ì²˜ë¦¬ (ì˜ˆ: form submit ë˜ëŠ” window.location.href)
                window.location.href = '${pageContext.request.contextPath}/logout'; // ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ URL
            });
        }

        // ì™¸ë¶€ í‘¸í„° íŒŒì¼ ë¡œë“œ
        fetch('${pageContext.request.contextPath}/resources/html/footer.html')
            .then(response => response.ok ? response.text() : Promise.reject('Footer not found'))
            .then(data => {
                const footerPlaceholder = document.getElementById('footer-placeholder');
                if (footerPlaceholder) {
                    footerPlaceholder.innerHTML = data;
                }
            })
            .catch(error => console.error('Error loading footer:', error));

        // ë°°ì†¡ ë©”ì‹œì§€ ì§ì ‘ ì…ë ¥ í† ê¸€
        function toggleCustomMessage() {
            const deliveryRequest = document.getElementById('deliveryRequest');
            const customMessageArea = document.getElementById('customMessageArea');
            customMessageArea.style.display = deliveryRequest.value === 'custom' ? 'block' : 'none';
        }
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        toggleCustomMessage(); // ì´ˆê¸° ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰

        // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ
        const paymentMethods = document.querySelectorAll('.payment-method');
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                paymentMethods.forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // ì£¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ (Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ë“± API ì—°ë™ í•„ìš”)
        function searchAddress() {
        	new daum.Postcode({
        		oncomplete: function(data) {
        			// íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„.

        			// ê° ì£¼ì†Œì˜ ë…¸ì¶œ ê·œì¹™ì— ë”°ë¼ ì£¼ì†Œë¥¼ ì¡°í•©í•œë‹¤.
        			// ë‚´ë ¤ì˜¤ëŠ” ë³€ìˆ˜ê°€ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—” ê³µë°±('')ê°’ì„ ê°€ì§€ë¯€ë¡œ, ì´ë¥¼ ì°¸ê³ í•˜ì—¬ ë¶„ê¸° í•œë‹¤.
        			var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜
        			var extraAddr = ''; // ì°¸ê³ í•­ëª© ë³€ìˆ˜

        			//ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
        			if (data.userSelectedType === 'R') { // ì‚¬ìš©ìê°€ ë„ë¡œëª… ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°
        			    addr = data.roadAddress;
        			} else { // ì‚¬ìš©ìê°€ ì§€ë²ˆ ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°(J)
        			    addr = data.jibunAddress;
        			}

        			// ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œê°€ ë„ë¡œëª… íƒ€ì…ì¼ë•Œ ì°¸ê³ í•­ëª©ì„ ì¡°í•©í•œë‹¤.
        			if(data.userSelectedType === 'R'){
        			    // ë²•ì •ë™ëª…ì´ ìˆì„ ê²½ìš° ì¶”ê°€í•œë‹¤. (ë²•ì •ë¦¬ëŠ” ì œì™¸)
        			    // ë²•ì •ë™ì˜ ê²½ìš° ë§ˆì§€ë§‰ ë¬¸ìê°€ "ë™/ë¡œ/ê°€"ë¡œ ëë‚œë‹¤.
        			    if(data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
        			        extraAddr += data.bname;
        			    }
        			    // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
        			    if(data.buildingName !== '' && data.apartment === 'Y'){
        			        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
        			    }
        			}

        			// ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
        			document.getElementById('postcode').value = data.zonecode;
        			document.getElementById("address").value = addr;
        			// ì»¤ì„œë¥¼ ìƒì„¸ì£¼ì†Œ í•„ë“œë¡œ ì´ë™í•œë‹¤.
        			document.getElementById("addressDetail").focus();
        		}
        	}).open();
        }
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡í•˜ì—¬ HTML onclickì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ í•¨
        window.searchAddress = searchAddress;

        // í¼ ìœ íš¨ì„± ê²€ì‚¬
        function validateForm() {
            const receiverName = document.getElementById('receiverName').value;
            const receiverPhone = document.getElementById('receiverPhone').value; // <-- ì—¬ê¸°ì„œ ê°’ì„ ê°€ì ¸ì˜´
            const orderEmailInput = document.getElementById('orderEmailInput').value; // <-- ì—¬ê¸°ì„œ ê°’ì„ ê°€ì ¸ì˜´
            const postcode = document.getElementById('postcode').value;
            const address = document.getElementById('address').value;
            const addressDetail = document.getElementById('addressDetail').value;
            const deliveryRequest = document.getElementById('deliveryRequest');
            const customMessage = document.getElementById('customMessage');
            const paymentAgreement = document.getElementById('paymentAgreement');
            const selectedPayment = document.querySelector('.payment-method.selected');

            if (!receiverName.trim()) {
                alert('ë°›ëŠ” ì‚¬ëŒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!receiverPhone.trim()) { // <-- ìœ íš¨ì„± ê²€ì‚¬
                alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!orderEmailInput.trim()) { // <-- ìœ íš¨ì„± ê²€ì‚¬
                alert('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!postcode || !address) {
                alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!addressDetail.trim()) {
                alert('ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (deliveryRequest.value === 'custom' && !customMessage.value.trim()) {
                alert('ë°°ì†¡ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!selectedPayment) {
                alert('ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return false;
            }
            if (!paymentAgreement.checked) {
                alert('ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ ë° ê²°ì œ ì§„í–‰ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return false;
            }
            return true;
        }

        // ì£¼ë¬¸ ì œì¶œ (ê²°ì œí•˜ê¸° ë²„íŠ¼)
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        if (submitOrderBtn) {
            submitOrderBtn.addEventListener('click', function() {
                if (!isLoggedIn) { // ë¡œê·¸ì¸ ì—¬ë¶€ ì¬í™•ì¸
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                    window.location.href = '${pageContext.request.contextPath}/login.html';
                    return;
                }

                if (validateForm()) { // <-- ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ í›„ ì§„í–‰
                    const selectedPayment = document.querySelector('.payment-method.selected');
                    if (selectedPayment.dataset.method === 'kakao') {
                        // ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì²˜ë¦¬ ì‹œì‘
                        const orderItemsElements = document.querySelectorAll('.order-item');
                        const orderItems = [];
                        let totalItemQty = 0;

                        orderItemsElements.forEach(itemEl => {
                            const goodsNo = parseInt(itemEl.dataset.goodsNo);
                            const goodsOptNo = parseInt(itemEl.dataset.goodsOptNo);
                            const qty = parseInt(itemEl.dataset.qty);

                            if (!isNaN(goodsNo) && !isNaN(qty)) {
                                const itemData = {
                                    goodsNo: goodsNo,
                                    qty: qty
                                };
                                if (!isNaN(goodsOptNo)) {
                                    itemData.goodsOptNo = goodsOptNo;
                                } else {
                                    itemData.goodsOptNo = 0;
                                }
                                orderItems.push(itemData);
                                totalItemQty += qty;
                            }
                        });

                        // ë°°ì†¡ì§€ ì •ë³´ ìˆ˜ì§‘ (ìœ íš¨ì„± ê²€ì‚¬ëœ ê°’ë“¤ì„ ë‹¤ì‹œ ê°€ì ¸ì˜´)
                        const receiverName = document.getElementById('receiverName').value;
                        const receiverPhone = document.getElementById('receiverPhone').value; // <-- ì´ì œ ì—¬ê¸°ì„œ ìµœì¢… ê°’
                        const postcode = document.getElementById('postcode').value;
                        const address1 = document.getElementById('address').value;
                        const address2 = document.getElementById('addressDetail').value;
                        const deliveryRequestSelect = document.getElementById('deliveryRequest');
                        const orderEmail = document.getElementById('orderEmailInput').value; // <-- ì´ì œ ì—¬ê¸°ì„œ ìµœì¢… ê°’
                        
                        let orderMemo = deliveryRequestSelect.value;
                        if (orderMemo === 'custom') {
                            orderMemo = document.getElementById('customMessage').value;
                        } else if (orderMemo === '') {
                            orderMemo = null;
                        }

                        // ìµœì¢… ê²°ì œ ê¸ˆì•¡ (í™”ë©´ì—ì„œ íŒŒì‹±)
                        const finalAmountDisplay = document.getElementById('finalPaymentAmountDisplay').textContent;
                        const finalAmount = parseInt(finalAmountDisplay.replace(/[^0-9]/g, ''));

                        // ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„ ìš”ì²­ Payload êµ¬ì„±
                        const payReadyPayload = {
                            orderItems: orderItems,
                            totalAmount: finalAmount,
                            totalQuantity: totalItemQty,

                            // OrdersVOì— í•„ìš”í•œ ë‚˜ë¨¸ì§€ ì •ë³´
                            orderRecipientNm: receiverName,
                            orderRecipientPhone: receiverPhone, // <-- payloadì— í¬í•¨
                            orderZipCode: postcode,
                            orderAddress1: address1,
                            orderAddress2: address2,
                            orderEmail: orderEmail, // <-- payloadì— í¬í•¨
                            orderMemo: orderMemo,
                            orderTypeCode: document.getElementById('orderTypeCodeInput').value, // <-- orderTypeCodeInputì—ì„œ ê°€ì ¸ì˜´
                            // ë‹¨ì¼ ìƒí’ˆì¼ ê²½ìš°ì˜ ìƒí’ˆëª… (ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œì°½ ìš”ì•½ìš©)
                            singleGoodsName: orderItems.length === 1 ? document.querySelector('.order-item .item-name').textContent : undefined
                        };

                        // ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„ API í˜¸ì¶œ
                        fetch('${pageContext.request.contextPath}/goods/order/pay/ready', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrfHeader]: csrfToken
                            },
                            body: JSON.stringify(payReadyPayload)
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errorData => {
                                    throw new Error(errorData.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.href = data.next_redirect_pc_url;
                            } else {
                                alert('ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜:', error);
                            alert('ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        });

                    } else {
                        alert('ì„ íƒëœ ê²°ì œ ìˆ˜ë‹¨ì´ ì¹´ì¹´ì˜¤í˜ì´ê°€ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                    }
                }
            });
        }
    });
</script>
</body>
</html>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN êµ¿ì¦ˆìƒµ - ì¥ë°”êµ¬ë‹ˆ</title>
	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods.css">
	<meta name="_csrf" content="${_csrf.token}"/>
	<meta name="_csrf_header" content="${_csrf.headerName}"/>
	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods_cart.css">
	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css" />
	
</head>
<body class="cart-page-body">
    <jsp:include page="/WEB-INF/views/modules/communityHeader.jsp" />

    <div class="cart-container">
        <div class="cart-header"><h1>ì¥ë°”êµ¬ë‹ˆ</h1></div>

        <div class="cart-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div><label><input type="checkbox" id="selectAllItems"> ì „ì²´ì„ íƒ</label></div>
            <button id="deleteSelectedItems" style="padding: 5px 10px; font-size:0.9em; border:1px solid #ddd; background-color:#fff; border-radius:4px; cursor:pointer;">ì„ íƒì‚­ì œ</button>
        </div>

        <div class="cart-item-list" id="cartItemList">
		    <c:set var="totalProductPriceInitial" value="0"/>
		    <c:forEach var="cartItem" items="${cartItems}">
		        <div class="cart-item 
		        	${cartItem.goodsStatCode eq 'SOLD_OUT' || cartItem.goodsStatCode eq 'UNAVAILABLE' ? 'disabled' : ''}"
		             data-product-id="${cartItem.goodsNo}" data-cart-no="${cartItem.cartNo }">  <%-- goodsNo ì‚¬ìš© --%>
		            <input type="checkbox" class="item-checkbox" 
		            	${cartItem.goodsStatCode eq 'SOLD_OUT' || cartItem.goodsStatCode eq 'UNAVAILABLE' ? 'disabled' : ''} checked>
		            <div class="item-image">
		                <img src="${not empty cartItem.representativeImageUrl ? cartItem.representativeImageUrl : 'https://via.placeholder.com/550x550/E6E6FA/000000?text=No+Image'}" <%-- null/empty ì²´í¬ ì¶”ê°€ --%>
		                     alt="${cartItem.goodsNm}">
		            </div>
		            <div class="item-info">
		                <a href="detail?id=${cartItem.goodsNo}" class="item-name">${cartItem.goodsNm}</a> <%-- goodsNo, goodsNm ì‚¬ìš© --%>
		                <span class="item-option">ì˜µì…˜: ${cartItem.goodsOptNm}</span> <%-- goodsOptNm ì‚¬ìš© --%>
		                <c:if test="${cartItem.goodsStatCode eq 'SOLD_OUT'}">
		                    <span class="item-status">(í’ˆì ˆ)</span>
		                </c:if>
		                <c:if test="${cartItem.goodsStatCode eq 'UNAVAILABLE'}">
		                    <span class="item-status">(ìƒí’ˆ ì •ë³´ ì—†ìŒ)</span>
		                </c:if>
		            </div>
		            <div class="item-quantity">
					    <button class="quantity-decrease" ${cartItem.goodsStatCode eq 'SOLD_OUT' || cartItem.goodsStatCode eq 'UNAVAILABLE' ? 'disabled' : ''}>-</button>
					    <input type="number" 
						       value="${cartItem.cartQty}" 
						       min="1" 
						       max="10" 
						       readonly 
						       ${cartItem.goodsStatCode eq 'SOLD_OUT' || cartItem.goodsStatCode eq 'UNAVAILABLE' ? 'disabled' : ''}
						       data-unit-price="${cartItem.goodsPrice}"
						>
					    <button class="quantity-increase" ${cartItem.goodsStatCode eq 'SOLD_OUT' || cartItem.goodsStatCode eq 'UNAVAILABLE' ? 'disabled' : ''}>+</button>
					</div>
		            <div class="item-price"> <%-- goodsPrice ì‚¬ìš© --%>
		                <fmt:formatNumber value="${cartItem.goodsPrice * cartItem.cartQty}" type="number"/>ì› <%-- goodsPrice, cartQty ì‚¬ìš© --%>
		            </div>
		            <div class="item-delete"><button title="ì‚­ì œ">ğŸ—‘ï¸</button></div>
		        </div>
		        <c:if test="${cartItem.goodsStatCode ne 'SOLD_OUT' && cartItem.goodsStatCode ne 'UNAVAILABLE'}">
		            <c:set var="totalProductPriceInitial" value="${totalProductPriceInitial + (cartItem.goodsPrice * cartItem.cartQty)}"/> <%-- goodsPrice, cartQty ì‚¬ìš© --%>
		        </c:if>
		    </c:forEach>
		</div>

        <div class="cart-summary">
            <h3>ì£¼ë¬¸ ìš”ì•½</h3>
            <div class="summary-row">
                <span class="label">ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                <span class="value" id="totalProductPrice"><fmt:formatNumber value="${totalProductPriceInitial}" type="number"/>ì›</span>
            </div>
            <div class="summary-row">
                <span class="label">ë°°ì†¡ë¹„</span>
                <span class="value" id="shippingFee"><fmt:formatNumber value="${totalProductPriceInitial > 0 ? 3000 : 0}" type="number"/>ì›</span>
            </div>
            <hr style="border:none; border-top:1px dashed #ddd; margin: 15px 0;">
            <div class="summary-row total">
                <span class="label">ì´ ê²°ì œ ê¸ˆì•¡</span>
                <span class="value" id="finalTotalPrice"><fmt:formatNumber value="${totalProductPriceInitial + (totalProductPriceInitial > 0 ? 3000 : 0)}" type="number"/>ì›</span>
            </div>
        </div>

        <div class="cart-actions">
            <a href="${pageContext.request.contextPath}/goods/main" class="btn-keep-shopping">ì‡¼í•‘ ê³„ì†í•˜ê¸°</a>
            <button class="btn-order" id="orderButton">ì£¼ë¬¸í•˜ê¸°</button>
        </div>
    </div>

    <div id="footer-placeholder"></div>

<script>
    let csrfToken;
    let csrfHeader;
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    document.addEventListener('DOMContentLoaded', function() {
    	 	csrfToken = document.querySelector('meta[name="_csrf"]').content;
    	    csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    	    console.log("DOMContentLoaded - CSRF Header:", csrfHeader, "CSRF Token:", csrfToken);
  
    	    const logoutBtn = document.getElementById('logoutBtn');       // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ìˆìœ¼ë©´ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(event) {
                event.preventDefault(); // ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë°©ì§€
                // Note: isUserLoggedInê³¼ localStorageëŠ” í˜„ì¬ JSPì—ëŠ” ì—†ìŠµë‹ˆë‹¤.
                // Spring Securityë¥¼ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ ì‹¤ì œ ë¡œê·¸ì•„ì›ƒì€ ì„œë²„ í˜¸ì¶œë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
                // alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤."); // ì´ ì•Œë¦¼ì€ í•„ìš”ì— ë”°ë¼ ìœ ì§€í•˜ê±°ë‚˜ ì œê±°í•˜ì„¸ìš”.
                // í¼ì„ í†µí•œ ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” AJAX ë¡œê·¸ì•„ì›ƒ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            });
        }

        // --- ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ ê´€ë ¨ ìš”ì†Œ ì°¸ì¡° ---
        const cartItemList = document.getElementById('cartItemList');       // ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ëª©ë¡ì„ ë‹´ëŠ” ë¶€ëª¨ ìš”ì†Œ
        const selectAllCheckbox = document.getElementById('selectAllItems'); // 'ì „ì²´ì„ íƒ' ì²´í¬ë°•ìŠ¤
        const deleteSelectedButton = document.getElementById('deleteSelectedItems'); // 'ì„ íƒì‚­ì œ' ë²„íŠ¼
        const orderButton = document.getElementById('orderButton');         // 'ì£¼ë¬¸í•˜ê¸°' ë²„íŠ¼
		
     // --- ì¥ë°”êµ¬ë‹ˆ ìš”ì•½ ì •ë³´(ì´ ìƒí’ˆ ê¸ˆì•¡, ë°°ì†¡ë¹„, ìµœì¢… ê²°ì œ ê¸ˆì•¡) ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateSummary() {
            let totalProductPrice = 0; // ì´ˆê¸° ì´ ìƒí’ˆ ê¸ˆì•¡
            
            // '.disabled' í´ë˜ìŠ¤ê°€ ì—†ê³  ì²´í¬ëœ '.item-checkbox'ë¥¼ ê°€ì§„ ëª¨ë“  ìƒí’ˆ ì„ íƒ
            const selectedCheckboxes = document.querySelectorAll('.cart-item:not(.disabled) .item-checkbox:checked');
            
            selectedCheckboxes.forEach(checkbox => {
                const item = checkbox.closest('.cart-item'); // ì²´í¬ë°•ìŠ¤ì˜ ê°€ì¥ ê°€ê¹Œìš´ '.cart-item' ë¶€ëª¨ ìš”ì†Œ
                
                const quantityInput = item.querySelector('input[type="number"]');
                if (quantityInput) {
                    const price = parseFloat(quantityInput.dataset.unitPrice) || 0; // 'data-unit-price' ì†ì„±ì—ì„œ ë‹¨ê°€ ê°€ì ¸ì˜¤ê¸°
                    const quantity = Number(quantityInput.value) || 0; // ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œì—ì„œ ìˆ˜ëŸ‰ ê°€ì ¸ì˜¤ê¸°
                    totalProductPrice += price * quantity; // ì´ ìƒí’ˆ ê¸ˆì•¡ì— í•©ì‚°
                } else {
                    console.warn("ê²½ê³ : 'input[type=\"number\"]' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ì¥ë°”êµ¬ë‹ˆ í•­ëª©: ", item);
                }
            });

            // ë°°ì†¡ë¹„ ê³„ì‚°: 30,000ì› ì´ìƒì´ë©´ ë¬´ë£Œ
            const freeShippingThreshold = 30000;
            let shippingFee = 0;
            if (totalProductPrice >= freeShippingThreshold) {
                shippingFee = 0; 
            } else if (totalProductPrice > 0) {
                shippingFee = 3000;
            } else {
                shippingFee = 0;
            }
            
            // ìµœì¢… ê²°ì œ ê¸ˆì•¡ = ì´ ìƒí’ˆ ê¸ˆì•¡ + ë°°ì†¡ë¹„
            const finalTotalPrice = totalProductPrice + shippingFee;
            
            // ê³„ì‚°ëœ ê¸ˆì•¡ë“¤ì„ í•´ë‹¹ HTML ìš”ì†Œì— ì—…ë°ì´íŠ¸ (formatCurrency í•¨ìˆ˜ ì‚¬ìš©)
            document.getElementById('totalProductPrice').textContent = formatCurrency(totalProductPrice);
            document.getElementById('shippingFee').textContent = formatCurrency(shippingFee);
            document.getElementById('finalTotalPrice').textContent = formatCurrency(finalTotalPrice);
            
            console.log('ì´ ìƒí’ˆ ê¸ˆì•¡:', totalProductPrice);
            console.log('ê³„ì‚°ëœ ë°°ì†¡ë¹„:', shippingFee);
            console.log('ìµœì¢… ê²°ì œ ê¸ˆì•¡:', finalTotalPrice);
            
            // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ 'ì „ì²´ì„ íƒ' ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            const selectAllCheckbox = document.getElementById('selectAllItems');
            const allItemCheckboxes = document.querySelectorAll('.cart-item:not(.disabled) .item-checkbox');
            const checkedItemCheckboxes = document.querySelectorAll('.cart-item:not(.disabled) .item-checkbox:checked');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allItemCheckboxes.length > 0 && allItemCheckboxes.length === checkedItemCheckboxes.length;
            }
        }
        
        //ìƒˆë¡œ DBì— ì¶”ê°€í•  ìˆ˜ëŸ‰ ì—…ëƒ í•¨ìˆ˜
        // --- ìƒˆë¡œ ì¶”ê°€í•  DB ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
	    async function updateCartItemQuantityInDb(cartNo, newQuantity) {
	        console.log(`[DB ì—…ë°ì´íŠ¸ ìš”ì²­ ì‹œì‘] cartNo: ${cartNo}, newQuantity: ${newQuantity}`);
	        console.log(`ì‚¬ìš©ë  CSRF Header: ${csrfHeader}, Token: ${csrfToken}`); // ë””ë²„ê¹…ìš©
			
	        try {
	            const response = await fetch('/goods/cart/updateQuantity', { // ì´ URLì€ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë§¤í•‘ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json', // JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
	                    'Accept': 'application/json',       // JSON ì‘ë‹µì„ ê¸°ëŒ€
	                    [csrfHeader]: csrfToken             // CSRF í† í° í—¤ë” í¬í•¨
	                },
	                body: JSON.stringify({ cartNo: cartNo, cartQty: newQuantity }) // JSON í˜•íƒœë¡œ ë°ì´í„° ì „ì†¡
	            });
	
	            const responseText = await response.text(); // ì¼ë‹¨ ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ í†µì§¸ë¡œ ë°›ì•„ì„œ íŒŒì‹± ì—ëŸ¬ ë°©ì§€
	            console.log("ì„œë²„ ì‘ë‹µ ì›ë³¸ í…ìŠ¤íŠ¸:", responseText);
	
	            let data;
	            try {
	                // ì‘ë‹µ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì§€ ì•Šê³  JSON í˜•ì‹ì¼ ë•Œë§Œ íŒŒì‹± ì‹œë„
	                if (responseText && responseText.trim().startsWith('{') && responseText.trim().endsWith('}')) {
	                    data = JSON.parse(responseText);
	                } else {
	                    // JSON í˜•ì‹ì´ ì•„ë‹Œ ì‘ë‹µì´ ì™”ì„ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
	                    throw new Error(`ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë³´ëƒˆìŠµë‹ˆë‹¤: ${responseText}`);
	                }
	            } catch (jsonParseError) {
	                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", jsonParseError);
	                throw new Error(`ì„œë²„ ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨. ì‘ë‹µ ë‚´ìš©: ${responseText.substring(0, 100)}...`);
	            }
	
	            if (!response.ok) { // HTTP ìƒíƒœ ì½”ë“œê°€ 200ë²ˆëŒ€ê°€ ì•„ë‹ˆë©´ (ì˜ˆ: 4xx, 5xx)
	                // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì‚¬ìš©, ì—†ë‹¤ë©´ ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€
	                throw new Error(data.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
	            }
	
	            if (data.status === 'success') {
	                console.log('DB ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì„±ê³µ:', data.message);
	                // DB ì—…ë°ì´íŠ¸ ì„±ê³µ í›„, UI ìš”ì•½ ì •ë³´ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
	                updateSummary(); 
	            } else {
	                console.warn('DB ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data.message);
	                alert('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
	                // ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (í•„ìš”ì‹œ UI ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸° ë¡œì§ ì¶”ê°€)
	            }
	        } catch (error) {
	            console.error('DB ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì¤‘ í†µì‹  ì˜¤ë¥˜:', error);
	            alert('ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
	            // í†µì‹  ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ UI ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (í˜„ì¬ UI ìƒíƒœë¥¼ ë°˜ì˜)
	            updateSummary();
	        }
	    }
	
        // --- ê°œë³„ ìƒí’ˆ ì‚­ì œë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³µí†µ í•¨ìˆ˜ ---
        // ì´ í•¨ìˆ˜ëŠ” ë‹¨ì¼ ìƒí’ˆ ì‚­ì œ ë¡œì§ì˜ ì¤‘ë³µì„ í”¼í•˜ê¸° ìœ„í•´ ë¶„ë¦¬
        function handleDeleteItem(itemElement) {
            const cartNo = itemElement.dataset.cartNo; // 'data-cart-no' ì†ì„±ì—ì„œ ì¥ë°”êµ¬ë‹ˆ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
            if (!cartNo) {
                console.error('ì¥ë°”êµ¬ë‹ˆ ë²ˆí˜¸(cartNo)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                alert('ì¥ë°”êµ¬ë‹ˆ í•­ëª© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm('ì„ íƒí•œ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            	const token = document.querySelector('meta[name="_csrf"]').content;
                const header = document.querySelector('meta[name="_csrf_header"]').content;
                
                // ì„œë²„ì— ì‚­ì œ ìš”ì²­ (POST ë°©ì‹, JSON ë°ì´í„° ì „ì†¡)
                fetch('/goods/cart/delete', { // /cart/delete ì»¨íŠ¸ë¡¤ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ë³´ëƒ„
                        'Accept': 'application/json',
                        [header]: token
                    },
                    body: JSON.stringify({ cartNo: parseInt(cartNo) }) // { "cartNo": 123 } í˜•íƒœì˜ JSON ì „ì†¡
                })
                .then(response => {
                    // HTTP ì‘ë‹µ ìƒíƒœê°€ 200ë²ˆëŒ€ê°€ ì•„ë‹ˆë©´ ì˜¤ë¥˜ ì²˜ë¦¬
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                    return response.json(); // JSON ì‘ë‹µ íŒŒì‹±
                })
                .then(data => {
                    alert(data.message); // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€(ì„±ê³µ/ì‹¤íŒ¨) í‘œì‹œ
                    if (data.message.includes('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤')) {
                        itemElement.remove(); // DB ì‚­ì œ ì„±ê³µ ì‹œ, í•´ë‹¹ ì¥ë°”êµ¬ë‹ˆ í•­ëª©ì„ DOMì—ì„œ ì œê±°
                        updateSummary();      // ì¥ë°”êµ¬ë‹ˆ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
                    }
                })
                .catch(error => {
                    console.error('ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            }
        }
	     // --- ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ë‚´ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„ (ìˆ˜ëŸ‰ ì¡°ì ˆ ë° ë‹¨ì¼ ì‚­ì œ) ---
	     // ***async í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ì—¬ awaitë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.***
	     cartItemList.addEventListener('click', async function(event) { 
	         const target = event.target;      // í´ë¦­ëœ ìš”ì†Œ
	         const item = target.closest('.cart-item'); // í´ë¦­ëœ ìš”ì†Œì˜ ê°€ì¥ ê°€ê¹Œìš´ '.cart-item' ë¶€ëª¨ ìš”ì†Œ
	         if (!item) return; // '.cart-item' ë‚´ì—ì„œ í´ë¦­ëœ ê²ƒì´ ì•„ë‹ˆë©´ í•¨ìˆ˜ ì¢…ë£Œ
	
	         // cartNoëŠ” itemì´ ì •ì˜ëœ í›„ì— ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤.
	         const cartNo = parseInt(item.dataset.cartNo); // cartNoë¥¼ ì—¬ê¸°ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
	         console.log("íŒŒì‹±ëœ cartNo (JS):", cartNo);
	         
	      // *** ì´ ë¶€ë¶„ì´ ìˆ˜ì •ë©ë‹ˆë‹¤. (ì¤‘ë³µ ì„ ì–¸ ì œê±°) ***
	         const input = item.querySelector('input[type="number"]');
	         if (!input) { 
	             console.error("ì˜¤ë¥˜: 'input[type=\"number\"]' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ì¥ë°”êµ¬ë‹ˆ í•­ëª©:", item);
	             return;
	         }
	         console.log("ì°¾ì€ input ìš”ì†Œ:", input);
	         console.log("input.value:", input.value);
	         console.log("Number(input.value):", Number(input.value));
	         
	         
	         const unitPriceString = input.getAttribute('data-unit-price'); // <<--- ì´ë ‡ê²Œ ë³€ê²½
	         console.log("input.getAttribute('data-unit-price'):", unitPriceString); 
	         
	         const unitPrice = parseFloat(unitPriceString) || 0; // <<--- ì´ë ‡ê²Œ ë³€ê²½
	         console.log("parseFloat(unitPriceString):", unitPrice); 
	         
	         let currentQuantity = Number(input.value) || 0; // í˜„ì¬ ìˆ˜ëŸ‰
	         
	         if (isNaN(cartNo) || cartNo <= 0 || isNaN(unitPrice) || unitPrice <= 0 || isNaN(currentQuantity) || currentQuantity <= 0) {
	              console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ë˜ëŠ” ìˆ˜ëŸ‰ì…ë‹ˆë‹¤. DB ì—…ë°ì´íŠ¸ ìš”ì²­ì„ ê±´ë„ˆëœœ.", 
	                              "cartNo:", cartNo, "unitPrice:", unitPrice, "currentQuantity:", currentQuantity);
	              alert("ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ìˆ˜ëŸ‰ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
	              return; 
	         }
	         
	         // 1. ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (ìƒí’ˆì´ í™œì„±í™” ìƒíƒœì´ë“  ë¹„í™œì„±í™” ìƒíƒœì´ë“  ìƒê´€ì—†ì´)
	         if (target.closest('.item-delete button')) {
	             handleDeleteItem(item); // ê³µí†µ ì‚­ì œ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
	             return; // ì‚­ì œ ì²˜ë¦¬ í›„ì—ëŠ” ë‹¤ë¥¸ ì´ë²¤íŠ¸ëŠ” ì²˜ë¦¬í•˜ì§€ ì•Šê³  í•¨ìˆ˜ ì¢…ë£Œ
	         }
	
	         // 2. ë¹„í™œì„±í™”ëœ ìƒí’ˆ(.disabled)ì€ ìˆ˜ëŸ‰ ì¡°ì ˆì´ë‚˜ ì²´í¬ë°•ìŠ¤ í´ë¦­ì„ ë§‰ìŒ
	         if (item.classList.contains('disabled')) {
	             return; // ë¹„í™œì„±í™”ëœ ìƒí’ˆì´ë©´ ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
	         }
	
	         // 3. í™œì„±í™”ëœ ìƒí’ˆì— ëŒ€í•œ ìˆ˜ëŸ‰ ì¡°ì ˆ ë° ì²´í¬ë°•ìŠ¤ í´ë¦­ ì²˜ë¦¬
	         if (target.classList.contains('quantity-increase')) { // ìˆ˜ëŸ‰ ì¦ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ
	             //const input = item.querySelector('input[type="number"]'); // ì´ë¯¸ ìœ„ì—ì„œ input ë³€ìˆ˜ ì„ ì–¸ë¨
	             const maxQuantity = parseInt(input.max); 
	             let newQuantity = Number(input.value); 
	
	             if (newQuantity < maxQuantity) { 
	                 newQuantity += 1;
	                 input.value = newQuantity; 
	
	                 // ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì´ìš©í•˜ì—¬ ìƒí’ˆ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ (UI)
	                 // const unitPrice = parseFloat(input.dataset.unitPrice) || 0; // ì´ë¯¸ ìœ„ì—ì„œ unitPrice ë³€ìˆ˜ ì„ ì–¸ë¨
	                 item.querySelector('.item-price').textContent = formatCurrency(unitPrice * newQuantity);
	
	                 await updateCartItemQuantityInDb(cartNo, newQuantity); 
	             }
	         } else if (target.classList.contains('quantity-decrease')) { // ìˆ˜ëŸ‰ ê°ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
	             //const input = item.querySelector('input[type="number"]'); // ì´ë¯¸ ìœ„ì—ì„œ input ë³€ìˆ˜ ì„ ì–¸ë¨
	             const minQuantity = parseInt(input.min); 
	             let newQuantity = Number(input.value); 
	
	             if (newQuantity > minQuantity) { 
	                 newQuantity -= 1;
	                 input.value = newQuantity; 
	
	                 // ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì´ìš©í•˜ì—¬ ìƒí’ˆ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ (UI)
	                 // const unitPrice = parseFloat(input.dataset.unitPrice) || 0; // ì´ë¯¸ ìœ„ì—ì„œ unitPrice ë³€ìˆ˜ ì„ ì–¸ë¨
	                 item.querySelector('.item-price').textContent = formatCurrency(unitPrice * newQuantity);
	
	                 await updateCartItemQuantityInDb(cartNo, newQuantity);
	             }
	         } else if (target.classList.contains('item-checkbox')) { // ê°œë³„ ìƒí’ˆ ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ
	             updateSummary(); 
	         }
	     });
        
		// --- 'ì „ì²´ì„ íƒ' ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ---
        if (selectAllCheckbox) { 
            selectAllCheckbox.addEventListener('change', function() {
                cartItemList.querySelectorAll('.cart-item:not(.disabled) .item-checkbox').forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSummary(); 
            });
        }
	
		// --- 'ì„ íƒì‚­ì œ' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
        if (deleteSelectedButton) { 
            deleteSelectedButton.addEventListener('click', function() {
                const selectedCheckboxes = cartItemList.querySelectorAll('.cart-item:not(.disabled) .item-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const cartNoList = []; 
                selectedCheckboxes.forEach(checkbox => {
                    const cartItemDiv = checkbox.closest('.cart-item');
                    const cartNo = cartItemDiv.dataset.cartNo; 
                    if (cartNo) {
                        cartNoList.push(parseInt(cartNo)); 
                    }
                });

                if (cartNoList.length === 0) {
                    alert('ì‚­ì œí•  ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ì˜¤ë¥˜)');
                    return;
                }

                if (confirm('ì„ íƒí•œ ' + cartNoList.length + 'ê°œ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                		const token = document.querySelector('meta[name="_csrf"]').content;
                    const header = document.querySelector('meta[name="_csrf_header"]').content;
                    
                    // --- ì—¬ê¸°ì„œ selectedCartNoList ëŒ€ì‹  cartNoListë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ---
                    const requestBody = {
                            cartNoList: cartNoList // ì´ ë³€ìˆ˜ë¥¼ ì‚¬ìš©
                        };    
                	
                    fetch('/goods/cart/deleteSelected', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            [header]: token
                        },
                        body: JSON.stringify(requestBody) 
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert(data.message);
                        if (data.status === 'success' || data.status === 'partial_success') {
                            location.reload(); 
                        }
                    })
                    .catch(error => {
                        console.error('ì¥ë°”êµ¬ë‹ˆ ì„ íƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                        alert('ì¥ë°”êµ¬ë‹ˆ ì„ íƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    });
                }
            });
        }
		
     // --- 'ì£¼ë¬¸í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ìƒˆë¡­ê²Œ í•µì‹¬ì ìœ¼ë¡œ ìˆ˜ì •ëœ ë¶€ë¶„) ---
        if (orderButton) { 
            orderButton.addEventListener('click', function() {
                const selectedCartItems = document.querySelectorAll('.cart-item:not(.disabled) .item-checkbox:checked');
                
                if (selectedCartItems.length === 0) {
                    alert('ì£¼ë¬¸í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const selectedCartNoList = []; 
                selectedCartItems.forEach(checkbox => {
                    const cartItemDiv = checkbox.closest('.cart-item');
                    const cartNo = cartItemDiv.dataset.cartNo; 
                    if (cartNo) {
                        selectedCartNoList.push(parseInt(cartNo)); 
                    }
                });

                if (selectedCartNoList.length === 0) {
                    alert('ì£¼ë¬¸í•  ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„° ì˜¤ë¥˜)');
                    return;
                }

                const token = document.querySelector('meta[name="_csrf"]').content;
                const header = document.querySelector('meta[name="_csrf_header"]').content;

                fetch('/goods/order/prepare', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', 
                        'Accept': 'application/json', 
                        [header]: token 
                    },
                    body: JSON.stringify({ cartNoList: selectedCartNoList }) 
                })
                .then(response => {
                    if (!response.ok) { 
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || 'ì£¼ë¬¸ ì¤€ë¹„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                    return response.json(); 
                })
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = '/goods/order'; 
                    } else {
                        alert('ì£¼ë¬¸ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('ì£¼ë¬¸ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            });
        }
     
        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ ---
        updateSummary();
    });

</script>
</body>
</html>
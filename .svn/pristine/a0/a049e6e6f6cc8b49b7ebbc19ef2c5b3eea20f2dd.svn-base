<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<%@ taglib uri="jakarta.tags.functions" prefix="fn" %>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artist A - 커뮤니티</title>
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.css" />
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/mainservice_common.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/artist_community.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" ></script>
<%@ include file="../../modules/headerPart.jsp" %>
<style>
.membership-blur {
    filter: blur(5px);
    pointer-events: none;
}

.membership-only {
    position: relative;
}

.membership-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

.membership-badge {
    background: #8a2be2;
    color: #fff;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.8em;
    margin-left: 5px;
}

.imgDiv{
	position :relative;
	width: 100px;
	height : 100px;
}

.imgDiv img{
	width : 100%;
	height : 100%
}

.imgDiv i{
	position : absolute;
	top : 5%;
	right: 5%; /* 아이콘을 이미지의 가로 중앙에 위치 */
    transform: translate(-10%, -10%); /* 아이콘을 중앙에 정확히 위치 */
    font-size: 1rem; /* 아이콘 크기 조절 */
    color: white; /* 아이콘 색상 설정 */
}


</style>
</head>
<body>
    
	<sec:authentication property="principal" var="user"/>
	
	    <c:out value="${user}"/>
    <div class="apt-main-layout">
        <div class="apt-container">
            <header class="apt-header">
                <div class="apt-header-avatar">
                    <div class="artist-avatar-placeholder">A</div><!-- 아티스트 그룹 이미지 넣을 예정-->
                </div>
                <div class="apt-header-info">
                    <h2><c:out value="${artistGroupVO.artGroupNm }" /> <span style="font-size:0.7em; color: #888;">(아티스트)</span></h2>
                    <div class="artist-stats">
                        <span><c:out value="${artistGroupVO.communityVO.totalArtist }"/>명</span> &bull; <span><fmt:formatNumber value="${artistGroupVO.communityVO.totalFan }" pattern="#,###"/></span> 팬
                    </div>
                </div>
                <div class="apt-header-actions">
	               	<c:if test="${followFlag eq 'N'}">
		                <button class="btn-apt-action" id="followToggleBtn">
		                    팔로우              	
		                </button>                	
	              	</c:if>
	               	<c:if test="${followFlag eq 'Y'}">
		                <button class="btn-apt-action following" id="followToggleBtn">
		                    <span class="follow-icon">✔</span> 팔로잉              	
		                </button>                	
	               	</c:if>
	                <button class="btn-apt-action">🔔 알림 설정</button>
	            </div>
            </header>

            <ul class="nav apt-tabs" id="comuTab" role="tabList">
            	<li class="nav-item" role="presentation">
            		<button class="tab-item active" id="artistPost" data-bs-toggle="tab" data-bs-target="#artistPostList" type="button" role="tab" aria-controls="artistPostList" aria-selected="true">아티스트</button>
            	</li>
            	<li class="nav-item" role="presentation">
            		<button class="tab-item" id="fanPost" data-bs-toggle="tab" data-bs-target="#fanPostList" type="button" role="tab" aria-controls="fanPostList" aria-selected="false">팬</button>
            	</li>
            	<li class="nav-item" role="presentation" >
            		<button class="tab-item" id="live" data-bs-toggle="tab" data-bs-target="#liveList" type="button" role="tab" aria-controls="liveList" aria-selected="false">라이브</button>
            	</li>
            	<li class="nav-item" role="presentation">
            		<button class="tab-item" id="schedule" data-bs-toggle="tab" data-bs-target="#scheduleList" type="button" role="tab" aria-controls="scheduleList" aria-selected="false">스케줄</button>
            	</li>
            	<li class="nav-item" role="presentation">
            		<button class="tab-item" id="noticeApt" data-bs-toggle="tab" data-bs-target="#noticeAptList" type="button" role="tab" aria-controls="noticeAptList" aria-selected="false">공지사항</button>
            	</li>
            </ul>

            <main class="apt-content-area">
                <div class="tab-pane show active" id="artistPostList" role="tabpanel" aria-labelledby="artistPost">
                    <div id="artistFeedSearchWrap" style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
		            	<form action="/community/gate/${artistGroupVO.artGroupNo }/apt" id="artistSearchForm" method="get">
			            	<input type="hidden" id="comuArtGroupNo" value="${artistGroupVO.artGroupNo }" />
			            	<input type="hidden" name="artistTabYn" value="true" />
			            	<input type="hidden" name="searchType" id="searchType" />
	                        <input type="text" name="searchWord" id="artistFeedSearchInput" value="${communityVO.searchWord }" placeholder="아티스트 게시글 검색 (제목)" style="flex:1; padding:7px 10px; border:1px solid #ccc; border-radius:6px; font-size:0.95em;">
	                        <input type="button" id="searchFormBtn" class="btn btn-primary" value="검색" />
	                        <sec:authorize access="hasAnyRole('MEMBER','MEMBERSHIP','EMPLOYEE','ADMIN')">
	                        	<input type="radio" class="btn-check" name="artistNm" id="all" value="" />
	                        	<label class="btn btn-outline-primary" for="all">전체</label>
		                        <c:forEach items="${artistGroupVO.artistList }" var="artist">
		                        	<input type="radio" class="btn-check" name="artistNm" id="${artist.artNm }" value="${artist.memUsername }" <c:if test="${not empty communityVO.searchType and communityVO.searchType eq artist.memUsername}">checked</c:if>/>
		                        	<label class="btn btn-outline-primary" for="${artist.artNm }">${artist.artNm }</label>
		                        </c:forEach>
	                        </sec:authorize>
		            	</form>
                    </div>
                    
                    <!-- 등록 모달 오픈 -->
                    <div class="post-composer" id="openModal">
				        <button type="button" data-bs-toggle="modal" data-bs-target="#insertPostModal">
					        <div class="profile-placeholder"></div>
					        <span class="placeholder-text">포스트를 남겨보세요.</span>
						</button>
				    </div>
				    
				    <!-- 등록 모달 오픈 끝 -->
				    
				    
                    
                    <div id="artistFeedList">
                    	<c:forEach items="${artistPostVO }" var="post" varStatus="v">
                    		<c:if test="${post.boardTypeCode eq 'ARTIST_BOARD'}">
                    			<div class="feed-item" data-post-id="${post.comuPostNo }">
                    				<div class="feed-item-header">
                    					<div class="author-avatar" style="background-color:'#8a2be2'; color:'#fff';"><img src="${post.writerProfile.comuProfileImg }"></div>
                    					<div class="author-info">
                    						<span class="author-name" style="color:'#8a2be2';">${post.writerProfile.comuNicknm}</span>
                    						<span class="post-time">
	                    						<c:choose>
	                    							<c:when test="${post.comuPostRegDate ne post.comuPostModDate }">
			                    						<fmt:formatDate value="${post.comuPostModDate }" pattern="MM.dd. HH:mm"/>(수정됨)
	                    							</c:when>
	                    							<c:otherwise>
	                    								<fmt:formatDate value="${post.comuPostRegDate }" pattern="MM.dd. HH:mm"/>
	                    							</c:otherwise>
	                    						</c:choose>
                    						</span>
                    						<c:if test="${post.memberShipYn }">
                    							<span class="membership-badge" style="background:#8a2be2;color:#fff;padding:2px 6px;border-radius:10px;font-size:0.8em;margin-left:5px;">멤버십 전용</span>
                    						</c:if>
                    					</div>
                    					<div class="post-options">
                    						<button class="post-options-btn" style="background:none;border:none;font-size:1.2em;cursor:pointer;">•••</button>
			                                <div class="post-options-menu" style="position:absolute;right:0;top:30px;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;min-width:90px;">
				                                <sec:authorize access="hasAnyRole('ARTIST','MEMBER')">
				                                	<c:if test="${user.username eq post.writerProfile.memUsername }">
					           							<div class="post-option-item" id="edit" data-postNum="${post.comuPostNo }">수정</div>
					           							<div class="post-option-item" data-action="delete">삭제</div>
				                                	</c:if>
				                                </sec:authorize>
			                                </div>
                    					</div>
                    				</div>
                    				<div class="feed-item-content<c:if test="${post.memberShipYn }">membership-blur</c:if>" style="<c:if test="${post.memberShipYn }">'position:relative;'</c:if>">
                    					<form id="postForm${v.index }" data-postNum=${v.index }>
	                   						<c:if test="${not empty post.postFiles }">
		                    					<div class="post-img">
	                    							<c:forEach items="${post.postFiles }" var="file">
	                    								<img src="${file.webPath }">
	                    							</c:forEach>
		                    					</div>
	                   						</c:if>
	                    					<div class="post-text" id="artistPostViewer">${post.comuPostContent}</div>
                    					</form>
                    				</div>
                    				<div class="feed-item-actions">
			                            <button class="action-btn comment-toggle-btn">💬 댓글 <span class="count"><c:out value="${post.comuPostReplyCount }" /></span></button>
			                        </div>
			                        <div class="comments-wrapper" style="display:block;">
			                        	<div class="comment-form-container">
			                        		<textarea class="comment-textarea" placeholder="댓글을 남겨보세요..."></textarea>
                    						<button class="btn-submit-comment" disabled>등록</button>
			                        	</div>
			                        	<div class="comment-list">
			                        		<c:forEach items="${post.comuPostReplyList }" var="reply">
				                        		<div class="comment-content">
				                        			<span class="comment-author-name"><c:out value="${reply.replyMember.comuNicknm }"/></span>
	                                				<p class="comment-text"><c:out value="${reply.comuReplyContent }"/></p>
				                        		</div>
			                        		</c:forEach>
			                        	</div>
			                        </div>
                    			</div>
                    		</c:if>
                    	</c:forEach>
                    </div>
                </div>
                <div class="tab-pane" id="fanPostList" role="tabpanel" aria-labelledby="fanPost">ddd</div>
                
				<div class="tab-pane" id="liveList" role="tabpanel" aria-labelledby="live">..d</div>
				
				<div class="tab-pane" id="scheduleList" role="tabpanel" aria-labelledby="schedule">.dd</div>
				<div class="tab-pane" id="noticeAptList" role="tabpanel" aria-labelledby="noticeApt">....</div>

            </main>
        </div>




<!-- /////////////////////////////////////////////////////////////////////////////////////////////////////// -->






        <aside class="apt-sidebar">
            <div class="sidebar-widget apt-level-widget">
                <h3>APT 현황</h3>
                <div class="apt-floor-display" id="aptFloorDisplay">123층 APT</div>
                <div class="fan-count-tooltip-wrapper"> <p class="fan-count-display">팬 <span id="sidebarFanCountApprox">약 12.3만</span> 명</p> <span class="fan-count-tooltip" id="sidebarFanCountExact">123,456명</span> </div>
            </div>

            <div class="sidebar-widget membership-widget">
                <div class="membership-icon">🛡️</div>
                <h3>Membership</h3>
                <p>지금 멤버십에 가입하고 Artist A의 특별한 혜택을 누려보세요.</p>
                <button class="btn-join-membership" id="openMembershipModalBtn">
                    멤버십 가입하기 <span class="arrow">&gt;</span>
                </button>
            </div>

             <!-- 마이 프로필 영역 추가 -->
             <div class="sidebar-widget my-profile-widget" style="margin-bottom: 20px; text-align: center; cursor: pointer;">
             	<div>
             		<button type="button" class="btn btn-outline-primary" id="registProfileBtn">프로필 만들기</button>
             	</div>
                <div style="width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; overflow: hidden; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                </div>
                <p id="myProfileNickname" style="margin-top: 8px; font-weight: bold; font-size: 1.1em;">나의멋진닉네임</p>
            </div>

        </aside>
    </div>

    <div id="footer-placeholder"></div>

     <div class="modal-overlay" id="membershipModalOverlay" style="display: none;">
        <div class="modal-content membership-modal">
            <button class="modal-close-btn" id="closeMembershipModalBtn" title="닫기">&times;</button>
            <div class="modal-header">
                <h2>Artist A OFFICIAL MEMBERSHIP</h2>
                <p class="membership-duration">이용 기간: 결제일로부터 30일</p>
            </div>
            <div class="modal-body">
                <div class="membership-main-image">
                </div>
                <h3>주요 혜택 안내</h3>
                <ul class="modal-benefits-list">
                    <li>✔️ 멤버십 전용 콘텐츠 이용 가능 (일부 블러 처리된 콘텐츠 즉시 해제!)</li>
                    <li>🗓️ APT 메인 상단에서 아티스트 구독일 D-Day 확인</li>
                    <li>🎤 콘서트/팬미팅 선예매 및 특별 이벤트 참여 기회</li>
                    <li>🎁 한정판 멤버십 키트 제공 (별도 구매 또는 등급에 따라)</li>
                </ul>

                <h3>이용 안내 및 유의사항</h3>
                <ul class="modal-notes-list">
                    <li>본 멤버십은 비용을 선지불하여 이용하는 유료 서비스입니다.</li>
                    <li>멤버십은 아티스트(솔로, 그룹)별로 별도 운영되며, 본 멤버십은 [Artist A] 전용입니다.</li>
                    <li>그룹 내 솔로 활동 멤버 발생 시, 해당 멤버의 커뮤니티는 별도 생성/운영될 수 있습니다.</li>
                    <li>자세한 내용은 구매 페이지의 약관을 참고해주세요.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <div class="membership-price">₩30,000 <span class="vat-notice">(VAT 포함)</span></div>
                <button class="btn-modal-purchase" id="goToPurchasePageBtn">멤버십 구매하기</button>
            </div>
        </div>
    </div>

	<c:if test="${followFlag eq 'N'}">
	     <!-- 커뮤니티 가입 오버레이 -->
	    <div id="communityOverlay" class="d-flex p-2 align-items-center fixed-bottom" 
	    	style="height:50px; bottom: 0px; width:100%; background-color: rgba(0,0,0,0.7); border-radius: 5px;">
	        <div class="community-overlay-bg"></div>
	        <span style="color: #fff;">커뮤니티 팔로우를 해서 모든 컨텐츠를 즐겨보세요</span>
	        <button class="community-join-btn" id="followBtn" style="margin-left: auto; color:#fff">팔로우하기</button>
	    </div> 
	
	    <!-- 닉네임 입력 모달 -->
	    <div class="modal fade" id="commProfileModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
	        <div class="modal-dialog modal-dialog-centered">
	            <div class="modal-content">
	                <div class="modal-header">
	                    <h5 class="modal-title" id="commProfileModalLabel">커뮤니티 프로필을 만들어보세요!</h5>
	                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	                </div>
	                <div class="modal-body">
	                	<div class="mb-3 d-flex justify-content-center align-items-center">
	                        <div class="profile-img-box" id="previewImgBox" style="width:100px; height:100px; border-radius: 50%; cursor:pointer; overflow: hidden;">
	                            <img alt="프로필이미지" src="${pageContext.request.contextPath}/upload/profile/base/defaultImg.png" id="previewImg" width="100px" height="100px">
	                        </div>
	                	</div>
	                    <div class="mb-3">
	                        <label for="comuNicknm" class="form-label">닉네임</label>
	                        <input type="text" class="form-control" id="comuNicknm" name="comuNicknm" maxlength="12" placeholder="12자 이내로 입력하세요">
	                    </div>
	
	                    <div class="mb-3">
	                        <label for="imgFile" class="form-label">프로필 이미지</label>
	                        <input class="form-control" type="file" id="imgFile" name="imgFile" accept="image/*">
	                    </div>
	                </div>
	                <div class="modal-footer">
	                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
	                    <button type="button" class="btn btn-primary" id="profileSubmitBtn">완료</button>
	                </div>
	            </div>
	        </div>
	    </div>
	</c:if>

    <!-- DM 모달이 삽입될 컨테이너 -->
    <div id="weverse-dm-modal-container"></div>

    <!-- DM 열기 버튼 (원하는 곳에 배치) -->
    <button onclick="openWeverseDM()">DM 열기</button>

<!-- 아티스트 글 등록 모달 -->
<div class="modal fade " id="insertPostModal" tabindex="-1"
	aria-labelledby="insertPostModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="insertPostModalLabel">
					<c:out value="${artistGroupVO.artGroupNm }" />
				</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="postForm" action="/community/insert/post"
					enctype="multipart/form-data" method="post">
					<input type="hidden" name="artGroupNo" value="${artistGroupVO.artGroupNo }" />

					<div id="imgArea"></div>

					<div>내용</div>
					<textarea rows="5" cols="10" id="comuPostContent"
						onkeyup="contentLengthCheck(this)" name="comuPostContent"></textarea>

					<div class="text-right pt-2">
						<span class="pt-1"><span class="cmt-sub-size">0</span>/1000</span>
					</div>

					<label for="memberShipYn"> <input type="checkbox"
						id="postMemberShipYn" name="postMemberShipYn" value="멤버십전용 게시물" />
						<input type="hidden" id="memberShipYn" name="memberShipYn"
						value="" /> 멤버십전용
					</label> <input type="file" name="files" id="insertPostFile" multiple
						accept="image/*">
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="postSendBtn">저장</button>
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
             
<!-- 아티스트 글 등록 모달 끝 -->

<!-- 아티스트 글 수정 모달 -->
<div class="modal fade " id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="editPostModalLabel">
					<c:out value="포스트 수정" />
				</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="editPostForm" enctype="multipart/form-data" method="post">
					<input type="hidden" name="artGroupNo" value="${artistGroupVO.artGroupNo }" />
					<input type="hidden" name="comuPostNo" id="postNum" />
					<input type="hidden" id="fileGroupNo" name="fileGroupNo" />
					<input type="hidden" id="deleteFiles" name="deleteFiles" />

					<div id="editImgArea"></div>

					<div>내용</div>
					<textarea rows="5" cols="10" id="editComuPostContent"
						 name="comuPostContent" onchange="contentLengthCheck(this)"></textarea>
					<div class="text-right pt-2">
						<span class="pt-1"><span class="cmt-sub-size">0</span>/1000</span>
					</div>

					<label for="editPostMemberShipYn" id="checkBoxMbs"> 
						<input type="checkbox" id="editPostMemberShipYn" name="postMemberShipYn" value="멤버십전용 게시물" />
						<input type="hidden" id="editMemberShipYn" name="memberShipYn"
						value="" /> 멤버십전용
					</label> 
					<input type="file" name="files" id="editInsertPostFile" multiple accept="image/*">
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="postUpdateBtn">수정</button>
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
             
<!-- 아티스트 글 수정 모달 끝 -->

<script>

$(function(){
	
	let fileMap = new Map();	// 업로드한 파일 담을 객체
	let fileNum = 0;		// 업로드한 파일의 순번

	let upFile = new Map();	// 수정 중 업로드한 파일 담을 객체
	let upFileNum = 0;		// 수정 중 업로드한 파일의 순번
	
	let deleteFileList = [];	// 삭제할 파일의 상세번호
	let deleteFileGroupNo = new Map();	// 삭제할 파일의 그룹번호
	
	// 이미지 영역 가져오기
	let area = $("#imgArea"); 
	
	$("#insertPostFile").on("change",function(e){
		let files = e.target.files;
		
		for(let i=0; i<files.length; i++){
			let file = files[i];
			
			fileMap.set(fileNum.toString(),file);
			
			let reader = new FileReader();
    		reader.onload = function(e){
    			html = `
					<div class="imgDiv">
						<img src="\${e.target.result}"  data-fileNum='\${fileNum}' >
								<i class="bi bi-x-lg"></i>
						</img>
						
					</div>
					`;
					$("#imgArea").append(html);
        		fileNum++;
    		}
    		reader.readAsDataURL(file);
		}
		
	});
	
	// 이미지 삭제 시 files map에 삭제
	area.on("click","i",function(){
		let pr = $(this).parent("div").remove();
		let cur = $(this).parent("div").children('img')[0].dataset.filenum;
		
		files.delete(cur);
		
	});
	
	$("#postSendBtn").on("click",function(){
		let checkeded = $("#postMemberShipYn").is(':checked');
		$("#memberShipYn").val(checkeded);
		let postForm = document.getElementById("postForm");
		
		let artGroupNo = $("#comuArtGroupNo").val();
		
		let data = new FormData(postForm);
		
		$.ajax({
			url : "/community/insert/post",
			type : "post",
			data : data,
			processData : false,
			contentType : false,
			success : function(res){
				if(res == 'OK'){
					alert("글 등록 성공!");
				}else{
					alert("글 등록 실패")
				}
				location.href = "/community/gate/" + artGroupNo + "/apt";
			},
			error : function(error){
				console.log(error.status);
			},
			beforeSend : function(xhr) {
		        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		    }
		});
	});
	
	
	// 아티스트 게시글 내용 정보 가져오기
	let artistPostList = document.querySelectorAll("#artistPostViewer");
	
	// 가져온 게시글 내용 리스트를 반복문을 돌려서 viewer 설정
	artistPostList.forEach((v, i) => {
		
		let content = v.dataset.markdown
		
		const viewr = new toastui.Editor.factory({
			el: v,
			viewer : true,
			initialValue : content,
		});
	})
	
	
	// 아티스트 페이지에서 검색 버튼 클릭 시
	$("#searchFormBtn").on("click",function(){
		console.log($("#artistSearchForm").find("input:checked").val());
		let selectArtist = $("#artistSearchForm").find("input:checked").val();
		$("#searchType").val(selectArtist);
		
		$("#artistSearchForm").submit();
	});
	

	
	////////////////////////////////////////////
	
	
	// 수정 버튼 클릭 시 
	let editBtnList = document.querySelectorAll("#edit");		// 모든 수정 버튼을 nodeList로 가져옴
	editBtnList.forEach(div => {								
		div.addEventListener("click",function(e){				// div 태그에 클릭 이벤트를 넘 
			let postNum = e.target.dataset.postnum;					// 클릭한 div에 저장되어있는 postNum을 가져와 postForm순번 과 editPostForm순번의 스타일 display를 변경해줌으로 수정할 수 있게 변경해줌
			
			$("#postNum").val(postNum);
			
			$.ajax({
				url : "/community/post/get/" + postNum,
				type : "get",
				success : function(res){
					console.log(res);
					$("#editComuPostContent").text(res.comuPostContent);
					
					$("#fileGroupNo").val(res.fileGroupNo);
					
					if(res.artistTabYn){
						if(res.memberShipYn){
							$("#editPostMemberShipYn").prop("checked",true);
						}
						$("#checkBoxMbs").attr("style", "display:block");
					}else{
						$("#checkBoxMbs").attr("style", "display:none");
					}
					
					let html = ``;
					if(res.postFiles != null && res.postFiles.length > 0){
						for(let i=0; i<res.postFiles.length; i++){
							let postFile = res.postFiles[i];
							html += `
								<div class="imgDiv">
									<img src="\${postFile.webPath}"  data-fileNum='\${postFile.attachDetailNo}' >
											<i class="bi bi-x-lg"></i>
									</img>
								</div>
							`;
						}
					}
					$("#editImgArea").append(html);
					
					let modal = document.getElementById("editPostModal")
					let myModal = new bootstrap.Modal(modal);
					myModal.show();
					
				},
				error : function(error){
					console.log(error.status);
				}
			});
			
			$("#editInsertPostFile").on("change",function(e){
				let files = e.target.files;
				
				for(let i=0; i<files.length; i++){
					let file = files[i];
					
					fileMap.set(fileNum.toString(),file);
					
					let reader = new FileReader();
		    		reader.onload = function(e){
		    			html = `
							<div class="imgDiv">
								<img src="\${e.target.result}"  data-fileNum='\${fileNum}' >
										<i class="bi bi-x-lg"></i>
								</img>
								
							</div>
							`;
							$("#editImgArea").append(html);
		        		fileNum++;
		    		}
		    		reader.readAsDataURL(file);
				}
				
			});
			
			$("#editImgArea").on("click","i",function(){
				$(this).parent('div').remove();		// 삭제할 파일을 감싸고 있는 div를 삭제함
				
				// 수정 이미지 영역에 이미지 element
				let img = $(this).parent('div').find('img')[0];
				
				if(img.dataset.filenum != null){
					deleteFileList.push(img.dataset.filenum);	// 삭제할 파일 리스트에 삭제한 파일의 상세번호를 넣음
				}
				deleteFileGroupNo.set(img.dataset.filegroupno,deleteFileList);	// 삭제할 파일 리스트를 삭제할 파일의 그룹번호를 키로 설정하고 안에 삭제할 파일 리스트를 넣음
			});
			
			$("#postUpdateBtn").on("click",function(){
				let checkeded = $("#editPostMemberShipYn").is(':checked');
				$("#editMemberShipYn").val(checkeded);
				let editPostForm = document.getElementById("editPostForm");
				
				if(deleteFileList != null && deleteFileList.length > 0){
					console.log(deleteFileList);
					$("#deleteFiles").val(deleteFileList);
				}
				
				let data = new FormData(editPostForm);
				
				$.ajax({
					url : "/community/update/post",
					type : "post",
					data : data,
					processData : false,
					contentType : false,
					success : function(res){
						console.log(res);
					},
					error : function(error){
						console.log(error.status);
					},
					beforeSend : function(xhr) {
				        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
				    }
				})
			});
			
		});
	})
	
	
	
	
	$("#test").on("click",function(){
		console.log($("#artistPostViewer").html());
		let a = document.querySelectorAll(".toastui-editor-contents");
		console.log(a);
	});


	// 팔로우 기능
	// 팔로우버튼
	let followFlag = "${followFlag}" != 'N' ? true : false; 
	let followToggleBtn = $("#followToggleBtn"); // 팔로우 버튼

	followToggleBtn.on("click",function(){
		if(followFlag){
			Swal.fire({
				   title: '팔로우를 취소하시겠습니까?',
				   text: '취소 후 재 가입시 기존 데이터에 접근할 수 없습니다.',
				   icon: 'warning',
				   
				   showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
				   confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
				   cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
				   confirmButtonText: '확인', // confirm 버튼 텍스트 지정
				   cancelButtonText: '취소', // cancel 버튼 텍스트 지정
				   
				}).then(result => {
				   // 만약 Promise리턴을 받으면,
				    if(result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면
				    	let comuProfileNo = "${userProfile.comuProfileNo}";
				    	let artGroupNo = "${userProfile.artGroupNo}";
				    	let memUsername = "${userProfile.memUsername}";
				    	let data = {
				    			comuProfileNo : comuProfileNo,
				    			artGroupNo : artGroupNo,
				    			memUsername : memUsername,
				    	}
				    	// 팔로우 취소
				    	$.ajax({
				    		url : "/api/community/removeapt",
				    		type : "post",
				    		contentType : "application/json; charset=utf-8",
				    		data : JSON.stringify(data),
				    		beforeSend : function(xhr){
								xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}')
							},
				    		success : function(res){
				    			location.reload();
				    		},
				    		error : function(err){
				    			console.log(err);
				    			sweetAlert("error","취소 도중 에러가 발생했습니다. 다시 시도해주세요!");
				    		}
				    	});
				   		
				    }
				});
		}else{
			$("#commProfileModal").modal("show");
		}
	})
	
	if(!followFlag){
		let followBtn = $("#followBtn");	// 오버레이쪽 팔로우 버튼
		let commProfileModal = $("#commProfileModal"); // 커뮤니티 프로필 생성 모달
		let previewImgBox = $("#previewImgBox"); //미리보기이미지박스
		let imgFile = $("#imgFile"); // 이미지 첨부 파일
		let previewImg = $("#previewImg"); // 미리보기 이미지
		let comuNicknm = $("#comuNicknm"); // 닉네임 필드
		let file = null;	// 파일 없으면 null
		let profileSubmitBtn = $("#profileSubmitBtn"); // 닉네임 등록 버튼
		
		followBtn.on("click",function(){
			commProfileModal.modal("show");
		});
		
		// 프로필 이미지 박스 클릭시 이미지파일 선택
		previewImgBox.on("click",function(){
			imgFile.click();	
		})
		
		// 프로필 이미지 이벤트
		imgFile.on("change",function(){
			const defaultPath = "${pageContext.request.contextPath}/upload/profile/base/defaultImg.png";
			const maxSize = 2 * 1024 * 1024;
			file = this.files[0];
	
			if(file == null){
				previewImg.attr("src", defaultPath);
				return false;
			}
			
			if(file.size > maxSize){
				sweetAlert("error", "파일 사이즈는 2MB 미만으로 선택해주세요!");
				$(this).val("");
				file = null;
				previewImg.attr("src", defaultPath);
				return false;
			}
			
			if(!file.type.startsWith("image/")){
				sweetAlert("error", "이미지파일만 선택해주세요");
				$(this).val("");
				file = null;
				previewImg.attr("src", defaultPath);
				return false;
			}
			
			let fileReader = new FileReader();
			fileReader.onload = function(e){
				previewImg.attr("src", e.target.result);
			};
			
			fileReader.readAsDataURL(file);
		})
		
		profileSubmitBtn.on("click",function(){
			let comuNicknmVal = comuNicknm.val();
			if(comuNicknmVal == null || comuNicknmVal.trim() == ''){
				sweetAlert("error","닉네임을 입력해주세요");
				return false;
			}
			if(comuNicknmVal.length > 12){
				sweetAlert("error","닉네임은 12자 이내로 입력해주세요");
				return false;
			}
			
			let formData = new FormData();
			let artGroupNo = "${artistGroupVO.artGroupNo}";
			let memUsername = "${user.username}";
			formData.append("artGroupNo",artGroupNo);
			formData.append("memUsername",memUsername);
			formData.append("comuNicknm", comuNicknmVal);
			formData.append("imgFile", file);
			joinCommunity(formData);
		})
		
	}
	
	function joinCommunity(formData){
		$.ajax({
			url : '/api/community/joinapt',
			type : "post",
			processData : false,
			contentType : false,
			data : formData,
			beforeSend : function(xhr){
				xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}')
			},
			success : function(res){
				location.reload();
			},
			error : function(err){
				console.log(err);
				sweetAlert("error","팔로우 하는 도중 에러가 발생했습니다. 다시 시도해주세요!");
			}
		});
	}
	
	let myProfile = $("#myProfile"); // 마이프로필 엘리먼트
	myProfile.on("click",function(){
		let artGroupNo = "${artistGroupVO.artGroupNo}";
		let comuProfileNo = $(this).data("comuProfileNo");
		location.href = `${pageContext.request.contextPath}/community/\${artGroupNo}/profile/\${comuProfileNo}`;
	});
	
});
function contentLengthCheck(ele){
	let size = ele.value.length;
	let text = ele.value;
	
	if(size > 1000){
		alert("글 작성은 1000자 이상을 넘을 수 없습니다.");
		let subText = text.substring(0,1000);	
		ele.value = subText;
		$(ele).parents("#postForm").find(".cmt-sub-size").text(subText.length);
		return false;
	}
	
	$(ele).parent("#postForm").find(".cmt-sub-size").text(size);
}


</script>
</body>
</html>
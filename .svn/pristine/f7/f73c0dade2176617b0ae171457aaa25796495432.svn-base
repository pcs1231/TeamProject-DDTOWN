<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="${_csrf.token}"/>
	<meta name="_csrf_header" content="${_csrf.headerName}"/>
    <title>DDTOWN êµ¿ì¦ˆìƒµ</title>
 	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods.css">
	<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/goods_main.css">
 	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="site-header">
        <div class="logo">
            <a href="${pageContext.request.contextPath}/goods/main">DDTOWN SQUARE</a>
        </div>
        <nav class="utility-nav">
            <c:choose>
                <c:when test="${sessionScope.isUserLoggedIn_server == true}">
                    <ul id="loggedInNav">
                        <li><a href="#" class="icon-btn" title="ì•Œë¦¼">ğŸ””</a></li>
                        <li><a href="${pageContext.request.contextPath}/mypage.html" class="icon-btn" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a></li>
                        <li><a href="#" class="icon-btn" title="ê³ ê°ì„¼í„°">ğŸ‘©â€ğŸ’»</a></li>
                        <li><a href="${pageContext.request.contextPath}/logout" id="logoutBtn" class="auth-link">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </c:when>
                <c:otherwise>
                    <ul id="loggedOutNav">
                        <li><a href="${pageContext.request.contextPath}/login.html" class="auth-link">ë¡œê·¸ì¸</a></li>
                        <li><a href="${pageContext.request.contextPath}/signup.html" class="signup-link">íšŒì›ê°€ì…</a></li>
                    </ul>
                </c:otherwise>
            </c:choose>
        </nav>
    </header>

    <nav class="main-navigation">
        <ul>
            <li><a href="${pageContext.request.contextPath}/goods/main">êµ¿ì¦ˆìƒµ</a></li>
            <li>
                <a href="#">ì„ í˜¸ë„ ì¡°ì‚¬</a>
                <ul class="submenu">
                    <li><a href="${pageContext.request.contextPath}">ì¸ê¸° íˆ¬í‘œ</a></li>
                </ul>
            </li>
            <li><a href="#">ì½˜ì„œíŠ¸</a></li>
        </ul>
    </nav>

    <%-- ë©”ì¸ ê³µì§€ì‚¬í•­ ê°ì²´(notice)ê°€ nullì´ ì•„ë‹ˆê³  ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í‘œì‹œ --%>
    <c:if test="${not empty notice}">
        <div class="shop-notice-bar">
            âœ¨ ${notice.goodsNotiTitle}<hr> <a href="${pageContext.request.contextPath}/notice/detail/${notice.goodsNotiNo}">ìì„¸íˆ ë³´ê¸°</a> âœ¨
            <%-- ê³µì§€ì‚¬í•­ ìƒì„¸ URL ìˆ˜ì •: goodsNotiNo ì•ì— /notice/detail/ ì¶”ê°€ --%>
        </div>
    </c:if>

    <nav class="artist-filter-bar">
        <%-- 'ì „ì²´' ë²„íŠ¼ì˜ í™œì„± ìƒíƒœ í™•ì¸ --%>
        <button class="filter-btn ${pagingVO.searchWord == null || pagingVO.searchWord == '' || !pagingVO.searchType.startsWith('artist') ? 'active' : ''}" data-artist-id="all">ì „ì²´</button>
        <c:forEach var="artist" items="${artistList}">
            <%-- ì•„í‹°ìŠ¤íŠ¸ ë²„íŠ¼ í™œì„± ìƒíƒœ í™•ì¸: searchTypeì´ 'artist'ë¡œ ì‹œì‘í•˜ê³  searchWordê°€ í˜„ì¬ ì•„í‹°ìŠ¤íŠ¸ì˜ artGroupNoì™€ ì¼ì¹˜í•˜ëŠ”ì§€ --%>
            <button class="filter-btn ${pagingVO.searchType.startsWith('artist') && pagingVO.searchWord == artist.artGroupNo ? 'active' : ''}"
                    data-artist-id="${artist.artGroupNo}">${artist.artGroupNm}</button>
        </c:forEach>
    </nav>

    <section class="product-list-section">
        <div class="product-grid-header">
            <h2>ì „ì²´ ìƒí’ˆ</h2>
            <div class="sort-options">
                <select id="sortProducts">
                    <%-- í˜„ì¬ ì •ë ¬ íƒ€ì…ì— ë”°ë¼ selected ì†ì„± ì¶”ê°€ --%>
                    <option value="newest" ${pagingVO.searchType == 'newest' || pagingVO.searchType == 'artist' ? 'selected' : ''}>ì‹ ìƒí’ˆìˆœ</option>
                    <option value="popularity" ${pagingVO.searchType.contains('popularity') ? 'selected' : ''}>ì¸ê¸°ìˆœ</option>
                    <option value="priceLowHigh" ${pagingVO.searchType.contains('priceLowHigh') ? 'selected' : ''}>ë‚®ì€ê°€ê²©ìˆœ</option>
                    <option value="priceHighLow" ${pagingVO.searchType.contains('priceHighLow') ? 'selected' : ''}>ë†’ì€ê°€ê²©ìˆœ</option>
                </select>
            </div>
        </div>

        <div class="product-grid" id="productGrid">
            <%-- ìƒí’ˆ ëª©ë¡ì´ ë¹„ì–´ìˆì§€ ì•Šê³ , ì´ ë ˆì½”ë“œ ìˆ˜ê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ ìƒí’ˆì„ í‘œì‹œ --%>
            <c:choose>
                <c:when test="${not empty pagingVO.dataList and pagingVO.totalRecord > 0}">
                    <c:forEach items="${pagingVO.dataList}" var="goods">
                        <div class="product-item">
                            <%-- goods ê°ì²´ì˜ isWished í•„ë“œë¥¼ ì§ì ‘ ì‚¬ìš© --%>
                            <button class="wish-button ${goods.isWished() ? 'wished' : ''}"
                                    data-wished="${goods.isWished()}"
                                    data-goods-no="${goods.goodsNo}">
                                <i class="fa-heart ${goods.isWished() ? 'fas' : 'far'}"></i>
                            </button>
                            <%-- ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ë§í¬ --%>
                            <a href="${pageContext.request.contextPath}/goods/detail?goodsNo=${goods.goodsNo}" class="product-link">
                                <c:choose>
                                    <c:when test="${not empty goods.representativeImageUrl}"> <%-- ì—¬ê¸°ë¥¼ goodsImgPath -> representativeImageUrlë¡œ ë³€ê²½ --%>
                                        <img src="${pageContext.request.contextPath}${goods.representativeImageUrl}" alt="${goods.goodsNm}" class="product-image"> <%-- ì—¬ê¸°ë„ ë³€ê²½. /resources/uploads/goods/ ì œê±° --%>
                                    </c:when>
                                    <c:otherwise>
                                        <img src="https://via.placeholder.com/200?text=No+Image" alt="ì´ë¯¸ì§€ ì—†ìŒ" class="product-image">
                                    </c:otherwise>
                                </c:choose>
                                <div class="product-info">
                                    <div>
                                        <%-- ì•„í‹°ìŠ¤íŠ¸ ê·¸ë£¹ ë²ˆí˜¸ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ ì•„í‹°ìŠ¤íŠ¸ ê·¸ë£¹ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥ --%>
                                        <span class="product-artist-tag">${goods.artGroupNo}</span>
                                        <h3 class="product-name">${goods.goodsNm}</h3>
                                    </div>
                                    <div class="product-price">
                                        <fmt:formatNumber value="${goods.goodsPrice}" type="number" />
                                        <span class="currency">ì›</span>
                                    </div>
                                    <%-- ì¬ê³  ìˆ˜ëŸ‰ í‘œì‹œ (í•„ìš”í•˜ë‹¤ë©´) --%>
                                    <div class="product-status-stock">
                                        <c:if test="${goods.stockRemainQty <= 0}">
                                            <span style="color: red; font-weight: bold;">[í’ˆì ˆ]</span>
                                        </c:if>
                                        <%-- <c:if test="${goods.stockRemainQty > 0}"> --%>
                                        <%--     <span style="color: green;">ì¬ê³ : ${goods.stockRemainQty}ê°œ</span> --%>
                                        <%-- </c:if> --%>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </c:forEach>
                </c:when>
                <c:otherwise>
                    <p style="text-align: center; width: 100%; padding: 50px;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </c:otherwise>
            </c:choose>
        </div>
    </section>

    <%-- í˜ì´ì§€ë„¤ì´ì…˜ HTML ì¶œë ¥ --%>
    <div class="pagination">
        ${pagingVO.pagingHTML}
    </div>

    <%-- ì¥ë°”êµ¬ë‹ˆ/ì°œëª©ë¡ í”Œë¡œíŒ… ë²„íŠ¼ (ìˆ˜ì • ì—†ìŒ) --%>
    <c:set var="cartCount" value="${not empty cartItemCount ? cartItemCount : 0}" />
    <c:set var="wishCount" value="${not empty wishlistItemCount ? wishlistItemCount : 0}" />

    <nav class="floating-nav">
        <a href="${pageContext.request.contextPath}/cart.html" class="floating-btn" id="floatingCartBtn" title="ì¥ë°”êµ¬ë‹ˆ">
            ğŸ›’
            <span class="item-count-badge" id="cartItemCount" style="display: ${cartCount > 0 ? 'flex' : 'none'};">${cartCount}</span>
        </a>
        <a href="${pageContext.request.contextPath}/wishlist.html" class="floating-btn" id="floatingWishlistBtn" title="ì°œëª©ë¡">
            â¤ï¸
            <span class="item-count-badge" id="wishlistItemCount" style="display: ${wishCount > 0 ? 'flex' : 'none'};">${wishCount}</span>
        </a>
    </nav>

    <script>
    let csrfToken;
    let csrfHeader;
    
    const contextPath = "${pageContext.request.contextPath}";

    document.addEventListener('DOMContentLoaded', function() {
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        if (csrfMeta && csrfHeaderMeta) {
            csrfToken = csrfMeta.content;
            csrfHeader = csrfHeaderMeta.content;
        } else {
            console.error("CSRF meta tags not found. CSRF protection might be disabled or misconfigured.");
        }

        const isUserLoggedIn = ${isLoggedIn};

        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ (ì´ ë¶€ë¶„ì€ JSPì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ë” ì¼ë°˜ì ì…ë‹ˆë‹¤. JSëŠ” í•„ìš”ì‹œ ë™ì  ë³€ê²½ì— ì‚¬ìš©)
        // const loggedOutNav = document.getElementById('loggedOutNav');
        // const loggedInNav = document.getElementById('loggedInNav');
        // if (isUserLoggedIn) {
        //     if(loggedOutNav) loggedOutNav.style.display = 'none';
        //     if(loggedInNav) loggedInNav.style.display = 'flex';
        // } else {
        //     if(loggedOutNav) loggedOutNav.style.display = 'flex';
        //     if(loggedInNav) loggedInNav.style.display = 'none';
        // }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(event) {
                alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        }

        // --- ì°œ(Wishlist) ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ ---
        const wishButtons = document.querySelectorAll('.wish-button');

        wishButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();

                const goodsNo = this.dataset.goodsNo;
                const isWished = this.dataset.wished === 'true';
                const icon = this.querySelector('i');

                if (!isUserLoggedIn) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                    window.location.href = '${pageContext.request.contextPath}/login';
                    return;
                }

                const requestBody = { goodsNo: parseInt(goodsNo) };

                fetch('${pageContext.request.contextPath}/goods/wishlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                         if (response.status === 401) {
                             alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                             window.location.href = '${pageContext.request.contextPath}/login';
                         }
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || `ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (HTTP ${response.status})`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);

                    if (data.status === 'success') {
                        if (data.action === 'added') {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            button.classList.add('wished');
                            this.dataset.wished = 'true';
                        } else if (data.action === 'removed') {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            button.classList.remove('wished');
                            this.dataset.wished = 'false';
                        }
                    }
                })
                .catch(error => {
                    console.error('ì°œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ì°œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            });
        });

     // --- ìƒí’ˆ ì •ë ¬ ë³€ê²½ ìŠ¤í¬ë¦½íŠ¸ ---
        const sortProductsSelect = document.getElementById('sortProducts');
        if (sortProductsSelect) {
            sortProductsSelect.addEventListener('change', function() {
                const selectedSortType = this.value;
                const currentPage = 1; // ì •ë ¬ ë³€ê²½ ì‹œ 1í˜ì´ì§€ë¡œ ì´ë™

                const urlParams = new URLSearchParams(window.location.search);
                let currentSearchWord = urlParams.get('searchWord') || '';
                let currentSearchType = urlParams.get('searchType') || 'newest';

                let finalSearchType = selectedSortType;
                let finalSearchWord = currentSearchWord;

                if (currentSearchType.startsWith('artist') && currentSearchWord) {
                    finalSearchWord = currentSearchWord;
                    finalSearchType = 'artist_' + selectedSortType;
                }

                // URL ì¬êµ¬ì„± ë° ì´ë™: pageContext.request.contextPath ëŒ€ì‹  contextPath ë³€ìˆ˜ ì‚¬ìš©
             	// **ì—¬ê¸° ìˆ˜ì •: ì˜¬ë°”ë¥¸ í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ë¬¸ë²•ê³¼ ë³€ìˆ˜ëª… ì‚¬ìš©**
                window.location.href = `${contextPath}/goods/main?currentPage=${currentPage}&searchWord=${finalSearchWord}&searchType=${finalSearchType}`;
            });
        }

     // --- ì•„í‹°ìŠ¤íŠ¸ í•„í„° ë²„íŠ¼ í´ë¦­ ìŠ¤í¬ë¦½íŠ¸ ---
        const filterButtons = document.querySelectorAll('.artist-filter-bar .filter-btn');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const artistId = this.dataset.artistId;
                const currentPage = 1;

                const urlParams = new URLSearchParams(window.location.search);
                let currentSortType = urlParams.get('searchType') || 'newest';

                let searchWord = '';
                let searchType = 'newest';

                if (artistId !== 'all') {
                    searchWord = artistId;

                    // ê¸°ì¡´ ì •ë ¬ íƒ€ì…ì—ì„œ 'artist_' ì ‘ë‘ì‚¬ ì œê±°
                    let baseSortType = currentSortType.replace('artist_', '');
                    
                    // ë§Œì•½ ê¸°ë³¸ ì •ë ¬ íƒ€ì…ì´ 'newest'ë¼ë©´, 'artist'ë§Œ ì‚¬ìš© (ex: /goods/main?searchType=artist&searchWord=1)
                    // ê·¸ ì™¸ì˜ ì •ë ¬ íƒ€ì…ì´ë¼ë©´ 'artist_ì •ë ¬íƒ€ì…' ì‚¬ìš© (ex: /goods/main?searchType=artist_popularity&searchWord=1)
                    if (baseSortType === 'newest') {
                        searchType = 'artist';
                    } else {
                        searchType = 'artist_' + baseSortType;
                    }
                } else {
                    // "ì „ì²´" ë²„íŠ¼ í´ë¦­ ì‹œ
                    searchWord = '';
                    // ê¸°ì¡´ ì •ë ¬ íƒ€ì…ì—ì„œ 'artist_' ì ‘ë‘ì‚¬ ì œê±° (ex: artist_popularity -> popularity)
                    searchType = currentSortType.replace('artist_', '');
                    // ë§Œì•½ 'artist'ë§Œ ë‚¨ì•„ìˆìœ¼ë©´ 'newest'ë¡œ ì„¤ì • (ì˜ˆ: artist -> newest)
                    if (searchType === 'artist') {
                        searchType = 'newest';
                    }
                }

                window.location.href = `${contextPath}/goods/main?currentPage=${currentPage}&searchWord=${searchWord}&searchType=${searchType}`;
            });
        });

     // --- í˜ì´ì§€ë„¤ì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸ ---
        const paginationArea = document.querySelector('.pagination');
        if (paginationArea) {
            paginationArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('page-link') && e.target.tagName === 'A') {
                    e.preventDefault(); // ê¸°ë³¸ ë§í¬ ì´ë™ ë°©ì§€
                    const page = e.target.dataset.page; // data-page ì†ì„± ê°’ ê°€ì ¸ì˜¤ê¸°
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('currentPage', page); // currentPage ì—…ë°ì´íŠ¸
                    window.location.href = `\${window.location.pathname}?\${urlParams.toString()}`;
                }
            });
        }
    });
    </script>
</body>
</html>